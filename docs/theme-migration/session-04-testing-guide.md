# 会话 4 测试指南 - 消息气泡颜色迁移

**测试范围**: AI/User 消息气泡颜色的 CSS Variables 迁移  
**测试日期**: 2025-11-05

## 测试准备

### 1. 启动开发服务器

```bash
npm run dev
```

### 2. 打开浏览器开发者工具

- 打开浏览器的开发者工具（F12）
- 切换到 Elements/元素 标签
- 准备检查 CSS Variables

## 测试项目

### 一、CSS Variables 注入测试

#### 1.1 检查根元素 CSS Variables

**步骤**：
1. 在开发者工具中选择 `<html>` 元素
2. 查看 Computed/计算后 样式
3. 搜索 `--theme-msg-` 开头的变量

**预期结果**：
应该看到以下 CSS Variables（根据当前主题和模式）：
```css
--theme-msg-ai-bg: <颜色值>
--theme-msg-ai-bg-active: <颜色值>
--theme-msg-ai-text: <颜色值>
--theme-msg-ai-border: <颜色值>
--theme-msg-user-bg: <颜色值>
--theme-msg-user-bg-active: <颜色值>
--theme-msg-user-text: <颜色值>
--theme-msg-user-border: <颜色值>
```

**验收标准**：
- ✅ 所有消息相关的 CSS Variables 都存在
- ✅ 颜色值与当前主题匹配
- ✅ 值随主题切换而改变

### 二、消息气泡颜色测试

#### 2.1 默认主题 - AI 消息气泡

**步骤**：
1. 切换到默认主题（设置 → 外观设置 → 主题风格 → 默认）
2. 在聊天界面发送一条消息，等待 AI 回复
3. 观察 AI 消息气泡的背景颜色

**预期结果**：
- **亮色模式**: 浅蓝灰色背景 (`#F8FAFC`)
- **暗色模式**: 深灰蓝色背景 (`#2D3748`)

**验收标准**：
- ✅ AI 消息气泡显示正确的背景颜色
- ✅ 颜色与 Design Tokens 定义一致
- ✅ 与之前的显示效果一致（向后兼容）

#### 2.2 默认主题 - 用户消息气泡

**步骤**：
1. 在默认主题下发送一条用户消息
2. 观察用户消息气泡的背景颜色

**预期结果**：
- **亮色模式**: 浅蓝色背景 (`#E0F2FE`)
- **暗色模式**: 深蓝色背景 (`#1E3A5F`)

**验收标准**：
- ✅ 用户消息气泡显示正确的背景颜色
- ✅ 与 AI 消息有明显区分
- ✅ 悬停效果正常

#### 2.3 Claude 主题 - 消息气泡

**步骤**：
1. 切换到 Claude 主题
2. 发送消息并观察 AI 和用户消息气泡

**预期结果**：

**亮色模式**：
- AI 消息: 温暖米白色 (`#FFF8E7`)
- 用户消息: 浅橙色 (`#FED7AA`)

**暗色模式**：
- AI 消息: 深棕色 (`#292524`)
- 用户消息: 深橙棕色 (`#7C2D12`)

**验收标准**：
- ✅ 消息气泡颜色符合 Claude 风格
- ✅ 温暖的大地色调
- ✅ AI 和用户消息有明显区分

#### 2.4 Nature 主题 - 消息气泡

**步骤**：
1. 切换到 Nature 主题
2. 发送消息并观察消息气泡

**预期结果**：

**亮色模式**：
- AI 消息: 浅米白色 (`#FDFCFB`)
- 用户消息: 浅灰绿色 (`#E8E3D8`)

**暗色模式**：
- AI 消息: 深绿灰色 (`#252B20`)
- 用户消息: 深绿色 (`#3D4E2C`)

**验收标准**：
- ✅ 消息气泡颜色符合自然风格
- ✅ 大地色调和绿色系
- ✅ 柔和舒适的视觉感受

#### 2.5 Tech 主题 - 消息气泡

**步骤**：
1. 切换到 Tech 主题
2. 发送消息并观察消息气泡

**预期结果**：

**亮色模式**：
- AI 消息: 淡蓝白色 (`#F0F9FF`)
- 用户消息: 浅蓝色 (`#DBEAFE`)

**暗色模式**：
- AI 消息: 深灰蓝色 (`#1E293B`)
- 用户消息: 深蓝色 (`#1E3A8A`)

**验收标准**：
- ✅ 消息气泡颜色符合科技风格
- ✅ 冷色调蓝色系
- ✅ 现代科技感

#### 2.6 Soft 主题 - 消息气泡

**步骤**：
1. 切换到 Soft 主题
2. 发送消息并观察消息气泡

**预期结果**：

**亮色模式**：
- AI 消息: 淡粉紫色 (`#FEF3FB`)
- 用户消息: 浅粉色 (`#FBCFE8`)

**暗色模式**：
- AI 消息: 深紫色 (`#2D1B3D`)
- 用户消息: 深粉紫色 (`#831843`)

**验收标准**：
- ✅ 消息气泡颜色符合柔和风格
- ✅ 温柔的粉色和紫色系
- ✅ 柔和舒适的视觉感受

### 三、交互状态测试

#### 3.1 悬停效果测试

**步骤**：
1. 将鼠标悬停在 AI 消息气泡上
2. 将鼠标悬停在用户消息气泡上
3. 观察颜色变化

**预期结果**：
- AI 消息悬停时：背景色变为 `msg-ai-bg-active` 定义的颜色
- 用户消息悬停时：背景色变为 `msg-user-bg-active` 定义的颜色
- 悬停效果平滑过渡

**验收标准**：
- ✅ 悬停时背景颜色有明显但不突兀的变化
- ✅ AI 和用户消息都有正确的悬停效果
- ✅ 过渡动画流畅
- ✅ 鼠标离开后颜色恢复正常

#### 3.2 选中/复制状态测试

**步骤**：
1. 选中消息气泡中的文字
2. 观察选中状态的视觉效果
3. 复制文字并粘贴到其他地方

**验收标准**：
- ✅ 文字选中高亮正常
- ✅ 复制粘贴功能正常
- ✅ 不影响气泡背景色

### 四、主题切换测试

#### 4.1 主题风格切换

**步骤**：
1. 在聊天界面保持多条消息
2. 依次切换所有主题风格（default → claude → nature → tech → soft → default）
3. 观察每次切换后的消息气泡颜色

**预期结果**：
- 每次切换主题后，所有消息气泡立即更新为新主题的颜色
- 不需要刷新页面
- 切换过程流畅无闪烁

**验收标准**：
- ✅ 主题切换后颜色立即更新
- ✅ 所有消息（包括历史消息）都使用新主题颜色
- ✅ 切换过程无明显延迟
- ✅ 无控制台错误

#### 4.2 亮色/暗色模式切换

**步骤**：
1. 在每个主题风格下切换亮色/暗色模式
2. 观察消息气泡颜色变化

**预期结果**：
- 亮色/暗色模式切换后，消息气泡颜色正确更新
- 亮色模式：浅色背景
- 暗色模式：深色背景

**验收标准**：
- ✅ 模式切换后颜色正确更新
- ✅ 亮色模式下背景色浅，文字深
- ✅ 暗色模式下背景色深，文字浅
- ✅ 对比度足够，文字可读性好

### 五、兼容性测试

#### 5.1 回退机制测试

**测试场景**: 测试在 CSS Variables 不可用时的回退机制

**步骤**（高级测试）：
1. 打开浏览器控制台
2. 执行以下代码临时禁用某个 CSS Variable：
```javascript
document.documentElement.style.removeProperty('--theme-msg-ai-bg');
```
3. 观察 AI 消息气泡是否仍然显示正确的颜色

**预期结果**：
- 即使 CSS Variable 不存在，消息气泡仍然显示正确的颜色
- 使用回退值（从 `themeUtils.ts` 的 fallback 函数）

**验收标准**：
- ✅ 没有 CSS Variable 时仍然正常显示
- ✅ 颜色与主题风格匹配
- ✅ 无控制台错误

#### 5.2 API 向后兼容性测试

**目的**: 确保现有组件无需修改即可使用新的颜色系统

**步骤**：
1. 检查所有使用 `getMessageStyles` 的组件
2. 确认它们无需修改即可正常工作

**验收标准**：
- ✅ 所有现有组件正常工作
- ✅ 无需修改组件代码
- ✅ API 接口保持不变

### 六、性能测试

#### 6.1 CSS Variables 读取性能

**步骤**：
1. 打开浏览器性能分析工具
2. 切换主题并记录性能指标
3. 滚动包含大量消息的聊天界面

**预期结果**：
- CSS Variables 读取不应成为性能瓶颈
- 主题切换响应时间 < 100ms
- 滚动流畅，帧率稳定

**验收标准**：
- ✅ 性能无明显下降
- ✅ 主题切换响应迅速
- ✅ 滚动性能良好（60 FPS）

### 七、浏览器兼容性测试

#### 7.1 推荐浏览器测试

在以下浏览器中重复上述核心测试：

- ✅ Chrome/Edge (最新版本)
- ✅ Firefox (最新版本)
- ✅ Safari (最新版本)

**验收标准**：
- ✅ 所有浏览器中颜色显示一致
- ✅ CSS Variables 支持正常
- ✅ 无浏览器特定的 bug

## 测试检查清单

在完成所有测试后，请确认以下检查项：

### 功能性
- [ ] 所有 5 个主题的消息气泡颜色正确显示
- [ ] 亮色/暗色模式切换正常
- [ ] 悬停效果正常
- [ ] 主题切换即时生效

### 视觉效果
- [ ] AI 和用户消息有明显区分
- [ ] 颜色对比度足够，文字可读
- [ ] 主题风格与设计一致
- [ ] 无颜色闪烁或不协调

### 兼容性
- [ ] 回退机制工作正常
- [ ] 现有组件无需修改
- [ ] 所有浏览器表现一致
- [ ] 无控制台错误或警告

### 性能
- [ ] 主题切换流畅
- [ ] 滚动性能良好
- [ ] CSS Variables 读取无性能问题

## 常见问题排查

### 问题 1: 消息气泡颜色不正确

**可能原因**：
- CSS Variables 未正确注入
- 主题配置错误
- 浏览器缓存问题

**解决方案**：
1. 检查 `document.documentElement.style` 中是否有正确的 CSS Variables
2. 清除浏览器缓存并刷新
3. 检查 `src/shared/utils/cssVariables.ts` 中的注入逻辑

### 问题 2: 主题切换后颜色未更新

**可能原因**：
- `applyCSSVariables` 未被调用
- React 组件未重新渲染

**解决方案**：
1. 检查 `useTheme.ts` 中的 `applyCSSVariables` 调用
2. 检查组件是否监听了主题变化
3. 尝试强制刷新页面

### 问题 3: 悬停效果不生效

**可能原因**：
- `getMessageStyles` 返回的样式不正确
- CSS 优先级问题

**解决方案**：
1. 检查开发者工具中的元素样式
2. 确认 `msg-ai-bg-active` 和 `msg-user-bg-active` CSS Variables 存在
3. 检查 CSS 选择器优先级

## 回归测试建议

在未来的开发中，每次修改主题相关代码后，建议至少执行以下快速回归测试：

1. **快速视觉检查**（2 分钟）
   - 切换所有 5 个主题
   - 检查消息气泡颜色
   - 测试亮色/暗色模式切换

2. **交互测试**（1 分钟）
   - 测试消息悬停效果
   - 测试文字选中

3. **构建测试**（必须）
   - 运行 `npm run build`
   - 确保无构建错误

## 测试报告模板

测试完成后，可以使用以下模板记录测试结果：

```markdown
### 测试结果

**测试日期**: YYYY-MM-DD
**测试人员**: [姓名]
**测试环境**: [浏览器] on [操作系统]

#### 通过的测试
- ✅ [测试项目名称]
- ✅ [测试项目名称]

#### 失败的测试
- ❌ [测试项目名称] - [问题描述]

#### 需要改进
- ⚠️ [改进建议]

#### 总体评价
[整体测试感受和建议]
```

## 相关文档

- [会话 4 进度记录](./session-04-progress.md)
- [会话 4 完成总结](./session-04-summary.md)
- [CSS Variables 命名规范](../css-variables-naming.md)








