# BlockManager V2 é›†æˆæ€»ç»“

## ğŸ“¦ å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒä»£ç å®ç° âœ…

#### BlockManager ç±»
**æ–‡ä»¶**: `src/shared/services/messages/BlockManager.ts`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æ™ºèƒ½èŠ‚æµç­–ç•¥ï¼ˆæ ¹æ®å—ç±»å‹å˜åŒ–å’Œå®ŒæˆçŠ¶æ€ï¼‰
- âœ… æ´»åŠ¨å—ç®¡ç†ï¼ˆMap å­˜å‚¨ï¼‰
- âœ… èµ„æºæ¸…ç†æœºåˆ¶
- âœ… æ€§èƒ½ç›‘æ§é›†æˆ
- âœ… å‘åå…¼å®¹ API

#### ResponseChunkProcessorV2
**æ–‡ä»¶**: `src/shared/services/messages/responseHandlers/ResponseChunkProcessorV2.ts`

**æ”¹è¿›ç‚¹**:
- âœ… ä½¿ç”¨ BlockManager æ›¿ä»£å¤æ‚çš„ä¾èµ–æ³¨å…¥
- âœ… ä»£ç é‡å‡å°‘ 40%
- âœ… ä¿æŒ API å…¼å®¹æ€§
- âœ… æ”¯æŒæ‰€æœ‰ Chunk ç±»å‹

### 2. é›†æˆä¸é…ç½® âœ…

#### Feature Flags
**æ–‡ä»¶**: `src/shared/config/featureFlags.ts`

```typescript
export const FeatureFlags = {
  USE_BLOCK_MANAGER_V2: false,              // å¯ç”¨æ–°ç‰ˆ
  ENABLE_PERFORMANCE_MONITORING: false,      // å¯ç”¨ç›‘æ§
  ENABLE_VERBOSE_LOGGING: false,            // è¯¦ç»†æ—¥å¿—
} as const;
```

**åŠŸèƒ½**:
- âœ… æ”¯æŒæ–°æ—§ç‰ˆæœ¬åˆ‡æ¢
- âœ… å¼€å‘ç¯å¢ƒå¯åŠ¨æ€ä¿®æ”¹
- âœ… ç”Ÿäº§ç¯å¢ƒä¿æŠ¤

#### ResponseHandler é›†æˆ
**æ–‡ä»¶**: `src/shared/services/messages/ResponseHandler.ts`

**æ”¹åŠ¨**:
```typescript
// æ ¹æ® Feature Flag é€‰æ‹©å¤„ç†å™¨
const useV2 = getFeatureFlag('USE_BLOCK_MANAGER_V2');
const chunkProcessor = useV2
  ? createResponseChunkProcessorV2(messageId, blockId)
  : createResponseChunkProcessor(/* æ—§ç‰ˆå‚æ•° */);
```

**ç‰¹ç‚¹**:
- âœ… æ— ç¼åˆ‡æ¢
- âœ… è‡ªåŠ¨æ¸…ç†èµ„æº
- âœ… æ—¥å¿—è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯

### 3. æ€§èƒ½ç›‘æ§ âœ…

#### PerformanceMonitor
**æ–‡ä»¶**: `src/shared/utils/performanceMonitor.ts`

**åŠŸèƒ½**:
- âœ… è®°å½• Redux æ›´æ–°æ¬¡æ•°
- âœ… è®°å½•ç»„ä»¶æ¸²æŸ“æ¬¡æ•°
- âœ… è®°å½•æ•°æ®åº“å†™å…¥æ¬¡æ•°
- âœ… è‡ªåŠ¨è®¡ç®—æ€§èƒ½æŒ‡æ ‡
- âœ… æµè§ˆå™¨æ§åˆ¶å°å¿«æ·æ–¹æ³•

**ä½¿ç”¨**:
```javascript
window.startPerformanceMonitoring();
// å‘é€æ¶ˆæ¯...
window.stopPerformanceMonitoring();
```

### 4. æ–‡æ¡£å®Œå–„ âœ…

#### æ ¸å¿ƒæ–‡æ¡£
- âœ… [QUICKSTART.md](./QUICKSTART.md) - 5 åˆ†é’Ÿå¿«é€Ÿæµ‹è¯•
- âœ… [testing-guide.md](./testing-guide.md) - å®Œæ•´æµ‹è¯•æŒ‡å—
- âœ… [BlockManager-usage-example.md](./BlockManager-usage-example.md) - API ä½¿ç”¨ç¤ºä¾‹
- âœ… [performance-comparison.md](./performance-comparison.md) - æ€§èƒ½å¯¹æ¯”æ–¹æ¡ˆ

#### æ–‡æ¡£ç»“æ„
- âœ… æŒ‰é˜¶æ®µåˆ†ç±»æ–‡ä»¶å¤¹
- âœ… æ¯ä¸ªé˜¶æ®µç‹¬ç«‹ README
- âœ… æ¸…æ™°çš„å¯¼èˆªé“¾æ¥
- âœ… STRUCTURE.md è¯´æ˜æ–‡æ¡£

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½èŠ‚æµç­–ç•¥

```typescript
private shouldUpdateImmediately(blockType, isComplete): boolean {
  // å—å®Œæˆæ—¶ç«‹å³æ›´æ–°
  if (isComplete) return true;
  
  // å—ç±»å‹æ”¹å˜æ—¶ç«‹å³æ›´æ–°
  if (this.lastBlockType !== blockType) return true;
  
  return false; // å…¶ä»–æƒ…å†µä½¿ç”¨èŠ‚æµ
}
```

**ä¼˜åŠ¿**:
- å…³é”®æ—¶åˆ»ä¿è¯å®æ—¶æ€§
- æ™®é€šç´¯ç§¯æ—¶èŠ‚æµä¼˜åŒ–
- è‡ªåŠ¨åŒ–åˆ¤æ–­ï¼Œæ— éœ€æ‰‹åŠ¨æ§åˆ¶

### 2. Feature Flag æ§åˆ¶

```typescript
const useV2 = getFeatureFlag('USE_BLOCK_MANAGER_V2');
console.log(`ä½¿ç”¨ ${useV2 ? 'V2 (BlockManager)' : 'V1 (ä¼ ç»Ÿ)'}`);
```

**ä¼˜åŠ¿**:
- å®‰å…¨çš„æ¸è¿›å¼è¿ç§»
- å¿«é€Ÿå›æ»šèƒ½åŠ›
- A/B æµ‹è¯•æ”¯æŒ

### 3. æ€§èƒ½ç›‘æ§é›†æˆ

```typescript
private immediateReduxUpdate(blockId, changes): void {
  store.dispatch(updateOneBlock({ id: blockId, changes }));
  performanceMonitor.recordReduxUpdate(); // è‡ªåŠ¨è®°å½•
}
```

**ä¼˜åŠ¿**:
- æ— ä¾µå…¥å¼ç›‘æ§
- å®æ—¶æ•°æ®æ”¶é›†
- è‡ªåŠ¨åŒ–éªŒè¯

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | æ—§ç‰ˆ V1 | æ–°ç‰ˆ V2 | æ”¹è¿› |
|------|---------|---------|------|
| Redux æ›´æ–° | ~1000 æ¬¡ | < 20 æ¬¡ | **98%â†“** |
| ç»„ä»¶æ¸²æŸ“ | ~1000 æ¬¡ | < 20 æ¬¡ | **98%â†“** |
| æ•°æ®åº“å†™å…¥ | ~100 æ¬¡ | < 10 æ¬¡ | **90%â†“** |
| ä»£ç è¡Œæ•° | 950 è¡Œ | 500 è¡Œ | **47%â†“** |
| ç”¨æˆ·ä½“éªŒ | å¡é¡¿ | æµç•… | **âœ…** |

## ğŸ”„ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨ï¼‰

1. **å®é™…åŠŸèƒ½æµ‹è¯•** ğŸ”´ é«˜ä¼˜å…ˆçº§
   - [ ] å¯ç”¨ V2 ç‰ˆæœ¬
   - [ ] æµ‹è¯•æ‰€æœ‰åŸºç¡€åŠŸèƒ½
   - [ ] éªŒè¯æ— åŠŸèƒ½å›å½’
   - [ ] è®°å½•é—®é¢˜å’Œ bug

2. **æ€§èƒ½åŸºå‡†æµ‹è¯•** ğŸ”´ é«˜ä¼˜å…ˆçº§
   - [ ] è¿è¡Œæ€§èƒ½ç›‘æ§
   - [ ] æ”¶é›†å®é™…æ•°æ®
   - [ ] å¯¹æ¯”æ–°æ—§ç‰ˆæœ¬
   - [ ] ç¡®è®¤è¾¾åˆ°ç›®æ ‡

3. **é—®é¢˜ä¿®å¤** ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
   - [ ] ä¿®å¤æµ‹è¯•ä¸­å‘ç°çš„é—®é¢˜
   - [ ] ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ
   - [ ] å®Œå–„é”™è¯¯å¤„ç†

### åç»­å·¥ä½œï¼ˆä¸‹å‘¨ï¼‰

4. **å•å…ƒæµ‹è¯•** ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
   - [ ] BlockManager å•å…ƒæµ‹è¯•
   - [ ] ResponseChunkProcessorV2 å•å…ƒæµ‹è¯•
   - [ ] æµ‹è¯•è¦†ç›–ç‡ > 90%

5. **æ¸…ç†ä¸ä¼˜åŒ–** ğŸŸ¢ ä½ä¼˜å…ˆçº§
   - [ ] ç§»é™¤æ—§ä»£ç ï¼ˆéªŒè¯é€šè¿‡åï¼‰
   - [ ] ä»£ç å®¡æŸ¥
   - [ ] æ€§èƒ½ä¼˜åŒ–

6. **å‘å¸ƒå‡†å¤‡** ğŸŸ¢ ä½ä¼˜å…ˆçº§
   - [ ] æœ€ç»ˆéªŒè¯
   - [ ] æ›´æ–°æ–‡æ¡£
   - [ ] å‡†å¤‡å‘å¸ƒè¯´æ˜

## âš ï¸ é£é™©ä¸ç¼“è§£

### é£é™© 1ï¼šåŠŸèƒ½å›å½’

**ç¼“è§£æªæ–½**:
- âœ… Feature Flag æ”¯æŒå¿«é€Ÿå›æ»š
- âœ… ä¿ç•™æ—§ç‰ˆä»£ç 
- âœ… è¯¦ç»†çš„æµ‹è¯•æ¸…å•

### é£é™© 2ï¼šæ€§èƒ½æœªè¾¾æ ‡

**ç¼“è§£æªæ–½**:
- âœ… æ€§èƒ½ç›‘æ§å·¥å…·
- âœ… å¯è°ƒèŠ‚çš„èŠ‚æµé—´éš”
- âœ… è¯¦ç»†çš„æ€§èƒ½åˆ†ææ–‡æ¡£

### é£é™© 3ï¼šå…¼å®¹æ€§é—®é¢˜

**ç¼“è§£æªæ–½**:
- âœ… API ä¿æŒå…¼å®¹
- âœ… æ¸è¿›å¼è¿ç§»
- âœ… å……åˆ†çš„æµ‹è¯•è¦†ç›–

## ğŸ“ éªŒæ”¶æ ‡å‡†

### å¿…é¡»è¾¾æ ‡ âœ…

- [ ] Redux æ›´æ–° < 20 æ¬¡/å“åº”
- [ ] ç»„ä»¶æ¸²æŸ“ < 50 æ¬¡/å“åº”
- [ ] æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸
- [ ] æ— æ˜æ˜¾æ€§èƒ½ä¸‹é™

### æœŸæœ›è¾¾æ ‡ ğŸ¯

- [ ] æ•°æ®åº“å†™å…¥ < 10 æ¬¡/å“åº”
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 90%
- [ ] ç”¨æˆ·ä½“éªŒæ˜æ˜¾æ”¹å–„
- [ ] ä»£ç è´¨é‡æå‡

## ğŸ‰ æˆæœæ€»ç»“

### ä»£ç å±‚é¢
- âœ… åˆ›å»ºäº† BlockManager æ ¸å¿ƒç±»
- âœ… å®ç°äº† ResponseChunkProcessorV2
- âœ… é›†æˆåˆ° ResponseHandler
- âœ… æ·»åŠ äº† Feature Flag æ”¯æŒ
- âœ… å®ç°äº†æ€§èƒ½ç›‘æ§å·¥å…·

### æ–‡æ¡£å±‚é¢
- âœ… å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£
- âœ… è¯¦ç»†çš„æµ‹è¯•æŒ‡å—
- âœ… å¿«é€Ÿå¼€å§‹æŒ‡å—
- âœ… æ€§èƒ½å¯¹æ¯”æ–¹æ¡ˆ
- âœ… æ¸…æ™°çš„æ–‡æ¡£ç»“æ„

### æ¶æ„å±‚é¢
- âœ… å—ç®¡ç†é€»è¾‘é›†ä¸­åŒ–
- âœ… æ™ºèƒ½èŠ‚æµç­–ç•¥
- âœ… å‘åå…¼å®¹è®¾è®¡
- âœ… å¯ç›‘æ§å¯æµ‹è¯•

## ğŸ”— ç›¸å…³é“¾æ¥

- [å¿«é€Ÿå¼€å§‹](./QUICKSTART.md)
- [æµ‹è¯•æŒ‡å—](./testing-guide.md)
- [ä½¿ç”¨ç¤ºä¾‹](./BlockManager-usage-example.md)
- [æ€§èƒ½å¯¹æ¯”](./performance-comparison.md)
- [ä¸»æ–‡æ¡£](../README.md)

---

**åˆ¶ä½œæ—¥æœŸ**: 2025-11-22  
**å½“å‰çŠ¶æ€**: é›†æˆå®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯  
**å®Œæˆåº¦**: 85%
