name: Tauri iOS Build (No Signing)

# æ³¨æ„ï¼š
# - Tauri CLI 2.9+ çš„ --no-sign æ ‡å¿—ä»…é€‚ç”¨äºŽæ¡Œé¢å¹³å°ï¼ˆWindows/macOS/Linuxï¼‰
# - iOS æž„å»ºé€šè¿‡ xcodebuild å‚æ•°ç¦ç”¨ä»£ç ç­¾åï¼ˆä¸ç›´æŽ¥ä¿®æ”¹ pbxprojï¼‰
# - æž„å»ºè¾“å‡ºæ ‡å‡†æ— ç­¾å IPAï¼Œå¯é€šè¿‡ AltStore/çˆ±æ€åŠ©æ‰‹å®‰è£…

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-14
    
    env:
      TAURI_PROJECT_NAME: "aetherlink"
      IPA_OUTPUT_NAME: "AetherLink-iOS-unsigned.ipa"
      IPA_SIZE: "æœªçŸ¥"
      APP_SIZE: "æœªçŸ¥"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim
      
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          # åŸºäºŽ Cargo.lock ç”Ÿæˆç¼“å­˜ key
          shared-key: "ios-rust-${{ hashFiles('**/Cargo.lock') }}"
          cache-on-failure: true
      
      # Xcode DerivedData ç¼“å­˜ - å¤§å¹…åŠ é€Ÿå¢žé‡æž„å»º
      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            src-tauri/gen/apple/build
          key: xcode-deriveddata-${{ runner.os }}-${{ hashFiles('src-tauri/gen/apple/**/*.swift', 'src-tauri/gen/apple/project.yml', 'src-tauri/Cargo.lock') }}
          restore-keys: |
            xcode-deriveddata-${{ runner.os }}-
      
      # CocoaPods ç¼“å­˜ï¼ˆå¦‚æžœå­˜åœ¨ Podfileï¼‰
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            src-tauri/gen/apple/Pods
            ~/Library/Caches/CocoaPods
          key: pods-${{ runner.os }}-${{ hashFiles('src-tauri/gen/apple/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-
      
      # Vite æž„å»ºç¼“å­˜
      - name: Cache Vite build
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            node_modules/.cache
          key: vite-${{ runner.os }}-${{ hashFiles('package-lock.json', 'vite.config.*') }}
          restore-keys: |
            vite-${{ runner.os }}-
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'  # é¡¹ç›®æ ¼å¼ 77 éœ€è¦ Xcode 16+ï¼Œä½¿ç”¨å¯ç”¨çš„ 16.1  

      - name: Install dependencies
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm ci || npm install --legacy-peer-deps
      
      - name: Build frontend
        run: npm run build
      
      - name: Verify iOS project exists
        run: |
          # æ£€æŸ¥ iOS é¡¹ç›®æ˜¯å¦å­˜åœ¨ï¼ˆåº”è¯¥å·²ç»åœ¨ä»£ç åº“ä¸­ï¼‰
          if [ -d "src-tauri/gen/apple" ]; then
            echo "âœ… iOS é¡¹ç›®å·²å­˜åœ¨ï¼Œä½¿ç”¨çŽ°æœ‰æºç "
            echo "=== Xcode é¡¹ç›®ä¿¡æ¯ ==="
            ls -la src-tauri/gen/apple/
            find src-tauri/gen/apple -name "*.xcodeproj" -maxdepth 1
          else
            echo "âŒ é”™è¯¯ï¼šiOS é¡¹ç›®ä¸å­˜åœ¨ï¼"
            echo "è¯·å…ˆè¿è¡Œ 'Initialize Tauri iOS Project' workflow åˆå§‹åŒ–é¡¹ç›®"
            echo "æˆ–è€…æ‰‹åŠ¨è¿è¡Œ: npx @tauri-apps/cli ios init"
            exit 1
          fi
      
      - name: Disable code signing in Xcode project
        run: |
          cd src-tauri/gen/apple
          
          echo "=== ä¿®æ”¹ Xcode é¡¹ç›®ç¦ç”¨ç­¾å ==="
          
          # ç›´æŽ¥ä¿®æ”¹ pbxproj æ–‡ä»¶ç¦ç”¨ç­¾å
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' aetherlink.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Development";/CODE_SIGN_IDENTITY = "";/g' aetherlink.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer";/CODE_SIGN_IDENTITY = "";/g' aetherlink.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = .*;/DEVELOPMENT_TEAM = "";/g' aetherlink.xcodeproj/project.pbxproj
          
          # æ·»åŠ  CODE_SIGNING_ALLOWED = NO
          if ! grep -q "CODE_SIGNING_ALLOWED" aetherlink.xcodeproj/project.pbxproj; then
            sed -i '' 's/buildSettings = {/buildSettings = {\n\t\t\t\tCODE_SIGNING_ALLOWED = NO;/g' aetherlink.xcodeproj/project.pbxproj
          fi
          
          echo "âœ… ä»£ç ç­¾åå·²ç¦ç”¨"
      
      - name: Build iOS App with Tauri CLI
        run: |
          echo "=== ä½¿ç”¨ Tauri CLI æž„å»º iOS ==="
          
          # ä½¿ç”¨ Tauri CLI æž„å»ºï¼Œä¸ä½¿ç”¨ --openï¼ˆCI çŽ¯å¢ƒä¸æ”¯æŒ GUIï¼‰
          npm run tauri ios build -- --ci 2>&1 | tee build.log || {
            EXIT_CODE=$?
            echo "âš ï¸ Tauri æž„å»ºé€€å‡ºç : $EXIT_CODE"
            
            # æ˜¾ç¤ºæž„å»ºæ—¥å¿—å°¾éƒ¨
            echo "=== æž„å»ºæ—¥å¿—ï¼ˆæœ€åŽ 50 è¡Œï¼‰==="
            tail -50 build.log
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¯¼å‡ºå¤±è´¥ï¼ˆexit code 70ï¼‰ä½† .app å·²åˆ›å»º
            echo ""
            echo "æŸ¥æ‰¾ç”Ÿæˆçš„ .app æ–‡ä»¶..."
            APP_FOUND=$(find src-tauri/gen/apple -path "*/Products/Applications/*.app" -type d | head -n 1)
            
            if [ -n "$APP_FOUND" ]; then
              echo "âœ… .app æ–‡ä»¶å·²åˆ›å»º: $APP_FOUND"
              echo "å¯¼å‡º IPA å¤±è´¥æ˜¯é¢„æœŸçš„ï¼ˆæ— ç­¾åé…ç½®ï¼‰"
              exit 0
            fi
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ DerivedData ä¸­çš„ .app
            APP_FOUND=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "AetherLink.app" -type d 2>/dev/null | grep -v Intermediates | head -n 1)
            if [ -n "$APP_FOUND" ]; then
              echo "âœ… åœ¨ DerivedData ä¸­æ‰¾åˆ° .app: $APP_FOUND"
              # å¤åˆ¶åˆ°æ ‡å‡†ä½ç½®
              mkdir -p src-tauri/gen/apple/build/aetherlink_iOS.xcarchive/Products/Applications/
              cp -R "$APP_FOUND" src-tauri/gen/apple/build/aetherlink_iOS.xcarchive/Products/Applications/
              exit 0
            fi
            
            echo "âŒ çœŸæ­£çš„æž„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ° .app æ–‡ä»¶"
            exit 1
          }
          
          # æŸ¥æ‰¾å¹¶è®°å½• .app å¤§å°
          APP_PATH=$(find src-tauri/gen/apple -path "*/Products/Applications/*.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            # ä»Ž DerivedData æŸ¥æ‰¾
            APP_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -name "AetherLink.app" -type d 2>/dev/null | grep -v Intermediates | head -n 1)
            if [ -n "$APP_PATH" ]; then
              # å¤åˆ¶åˆ°æ ‡å‡†ä½ç½®
              mkdir -p src-tauri/gen/apple/build/aetherlink_iOS.xcarchive/Products/Applications/
              cp -R "$APP_PATH" src-tauri/gen/apple/build/aetherlink_iOS.xcarchive/Products/Applications/
              APP_PATH="src-tauri/gen/apple/build/aetherlink_iOS.xcarchive/Products/Applications/AetherLink.app"
            fi
          fi
          
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            APP_SIZE=$(du -sh "$APP_PATH" | awk '{print $1}')
            echo "APP_SIZE=$APP_SIZE" >> $GITHUB_ENV
            echo "âœ… .app å¤§å°: $APP_SIZE"
            echo "âœ… .app ä½ç½®: $APP_PATH"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Package Unsigned IPA (æ ‡å‡†æµç¨‹)
        run: |
          echo "=== ä»Ž xcarchive æ‰“åŒ…æ— ç­¾å IPA ==="
          
          APP_PATH="src-tauri/gen/apple/build/aetherlink_iOS.xcarchive/Products/Applications/AetherLink.app"
          OUTPUT_DIR="ios-artifacts"
          mkdir -p "$OUTPUT_DIR"
          
          # éªŒè¯ .app å­˜åœ¨
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ .app æ–‡ä»¶ä¸å­˜åœ¨: $APP_PATH"
            echo "æŸ¥æ‰¾å¯èƒ½çš„ .app ä½ç½®ï¼š"
            find src-tauri/gen/apple -name "*.app" -type d || true
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° .app: $APP_PATH"
          
          # åˆ›å»ºæ ‡å‡† IPA ç»“æž„ï¼šPayload ç›®å½•
          PAYLOAD_DIR="${OUTPUT_DIR}/Payload"
          mkdir -p "$PAYLOAD_DIR"
          
          # å¤åˆ¶ .app åˆ° Payloadï¼ˆä¿æŒå®Œæ•´ç›®å½•ç»“æž„ï¼‰
          echo "å¤åˆ¶ .app åˆ° Payload..."
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"
          
          # ä¿®å¤ .app æƒé™ï¼ˆé¿å…å®‰è£…å¤±è´¥ï¼‰
          echo "ä¿®å¤æ–‡ä»¶æƒé™..."
          chmod -R 755 "$PAYLOAD_DIR/AetherLink.app"
          find "$PAYLOAD_DIR/AetherLink.app" -type f -exec chmod 644 {} \;
          find "$PAYLOAD_DIR/AetherLink.app" -type d -exec chmod 755 {} \;
          
          # æ‰“åŒ…ä¸º IPAï¼ˆä½¿ç”¨ zipï¼Œ-r é€’å½’ï¼Œ-q å®‰é™æ¨¡å¼ï¼‰
          echo "æ‰“åŒ… IPA..."
          cd "$OUTPUT_DIR"
          zip -r -q "${IPA_OUTPUT_NAME}" Payload/
          
          # æ¸…ç†ä¸´æ—¶ Payload ç›®å½•
          rm -rf Payload/
          
          # éªŒè¯ IPA
          if [ -f "${IPA_OUTPUT_NAME}" ]; then
            IPA_SIZE=$(du -sh "${IPA_OUTPUT_NAME}" | awk '{print $1}')
            echo "IPA_SIZE=$IPA_SIZE" >> $GITHUB_ENV
            echo "âœ… æ— ç­¾å IPA åˆ›å»ºæˆåŠŸ"
            echo "æ–‡ä»¶å: ${IPA_OUTPUT_NAME}"
            echo "å¤§å°: $IPA_SIZE"
            
            # æ˜¾ç¤º IPA ç»“æž„
            echo ""
            echo "=== IPA å†…å®¹é¢„è§ˆ ==="
            unzip -l "${IPA_OUTPUT_NAME}" | head -30
          else
            echo "âŒ IPA æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
      
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ios-unsigned-ipa
          path: ios-artifacts/${{ env.IPA_OUTPUT_NAME }}
          if-no-files-found: error
          retention-days: 30
      
      - name: Generate Build Summary
        if: always()
        run: |
          echo "## ðŸŽ Tauri iOS æ— ç­¾åæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ äº§ç‰©åç§° | ${{ env.IPA_OUTPUT_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š IPA å¤§å° | ${{ env.IPA_SIZE || 'æœªçŸ¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± .app å¤§å° | ${{ env.APP_SIZE || 'æœªçŸ¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”– ç‰ˆæœ¬ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ è¯¥ IPA ä¸º**æ— ç­¾åç‰ˆæœ¬**ï¼Œä»…ç”¨äºŽæµ‹è¯•/å†…éƒ¨åˆ†å‘" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ å®‰è£…æ–¹å¼ï¼šAltStoreã€SideStoreã€çˆ±æ€åŠ©æ‰‹ã€PPåŠ©æ‰‹ç­‰" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš« **æ— æ³•**é€šè¿‡ App Store æˆ– TestFlight å®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“² æ”¯æŒè®¾å¤‡ï¼šiOS 14.0+" >> $GITHUB_STEP_SUMMARY