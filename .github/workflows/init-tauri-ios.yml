name: Initialize Tauri iOS Project

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  init-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm install

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios, x86_64-apple-ios

      - name: Install iOS targets
        run: |
          rustup target add aarch64-apple-ios
          rustup target add x86_64-apple-ios
          rustup target add aarch64-apple-ios-sim

      - name: Check Tauri CLI version and commands
        run: |
          echo "=== Tauri CLI ç‰ˆæœ¬ ==="
          npx @tauri-apps/cli --version
          echo ""
          echo "=== å¯ç”¨å‘½ä»¤ ==="
          npx @tauri-apps/cli --help
          echo ""
          echo "=== æ£€æŸ¥æ˜¯å¦æœ‰ iOS å‘½ä»¤ ==="
          npx @tauri-apps/cli ios --help || echo "iOS å‘½ä»¤ä¸å¯ç”¨"

      - name: Initialize Tauri iOS project
        run: |
          echo "å°è¯•åˆå§‹åŒ– Tauri iOS é¡¹ç›®..."
          # æ–¹æ³• 1: ä½¿ç”¨ npx
          npx @tauri-apps/cli ios init || {
            echo "æ–¹æ³• 1 å¤±è´¥ï¼Œå°è¯•æ–¹æ³• 2..."
            # æ–¹æ³• 2: ä½¿ç”¨ cargo
            cd src-tauri && cargo tauri ios init || {
              echo "æ–¹æ³• 2 å¤±è´¥ï¼Œå°è¯•æ–¹æ³• 3..."
              cd ..
              # æ–¹æ³• 3: ç›´æŽ¥ä½¿ç”¨ npm script
              npm run tauri ios init || echo "æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥äº†"
            }
          }

      - name: Verify iOS project creation
        run: |
          echo "æ£€æŸ¥ iOS/Apple ç›®å½•..."
          if [ -d "src-tauri/gen/apple" ]; then
            echo "âœ… Apple (iOS) ç›®å½•å·²åˆ›å»º"
            ls -la src-tauri/gen/apple/
            echo ""
            echo "=== Xcode é¡¹ç›®æ–‡ä»¶ ==="
            find src-tauri/gen/apple -name "*.xcodeproj" -o -name "*.xcworkspace"
          elif [ -d "src-tauri/gen/ios" ]; then
            echo "âœ… iOS ç›®å½•å·²åˆ›å»º"
            ls -la src-tauri/gen/ios/
          else
            echo "âŒ iOS/Apple ç›®å½•æœªåˆ›å»º"
            echo "åˆ—å‡º gen ç›®å½•å†…å®¹ï¼š"
            ls -la src-tauri/gen/ || echo "gen ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Package iOS project files
        run: |
          cd src-tauri/gen
          # Tauri v2 å°† iOS é¡¹ç›®æ”¾åœ¨ apple/ ç›®å½•
          if [ -d "apple" ]; then
            echo "âœ… æ‰“åŒ… Apple (iOS) é¡¹ç›®..."
            tar -czf ios-project.tar.gz apple/
            mv ios-project.tar.gz ../../
            echo "âœ… iOS é¡¹ç›®å·²æ‰“åŒ…"
          elif [ -d "ios" ]; then
            echo "âœ… æ‰“åŒ… iOS é¡¹ç›®..."
            tar -czf ios-project.tar.gz ios/
            mv ios-project.tar.gz ../../
            echo "âœ… iOS é¡¹ç›®å·²æ‰“åŒ…"
          else
            echo "âŒ æœªæ‰¾åˆ° iOS/Apple ç›®å½•"
            exit 1
          fi

      - name: Upload iOS project as artifact
        uses: actions/upload-artifact@v4
        with:
          name: tauri-ios-project
          path: ios-project.tar.gz
          retention-days: 7

      - name: Create summary
        run: |
          echo "## âœ… Tauri iOS é¡¹ç›®åˆå§‹åŒ–å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ä¸‹è½½æ­¥éª¤ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. ç‚¹å‡»ä¸Šæ–¹çš„ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. ä¸‹è½½ \`tauri-ios-project\`" >> $GITHUB_STEP_SUMMARY
          echo "3. è§£åŽ‹åˆ°é¡¹ç›®æ ¹ç›®å½•" >> $GITHUB_STEP_SUMMARY
          echo "4. è¿è¡Œ: \`tar -xzf ios-project.tar.gz -C src-tauri/gen/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la src-tauri/gen/ios/ || echo "iOS ç›®å½•æœªç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
