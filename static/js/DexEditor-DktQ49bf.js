import{t as e}from"./InputAdornment-DO0tC8Wv.js";import{n as t,t as n}from"./Tabs-DsnHk16H.js";import{t as r}from"./clock-Dks_woIj.js";import{t as i}from"./search-DqeTnaF8.js";import{$l as a,Bu as o,Eu as s,Iu as c,Ju as ee,Mp as l,Nu as te,Qu as ne,Su as u,Vl as re,Vu as d,Wu as f,Zu as p,_ as ie,_u as ae,ad as oe,cd as m,dd as h,eu as se,fd as g,hp as ce,hu as le,id as _,jd as ue,m as de,n as fe,nd as v,nt as y,od as pe,pp as me,qp as b,qu as he,wd as ge,xd as x,xp as S,zp as _e,zu as C}from"./index-hvLbsAjx.js";var ve=u(`funnel`,[[`path`,{d:`M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z`,key:`sc7q7i`}]]),ye=u(`hammer`,[[`path`,{d:`m15 12-9.373 9.373a1 1 0 0 1-3.001-3L12 9`,key:`1hayfq`}],[`path`,{d:`m18 15 4-4`,key:`16gjal`}],[`path`,{d:`m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172v-.344a2 2 0 0 0-.586-1.414l-1.657-1.657A6 6 0 0 0 12.516 3H9l1.243 1.243A6 6 0 0 1 12 8.485V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5`,key:`15ts47`}]]),w=b(_e(),1),be=({open:e,onClose:t,initialContent:n,onSave:r,title:i=`Smali Editor`,className:a,readOnly:o=!1})=>{let s=(0,w.useRef)(!1),c=(0,w.useRef)({initialContent:n,title:i,className:a,readOnly:o,onSave:r,onClose:t});return c.current={initialContent:n,title:i,className:a,readOnly:o,onSave:r,onClose:t},(0,w.useEffect)(()=>{!e||s.current||(async()=>{if(!l.isNativePlatform()){console.warn(`Native editor only available on Android`),c.current.onClose();return}s.current=!0,console.log(`[NativeSmaliEditor] Opening native editor...`);try{let e=await y.openSmaliEditor({content:c.current.initialContent,title:c.current.title||`Smali Editor`,className:c.current.className||``,readOnly:c.current.readOnly||!1});console.log(`[NativeSmaliEditor] Result:`,e),e.success&&e.modified&&c.current.onSave&&e.content&&await c.current.onSave(e.content)}catch(e){console.error(`[NativeSmaliEditor] Failed to open native editor:`,e)}finally{s.current=!1,c.current.onClose()}})()},[e]),null},T=b(S(),1),E=({children:e,value:t,index:n})=>(0,T.jsx)(g,{role:`tabpanel`,hidden:t!==n,sx:{flex:1,overflow:`auto`,display:t===n?`flex`:`none`,flexDirection:`column`,pb:`var(--content-bottom-padding)`},children:t===n&&e}),D=()=>{let l=me(),[u]=ce(),b=u.get(`apkPath`)||``,S=u.get(`dexPath`)||``,_e=u.get(`name`)||`classes.dex`,[D,O]=(0,w.useState)(!0),[k,xe]=(0,w.useState)(0),[Se,Ce]=(0,w.useState)([]),[we,Te]=(0,w.useState)(new Set),[Ee,A]=(0,w.useState)(!1),[j,De]=(0,w.useState)(``),[Oe,ke]=(0,w.useState)(`/`),[M,Ae]=(0,w.useState)(`code`),[je,Me]=(0,w.useState)(!0),[N,Ne]=(0,w.useState)(!1),[P,Pe]=(0,w.useState)(!1),[F,I]=(0,w.useState)([]),[L,R]=(0,w.useState)(!1),[z,Fe]=(0,w.useState)([]),[B,V]=(0,w.useState)(!1),[H,Ie]=(0,w.useState)(``),[U,Le]=(0,w.useState)([]),[Re,ze]=(0,w.useState)(!1),[Be,W]=(0,w.useState)(``),[G,Ve]=(0,w.useState)(``),[He,Ue]=(0,w.useState)(!1),[K,q]=(0,w.useState)({}),We=Object.keys(K).length>0,[J,Ge]=(0,w.useState)(!0),[Y,X]=(0,w.useState)({open:!1,title:``,message:``,percent:0});(0,w.useEffect)(()=>{b&&S&&Ke()},[b,S]),(0,w.useEffect)(()=>{let e=y.addListener(`compileProgress`,e=>{e.type===`title`?X(t=>({...t,title:e.title||``})):e.type===`message`?X(t=>({...t,message:e.message||``})):e.type===`progress`&&X(t=>({...t,percent:e.percent||0}))});return()=>{e.then(e=>e.remove())}},[]);let Ke=async()=>{O(!0);try{let e=await y.execute({action:`listDexClasses`,params:{apkPath:b,dexPath:S}});e.success&&e.data&&Ce(qe(e.data.classes||[]))}catch(e){console.error(`Failed to load DEX classes:`,e)}finally{O(!1)}},qe=e=>{let t=new Map;e.forEach(e=>{let n=e.split(`.`),r=t,i=``;n.forEach((e,t)=>{i=i?`${i}.${e}`:e;let a=t===n.length-1;r.has(e)||r.set(e,{name:e,fullName:i,isPackage:!a,children:new Map});let o=r.get(e);a||(r=o.children)})});let n=e=>Array.from(e.values()).map(e=>({name:e.name,fullName:e.fullName,isPackage:e.isPackage,children:e.children.size>0?n(e.children):void 0})).sort((e,t)=>e.isPackage&&!t.isPackage?-1:!e.isPackage&&t.isPackage?1:e.name.localeCompare(t.name));return n(t)},Je=e=>{Te(t=>{let n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},Z=async e=>{if(!e.isPackage){Le(t=>{let n=t.filter(t=>t!==e.fullName);return[e.fullName,...n].slice(0,20)}),Ve(e.fullName),Ue(!0),ze(!0);try{let t=await y.execute({action:`getClassSmali`,params:{apkPath:b,dexPath:S,className:e.fullName}});t.success&&t.data?W(t.data.smali||``):W(`# 无法加载类 ${e.fullName} 的 Smali 代码\n# 错误: ${t.error||`未知错误`}`)}catch(e){console.error(`Failed to load smali:`,e),W(`# 加载失败\n# ${e}`)}finally{Ue(!1)}}},Ye=async()=>{if(!We){alert(`没有修改需要编译`);return}let e=Object.keys(K).length,t=J?`（将自动签名）`:`（不签名）`;if(confirm(`确定要编译 ${e} 个已修改的类吗？${t}`)){X({open:!0,title:`准备编译...`,message:``,percent:0});try{for(let[e,t]of Object.entries(K)){console.log(`[DexEditor] Compiling:`,e);let n=await y.execute({action:`saveClassSmali`,params:{apkPath:b,dexPath:S,className:e,smaliContent:t}});if(!n.success){X(e=>({...e,open:!1})),alert(`编译 ${e} 失败: ${n.error||`未知错误`}`);return}}if(q({}),J){X(e=>({...e,title:`签名 APK`,message:`正在签名...`,percent:0}));try{let e=b.replace(`.apk`,`_signed.apk`),t=await y.execute({action:`signApkWithTestKey`,params:{apkPath:b,outputPath:e}});X(e=>({...e,open:!1})),t.success?alert(`编译成功！\n\nAPK 已签名并保存到:\n${e}`):alert(`编译成功！APK 已更新\n\n签名失败: ${t.error||`未知错误`}\n请手动签名后安装`)}catch(e){X(e=>({...e,open:!1})),console.error(`[DexEditor] Sign error:`,e),alert(`编译成功！APK 已更新

自动签名出错，请手动签名`)}}else X(e=>({...e,open:!1})),alert(`编译成功！APK 内的 DEX 已更新

注意：修改后的 APK 需要重新签名才能安装`)}catch(e){X(e=>({...e,open:!1})),console.error(`[DexEditor] Compile error:`,e),alert(`编译出错: `+e)}}},Xe=async()=>{if(j.trim()){R(!0);try{console.log(`[DexEditor] Search params:`,{apkPath:b,dexPath:S,query:j,searchType:M});let e=await y.execute({action:`searchInDex`,params:{apkPath:b,dexPath:S,query:j,searchType:M,caseSensitive:N,useRegex:P}});console.log(`[DexEditor] Search result:`,e),e.success&&e.data?I(e.data.results||[]):console.error(`[DexEditor] Search failed:`,e.error)}catch(e){console.error(`[DexEditor] Search exception:`,e)}finally{R(!1)}}},Ze=async()=>{V(!0);try{let e=await y.execute({action:`getDexStrings`,params:{apkPath:b,dexPath:S}});e.success&&e.data&&Fe(e.data.strings||[])}catch(e){console.error(`Failed to load strings:`,e)}finally{V(!1)}};(0,w.useEffect)(()=>{k===3&&z.length===0&&!B&&Ze()},[k]);let Q=(0,w.useCallback)(()=>(l(-1),!0),[l]);fe(Q,[Q]);let Qe=H?z.filter(e=>e.value.toLowerCase().includes(H.toLowerCase())):z,$=(e,t=0)=>{let n=we.has(e.fullName),r=e.children&&e.children.length>0;return(0,T.jsxs)(w.Fragment,{children:[(0,T.jsxs)(d,{onClick:()=>e.isPackage?Je(e.fullName):Z(e),sx:{pl:2+t*2,py:.75,cursor:`pointer`,"&:hover":{bgcolor:`action.hover`}},children:[(0,T.jsx)(o,{sx:{minWidth:32},children:e.isPackage?r?n?(0,T.jsx)(ae,{size:18}):(0,T.jsx)(le,{size:18}):(0,T.jsx)(a,{size:18,color:`#FFA726`}):(0,T.jsx)(g,{sx:{width:20,height:20,bgcolor:`#4CAF50`,borderRadius:.5,display:`flex`,alignItems:`center`,justifyContent:`center`},children:(0,T.jsx)(x,{variant:`caption`,sx:{color:`white`,fontWeight:`bold`,fontSize:10},children:`C`})})}),e.isPackage&&r&&(0,T.jsx)(o,{sx:{minWidth:24},children:n?(0,T.jsx)(se,{size:18,color:`#FFA726`}):(0,T.jsx)(a,{size:18,color:`#FFA726`})}),(0,T.jsx)(C,{primary:e.name,primaryTypographyProps:{variant:`body2`,noWrap:!0,sx:{fontFamily:e.isPackage?`inherit`:`monospace`}}})]}),e.isPackage&&r&&(0,T.jsx)(ue,{in:n,timeout:`auto`,unmountOnExit:!0,children:e.children.map(e=>$(e,t+1))})]},e.fullName)};return(0,T.jsxs)(ie,{children:[(0,T.jsx)(de,{title:`Dex 编辑器`,onBackPress:Q,rightButton:(0,T.jsxs)(g,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[We&&(0,T.jsxs)(T.Fragment,{children:[(0,T.jsx)(p,{control:(0,T.jsx)(m,{size:`small`,checked:J,onChange:e=>Ge(e.target.checked),sx:{p:.5}}),label:(0,T.jsx)(x,{variant:`caption`,children:`签名`}),sx:{m:0,mr:.5}}),(0,T.jsxs)(h,{size:`small`,variant:`contained`,color:`warning`,startIcon:(0,T.jsx)(ye,{size:16}),onClick:Ye,sx:{minWidth:`auto`,px:1.5},children:[`编译(`,Object.keys(K).length,`)`]})]}),(0,T.jsx)(x,{variant:`caption`,sx:{opacity:.7},children:_e})]})}),(0,T.jsxs)(n,{value:k,onChange:(e,t)=>xe(t),variant:`fullWidth`,sx:{borderBottom:1,borderColor:`divider`,minHeight:44,"& .MuiTab-root":{minHeight:44,py:1}},children:[(0,T.jsx)(t,{label:`浏览`}),(0,T.jsx)(t,{label:`最近`}),(0,T.jsx)(t,{label:`搜索`}),(0,T.jsx)(t,{label:`常量`})]}),(0,T.jsx)(E,{value:k,index:0,children:D?(0,T.jsx)(g,{sx:{display:`flex`,justifyContent:`center`,alignItems:`center`,flex:1},children:(0,T.jsx)(ge,{size:32})}):(0,T.jsx)(f,{disablePadding:!0,sx:{overflow:`auto`},children:Se.map(e=>$(e))})}),(0,T.jsx)(E,{value:k,index:1,children:U.length===0?(0,T.jsxs)(g,{sx:{display:`flex`,flexDirection:`column`,alignItems:`center`,justifyContent:`center`,flex:1,color:`text.secondary`},children:[(0,T.jsx)(r,{size:48,style:{opacity:.3,marginBottom:16}}),(0,T.jsx)(x,{children:`暂无最近访问记录`})]}):(0,T.jsx)(f,{disablePadding:!0,children:U.map((e,t)=>(0,T.jsxs)(d,{onClick:()=>Z({name:e.split(`.`).pop(),fullName:e,isPackage:!1}),sx:{cursor:`pointer`,"&:hover":{bgcolor:`action.hover`}},children:[(0,T.jsx)(o,{sx:{minWidth:32},children:(0,T.jsx)(g,{sx:{width:20,height:20,bgcolor:`#4CAF50`,borderRadius:.5,display:`flex`,alignItems:`center`,justifyContent:`center`},children:(0,T.jsx)(x,{variant:`caption`,sx:{color:`white`,fontWeight:`bold`,fontSize:10},children:`C`})})}),(0,T.jsx)(C,{primary:e.split(`.`).pop(),secondary:e,primaryTypographyProps:{variant:`body2`,fontFamily:`monospace`},secondaryTypographyProps:{variant:`caption`,noWrap:!0}})]},t))})}),(0,T.jsxs)(E,{value:k,index:2,children:[(0,T.jsxs)(g,{sx:{bgcolor:`action.hover`,borderBottom:1,borderColor:`divider`},children:[(0,T.jsx)(x,{variant:`caption`,sx:{px:2,py:.5,display:`block`,color:`text.secondary`},children:`功能`}),(0,T.jsx)(f,{disablePadding:!0,dense:!0,children:(0,T.jsxs)(d,{onClick:()=>A(!0),sx:{py:.75,cursor:`pointer`,"&:hover":{bgcolor:`action.selected`}},children:[(0,T.jsx)(o,{sx:{minWidth:32},children:(0,T.jsx)(i,{size:18})}),(0,T.jsx)(C,{primary:`发起新搜索`,primaryTypographyProps:{variant:`body2`}})]})})]}),F.length>0?(0,T.jsxs)(T.Fragment,{children:[(0,T.jsxs)(g,{sx:{display:`flex`,justifyContent:`space-between`,alignItems:`center`,px:2,py:1,borderBottom:1,borderColor:`divider`},children:[(0,T.jsxs)(x,{variant:`caption`,color:`text.secondary`,children:[`搜索结果(`,F.length,`) - `,j]}),(0,T.jsx)(x,{variant:`caption`,sx:{cursor:`pointer`,color:`primary.main`},onClick:()=>I([]),children:`清除`})]}),(0,T.jsx)(f,{disablePadding:!0,sx:{overflow:`auto`,flex:1},children:(()=>{let e={};F.forEach(t=>{let n=t.className.split(`.`).slice(0,-1).join(`.`)||`(default)`;e[n]||(e[n]=[]),e[n].push(t)});let t=(e,t)=>{if(!t)return e;let n=RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,`\\$&`)})`,`gi`);return e.split(n).map((e,t)=>n.test(e)?(0,T.jsx)(`span`,{style:{backgroundColor:`#2196F3`,color:`white`,padding:`0 2px`,borderRadius:2},children:e},t):e)};return Object.entries(e).map(([e,n])=>(0,T.jsxs)(w.Fragment,{children:[(0,T.jsxs)(d,{sx:{py:.5,bgcolor:`action.hover`},children:[(0,T.jsx)(o,{sx:{minWidth:28},children:(0,T.jsx)(a,{size:16})}),(0,T.jsx)(C,{primary:e,primaryTypographyProps:{variant:`body2`,fontWeight:`medium`}})]}),n.map((e,n)=>{let r=e.className.split(`.`).pop()||e.className;return(0,T.jsxs)(d,{onClick:()=>Z({name:r,fullName:e.className,isPackage:!1}),sx:{flexDirection:`column`,alignItems:`flex-start`,borderBottom:1,borderColor:`divider`,pl:4,cursor:`pointer`,"&:hover":{bgcolor:`action.selected`}},children:[(0,T.jsxs)(g,{sx:{display:`flex`,alignItems:`center`,gap:1,width:`100%`},children:[(0,T.jsx)(g,{sx:{width:20,height:20,bgcolor:`#4CAF50`,borderRadius:.5,display:`flex`,alignItems:`center`,justifyContent:`center`,flexShrink:0},children:(0,T.jsx)(x,{variant:`caption`,sx:{color:`white`,fontWeight:`bold`,fontSize:10},children:`C`})}),(0,T.jsx)(x,{variant:`body2`,sx:{fontFamily:`monospace`},children:t(r,j)})]}),(0,T.jsx)(x,{variant:`caption`,color:`text.secondary`,sx:{pl:3.5,fontFamily:`monospace`,wordBreak:`break-all`},children:t(e.content,j)})]},n)})]},e))})()})]}):(0,T.jsxs)(g,{sx:{display:`flex`,flexDirection:`column`,alignItems:`center`,justifyContent:`center`,flex:1,color:`text.secondary`},children:[(0,T.jsx)(i,{size:48,style:{opacity:.3,marginBottom:16}}),(0,T.jsx)(x,{children:`点击"发起新搜索"开始搜索`})]}),(0,T.jsxs)(pe,{open:Ee,onClose:()=>A(!1),maxWidth:`sm`,fullWidth:!0,children:[(0,T.jsx)(v,{children:`搜索`}),(0,T.jsx)(_,{children:(0,T.jsxs)(g,{sx:{display:`flex`,flexDirection:`column`,gap:2,pt:1},children:[(0,T.jsx)(s,{label:`查找内容`,fullWidth:!0,size:`small`,value:j,onChange:e=>De(e.target.value),autoFocus:!0}),(0,T.jsx)(s,{label:`路径`,fullWidth:!0,size:`small`,value:Oe,onChange:e=>ke(e.target.value)}),(0,T.jsxs)(ne,{fullWidth:!0,size:`small`,children:[(0,T.jsx)(ee,{children:`搜索类型`}),(0,T.jsxs)(te,{value:M,label:`搜索类型`,onChange:e=>Ae(e.target.value),children:[(0,T.jsx)(c,{value:`code`,children:`代码`}),(0,T.jsx)(c,{value:`class`,children:`类名`}),(0,T.jsx)(c,{value:`field`,children:`字段名`}),(0,T.jsx)(c,{value:`method`,children:`方法名`}),(0,T.jsx)(c,{value:`string`,children:`字符串`}),(0,T.jsx)(c,{value:`integer`,children:`整数`})]})]}),(0,T.jsx)(p,{control:(0,T.jsx)(m,{checked:je,onChange:e=>Me(e.target.checked)}),label:`搜索子目录`}),(0,T.jsx)(p,{control:(0,T.jsx)(m,{checked:N,onChange:e=>Ne(e.target.checked)}),label:`区分大小写`}),(0,T.jsx)(p,{control:(0,T.jsx)(m,{checked:P,onChange:e=>Pe(e.target.checked)}),label:`正则表达式`})]})}),(0,T.jsxs)(oe,{children:[(0,T.jsx)(h,{onClick:()=>A(!1),children:`取消`}),(0,T.jsx)(h,{onClick:()=>{A(!1),Xe()},variant:`contained`,disabled:!j.trim()||L,children:L?`搜索中...`:`确定`})]})]})]}),(0,T.jsxs)(E,{value:k,index:3,children:[(0,T.jsx)(g,{sx:{display:`flex`,alignItems:`center`,gap:1,px:2,py:1,borderBottom:1,borderColor:`divider`,bgcolor:`action.hover`},children:(0,T.jsxs)(g,{onClick:Ze,sx:{display:`flex`,alignItems:`center`,gap:.5,cursor:`pointer`,color:`primary.main`,"&:hover":{opacity:.8}},children:[(0,T.jsx)(re,{size:16}),(0,T.jsx)(x,{variant:`caption`,children:`刷新`})]})}),(0,T.jsx)(g,{sx:{p:2,borderBottom:1,borderColor:`divider`},children:(0,T.jsx)(s,{fullWidth:!0,size:`small`,placeholder:`过滤字符串...`,value:H,onChange:e=>Ie(e.target.value),InputProps:{startAdornment:(0,T.jsx)(e,{position:`start`,children:(0,T.jsx)(ve,{size:18})})}})}),(0,T.jsxs)(x,{variant:`caption`,sx:{px:2,py:1,display:`block`,bgcolor:`action.hover`,color:`text.secondary`},children:[`字符常量池 (`,Qe.length,`)`]}),B?(0,T.jsx)(g,{sx:{display:`flex`,justifyContent:`center`,alignItems:`center`,flex:1},children:(0,T.jsx)(ge,{size:32})}):(0,T.jsx)(f,{disablePadding:!0,sx:{overflow:`auto`,flex:1},children:Qe.map((e,t)=>(0,T.jsx)(d,{sx:{borderBottom:1,borderColor:`divider`,py:1.5},children:(0,T.jsx)(C,{primary:e.value||`(empty)`,primaryTypographyProps:{variant:`body2`,sx:{fontFamily:`monospace`,wordBreak:`break-all`,color:e.value?`text.primary`:`text.secondary`}}})},t))})]}),(0,T.jsx)(be,{open:Re&&!He,onClose:()=>ze(!1),initialContent:Be,title:G.split(`.`).pop()||`Smali`,className:G,readOnly:!1,onSave:e=>{W(e),q(t=>({...t,[G]:e})),console.log(`[DexEditor] Smali saved to memory:`,G)}}),(0,T.jsxs)(pe,{open:Y.open,maxWidth:`xs`,fullWidth:!0,children:[(0,T.jsx)(v,{children:Y.title||`编译中...`}),(0,T.jsxs)(_,{children:[(0,T.jsx)(g,{sx:{width:`100%`,mb:2},children:(0,T.jsx)(he,{variant:`determinate`,value:Y.percent})}),(0,T.jsx)(x,{variant:`body2`,color:`text.secondary`,children:Y.message||`请稍候...`}),(0,T.jsxs)(x,{variant:`caption`,color:`text.secondary`,sx:{mt:1,display:`block`},children:[Y.percent,`%`]})]})]})]})};export{D as default};