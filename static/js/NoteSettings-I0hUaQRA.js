import{t as e}from"./Switch-C_ekiChs.js";import{n as t,t as n}from"./pen-BWmXbOiY.js";import{n as ee,r as te,t as ne}from"./folder-plus-DTq_ujqz.js";import{t as re}from"./file-text-BSjgZddV.js";import{t as ie}from"./house-Cnizn3cu.js";import{t as ae}from"./search-DqeTnaF8.js";import{t as oe}from"./star-CH3UH8HS.js";import{$l as se,Ad as r,Al as ce,Bu as le,Cd as i,Du as ue,Eu as a,Gi as o,Hu as de,Iu as fe,Lu as pe,Uu as me,Vu as s,Wu as c,_ as he,ad as l,at as ge,bd as _e,dd as u,eu as ve,fd as d,hu as ye,id as f,jd as be,ku as p,nd as m,o as h,oi as xe,pp as Se,qp as g,td as Ce,uu as we,wd as Te,xd as _,xp as Ee,xu as v,yp as De,zp as y,zu as b}from"./index-hvLbsAjx.js";import{r as x,t as Oe}from"./SimpleNoteService-DYyyUaKJ.js";import{t as ke}from"./useNotesSearch-D4OlEKjP.js";var S=g(y(),1),C=g(Ee(),1),w=()=>{let g=Se(),Ee=De(),[y,w]=(0,S.useState)(``),[Ae,je]=(0,S.useState)(!1),[T,E]=(0,S.useState)(``),[D,O]=(0,S.useState)({}),[k,Me]=(0,S.useState)({}),[A,j]=(0,S.useState)(null),[M,Ne]=(0,S.useState)(`name`),[N,Pe]=(0,S.useState)(!1),{search:Fe,reset:Ie,keyword:P,isSearching:F,results:I,stats:L}=ke({debounceMs:300}),[Le,R]=(0,S.useState)(!1),[z,Re]=(0,S.useState)(`file`),[B,ze]=(0,S.useState)(``),[Be,V]=(0,S.useState)(!1),[Ve,H]=(0,S.useState)(!1),[He,Ue]=(0,S.useState)(null),[U,We]=(0,S.useState)(null),[W,G]=(0,S.useState)(``),K=!!y;(0,S.useEffect)(()=>{Ge()},[]),(0,S.useEffect)(()=>{K?(E(``),O({}),J(``)):(O({}),j(null))},[K]);let Ge=async()=>{let e=await x.getStoragePath(),t=await x.isSidebarEnabled();w(e||``),je(t)},Ke=()=>{g(`/settings`)},qe=async()=>{try{let e=await ge.openSystemFilePicker({type:`directory`,multiple:!1,title:`选择笔记存储目录`});if(!e.cancelled&&e.directories&&e.directories.length>0){let t=e.directories[0],n=t.displayPath||t.path||t.uri;if(!n){h.error(`无法获取有效的目录路径`,`错误`);return}await x.setStoragePath(n),w(n),h.success(`存储路径已更新`,`设置成功`)}}catch(e){console.error(`选择目录失败:`,e),h.error(`选择目录失败`,`错误`)}},Je=async e=>{let t=e.target.checked;await x.setSidebarEnabled(t),Ee(xe({[Oe]:t})),je(t),h.success(`侧边栏入口已${t?`启用`:`禁用`}`,`设置成功`)},q=(0,S.useCallback)((e,t)=>{Me(n=>({...n,[e]:t}))},[]),J=(0,S.useCallback)(async e=>{q(e,!0);try{let t=await x.listNotes(e);O(n=>({...n,[e]:t}))}catch(t){console.error(`加载目录 ${e} 失败:`,t),h.error(`加载目录失败`,`错误`)}finally{q(e,!1)}},[q]),Y=async e=>{await J(e)},X=e=>e?e.split(`/`).slice(0,-1).join(`/`):``,Ye=async e=>{E(e),D[e]||await J(e)},Xe=()=>{E(X(T))},Z=()=>{if(!T)return[{name:`根目录`,path:``}];let e=T.split(`/`),t=[{name:`根目录`,path:``}],n=``;return e.forEach(e=>{n=n?`${n}/${e}`:e,t.push({name:e,path:n})}),t},Ze=e=>{if(!K){h.warning(`请先设置存储目录`,`提示`);return}ze(T),Re(e),G(``),R(!0)},Qe=async()=>{if(W)try{z===`folder`?await x.createFolder(B,W):await x.createNote(B,W),R(!1),G(``),await Y(T),h.success(`创建成功`,`成功`)}catch(e){console.error(`创建失败:`,e),h.error(`创建失败`,`错误`)}},$e=(e,t)=>{e.stopPropagation(),e.preventDefault(),Ue(e.currentTarget),We(t),G(t.name)},Q=()=>{Ue(null)},et=async()=>{if(!U||!W){console.log(`重命名条件不满足:`,{menuTargetItem:U,newItemName:W});return}console.log(`开始重命名:`,{path:U.path,newName:W});try{await x.renameItem(U.path,W),V(!1),G(``),await Y(X(U.path)),h.success(`重命名成功`,`成功`)}catch(e){console.error(`重命名失败:`,e),h.error(`重命名失败: ${e instanceof Error?e.message:String(e)}`,`错误`)}},tt=async()=>{if(U)try{await x.deleteItem(U.path,U.isDirectory),H(!1),await Y(X(U.path)),A?.path===U.path&&j(null),h.success(`删除成功`,`成功`)}catch{h.error(`删除失败`,`错误`)}},nt=(0,S.useCallback)(e=>{j(e),e.isDirectory?Ye(e.path):g(`/settings/notes/edit?path=${encodeURIComponent(e.path)}&name=${encodeURIComponent(e.name)}`)},[Ye,g]),$=(0,S.useMemo)(()=>{if(N&&P)return I;let e=[...D[T]||[]];return e.sort((e,t)=>e.isDirectory===t.isDirectory?M===`date`?new Date(t.lastModified).getTime()-new Date(e.lastModified).getTime():e.name.localeCompare(t.name):e.isDirectory?-1:1),e},[N,P,I,D,T,M]),rt=(0,S.useCallback)(()=>(!N||!P)&&!D[T]?k[T]?(0,C.jsxs)(d,{sx:{display:`flex`,alignItems:`center`,justifyContent:`center`,p:4},children:[(0,C.jsx)(Te,{size:24}),(0,C.jsx)(_,{variant:`body2`,sx:{ml:2},children:`加载中...`})]}):null:N&&F?(0,C.jsxs)(d,{sx:{display:`flex`,alignItems:`center`,justifyContent:`center`,p:4},children:[(0,C.jsx)(Te,{size:24}),(0,C.jsx)(_,{variant:`body2`,sx:{ml:2},children:`搜索中...`})]}):$.length===0&&!P?(0,C.jsx)(s,{children:(0,C.jsx)(b,{primary:(0,C.jsx)(_,{color:`text.secondary`,children:`此文件夹为空`})})}):$.length===0&&P?(0,C.jsx)(s,{children:(0,C.jsx)(b,{primary:(0,C.jsxs)(d,{children:[(0,C.jsx)(_,{color:`text.secondary`,children:`未找到匹配的笔记`}),(0,C.jsx)(_,{variant:`caption`,color:`text.secondary`,children:`尝试使用其他关键词`})]})})}):(0,C.jsxs)(C.Fragment,{children:[N&&P&&L.total>0?(0,C.jsxs)(d,{sx:{px:1.5,py:.5,fontSize:11,color:`text.secondary`},children:[`找到 `,L.total,` 个结果`,L.bothMatches>0&&` (其中 ${L.bothMatches} 个全匹配)`]}):null,$.map(e=>{let t=A?.path===e.path,n=`matchType`in e?e:null;return(0,C.jsx)(s,{disablePadding:!0,sx:{display:`block`},onContextMenu:t=>$e(t,e),children:(0,C.jsx)(me,{selected:t,onClick:()=>nt(e),sx:{pl:1.5,pr:1,minHeight:40,"&.Mui-selected":{bgcolor:`action.selected`},"&:hover":{bgcolor:`action.hover`}},children:(0,C.jsxs)(d,{sx:{display:`flex`,alignItems:`center`,width:`100%`,gap:1},children:[(0,C.jsx)(d,{sx:{color:e.isDirectory?`#FBC02D`:`#42A5F5`,display:`flex`},children:e.isDirectory?(0,C.jsx)(se,{size:18}):(0,C.jsx)(re,{size:18})}),(0,C.jsx)(b,{primaryTypographyProps:{variant:`body2`,noWrap:!0},primary:(0,C.jsxs)(d,{sx:{display:`flex`,alignItems:`center`,gap:.5},children:[(0,C.jsx)(`span`,{children:e.name}),n?.matchType===`both`&&(0,C.jsx)(d,{component:`span`,sx:{fontSize:10,px:.5,py:.25,borderRadius:.5,bgcolor:`primary.main`,color:`primary.contrastText`},children:`全`})]}),secondary:(0,C.jsxs)(C.Fragment,{children:[N&&e.path.includes(`/`)&&(0,C.jsx)(_,{component:`span`,variant:`caption`,sx:{display:`block`,opacity:.7},children:e.path}),n?.matches&&n.matches.length>0&&(0,C.jsx)(_,{component:`span`,variant:`caption`,sx:{display:`block`,"& mark":{bgcolor:`warning.light`,color:`inherit`,px:.25,borderRadius:.25}},dangerouslySetInnerHTML:{__html:(()=>{let e=n.matches[0];return`${e.context.substring(0,e.matchStart)}<mark>${e.context.substring(e.matchStart,e.matchEnd)}</mark>${e.context.substring(e.matchEnd)}`})()}}),!N&&!e.isDirectory&&new Date(e.lastModified).toLocaleString(`zh-CN`)]}),secondaryTypographyProps:{variant:`caption`}}),e.isDirectory&&(0,C.jsx)(ye,{size:16,style:{opacity:.5}}),(0,C.jsx)(i,{size:`small`,onClick:t=>$e(t,e),sx:{ml:`auto`},children:(0,C.jsx)(te,{size:14})})]})})},e.path)})]}),[T,$,nt,A?.path,D,k,P,N,F,L]);return(0,C.jsxs)(he,{children:[(0,C.jsx)(_e,{position:`static`,elevation:0,sx:{bgcolor:`background.paper`,color:`text.primary`,borderBottom:1,borderColor:`divider`,backdropFilter:`blur(8px)`},children:(0,C.jsxs)(ue,{children:[(0,C.jsx)(i,{edge:`start`,onClick:Ke,"aria-label":`back`,sx:{color:`primary.main`},children:(0,C.jsx)(v,{})}),(0,C.jsx)(_,{variant:`h6`,sx:{flexGrow:1,fontWeight:600},children:`笔记设置`})]})}),(0,C.jsxs)(d,{sx:{flexGrow:1,overflow:`auto`,p:{xs:1,sm:2},pb:`var(--content-bottom-padding)`,display:`flex`,flexDirection:`column`,gap:2},children:[(0,C.jsx)(r,{elevation:0,sx:{borderRadius:2,border:`1px solid`,borderColor:`divider`},children:(0,C.jsxs)(c,{children:[(0,C.jsxs)(s,{children:[(0,C.jsx)(b,{primary:`存储位置`,secondary:y||`未设置，请选择存储目录`,secondaryTypographyProps:{sx:{wordBreak:`break-all`,color:y?`text.secondary`:`error.main`}}}),(0,C.jsx)(de,{children:(0,C.jsx)(u,{variant:`outlined`,size:`small`,startIcon:(0,C.jsx)(ve,{size:16}),onClick:qe,children:`选择目录`})})]}),(0,C.jsx)(Ce,{}),(0,C.jsxs)(s,{children:[(0,C.jsx)(b,{primary:`侧边栏入口`,secondary:`在聊天界面侧边栏显示笔记 Tab`}),(0,C.jsx)(de,{children:(0,C.jsx)(e,{edge:`end`,checked:Ae,onChange:Je})})]})]})}),(0,C.jsxs)(r,{elevation:0,sx:{borderRadius:2,border:`1px solid`,borderColor:`divider`,display:`flex`,flexDirection:`column`,minHeight:420},children:[(0,C.jsxs)(d,{sx:{p:1,borderBottom:`1px solid`,borderColor:`divider`,display:`flex`,justifyContent:`space-between`,alignItems:`center`},children:[(0,C.jsx)(_,{variant:`subtitle2`,sx:{fontWeight:600},children:`笔记文件`}),(0,C.jsxs)(d,{sx:{display:`flex`,gap:.5},children:[(0,C.jsx)(p,{title:`新建笔记`,children:(0,C.jsx)(i,{size:`small`,onClick:()=>Ze(`file`),children:(0,C.jsx)(ee,{size:16})})}),(0,C.jsx)(p,{title:`新建文件夹`,children:(0,C.jsx)(i,{size:`small`,onClick:()=>Ze(`folder`),children:(0,C.jsx)(ne,{size:16})})}),(0,C.jsx)(p,{title:`切换排序`,children:(0,C.jsx)(i,{size:`small`,color:M===`date`?`primary`:`default`,onClick:()=>Ne(M===`name`?`date`:`name`),children:(0,C.jsx)(t,{size:16})})}),(0,C.jsx)(p,{title:`收藏（即将推出）`,children:(0,C.jsx)(i,{size:`small`,children:(0,C.jsx)(oe,{size:16})})}),(0,C.jsx)(p,{title:`搜索`,children:(0,C.jsx)(i,{size:`small`,color:N?`primary`:`default`,onClick:()=>Pe(e=>!e),children:(0,C.jsx)(ae,{size:16})})})]})]}),(0,C.jsx)(be,{in:N,unmountOnExit:!0,children:(0,C.jsx)(d,{sx:{p:1,borderBottom:`1px solid`,borderColor:`divider`},children:(0,C.jsx)(a,{size:`small`,fullWidth:!0,placeholder:`搜索笔记名称或内容...`,value:P,onChange:e=>Fe(e.target.value),InputProps:{startAdornment:(0,C.jsx)(ae,{size:14,style:{marginRight:6,opacity:.6}})}})})}),K?(0,C.jsxs)(C.Fragment,{children:[(0,C.jsxs)(d,{sx:{px:1.5,py:1,borderBottom:`1px solid`,borderColor:`divider`,display:`flex`,alignItems:`center`,gap:.5},children:[T&&(0,C.jsx)(p,{title:`返回上级`,children:(0,C.jsx)(i,{size:`small`,onClick:Xe,children:(0,C.jsx)(v,{size:16})})}),(0,C.jsx)(d,{sx:{display:`flex`,alignItems:`center`,gap:.5,flexWrap:`wrap`,flex:1},children:Z().map((e,t)=>(0,C.jsxs)(S.Fragment,{children:[t>0&&(0,C.jsx)(ye,{size:14,style:{opacity:.4}}),(0,C.jsx)(u,{size:`small`,onClick:()=>E(e.path),sx:{minWidth:`auto`,textTransform:`none`,color:t===Z().length-1?`primary.main`:`text.secondary`,fontWeight:t===Z().length-1?600:400,"&:hover":{bgcolor:`action.hover`}},startIcon:t===0?(0,C.jsx)(ie,{size:14}):void 0,children:e.name})]},e.path))})]}),(0,C.jsx)(d,{sx:{flexGrow:1,overflowY:`auto`},children:(0,C.jsx)(c,{dense:!0,disablePadding:!0,children:rt()})}),(0,C.jsxs)(d,{sx:{m:1.5,p:1.5,border:`1px dashed`,borderColor:`divider`,borderRadius:1,display:`flex`,alignItems:`center`,justifyContent:`center`,gap:1,color:`text.secondary`,fontSize:`0.85rem`,bgcolor:`action.hover`,"&:hover":{borderColor:`primary.main`,color:`primary.main`}},children:[(0,C.jsx)(we,{size:16}),`拖拽 .md 文件或目录到此处导入（即将支持）`]})]}):(0,C.jsxs)(d,{sx:{flexGrow:1,display:`flex`,flexDirection:`column`,alignItems:`center`,justifyContent:`center`,gap:1.5,p:3},children:[(0,C.jsx)(_,{color:`text.secondary`,children:`请先选择存储目录以管理笔记`}),(0,C.jsx)(u,{variant:`contained`,onClick:qe,startIcon:(0,C.jsx)(ve,{size:16}),children:`立即设置`})]})]}),(0,C.jsx)(_,{variant:`caption`,color:`text.secondary`,sx:{px:1},children:`注意：笔记功能依赖于本地文件系统访问权限。请确保已授予应用相应的存储权限。`})]}),(0,C.jsxs)(pe,{anchorEl:He,open:!!He,onClose:Q,children:[(0,C.jsxs)(fe,{onClick:()=>{U&&G(U.name),V(!0),Q()},children:[(0,C.jsx)(le,{children:(0,C.jsx)(n,{size:14})}),`重命名`]}),(0,C.jsxs)(fe,{onClick:()=>{H(!0),Q()},sx:{color:`error.main`},children:[(0,C.jsx)(le,{children:(0,C.jsx)(ce,{size:14,color:`var(--mui-palette-error-main)`})}),`删除`]})]}),(0,C.jsxs)(o,{open:Le,onClose:()=>R(!1),maxWidth:`xs`,fullWidth:!0,children:[(0,C.jsxs)(m,{children:[`新建`,z===`folder`?`文件夹`:`笔记`]}),(0,C.jsxs)(f,{children:[(0,C.jsx)(a,{autoFocus:!0,fullWidth:!0,label:`名称`,value:W,onChange:e=>G(e.target.value),onKeyDown:e=>e.key===`Enter`&&Qe()}),B&&(0,C.jsxs)(_,{variant:`caption`,color:`text.secondary`,sx:{mt:1,display:`block`},children:[`位置：`,B||`根目录`]})]}),(0,C.jsxs)(l,{children:[(0,C.jsx)(u,{onClick:()=>R(!1),children:`取消`}),(0,C.jsx)(u,{onClick:Qe,variant:`contained`,children:`创建`})]})]}),(0,C.jsxs)(o,{open:Be,onClose:()=>V(!1),maxWidth:`xs`,fullWidth:!0,children:[(0,C.jsx)(m,{children:`重命名`}),(0,C.jsx)(f,{children:(0,C.jsx)(a,{autoFocus:!0,fullWidth:!0,label:`新名称`,value:W,onChange:e=>G(e.target.value),onKeyDown:e=>e.key===`Enter`&&et()})}),(0,C.jsxs)(l,{children:[(0,C.jsx)(u,{onClick:()=>V(!1),children:`取消`}),(0,C.jsx)(u,{onClick:et,variant:`contained`,children:`确定`})]})]}),(0,C.jsxs)(o,{open:Ve,onClose:()=>H(!1),maxWidth:`xs`,children:[(0,C.jsx)(m,{children:`确认删除`}),(0,C.jsx)(f,{children:(0,C.jsxs)(_,{children:[`确定要删除 "`,U?.name,`" 吗？`,U?.isDirectory&&` 该文件夹内的所有内容也将被删除。`]})}),(0,C.jsxs)(l,{children:[(0,C.jsx)(u,{onClick:()=>H(!1),children:`取消`}),(0,C.jsx)(u,{onClick:tt,color:`error`,variant:`contained`,children:`删除`})]})]})]})};export{w as default};