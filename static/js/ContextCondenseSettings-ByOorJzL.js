import{Ad as e,Cd as t,Du as n,Eu as r,Vu as i,Wu as a,Xl as o,bd as s,bp as c,ci as l,dd as u,ei as d,fd as f,i as p,ju as m,ni as h,pp as g,qd as _,qp as v,qr as y,s as b,td as x,ti as S,xd as C,xp as w,xu as T,yp as E,zp as D,zu as O}from"./index-hvLbsAjx.js";import{t as k}from"./CustomIcon-BKBQb-ts.js";import"./SolidBridge-4JuNrAWl.js";import"./DialogModelSelector.solid-B0UTW3Od.js";import"./DropdownModelSelector-D62zD9hR.js";import{t as A}from"./ModelSelector-DfSiUGl_.js";var j=v(D(),1),M=v(w(),1),N=()=>{let{t:v}=l(),w=g(),D=E(),{containerRef:N,handleScroll:P}=p(`settings-context-condense`,{autoRestore:!0,restoreDelay:0}),F=c(e=>e.settings.contextCondense),I=c(e=>e.settings.defaultModelId),L=c(e=>e.settings.providers),[R,z]=(0,j.useState)(!1),B=(0,j.useMemo)(()=>L.filter(e=>e.isEnabled).flatMap(e=>e.models.filter(e=>e.enabled).map(t=>({...t,providerName:e.name,providerId:e.id}))),[L]),V=(0,j.useMemo)(()=>{let e=h(F?.modelId||I);return e&&B.find(t=>S(t,e,t.providerId))||null},[B,F?.modelId,I]),H=()=>{w(`/settings`)},U=e=>{let t=e.provider||e.providerId;D(y({modelId:d({id:e.id,provider:t})})),z(!1)},W=e=>{D(y({enabled:e.target.checked}))},G=e=>{D(y({useCurrentTopicModel:e.target.checked}))},K=(e,t)=>{D(y({threshold:t}))},q=e=>{D(y({customPrompt:e.target.value||void 0}))},J=()=>{z(!0)},Y=()=>{z(!1)},X=()=>{D(y({customPrompt:void 0}))},Z=()=>{D(y({modelId:void 0}))};return(0,M.jsxs)(f,{sx:{flexGrow:1,display:`flex`,flexDirection:`column`,height:`100vh`,bgcolor:e=>e.palette.mode===`light`?_(e.palette.primary.main,.02):_(e.palette.background.default,.9)},children:[(0,M.jsx)(s,{position:`static`,elevation:0,sx:{bgcolor:`background.paper`,color:`text.primary`,borderBottom:1,borderColor:`divider`,backdropFilter:`blur(8px)`},children:(0,M.jsxs)(n,{children:[(0,M.jsx)(t,{edge:`start`,color:`inherit`,onClick:H,"aria-label":`back`,sx:{color:e=>e.palette.primary.main},children:(0,M.jsx)(T,{size:20})}),(0,M.jsx)(C,{variant:`h6`,component:`div`,sx:{flexGrow:1,fontWeight:600},children:v(`settings:contextCondense.title`,`上下文压缩`)})]})}),(0,M.jsxs)(f,{ref:N,onScroll:P,sx:{flexGrow:1,overflowY:`auto`,p:2,"&::-webkit-scrollbar":{width:`6px`},"&::-webkit-scrollbar-thumb":{backgroundColor:`rgba(0,0,0,0.1)`,borderRadius:`3px`}},children:[(0,M.jsx)(e,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`info.main`,overflow:`hidden`,bgcolor:e=>_(e.palette.info.main,.05)},children:(0,M.jsxs)(f,{sx:{p:2,display:`flex`,gap:1.5,alignItems:`flex-start`},children:[(0,M.jsx)(o,{size:20,style:{marginTop:2,flexShrink:0}}),(0,M.jsxs)(f,{children:[(0,M.jsx)(C,{variant:`subtitle2`,sx:{fontWeight:600,mb:.5},children:v(`settings:contextCondense.whatIsThis`,`什么是上下文压缩？`)}),(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:v(`settings:contextCondense.description`,`当对话历史过长时，会占用大量的 Token，导致成本增加、响应变慢，甚至超出模型的上下文窗口限制。上下文压缩通过 AI 将冗长的对话历史智能地总结成精简摘要，同时保留关键信息。`)})]})]})}),(0,M.jsxs)(e,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`,overflow:`hidden`,bgcolor:`background.paper`,boxShadow:`0 4px 12px rgba(0,0,0,0.05)`},children:[(0,M.jsxs)(f,{sx:{p:2,bgcolor:`rgba(0,0,0,0.01)`},children:[(0,M.jsxs)(C,{variant:`subtitle1`,sx:{fontWeight:600,display:`flex`,alignItems:`center`,gap:1},children:[(0,M.jsx)(k,{name:`foldVertical`,size:18}),v(`settings:contextCondense.autoCondense`,`自动压缩`)]}),(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:v(`settings:contextCondense.autoCondenseDesc`,`当上下文占用达到设定阈值时自动进行压缩`)})]}),(0,M.jsx)(x,{}),(0,M.jsx)(a,{disablePadding:!0,children:(0,M.jsxs)(i,{children:[(0,M.jsx)(O,{primary:v(`settings:contextCondense.enableAutoCondense`,`启用自动压缩`)}),(0,M.jsx)(b,{checked:F?.enabled??!1,onChange:W})]})})]}),(0,M.jsxs)(e,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`,overflow:`hidden`,bgcolor:`background.paper`,boxShadow:`0 4px 12px rgba(0,0,0,0.05)`},children:[(0,M.jsxs)(f,{sx:{p:2,bgcolor:`rgba(0,0,0,0.01)`},children:[(0,M.jsx)(C,{variant:`subtitle1`,sx:{fontWeight:600},children:v(`settings:contextCondense.threshold`,`触发阈值`)}),(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:v(`settings:contextCondense.thresholdDesc`,`当上下文窗口占用达到此百分比时触发自动压缩`)})]}),(0,M.jsx)(x,{}),(0,M.jsxs)(f,{sx:{p:3},children:[(0,M.jsxs)(f,{sx:{display:`flex`,alignItems:`center`,justifyContent:`space-between`,mb:1},children:[(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:v(`settings:contextCondense.currentThreshold`,`当前阈值`)}),(0,M.jsxs)(C,{variant:`body1`,sx:{fontWeight:600},children:[F?.threshold??80,`%`]})]}),(0,M.jsx)(m,{value:F?.threshold??80,onChange:K,min:5,max:100,step:5,marks:[{value:5,label:`5%`},{value:50,label:`50%`},{value:100,label:`100%`}],valueLabelDisplay:`auto`,valueLabelFormat:e=>`${e}%`}),(0,M.jsx)(C,{variant:`caption`,color:`text.secondary`,sx:{mt:1,display:`block`},children:v(`settings:contextCondense.thresholdHint`,`建议设置在 70%-90% 之间，过低会频繁触发压缩，过高可能导致超出限制`)})]})]}),(0,M.jsxs)(e,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`,overflow:`hidden`,bgcolor:`background.paper`,boxShadow:`0 4px 12px rgba(0,0,0,0.05)`},children:[(0,M.jsxs)(f,{sx:{p:2,bgcolor:`rgba(0,0,0,0.01)`},children:[(0,M.jsx)(C,{variant:`subtitle1`,sx:{fontWeight:600},children:v(`settings:contextCondense.condenseModel`,`压缩模型`)}),(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:v(`settings:contextCondense.condenseModelDesc`,`选择用于压缩对话的模型（可使用更便宜的模型来节省成本）`)})]}),(0,M.jsx)(x,{}),(0,M.jsx)(a,{disablePadding:!0,children:(0,M.jsxs)(i,{children:[(0,M.jsx)(O,{primary:v(`settings:contextCondense.useCurrentTopicModel`,`使用当前话题模型`),secondary:v(`settings:contextCondense.useCurrentTopicModelDesc`,`使用当前对话所选择的模型进行压缩`)}),(0,M.jsx)(b,{checked:F?.useCurrentTopicModel??!0,onChange:G})]})}),(0,M.jsx)(x,{}),F?.useCurrentTopicModel===!1&&(0,M.jsxs)(f,{sx:{p:2,display:`flex`,alignItems:`center`,gap:1.5,flexWrap:`wrap`},children:[(0,M.jsx)(u,{variant:`outlined`,onClick:J,size:`small`,children:v(`settings:contextCondense.selectModel`,`选择模型`)}),F?.modelId&&(0,M.jsx)(u,{variant:`text`,onClick:Z,size:`small`,color:`secondary`,children:v(`settings:contextCondense.useDefaultModel`,`使用默认模型`)}),(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:V?`${v(`settings:contextCondense.currentModelPrefix`,`当前`)}: ${V.name}`:v(`settings:contextCondense.usingDefaultModel`,`使用默认模型`)}),(0,M.jsx)(A,{selectedModel:V,availableModels:B,handleModelSelect:U,handleMenuClick:J,handleMenuClose:Y,menuOpen:R})]})]}),(0,M.jsxs)(e,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`,overflow:`hidden`,bgcolor:`background.paper`,boxShadow:`0 4px 12px rgba(0,0,0,0.05)`},children:[(0,M.jsxs)(f,{sx:{p:2,bgcolor:`rgba(0,0,0,0.01)`},children:[(0,M.jsx)(C,{variant:`subtitle1`,sx:{fontWeight:600},children:v(`settings:contextCondense.customPrompt`,`自定义提示词`)}),(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,children:v(`settings:contextCondense.customPromptDesc`,`自定义压缩时使用的系统提示词（留空使用内置提示词）`)})]}),(0,M.jsx)(x,{}),(0,M.jsxs)(f,{sx:{p:2},children:[(0,M.jsx)(r,{fullWidth:!0,multiline:!0,rows:6,value:F?.customPrompt??``,onChange:q,placeholder:v(`settings:contextCondense.customPromptPlaceholder`,`请输入自定义提示词...

内置提示词会生成包含以下内容的摘要：
- 之前的对话概述
- 当前工作详情
- 关键技术概念
- 相关文件和代码
- 问题解决进展
- 待完成任务`),variant:`outlined`,sx:{"& .MuiOutlinedInput-root":{borderRadius:1}}}),F?.customPrompt&&(0,M.jsx)(u,{variant:`outlined`,size:`small`,sx:{mt:1},onClick:X,children:v(`settings:contextCondense.resetToDefault`,`恢复默认`)})]})]}),(0,M.jsxs)(e,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`,overflow:`hidden`,bgcolor:`background.paper`,boxShadow:`0 4px 12px rgba(0,0,0,0.05)`},children:[(0,M.jsx)(f,{sx:{p:2,bgcolor:`rgba(0,0,0,0.01)`},children:(0,M.jsx)(C,{variant:`subtitle1`,sx:{fontWeight:600},children:v(`settings:contextCondense.howItWorks`,`工作原理`)})}),(0,M.jsx)(x,{}),(0,M.jsx)(f,{sx:{p:2},children:(0,M.jsx)(C,{variant:`body2`,color:`text.secondary`,component:`div`,children:(0,M.jsxs)(`ol`,{style:{margin:0,paddingLeft:20},children:[(0,M.jsx)(`li`,{children:v(`settings:contextCondense.step1`,`保留首条消息 - 通常包含任务初始指令`)}),(0,M.jsx)(`li`,{children:v(`settings:contextCondense.step2`,`保留最后3条消息 - 保持最新上下文的完整性`)}),(0,M.jsx)(`li`,{children:v(`settings:contextCondense.step3`,`压缩中间消息 - 使用 AI 生成结构化摘要`)}),(0,M.jsx)(`li`,{children:v(`settings:contextCondense.step4`,`重组消息 - [首条消息, 摘要, 最后3条消息]`)})]})})})]})]})]})};export{N as default};