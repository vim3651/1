import{t as e}from"./Card-CgnXHdbl.js";import{t}from"./CardContent-f2tPkMYB.js";import{t as n}from"./InputAdornment-DO0tC8Wv.js";import{t as r}from"./plus-DCrdXXDc.js";import{$t as i,Ad as a,Cd as o,Du as s,Eu as c,Gi as l,Hu as u,Iu as d,Jr as f,Ju as ee,Nu as te,Ol as p,Pl as m,Qt as h,Qu as ne,Sd as re,Su as g,U as _,Vu as v,Wu as y,Zu as b,_ as x,ad as S,bd as C,dd as w,fd as T,fu as E,id as D,ku as O,mp as k,nd as ie,nu as A,pp as j,pu as ae,qd as M,qp as N,qu as P,s as oe,tu as se,vd as F,xd as I,xp as L,xu as R,zp as z,zu as B}from"./index-hvLbsAjx.js";var V=g(`delete`,[[`path`,{d:`M10 5a2 2 0 0 0-1.344.519l-6.328 5.74a1 1 0 0 0 0 1.481l6.328 5.741A2 2 0 0 0 10 19h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z`,key:`1yo7s0`}],[`path`,{d:`m12 9 6 6`,key:`anjzzh`}],[`path`,{d:`m18 9-6 6`,key:`1fp51s`}]]),H=N(z(),1),U=N(L(),1),W=({providerName:i,providerType:a,apiKeys:s,strategy:f,onKeysChange:h,onStrategyChange:g})=>{let[x,C]=(0,H.useState)(!1),[k,j]=(0,H.useState)(null),[N,L]=(0,H.useState)(``),[R,z]=(0,H.useState)(``),[W,G]=(0,H.useState)(5),[K,q]=(0,H.useState)(``),[J,Y]=(0,H.useState)(!1),[X,Z]=(0,H.useState)(null),Q=_.getInstance(),ce=e=>{switch(e){case`active`:return{icon:(0,U.jsx)(E,{size:16}),color:`success`,text:`正常`};case`error`:return{icon:(0,U.jsx)(ae,{size:16}),color:`error`,text:`错误`};case`disabled`:return{icon:(0,U.jsx)(p,{size:16}),color:`warning`,text:`禁用`};case`rate_limited`:return{icon:(0,U.jsx)(p,{size:16}),color:`warning`,text:`限流`};default:return{icon:(0,U.jsx)(p,{size:16}),color:`default`,text:`未知`}}},le=()=>{j(null),L(``),z(``),G(5),q(``),Y(!1),C(!0)},ue=e=>{j(e),L(e.key),z(e.name||``),G(e.priority),q(``),Y(!1),Z(null),C(!0)},de=()=>{if(!Q.validateApiKey(N,a)){q(`无效的 ${i} API Key 格式`);return}if(s.some(e=>e.key===N&&e.id!==k?.id)){q(`该 API Key 已存在`);return}let e;if(k)e=s.map(e=>e.id===k.id?{...e,key:N,name:R||`API Key ${Date.now()}`,priority:W,updatedAt:Date.now()}:e);else{let t=Q.createApiKeyConfig(N,R||`API Key ${Date.now()}`,W);e=[...s,t]}h(e),C(!1)},fe=e=>{X===e?(h(s.filter(t=>t.id!==e)),Q.resetRoundRobinState(),Z(null)):Z(e)},pe=(e,t)=>{h(s.map(n=>n.id===e?{...n,isEnabled:t,updatedAt:Date.now()}:n)),Z(null)},me=e=>e.length<=8?`••••••••`:`${e.substring(0,4)}••••${e.substring(e.length-4)}`,$=Q.getKeyStats(s);return(0,U.jsxs)(T,{children:[(0,U.jsxs)(T,{sx:{display:`grid`,gridTemplateColumns:`repeat(auto-fit, minmax(120px, 1fr))`,gap:2,mb:3},children:[(0,U.jsx)(e,{children:(0,U.jsxs)(t,{sx:{textAlign:`center`,py:2},children:[(0,U.jsx)(I,{variant:`h6`,color:`primary`,children:$.total}),(0,U.jsx)(I,{variant:`body2`,color:`text.secondary`,children:`总数`})]})}),(0,U.jsx)(e,{children:(0,U.jsxs)(t,{sx:{textAlign:`center`,py:2},children:[(0,U.jsx)(I,{variant:`h6`,color:`success.main`,children:$.active}),(0,U.jsx)(I,{variant:`body2`,color:`text.secondary`,children:`正常`})]})}),(0,U.jsx)(e,{children:(0,U.jsxs)(t,{sx:{textAlign:`center`,py:2},children:[(0,U.jsx)(I,{variant:`h6`,color:`error.main`,children:$.error}),(0,U.jsx)(I,{variant:`body2`,color:`text.secondary`,children:`错误`})]})}),(0,U.jsx)(e,{children:(0,U.jsxs)(t,{sx:{textAlign:`center`,py:2},children:[(0,U.jsxs)(I,{variant:`h6`,color:`text.primary`,children:[$.successRate,`%`]}),(0,U.jsx)(I,{variant:`body2`,color:`text.secondary`,children:`成功率`})]})})]}),(0,U.jsx)(T,{sx:{mb:3},children:(0,U.jsxs)(ne,{fullWidth:!0,children:[(0,U.jsx)(ee,{children:`负载均衡策略`}),(0,U.jsxs)(te,{value:f,label:`负载均衡策略`,onChange:e=>g(e.target.value),children:[(0,U.jsx)(d,{value:`round_robin`,children:`轮询 (Round Robin)`}),(0,U.jsx)(d,{value:`priority`,children:`优先级 (Priority)`}),(0,U.jsx)(d,{value:`least_used`,children:`最少使用 (Least Used)`}),(0,U.jsx)(d,{value:`random`,children:`随机 (Random)`})]})]})}),(0,U.jsxs)(T,{sx:{display:`flex`,justifyContent:`space-between`,alignItems:`center`,mb:2},children:[(0,U.jsxs)(I,{variant:`h6`,children:[`API Keys (`,s.length,`)`]}),(0,U.jsx)(w,{variant:`contained`,startIcon:(0,U.jsx)(r,{size:16}),onClick:le,size:`small`,children:`添加 Key`})]}),s.length===0?(0,U.jsx)(re,{severity:`info`,children:`还没有配置 API Key。点击"添加 Key"开始配置。`}):(0,U.jsx)(y,{children:s.map((e,t)=>{let n=ce(e.status);return(0,U.jsxs)(v,{divider:!0,children:[(0,U.jsx)(B,{primary:(0,U.jsxs)(T,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[(0,U.jsx)(I,{variant:`subtitle2`,children:e.name||`Key ${t+1}`}),(0,U.jsx)(F,{icon:n.icon,label:n.text,size:`small`,color:n.color}),(0,U.jsx)(F,{label:`优先级: ${e.priority}`,size:`small`,variant:`outlined`})]}),secondary:(0,U.jsxs)(T,{children:[(0,U.jsx)(I,{variant:`body2`,sx:{fontFamily:`monospace`,whiteSpace:`nowrap`,overflow:`hidden`,textOverflow:`ellipsis`,maxWidth:`100%`},children:me(e.key)}),(0,U.jsxs)(I,{variant:`caption`,color:`text.secondary`,children:[`请求: `,e.usage.totalRequests,` | 成功: `,e.usage.successfulRequests,` | 失败: `,e.usage.failedRequests]}),e.usage.totalRequests>0&&(0,U.jsx)(P,{variant:`determinate`,value:e.usage.successfulRequests/e.usage.totalRequests*100,sx:{mt:1,height:4,borderRadius:2}})]}),secondaryTypographyProps:{component:`div`}}),(0,U.jsx)(u,{children:(0,U.jsxs)(T,{sx:{display:`flex`,alignItems:`center`,gap:1.5},children:[(0,U.jsx)(b,{control:(0,U.jsx)(oe,{checked:e.isEnabled,onChange:t=>pe(e.id,t.target.checked)}),label:``}),(0,U.jsx)(O,{title:`编辑`,children:(0,U.jsx)(o,{size:`medium`,onClick:()=>ue(e),sx:{bgcolor:e=>M(e.palette.info.main,.1),"&:hover":{bgcolor:e=>M(e.palette.info.main,.2)}},children:(0,U.jsx)(m,{size:20})})}),(0,U.jsx)(O,{title:X===e.id?`再次点击确认删除`:`删除`,children:(0,U.jsx)(o,{size:`medium`,onClick:()=>fe(e.id),sx:{bgcolor:X===e.id?`error.main`:e=>M(e.palette.error.main,.1),color:X===e.id?`white`:`error.main`,"&:hover":{bgcolor:X===e.id?`error.dark`:e=>M(e.palette.error.main,.2)}},children:X===e.id?(0,U.jsx)(E,{size:20}):(0,U.jsx)(V,{size:20})})})]})})]},e.id)})}),(0,U.jsxs)(l,{open:x,onClose:()=>C(!1),maxWidth:`sm`,fullWidth:!0,children:[(0,U.jsx)(ie,{children:k?`编辑 API Key`:`添加 API Key`}),(0,U.jsxs)(D,{children:[(0,U.jsx)(c,{autoFocus:!0,margin:`dense`,label:`API Key`,type:J?`text`:`password`,fullWidth:!0,variant:`outlined`,value:N,onChange:e=>{L(e.target.value),q(``)},error:!!K,helperText:K||`请输入有效的 ${i} API Key`,sx:{mb:2},InputProps:{endAdornment:(0,U.jsx)(n,{position:`end`,children:(0,U.jsx)(o,{"aria-label":J?`隐藏密钥`:`显示密钥`,onClick:()=>Y(!J),edge:`end`,size:`small`,children:J?(0,U.jsx)(A,{size:16}):(0,U.jsx)(se,{size:16})})})}}),(0,U.jsx)(c,{margin:`dense`,label:`名称 (可选)`,fullWidth:!0,variant:`outlined`,value:R,onChange:e=>z(e.target.value),placeholder:`例如：主要账户、备用账户`,sx:{mb:2}}),(0,U.jsx)(c,{margin:`dense`,label:`优先级`,type:`number`,fullWidth:!0,variant:`outlined`,value:W,onChange:e=>G(Number(e.target.value)),inputProps:{min:1,max:10},helperText:`1-10，数字越小优先级越高`})]}),(0,U.jsxs)(S,{children:[(0,U.jsx)(w,{onClick:()=>C(!1),children:`取消`}),(0,U.jsx)(w,{onClick:de,variant:`contained`,children:k?`保存`:`添加`})]})]})]})},G=()=>{let{providerId:e}=k(),t=j(),n=h(),r=i(t=>t.settings.providers.find(t=>t.id===e));if(!r)return(0,U.jsxs)(T,{sx:{p:3},children:[(0,U.jsx)(I,{children:`供应商未找到`}),(0,U.jsx)(w,{onClick:()=>t(`/settings/default-model`),children:`返回`})]});let c=()=>{t(`/settings/model-provider/${e}`)},l=e=>{n(f({id:r.id,updates:{apiKeys:e,apiKey:e.length>0?void 0:r.apiKey}}))},u=e=>{n(f({id:r.id,updates:{keyManagement:{strategy:e,maxFailuresBeforeDisable:r.keyManagement?.maxFailuresBeforeDisable||3,failureRecoveryTime:r.keyManagement?.failureRecoveryTime||5,enableAutoRecovery:r.keyManagement?.enableAutoRecovery??!0}}}))};return(0,U.jsxs)(x,{children:[(0,U.jsx)(C,{position:`static`,elevation:0,sx:{bgcolor:`background.paper`,color:`text.primary`,borderBottom:1,borderColor:`divider`,backdropFilter:`blur(8px)`},children:(0,U.jsxs)(s,{children:[(0,U.jsx)(o,{edge:`start`,onClick:c,"aria-label":`back`,sx:{color:e=>e.palette.primary.main},children:(0,U.jsx)(R,{size:20})}),(0,U.jsxs)(I,{variant:`h6`,component:`div`,sx:{flexGrow:1,fontWeight:600},children:[r.name,` - 多 Key 管理`]})]})}),(0,U.jsx)(T,{sx:{flexGrow:1,overflowY:`auto`,p:2,pb:`var(--content-bottom-padding)`,"&::-webkit-scrollbar":{width:`6px`},"&::-webkit-scrollbar-thumb":{backgroundColor:`rgba(0,0,0,0.1)`,borderRadius:`3px`}},children:(0,U.jsx)(a,{elevation:0,sx:{p:3,borderRadius:2,border:`1px solid`,borderColor:`divider`,bgcolor:`background.paper`,boxShadow:`0 4px 12px rgba(0,0,0,0.05)`},children:(0,U.jsx)(W,{providerName:r.name,providerType:r.providerType||`openai`,apiKeys:r.apiKeys||[],strategy:r.keyManagement?.strategy||`round_robin`,onKeysChange:l,onStrategyChange:u})})})]})};export{G as default};