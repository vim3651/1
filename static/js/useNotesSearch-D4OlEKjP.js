const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["static/js/web-BdS4cMAu.js","static/js/index-hvLbsAjx.js","static/css/index-iKlUzaLt.css"])))=>i.map(i=>d[i]);
import{Ef as e,Lp as t,Tp as n,jp as r,qp as i,zp as a}from"./index-hvLbsAjx.js";import{n as o,r as s}from"./SimpleNoteService-DYyyUaKJ.js";var c=t(`AdvancedFileManager`,{web:()=>r(()=>import(`./web-BdS4cMAu.js`),__vite__mapDeps([0,1,2])).then(e=>new e.AdvancedFileManagerWeb)});function l(e){return e.replace(/[.*+?^${}()|[\]\\]/g,`\\$&`)}function u(e,t,n){let r=0,i=e.name.toLowerCase(),a=t.toLowerCase();return i===a||i===`${a}.md`?r+=200:i.includes(a)&&(r+=100),r+=Math.min(n.length*2,50),e.isDirectory&&(r-=10),r}function d(e,t,n=!1){let r=n?e.name:e.name.toLowerCase(),i=n?t:t.toLowerCase();return r.includes(i)}async function f(e,t,n={}){let{caseSensitive:r=!1,maxMatchesPerFile:i=10,contextLength:a=40,maxFileSize:o=5*1024*1024}=n;if(e.isDirectory)return[];if(e.size&&e.size>o)return console.log(`跳过大文件: ${e.path} (${(e.size/1024).toFixed(1)} KB)`),[];try{let n=await s.readNote(e.path);if(!n)return[];if(n.length>o)return console.log(`跳过大文件内容: ${e.path} (${(n.length/1024).toFixed(1)} KB)`),[];let c=r?`g`:`gi`,u=new RegExp(l(t),c),d=n.split(`
`),f=[];for(let e=0;e<d.length;e++){let t=d[e];u.lastIndex=0;let n;for(;(n=u.exec(t))!==null;){let r=n.index,o=r+n[0].length,s=Math.min(2,r),c=r-s,l=Math.min(t.length,o+a),u=c>0?`...`:``,d=u+t.substring(c,l);if(f.push({lineNumber:e+1,lineContent:t,matchStart:s+u.length,matchEnd:o-r+s+u.length,context:d}),f.length>=i)break}if(f.length>=i)break}return f}catch(t){return console.error(`搜索文件内容失败: ${e.path}`,t),[]}}async function p(e=``,t=100,n=5,r=0){let i=[];if(r>=n)return i;try{let a=await s.listNotes(e);for(let e of a){if(i.length>=t)break;if(i.push(e),e.isDirectory&&i.length<t){let a=await p(e.path,t-i.length,n,r+1);i.push(...a)}}}catch(t){console.error(`获取文件列表失败: ${e}`,t)}return i}async function m(){return await e.getSetting(`NOTE_STORAGE_PATH`)||``}async function h(e,t={}){let{caseSensitive:n=!1,maxMatchesPerFile:r=10,contextLength:i=40,maxFiles:a=100,maxFileSize:o=5*1024*1024,maxDepth:s=5}=t;try{let t=await m();if(!t)return console.warn(`笔记存储路径未配置`),[];console.log(`[原生搜索] 目录: ${t}, 关键词: ${e}`);let l=await c.searchContent({directory:t,keyword:e,caseSensitive:n,fileExtensions:[`.md`,`.txt`,`.json`],maxFiles:a,maxFileSize:o,maxMatchesPerFile:r,contextLength:i,maxDepth:s,recursive:!0});return console.log(`[原生搜索] 完成: ${l.totalFiles} 文件, ${l.totalMatches} 匹配, ${l.duration}ms`),l.results.map(e=>({id:e.path,name:e.name,path:e.path.replace(t+`/`,``).replace(t,``),isDirectory:!1,lastModified:new Date().toISOString(),extension:e.name.split(`.`).pop()||``,matchType:e.matchType,matches:e.matches.map(e=>({lineNumber:e.lineNumber,lineContent:e.lineContent,matchStart:e.matchStart,matchEnd:e.matchEnd,context:e.context})),score:e.score}))}catch(n){return console.error(`[原生搜索] 失败:`,n),g(e,t)}}async function g(e,t={},n){let{searchContent:r=!0,maxFiles:i=100,maxDepth:a=5,...o}=t,s=[];try{let c=await p(``,i,a);console.log(`[JS搜索] 范围: ${c.length} 个文件/文件夹`);for(let i of c){if(n?.aborted)break;let a=d(i,e,t.caseSensitive),c=[];r&&!i.isDirectory&&(c=await f(i,e,o)),a&&c.length>0?s.push({...i,matchType:`both`,matches:c,score:u(i,e,c)+100}):a?s.push({...i,matchType:`filename`,matches:[],score:u(i,e,[])}):c.length>0&&s.push({...i,matchType:`content`,matches:c,score:u(i,e,c)})}return s.sort((e,t)=>t.score-e.score)}catch(e){return console.error(`[JS搜索] 失败:`,e),[]}}async function _(e,t={},r){return e.trim()?n()?h(e,t):g(e,t,r):[]}var v=i(a(),1);function y(e={}){let{debounceMs:t=300,maxResults:n=100,enabled:r=!0,...i}=e,[a,o]=(0,v.useState)(``),[s,c]=(0,v.useState)(!1),[l,u]=(0,v.useState)([]),[d,f]=(0,v.useState)(null),[p,m]=(0,v.useState)({total:0,fileNameMatches:0,contentMatches:0,bothMatches:0}),h=(0,v.useRef)(null),g=(0,v.useRef)(null),y=(0,v.useRef)(i),b=(0,v.useRef)(n),x=(0,v.useRef)(r);(0,v.useEffect)(()=>{y.current=i,b.current=n,x.current=r},[i,n,r]);let S=(0,v.useCallback)(()=>{h.current&&=(h.current.abort(),null),g.current&&=(clearTimeout(g.current),null),c(!1)},[]),C=(0,v.useCallback)(()=>{S(),o(``),u([]),m({total:0,fileNameMatches:0,contentMatches:0,bothMatches:0}),f(null)},[S]),w=(0,v.useCallback)(async e=>{if(!x.current)return;if(S(),!e.trim()){u([]),m({total:0,fileNameMatches:0,contentMatches:0,bothMatches:0});return}c(!0),f(null);let t=new AbortController;h.current=t;try{let n=await _(e.trim(),y.current,t.signal);if(t.signal.aborted)return;let r=n.slice(0,b.current),i={total:r.length,fileNameMatches:r.filter(e=>e.matchType===`filename`).length,contentMatches:r.filter(e=>e.matchType===`content`).length,bothMatches:r.filter(e=>e.matchType===`both`).length};u(r),m(i)}catch(e){e instanceof Error&&e.name!==`AbortError`&&f(e)}finally{t.signal.aborted||c(!1)}},[S]),T=(0,v.useCallback)(e=>{o(e),g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{w(e)},t)},[w,t]);return(0,v.useEffect)(()=>()=>{S()},[S]),{search:T,cancel:S,reset:C,keyword:a,setKeyword:o,isSearching:s,results:l,stats:p,error:d}}export{y as t};