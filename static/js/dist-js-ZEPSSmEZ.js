import{i as e,t}from"./core-Drq98oSU.js";var n=`Request cancelled`;async function r(r,i){let a=i?.signal;if(a?.aborted)throw Error(n);let o=i?.maxRedirections,s=i?.connectTimeout,c=i?.proxy,l=i?.danger;i&&(delete i.maxRedirections,delete i.connectTimeout,delete i.proxy,delete i.danger);let u=i?.headers?i.headers instanceof Headers?i.headers:new Headers(i.headers):new Headers,d=new Request(r,i),f=await d.arrayBuffer(),p=f.byteLength===0?null:Array.from(new Uint8Array(f));for(let[e,t]of d.headers)u.get(e)||u.set(e,t);let m=(u instanceof Headers?Array.from(u.entries()):Array.isArray(u)?u:Object.entries(u)).map(([e,t])=>[e,typeof t==`string`?t:t.toString()]);if(a?.aborted)throw Error(n);let h=await e(`plugin:http|fetch`,{clientConfig:{method:d.method,url:d.url,headers:m,data:p,maxRedirections:o,connectTimeout:s,proxy:c,danger:l}}),g=()=>e(`plugin:http|fetch_cancel`,{rid:h});if(a?.aborted)throw g(),Error(n);a?.addEventListener(`abort`,()=>void g());let{status:_,statusText:v,url:y,headers:b,rid:x}=await e(`plugin:http|fetch_send`,{rid:h}),S=[101,103,204,205,304].includes(_)?null:new ReadableStream({start:r=>{let i=new t;i.onmessage=e=>{if(a?.aborted){r.error(n);return}let t=new Uint8Array(e),i=t[t.byteLength-1],o=t.slice(0,t.byteLength-1);if(i==1){r.close();return}r.enqueue(o)},e(`plugin:http|fetch_read_body`,{rid:x,streamChannel:i}).catch(e=>{r.error(e)})}}),C=new Response(S,{status:_,statusText:v});return Object.defineProperty(C,`url`,{value:y}),Object.defineProperty(C,`headers`,{value:new Headers(b)}),C}export{r as fetch};