import{t as e}from"./Card-CgnXHdbl.js";import{t}from"./CardActions-Di-BmE_R.js";import{t as n}from"./CardContent-f2tPkMYB.js";import{t as r}from"./plus-DCrdXXDc.js";import{$l as i,Ad as a,Al as o,Bt as s,Cd as c,Dl as l,Du as u,Ef as d,Eu as f,Gi as p,Gt as m,Hd as h,Ht as g,Iu as _,Ju as v,Kt as y,Lt as b,Nu as x,Ol as S,Ou as C,Qu as w,Rt as T,Sd as E,Ut as D,Vt as O,Wt as k,Xu as A,_ as j,_u as M,ad as N,bd as P,dd as F,fd as I,id as L,iu as R,jd as z,ju as B,md as V,mu as H,nd as U,o as W,pp as G,qp as K,td as q,tu as J,wd as Y,xd as X,xp as Z,xu as ee,zp as te,zt as ne}from"./index-hvLbsAjx.js";var Q=K(te(),1),$=K(Z(),1),re=({open:e,onClose:t,onSave:n,initialData:r,isEditing:i=!1})=>{let[a,o]=(0,Q.useState)([]),[l,u]=(0,Q.useState)({name:r?.name||``,model:r?.model||``,dimensions:r?.dimensions||1536,documentCount:r?.documentCount||6,chunkSize:r?.chunkSize||1e3,chunkOverlap:r?.chunkOverlap||200,threshold:r?.threshold||.7}),[d,h]=(0,Q.useState)({}),[g,b]=(0,Q.useState)(!1),[S,T]=(0,Q.useState)(!1),[j,P]=(0,Q.useState)(null),R=(0,Q.useRef)(null);(0,Q.useEffect)(()=>{let e=m();if(o(e),i&&!l.model&&e.length>0){let t=e[0],n=y(t.id);u(e=>({...e,model:t.id,dimensions:n}))}},[i,l.model]),(0,Q.useEffect)(()=>{u(r?{name:r.name||``,model:r.model||``,dimensions:r.dimensions||1536,documentCount:r.documentCount||6,chunkSize:r.chunkSize||1e3,chunkOverlap:r.chunkOverlap||200,threshold:r.threshold||.7}:{name:``,model:``,dimensions:O,documentCount:6,chunkSize:s,chunkOverlap:200,threshold:D})},[r]),(0,Q.useEffect)(()=>{e||(h({}),P(null))},[e]),(0,Q.useEffect)(()=>()=>{R.current&&R.current.abort()},[]);let V=e=>{let{name:t,value:n}=e.target;t&&(u(e=>({...e,[t]:n})),d[t]&&h(e=>{let n={...e};return delete n[t],n}))},W=(0,Q.useCallback)(e=>(t,n)=>{typeof n==`number`&&u(t=>({...t,[e]:n}))},[]),G=(0,Q.useCallback)(async e=>{let t=e.target.value;R.current&&R.current.abort(),R.current=new AbortController;let n;try{n=await k.getInstance().getEmbeddingDimensions(t)}catch(e){console.error(`获取模型维度失败:`,e),n=y(t)}R.current?.signal.aborted||u(e=>({...e,model:t,dimensions:n}))},[]),K=()=>{let e={};return l.name?.trim()||(e.name=`知识库名称不能为空`),l.model||(e.model=`请选择嵌入模型`),h(e),Object.keys(e).length===0},J=async()=>{if(K())try{b(!0),P(null),await n(l),t()}catch(e){console.error(`保存知识库失败:`,e),P(e instanceof Error?e.message:`保存知识库失败，请稍后再试`)}finally{b(!1)}};return(0,$.jsxs)(p,{open:e,onClose:t,fullWidth:!0,maxWidth:`md`,children:[(0,$.jsx)(U,{children:i?`编辑知识库`:`创建知识库`}),(0,$.jsx)(L,{dividers:!0,children:(0,$.jsxs)(C,{spacing:3,children:[j&&(0,$.jsx)(E,{severity:`error`,onClose:()=>P(null),children:j}),(0,$.jsx)(f,{autoFocus:!0,name:`name`,label:`知识库名称`,fullWidth:!0,required:!0,value:l.name,onChange:V,error:!!d.name,helperText:d.name||`给知识库起一个描述性的名称`}),(0,$.jsxs)(w,{fullWidth:!0,error:!!d.model,children:[(0,$.jsx)(v,{children:`嵌入模型 *`}),(0,$.jsx)(x,{name:`model`,value:l.model||``,onChange:G,label:`嵌入模型 *`,MenuProps:{disableAutoFocus:!0,disableRestoreFocus:!0},children:a.length>0?a.map(e=>(0,$.jsxs)(_,{value:e.id,children:[e.name,` (来自 `,e.provider,`)`]},e.id)):(0,$.jsx)(_,{disabled:!0,value:``,children:`未找到可用的嵌入模型，请先在设置中配置`})}),(0,$.jsx)(A,{children:d.model||`用于将文本转换为向量的模型`})]}),(0,$.jsxs)(I,{children:[(0,$.jsxs)(X,{gutterBottom:!0,children:[`请求文档段数量: `,l.documentCount]}),(0,$.jsx)(B,{name:`documentCount`,value:l.documentCount||6,onChange:W(`documentCount`),min:1,max:30,step:1,marks:[{value:1,label:`1`},{value:6,label:`默认`},{value:30,label:`30`}],valueLabelDisplay:`auto`,"aria-label":`文档数量`}),(0,$.jsx)(X,{variant:`caption`,color:`text.secondary`,children:`搜索时返回的文档段数量，影响回答的详细程度`})]}),(0,$.jsx)(q,{}),(0,$.jsxs)(I,{sx:{display:`flex`,alignItems:`center`,justifyContent:`space-between`},children:[(0,$.jsx)(X,{variant:`subtitle1`,fontWeight:`bold`,children:`高级设置`}),(0,$.jsx)(c,{onClick:()=>T(!S),size:`small`,children:S?(0,$.jsx)(H,{size:20}):(0,$.jsx)(M,{size:20})})]}),(0,$.jsx)(z,{in:S,children:(0,$.jsxs)(C,{spacing:3,sx:{mt:2},children:[(0,$.jsx)(f,{name:`chunkSize`,label:`分块大小`,type:`number`,fullWidth:!0,value:l.chunkSize,onChange:V,helperText:`将文档分割成的块的大小（字符数）`,slotProps:{htmlInput:{min:100,max:5e3,step:100}}}),(0,$.jsx)(f,{name:`chunkOverlap`,label:`重叠大小`,type:`number`,fullWidth:!0,value:l.chunkOverlap,onChange:V,helperText:`每个块之间重叠的字符数`,slotProps:{htmlInput:{min:0,max:1e3,step:50}}}),(0,$.jsxs)(I,{children:[(0,$.jsxs)(X,{gutterBottom:!0,children:[`相似度阈值: `,l.threshold]}),(0,$.jsx)(B,{name:`threshold`,value:l.threshold||.7,onChange:W(`threshold`),min:0,max:1,step:.05,marks:[{value:0,label:`0`},{value:.5,label:`0.5`},{value:1,label:`1`}],valueLabelDisplay:`auto`,"aria-label":`相似度阈值`}),(0,$.jsx)(X,{variant:`caption`,color:`text.secondary`,children:`搜索结果的最低相似度分数，值越高结果越精确`})]})]})})]})}),(0,$.jsxs)(N,{children:[(0,$.jsx)(F,{onClick:t,disabled:g,children:`取消`}),(0,$.jsx)(F,{onClick:J,variant:`contained`,color:`primary`,disabled:g,children:g?`保存中...`:i?`更新`:`创建`})]})]})},ie=h(j)(()=>({position:`relative`,overflow:`hidden`})),ae=h(e)(({theme:e})=>({height:`100%`,display:`flex`,flexDirection:`column`,cursor:`pointer`,borderRadius:e.shape.borderRadius*2})),oe=()=>{let s=G(),[f,m]=(0,Q.useState)(!1),[h,g]=(0,Q.useState)(!1),[_,v]=(0,Q.useState)(!1),[y,x]=(0,Q.useState)(!1),[C,w]=(0,Q.useState)(!1),E=Q.useRef(null),[D,O]=(0,Q.useState)({totalKnowledgeBases:0,totalDocuments:0,totalVectors:0,storageSize:`0 MB`}),{knowledgeBases:k,isLoading:A,refreshKnowledgeBases:j}=b(),M=e=>{s(`/knowledge/${e}`)},z=()=>{s(`/settings`)},B=async()=>{try{w(!0);let e=(await d.knowledge_documents.toArray()).length,t=e,n=H(1536*4*t);O({totalKnowledgeBases:k.length,totalDocuments:e,totalVectors:t,storageSize:n})}catch(e){console.error(`加载统计信息失败:`,e)}finally{w(!1)}},H=e=>{if(e===0)return`0 B`;let t=1024,n=[`B`,`KB`,`MB`,`GB`],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/t**+r).toFixed(2))+` `+n[r]};(0,Q.useEffect)(()=>{k.length>0&&B()},[k]);let K=()=>{m(!0)},Z=()=>{m(!1)},te=async e=>{try{w(!0),await T.getInstance().createKnowledgeBase(e),Z(),j(),W.success(`知识库创建成功！`,`创建成功`)}catch(e){console.error(`创建知识库失败:`,e),W.error(`创建失败，请重试`,`创建失败`)}finally{w(!1)}},ne=async(e,t)=>{if(t.stopPropagation(),window.confirm(`确认要删除这个知识库吗？此操作将删除所有相关文档，无法撤销。`))try{await T.getInstance().deleteKnowledgeBase(e),j(),W.success(`知识库删除成功`,`删除成功`)}catch(e){console.error(`删除知识库失败:`,e),W.error(`删除失败，请重试`,`删除失败`)}},oe=async()=>{try{w(!0);let e=await d.knowledge_bases.toArray(),t=await d.knowledge_documents.toArray(),n={version:`1.0`,timestamp:new Date().toISOString(),knowledgeBases:e,documents:t},r=new Blob([JSON.stringify(n,null,2)],{type:`application/json`}),i=URL.createObjectURL(r),a=document.createElement(`a`);a.href=i,a.download=`knowledge-backup-${new Date().toISOString().split(`T`)[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),g(!1),W.success(`知识库数据导出成功`,`导出成功`)}catch(e){console.error(`导出知识库数据失败:`,e),W.error(`导出失败，请重试`,`导出失败`)}finally{w(!1)}},se=async e=>{let t=e.target.files?.[0];if(t)try{w(!0);let e=await t.text(),n=JSON.parse(e);if(!n.version||!n.knowledgeBases||!n.documents)throw Error(`无效的备份文件格式`);for(let e of n.knowledgeBases)await d.knowledge_bases.put(e);for(let e of n.documents)await d.knowledge_documents.put(e);j(),v(!1),W.success(`成功导入 ${n.knowledgeBases.length} 个知识库和 ${n.documents.length} 个文档`,`导入成功`)}catch(e){console.error(`导入知识库数据失败:`,e),W.error(`导入失败，请检查文件格式`,`导入失败`)}finally{w(!1),E.current&&(E.current.value=``)}},ce=async()=>{try{w(!0),await d.knowledge_bases.clear(),await d.knowledge_documents.clear(),j(),x(!1),W.success(`知识库数据已清理完成`,`清理成功`)}catch(e){console.error(`清理知识库数据失败:`,e),W.error(`清理失败，请重试`,`清理失败`)}finally{w(!1)}},le=e=>new Date(e).toLocaleDateString();return(0,$.jsxs)(ie,{children:[(0,$.jsx)(P,{position:`static`,elevation:0,sx:{bgcolor:`background.paper`,color:`text.primary`,borderBottom:1,borderColor:`divider`},children:(0,$.jsxs)(u,{children:[(0,$.jsx)(c,{edge:`start`,onClick:z,"aria-label":`back`,sx:{color:e=>e.palette.primary.main},children:(0,$.jsx)(ee,{size:20})}),(0,$.jsx)(X,{variant:`h6`,component:`div`,sx:{flexGrow:1,fontWeight:600},children:`知识库设置`}),(0,$.jsx)(F,{variant:`contained`,startIcon:(0,$.jsx)(r,{size:20}),onClick:K,sx:{background:`linear-gradient(45deg, #059669 30%, #10b981 90%)`,"&:hover":{background:`linear-gradient(45deg, #047857 30%, #059669 90%)`}},children:`创建知识库`})]})}),(0,$.jsxs)(I,{sx:{flexGrow:1,overflow:`auto`,px:2,py:2,pb:`var(--content-bottom-padding)`,WebkitOverflowScrolling:`touch`,"&::-webkit-scrollbar":{width:`6px`},"&::-webkit-scrollbar-thumb":{backgroundColor:`rgba(0,0,0,0.2)`,borderRadius:`3px`}},children:[(0,$.jsx)(a,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`},children:(0,$.jsxs)(I,{sx:{p:2},children:[(0,$.jsx)(X,{variant:`subtitle1`,sx:{fontWeight:600,mb:2},children:`知识库统计`}),C?(0,$.jsx)(I,{display:`flex`,justifyContent:`center`,py:3,children:(0,$.jsx)(Y,{})}):(0,$.jsxs)(I,{sx:{display:`flex`,flexWrap:`wrap`,margin:-1},children:[(0,$.jsx)(I,{sx:{width:{xs:`50%`,sm:`25%`},p:1},children:(0,$.jsx)(e,{variant:`outlined`,children:(0,$.jsxs)(n,{sx:{textAlign:`center`,py:2},children:[(0,$.jsx)(X,{variant:`h4`,color:`primary`,fontWeight:`bold`,children:D.totalKnowledgeBases}),(0,$.jsx)(X,{variant:`body2`,color:`textSecondary`,children:`知识库数量`})]})})}),(0,$.jsx)(I,{sx:{width:{xs:`50%`,sm:`25%`},p:1},children:(0,$.jsx)(e,{variant:`outlined`,children:(0,$.jsxs)(n,{sx:{textAlign:`center`,py:2},children:[(0,$.jsx)(X,{variant:`h4`,color:`success.main`,fontWeight:`bold`,children:D.totalDocuments}),(0,$.jsx)(X,{variant:`body2`,color:`textSecondary`,children:`文档数量`})]})})}),(0,$.jsx)(I,{sx:{width:{xs:`50%`,sm:`25%`},p:1},children:(0,$.jsx)(e,{variant:`outlined`,children:(0,$.jsxs)(n,{sx:{textAlign:`center`,py:2},children:[(0,$.jsx)(X,{variant:`h4`,color:`warning.main`,fontWeight:`bold`,children:D.totalVectors}),(0,$.jsx)(X,{variant:`body2`,color:`textSecondary`,children:`向量数量`})]})})}),(0,$.jsx)(I,{sx:{width:{xs:`50%`,sm:`25%`},p:1},children:(0,$.jsx)(e,{variant:`outlined`,children:(0,$.jsxs)(n,{sx:{textAlign:`center`,py:2},children:[(0,$.jsx)(X,{variant:`h4`,color:`info.main`,fontWeight:`bold`,children:D.storageSize}),(0,$.jsx)(X,{variant:`body2`,color:`textSecondary`,children:`存储大小`})]})})})]})]})}),(0,$.jsx)(a,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`},children:(0,$.jsxs)(I,{sx:{p:2},children:[(0,$.jsxs)(X,{variant:`subtitle1`,sx:{fontWeight:600,mb:2},children:[`已添加的知识库 (`,k.length,`)`]}),A?(0,$.jsx)(I,{display:`flex`,justifyContent:`center`,py:3,children:(0,$.jsx)(Y,{})}):k.length===0?(0,$.jsxs)(a,{sx:{p:4,textAlign:`center`,my:5,borderRadius:2},children:[(0,$.jsx)(X,{variant:`body1`,color:`textSecondary`,gutterBottom:!0,children:`暂无知识库`}),(0,$.jsx)(X,{variant:`body2`,color:`textSecondary`,children:`点击右上角"创建知识库"按钮开始使用`})]}):(0,$.jsx)(I,{sx:{display:`flex`,flexWrap:`wrap`,margin:-1},children:k.map(e=>(0,$.jsx)(I,{sx:{width:{xs:`100%`,sm:`50%`,md:`33.33%`},p:1},children:(0,$.jsxs)(ae,{onClick:()=>M(e.id),children:[(0,$.jsxs)(n,{sx:{flexGrow:1},children:[(0,$.jsxs)(I,{display:`flex`,alignItems:`center`,mb:1,children:[(0,$.jsx)(V,{sx:{mr:1,bgcolor:`primary.main`},children:(0,$.jsx)(i,{size:20})}),(0,$.jsx)(X,{variant:`h6`,noWrap:!0,children:e.name})]}),(0,$.jsx)(X,{variant:`body2`,color:`text.secondary`,sx:{mb:2,height:40,overflow:`hidden`,textOverflow:`ellipsis`,display:`-webkit-box`,WebkitLineClamp:2,WebkitBoxOrient:`vertical`},children:e.description||`无描述`}),(0,$.jsxs)(I,{display:`flex`,flexWrap:`wrap`,gap:.5,children:[(0,$.jsxs)(X,{variant:`caption`,color:`text.secondary`,children:[`模型: `,e.model]}),(0,$.jsxs)(X,{variant:`caption`,color:`text.secondary`,children:[`• 创建: `,le(e.created_at)]})]})]}),(0,$.jsx)(q,{}),(0,$.jsxs)(t,{children:[(0,$.jsx)(c,{size:`small`,onClick:t=>ne(e.id,t),children:(0,$.jsx)(o,{size:16})}),(0,$.jsx)(I,{flexGrow:1}),(0,$.jsx)(F,{size:`small`,variant:`outlined`,startIcon:(0,$.jsx)(J,{size:16}),onClick:()=>M(e.id),children:`查看`})]})]})},e.id))})]})}),(0,$.jsx)(a,{elevation:0,sx:{mb:2,borderRadius:2,border:`1px solid`,borderColor:`divider`},children:(0,$.jsxs)(I,{sx:{p:2},children:[(0,$.jsx)(X,{variant:`subtitle1`,sx:{fontWeight:600,mb:2},children:`数据管理`}),(0,$.jsx)(X,{variant:`body2`,color:`text.secondary`,sx:{mb:2},children:`导入、导出备份和清理知识库数据`}),(0,$.jsxs)(I,{sx:{display:`flex`,gap:2,flexWrap:`wrap`},children:[(0,$.jsx)(F,{variant:`outlined`,startIcon:(0,$.jsx)(l,{size:18}),onClick:()=>v(!0),disabled:C,children:`导入数据`}),(0,$.jsx)(F,{variant:`outlined`,startIcon:(0,$.jsx)(R,{size:18}),onClick:()=>g(!0),disabled:C||k.length===0,children:`导出数据`}),(0,$.jsx)(F,{variant:`outlined`,color:`error`,startIcon:(0,$.jsx)(S,{size:18}),onClick:()=>x(!0),disabled:C||k.length===0,children:`清理所有数据`})]})]})})]}),(0,$.jsx)(p,{open:f,onClose:Z,children:(0,$.jsx)(re,{open:!0,onClose:Z,onSave:te,isEditing:!1})}),(0,$.jsxs)(p,{open:_,onClose:()=>v(!1),children:[(0,$.jsx)(U,{children:`导入知识库数据`}),(0,$.jsxs)(L,{children:[(0,$.jsx)(X,{sx:{mb:2},children:`选择之前导出的 JSON 备份文件进行导入。导入的数据将与现有数据合并。`}),(0,$.jsx)(`input`,{ref:E,type:`file`,accept:`.json`,onChange:se,style:{display:`none`}}),(0,$.jsx)(F,{variant:`outlined`,fullWidth:!0,onClick:()=>E.current?.click(),disabled:C,children:C?(0,$.jsx)(Y,{size:20}):`选择文件`})]}),(0,$.jsx)(N,{children:(0,$.jsx)(F,{onClick:()=>v(!1),children:`关闭`})})]}),(0,$.jsxs)(p,{open:h,onClose:()=>g(!1),children:[(0,$.jsx)(U,{children:`导出知识库数据`}),(0,$.jsx)(L,{children:(0,$.jsx)(X,{children:`将导出所有知识库和文档数据为JSON文件，可用于备份或迁移。`})}),(0,$.jsxs)(N,{children:[(0,$.jsx)(F,{onClick:()=>g(!1),children:`取消`}),(0,$.jsx)(F,{onClick:oe,disabled:C,variant:`contained`,children:C?(0,$.jsx)(Y,{size:20}):`确认导出`})]})]}),(0,$.jsxs)(p,{open:y,onClose:()=>x(!1),children:[(0,$.jsx)(U,{children:`确认清理所有知识库数据`}),(0,$.jsx)(L,{children:(0,$.jsx)(X,{children:`此操作将删除所有知识库、文档和向量数据，且无法恢复。确定要继续吗？`})}),(0,$.jsxs)(N,{children:[(0,$.jsx)(F,{onClick:()=>x(!1),children:`取消`}),(0,$.jsx)(F,{onClick:ce,color:`error`,disabled:C,variant:`contained`,children:C?(0,$.jsx)(Y,{size:20}):`确认清理`})]})]})]})};export{oe as default};