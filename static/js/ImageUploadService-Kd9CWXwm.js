import{Fp as e,Lp as t,Mp as n,Np as r,Su as i}from"./index-hvLbsAjx.js";var a=i(`check`,[[`path`,{d:`M20 6 9 17l-5-5`,key:`1gmf2c`}]]),o;(function(e){e.Prompt=`PROMPT`,e.Camera=`CAMERA`,e.Photos=`PHOTOS`})(o||={});var s;(function(e){e.Rear=`REAR`,e.Front=`FRONT`})(s||={});var c;(function(e){e.Uri=`uri`,e.Base64=`base64`,e.DataUrl=`dataUrl`})(c||={});var l=class extends e{async getPhoto(e){return new Promise(async(t,n)=>{if(e.webUseInput||e.source===o.Photos)this.fileInputExperience(e,t,n);else if(e.source===o.Prompt){let r=document.querySelector(`pwa-action-sheet`);r||(r=document.createElement(`pwa-action-sheet`),document.body.appendChild(r)),r.header=e.promptLabelHeader||`Photo`,r.cancelable=!1,r.options=[{title:e.promptLabelPhoto||`From Photos`},{title:e.promptLabelPicture||`Take Picture`}],r.addEventListener(`onSelection`,async r=>{r.detail===0?this.fileInputExperience(e,t,n):this.cameraExperience(e,t,n)})}else this.cameraExperience(e,t,n)})}async pickImages(e){return new Promise(async(e,t)=>{this.multipleFileInputExperience(e,t)})}async cameraExperience(e,t,n){if(customElements.get(`pwa-camera-modal`)){let i=document.createElement(`pwa-camera-modal`);i.facingMode=e.direction===s.Front?`user`:`environment`,document.body.appendChild(i);try{await i.componentOnReady(),i.addEventListener(`onPhoto`,async a=>{let o=a.detail;o===null?n(new r(`User cancelled photos app`)):o instanceof Error?n(o):t(await this._getCameraPhoto(o,e)),i.dismiss(),document.body.removeChild(i)}),i.present()}catch{this.fileInputExperience(e,t,n)}}else console.error(`Unable to load PWA Element 'pwa-camera-modal'. See the docs: https://capacitorjs.com/docs/web/pwa-elements.`),this.fileInputExperience(e,t,n)}fileInputExperience(e,t,n){let i=document.querySelector(`#_capacitor-camera-input`),a=()=>{var e;(e=i.parentNode)==null||e.removeChild(i)};i||(i=document.createElement(`input`),i.id=`_capacitor-camera-input`,i.type=`file`,i.hidden=!0,document.body.appendChild(i),i.addEventListener(`change`,n=>{let r=i.files[0],o=`jpeg`;if(r.type===`image/png`?o=`png`:r.type===`image/gif`&&(o=`gif`),e.resultType===`dataUrl`||e.resultType===`base64`){let n=new FileReader;n.addEventListener(`load`,()=>{if(e.resultType===`dataUrl`)t({dataUrl:n.result,format:o});else if(e.resultType===`base64`){let e=n.result.split(`,`)[1];t({base64String:e,format:o})}a()}),n.readAsDataURL(r)}else t({webPath:URL.createObjectURL(r),format:o}),a()}),i.addEventListener(`cancel`,e=>{n(new r(`User cancelled photos app`)),a()})),i.accept=`image/*`,i.capture=!0,e.source===o.Photos||e.source===o.Prompt?i.removeAttribute(`capture`):e.direction===s.Front?i.capture=`user`:e.direction===s.Rear&&(i.capture=`environment`),i.click()}multipleFileInputExperience(e,t){let n=document.querySelector(`#_capacitor-camera-input-multiple`),i=()=>{var e;(e=n.parentNode)==null||e.removeChild(n)};n||(n=document.createElement(`input`),n.id=`_capacitor-camera-input-multiple`,n.type=`file`,n.hidden=!0,n.multiple=!0,document.body.appendChild(n),n.addEventListener(`change`,t=>{let r=[];for(let e=0;e<n.files.length;e++){let t=n.files[e],i=`jpeg`;t.type===`image/png`?i=`png`:t.type===`image/gif`&&(i=`gif`),r.push({webPath:URL.createObjectURL(t),format:i})}e({photos:r}),i()}),n.addEventListener(`cancel`,e=>{t(new r(`User cancelled photos app`)),i()})),n.accept=`image/*`,n.click()}_getCameraPhoto(e,t){return new Promise((n,r)=>{let i=new FileReader,a=e.type.split(`/`)[1];t.resultType===`uri`?n({webPath:URL.createObjectURL(e),format:a,saved:!1}):(i.readAsDataURL(e),i.onloadend=()=>{let e=i.result;t.resultType===`dataUrl`?n({dataUrl:e,format:a,saved:!1}):n({base64String:e.split(`,`)[1],format:a,saved:!1})},i.onerror=e=>{r(e)})})}async checkPermissions(){if(typeof navigator>`u`||!navigator.permissions)throw this.unavailable(`Permissions API not available in this browser`);try{return{camera:(await window.navigator.permissions.query({name:`camera`})).state,photos:`granted`}}catch{throw this.unavailable(`Camera permissions are not available in this browser`)}}async requestPermissions(){throw this.unimplemented(`Not implemented on web.`)}async pickLimitedLibraryPhotos(){throw this.unavailable(`Not implemented on web.`)}async getLimitedLibraryPhotos(){throw this.unavailable(`Not implemented on web.`)}};new l;var u=t(`Camera`,{web:()=>new l});const d={async selectImages(e=`photos`){try{if(n.isNativePlatform()){let t=e===`camera`?o.Camera:o.Photos;try{let t=await u.checkPermissions();if(t.photos!==`granted`&&e===`photos`){if((await u.requestPermissions({permissions:[`photos`]})).photos!==`granted`)return console.warn(`用户拒绝了相册访问权限`),[]}else if(t.camera!==`granted`&&e===`camera`&&(await u.requestPermissions({permissions:[`camera`]})).camera!==`granted`)return console.warn(`用户拒绝了相机访问权限`),[]}catch(e){return console.error(`权限检查失败:`,e),[]}let n;try{n=await u.getPhoto({quality:75,allowEditing:!1,resultType:c.Base64,source:t,width:1024,height:1024,correctOrientation:!0})}catch(e){let t=e?.message||String(e);return t.includes(`cancel`)||t.includes(`取消`)||t.includes(`User cancelled`)||t.includes(`cancelled`)?(console.log(`用户取消了图片选择`),[]):(console.error(`获取图片失败:`,e),[])}if(!n||!n.base64String)return console.warn(`未获取到图片数据，用户可能取消了操作`),[];let r=n.format?`image/${n.format.toLowerCase()}`:`image/jpeg`;return[{url:``,base64Data:`data:${r};base64,${n.base64String}`,mimeType:r}]}else return new Promise((e,t)=>{let n=document.createElement(`input`);n.type=`file`,n.accept=`image/*`,n.multiple=!0;let r=!1;n.onchange=async n=>{if(r)return;r=!0;let i=n.target.files;if(!i||i.length===0){e([]);return}try{e(await Promise.all(Array.from(i).map(e=>this.processFile(e))))}catch(e){t(e)}},n.oncancel=()=>{r||(r=!0,e([]))};let i=()=>{setTimeout(()=>{!r&&(!n.files||n.files.length===0)&&(r=!0,e([])),window.removeEventListener(`focus`,i)},300)};window.addEventListener(`focus`,i),n.click()})}catch(e){throw console.error(`选择图片失败:`,e),e}},async processFile(e){return new Promise((t,n)=>{try{let r=new FileReader;r.onload=r=>{if(!r.target||!r.target.result){n(Error(`读取文件失败`));return}let i=r.target.result,a=new Image;a.onload=()=>{t({url:``,base64Data:i,mimeType:e.type,width:a.width,height:a.height,size:e.size})},a.onerror=()=>{n(Error(`图片加载失败`))},a.src=i},r.onerror=()=>{n(Error(`读取文件失败`))},r.readAsDataURL(e)}catch(e){n(e)}})},async compressImage(e,t=1024){return new Promise((n,r)=>{try{if(!e.base64Data){n(e);return}let i=new Image;i.onload=()=>{let a=Math.round((e.base64Data?.length||0)*.75/1024);if(a<=t){n({...e,width:i.width,height:i.height});return}let o=document.createElement(`canvas`),s=o.getContext(`2d`);if(!s){r(Error(`无法创建Canvas上下文`));return}let c=2048,l=i.width,u=i.height;(l>c||u>c)&&(l>u?(u=Math.round(u*c/l),l=c):(l=Math.round(l*c/u),u=c)),l<56&&(l=56),u<56&&(u=56),o.width=l,o.height=u,s.clearRect(0,0,l,u),s.drawImage(i,0,0,l,u);let d=.85;a>t*2?d=.7:a>t*5&&(d=.5);let f=o.toDataURL(`image/jpeg`,d),p=Math.round(f.length*.75/1024),m=0;for(;p>t&&m<5;)m++,d*=.8,f=o.toDataURL(`image/jpeg`,d),p=Math.round(f.length*.75/1024);console.log(`图片压缩：原始大小=${a}KB, 压缩后=${p}KB, 质量=${d}, 尺寸=${l}x${u}`),n({...e,base64Data:f,mimeType:`image/jpeg`,width:l,height:u,size:p*1024})},i.onerror=()=>{r(Error(`图片加载失败`))},i.src=e.base64Data}catch(e){r(e)}})},ensureCorrectFormat(e){if(!e.base64Data)return e;if(!e.base64Data.startsWith(`data:`)){let t=e.mimeType||`image/jpeg`;return{...e,base64Data:`data:${t};base64,${e.base64Data}`}}if((!e.width||!e.height)&&e.base64Data){let t=new Image;t.onload=()=>{console.log(`获取到图片尺寸: ${t.width}x${t.height}`)},t.src=e.base64Data}return e},base64ToUint8Array(e){let t=e.split(`,`)[1],n=atob(t),r=new Uint8Array(n.length);for(let e=0;e<n.length;e++)r[e]=n.charCodeAt(e);return r}};export{a as n,d as t};