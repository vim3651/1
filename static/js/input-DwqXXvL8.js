const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["static/js/MobileKnowledgeService-SzgWqQxm.js","static/js/index-hvLbsAjx.js","static/css/index-iKlUzaLt.css","static/js/MultiModelSelector.solid-Cj_lkK-t.js","static/js/web-DV3rYUP8.js","static/js/providerIcons-C3i_yWyD.js","static/css/MultiModelSelector-Dy-EQBYZ.css","static/js/dist-js-DUJMg-md.js","static/js/core-Drq98oSU.js","static/js/dist-B5qeFBon.js","static/js/esm-DYZd5LID.js"])))=>i.map(i=>d[i]);
import{t as e}from"./arrow-left-right-Czyvlhqu.js";import{t}from"./book-open-Cg499jJK.js";import{t as n}from"./camera-DPY5JI0W.js";import{n as r,t as i}from"./ImageUploadService-Kd9CWXwm.js";import{t as a}from"./file-text-BSjgZddV.js";import{t as o}from"./file-GY4o0CHl.js";import{t as s}from"./image-7oImefSY.js";import{t as c}from"./keyboard-DPLpzxwl.js";import{i as l,t as u}from"./VoiceRecognition-BD7QZRqp.js";import{t as d}from"./mic-DOR2hOIQ.js";import{t as f}from"./play-CM6mFUlz.js";import{t as p}from"./plus-DCrdXXDc.js";import{t as m}from"./search-DqeTnaF8.js";import{t as h}from"./send-BodRSmN3.js";import{t as g}from"./video-D7kdqg3e.js";import{$d as _,$l as v,Al as y,Bd as b,Bu as x,Cd as S,Cp as C,Cu as w,Dn as T,Dp as E,Ef as D,Eu as O,Fu as k,Gd as A,Gi as j,Hd as M,Hu as N,In as P,Iu as F,Ju as I,Ki as L,Kn as R,Ln as z,Lu as ee,Md as B,Ml as te,Mp as ne,Mu as V,Nl as re,Nu as ie,Ol as ae,Pu as oe,Qd as se,Ql as H,Qu as ce,Rl as le,Sd as ue,Sp as de,St as fe,Su as U,Td as W,Tl as pe,Ud as me,Uu as he,Vd as ge,Vl as _e,Vu as ve,Wi as ye,Wu as be,Xt as xe,Yr as Se,Yt as G,Yu as Ce,Zd as K,Zl as we,Zt as Te,Zu as Ee,_u as De,a as Oe,ad as ke,af as q,au as Ae,bp as J,bt as je,ci as Me,cu as Ne,dd as Pe,dt as Fe,ed as Ie,ei as Le,et as Re,eu as ze,fd as Y,ft as Be,fu as Ve,gf as He,gu as Ue,hd as We,hu as Ge,id as Ke,jd as qe,jp as Je,ku as X,lt as Ye,md as Xe,mu as Ze,nd as Qe,o as $e,op as et,pp as tt,pu as nt,qd as rt,qp as it,qu as at,rr as ot,s as st,td as ct,vd as lt,wd as ut,wf as dt,wl as ft,xd as Z,xp as pt,xt as mt,xu as ht,yp as gt,zd as _t,zp as vt,zu as yt}from"./index-hvLbsAjx.js";import{t as bt}from"./esm-DlPY44W4.js";import{t as xt}from"./esm-C7HltxvG.js";import{t as St}from"./CustomIcon-BKBQb-ts.js";import{t as Ct}from"./QuickPhraseService-Vk3lcb6h.js";import{t as wt}from"./SolidBridge-4JuNrAWl.js";import{t as Tt}from"./settingsSelectors-BdPnPOZr.js";import{r as Et}from"./SimpleNoteService-DYyyUaKJ.js";import{t as Dt}from"./useVoiceRecognition-BsXW9Pyd.js";import{t as Ot}from"./useNotesSearch-D4OlEKjP.js";var Q=it(vt());function kt(e){let t=Q.useRef({});return Q.useEffect(()=>{t.current=e}),t.current}var At=kt;function jt(e){let{badgeContent:t,invisible:n=!1,max:r=99,showZero:i=!1}=e,a=At({badgeContent:t,max:r}),o=n;n===!1&&t===0&&!i&&(o=!0);let{badgeContent:s,max:c=r}=o?a:e,l=s&&Number(s)>c?`${c}+`:s;return{badgeContent:s,invisible:o,max:c,displayValue:l}}var Mt=jt;function Nt(e){return se(`MuiBadge`,e)}var Pt=K(`MuiBadge`,[`root`,`badge`,`dot`,`standard`,`anchorOriginTopRight`,`anchorOriginBottomRight`,`anchorOriginTopLeft`,`anchorOriginBottomLeft`,`invisible`,`colorError`,`colorInfo`,`colorPrimary`,`colorSecondary`,`colorSuccess`,`colorWarning`,`overlapRectangular`,`overlapCircular`,`anchorOriginTopLeftCircular`,`anchorOriginTopLeftRectangular`,`anchorOriginTopRightCircular`,`anchorOriginTopRightRectangular`,`anchorOriginBottomLeftCircular`,`anchorOriginBottomLeftRectangular`,`anchorOriginBottomRightCircular`,`anchorOriginBottomRightRectangular`]),$=it(pt()),Ft=10,It=4,Lt=e=>{let{color:t,anchorOrigin:n,invisible:r,overlap:i,variant:a,classes:o={}}=e;return A({root:[`root`],badge:[`badge`,a,r&&`invisible`,`anchorOrigin${ge(n.vertical)}${ge(n.horizontal)}`,`anchorOrigin${ge(n.vertical)}${ge(n.horizontal)}${ge(i)}`,`overlap${ge(i)}`,t!==`default`&&`color${ge(t)}`]},Nt,o)},Rt=M(`span`,{name:`MuiBadge`,slot:`Root`})({position:`relative`,display:`inline-flex`,verticalAlign:`middle`,flexShrink:0}),zt=M(`span`,{name:`MuiBadge`,slot:`Badge`,overridesResolver:(e,t)=>{let{ownerState:n}=e;return[t.badge,t[n.variant],t[`anchorOrigin${ge(n.anchorOrigin.vertical)}${ge(n.anchorOrigin.horizontal)}${ge(n.overlap)}`],n.color!==`default`&&t[`color${ge(n.color)}`],n.invisible&&t.invisible]}})(b(({theme:e})=>({display:`flex`,flexDirection:`row`,flexWrap:`wrap`,justifyContent:`center`,alignContent:`center`,alignItems:`center`,position:`absolute`,boxSizing:`border-box`,fontFamily:e.typography.fontFamily,fontWeight:e.typography.fontWeightMedium,fontSize:e.typography.pxToRem(12),minWidth:Ft*2,lineHeight:1,padding:`0 6px`,height:Ft*2,borderRadius:Ft,zIndex:1,transition:e.transitions.create(`transform`,{easing:e.transitions.easing.easeInOut,duration:e.transitions.duration.enteringScreen}),variants:[...Object.entries(e.palette).filter(W([`contrastText`])).map(([t])=>({props:{color:t},style:{backgroundColor:(e.vars||e).palette[t].main,color:(e.vars||e).palette[t].contrastText}})),{props:{variant:`dot`},style:{borderRadius:It,height:It*2,minWidth:It*2,padding:0}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`top`&&e.anchorOrigin.horizontal===`right`&&e.overlap===`rectangular`,style:{top:0,right:0,transform:`scale(1) translate(50%, -50%)`,transformOrigin:`100% 0%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(50%, -50%)`}}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`bottom`&&e.anchorOrigin.horizontal===`right`&&e.overlap===`rectangular`,style:{bottom:0,right:0,transform:`scale(1) translate(50%, 50%)`,transformOrigin:`100% 100%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(50%, 50%)`}}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`top`&&e.anchorOrigin.horizontal===`left`&&e.overlap===`rectangular`,style:{top:0,left:0,transform:`scale(1) translate(-50%, -50%)`,transformOrigin:`0% 0%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(-50%, -50%)`}}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`bottom`&&e.anchorOrigin.horizontal===`left`&&e.overlap===`rectangular`,style:{bottom:0,left:0,transform:`scale(1) translate(-50%, 50%)`,transformOrigin:`0% 100%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(-50%, 50%)`}}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`top`&&e.anchorOrigin.horizontal===`right`&&e.overlap===`circular`,style:{top:`14%`,right:`14%`,transform:`scale(1) translate(50%, -50%)`,transformOrigin:`100% 0%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(50%, -50%)`}}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`bottom`&&e.anchorOrigin.horizontal===`right`&&e.overlap===`circular`,style:{bottom:`14%`,right:`14%`,transform:`scale(1) translate(50%, 50%)`,transformOrigin:`100% 100%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(50%, 50%)`}}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`top`&&e.anchorOrigin.horizontal===`left`&&e.overlap===`circular`,style:{top:`14%`,left:`14%`,transform:`scale(1) translate(-50%, -50%)`,transformOrigin:`0% 0%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(-50%, -50%)`}}},{props:({ownerState:e})=>e.anchorOrigin.vertical===`bottom`&&e.anchorOrigin.horizontal===`left`&&e.overlap===`circular`,style:{bottom:`14%`,left:`14%`,transform:`scale(1) translate(-50%, 50%)`,transformOrigin:`0% 100%`,[`&.${Pt.invisible}`]:{transform:`scale(0) translate(-50%, 50%)`}}},{props:{invisible:!0},style:{transition:e.transitions.create(`transform`,{easing:e.transitions.easing.easeInOut,duration:e.transitions.duration.leavingScreen})}}]})));function Bt(e){return{vertical:e?.vertical??`top`,horizontal:e?.horizontal??`right`}}var Vt=Q.forwardRef(function(e,t){let n=_t({props:e,name:`MuiBadge`}),{anchorOrigin:r,className:i,classes:a,component:o,components:s={},componentsProps:c={},children:l,overlap:u=`rectangular`,color:d=`default`,invisible:f=!1,max:p=99,badgeContent:m,slots:h,slotProps:g,showZero:v=!1,variant:y=`standard`,...b}=n,{badgeContent:x,invisible:S,max:C,displayValue:w}=Mt({max:p,invisible:f,badgeContent:m,showZero:v}),T=At({anchorOrigin:Bt(r),color:d,overlap:u,variant:y,badgeContent:m}),E=S||x==null&&y!==`dot`,{color:D=d,overlap:O=u,anchorOrigin:k,variant:A=y}=E?T:n,j=Bt(k),M=A===`dot`?void 0:w,N={...n,badgeContent:x,invisible:E,max:C,displayValue:M,showZero:v,anchorOrigin:j,color:D,overlap:O,variant:A},P=Lt(N),F={slots:{root:h?.root??s.Root,badge:h?.badge??s.Badge},slotProps:{root:g?.root??c.root,badge:g?.badge??c.badge}},[I,L]=B(`root`,{elementType:Rt,externalForwardedProps:{...F,...b},ownerState:N,className:_(P.root,i),ref:t,additionalProps:{as:o}}),[R,z]=B(`badge`,{elementType:zt,externalForwardedProps:F,ownerState:N,className:P.badge});return(0,$.jsxs)(I,{...L,children:[l,(0,$.jsx)(R,{...z,children:M})]})}),Ht=U(`at-sign`,[[`circle`,{cx:`12`,cy:`12`,r:`4`,key:`4exip2`}],[`path`,{d:`M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-4 8`,key:`7n84p3`}]]),Ut=U(`bot-message-square`,[[`path`,{d:`M12 6V2H8`,key:`1155em`}],[`path`,{d:`M15 11v2`,key:`i11awn`}],[`path`,{d:`M2 12h2`,key:`1t8f8n`}],[`path`,{d:`M20 12h2`,key:`1q8mjw`}],[`path`,{d:`M20 16a2 2 0 0 1-2 2H8.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 4 20.286V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2z`,key:`11gyqh`}],[`path`,{d:`M9 11v2`,key:`1ueba0`}]]),Wt=U(`music`,[[`path`,{d:`M9 18V5l12-2v13`,key:`1jmyc2`}],[`circle`,{cx:`6`,cy:`18`,r:`3`,key:`fqmcym`}],[`circle`,{cx:`18`,cy:`16`,r:`3`,key:`1hluhg`}]]),Gt=U(`paperclip`,[[`path`,{d:`m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551`,key:`1miecu`}]]),Kt=({drawerId:e,open:t,onClose:n,children:r,...i})=>{let a=(0,Q.useId)();return L(e||`drawer-${a}`,!!t,()=>{n&&n({},`escapeKeyDown`)}),(0,$.jsx)(Ie,{open:t,onClose:n,...i,children:r})},qt=({knowledgeBaseName:e,onRemove:n})=>{let r=me(),i=r.palette.mode===`dark`;return(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,gap:.5,mb:1,px:1},children:(0,$.jsx)(lt,{icon:(0,$.jsx)(t,{size:14,color:i?`rgba(5, 150, 105, 0.9)`:`rgba(5, 150, 105, 0.8)`}),label:e,onDelete:n,deleteIcon:(0,$.jsx)(ft,{size:14}),size:`small`,sx:{backgroundColor:i?`rgba(5, 150, 105, 0.15)`:`rgba(5, 150, 105, 0.08)`,color:i?`rgba(5, 150, 105, 0.95)`:`rgba(5, 150, 105, 0.85)`,border:`1px solid ${i?`rgba(5, 150, 105, 0.3)`:`rgba(5, 150, 105, 0.2)`}`,fontWeight:500,height:28,"& .MuiChip-label":{fontWeight:500,fontSize:`0.8125rem`},"& .MuiChip-icon":{color:i?`rgba(5, 150, 105, 0.9)`:`rgba(5, 150, 105, 0.8)`},"& .MuiChip-deleteIcon":{color:i?`rgba(5, 150, 105, 0.9)`:`rgba(5, 150, 105, 0.8)`,"&:hover":{color:r.palette.error.main}}}})})};const Jt=({onSendMessage:e,onSendImagePrompt:t,isLoading:n=!1,allowConsecutiveMessages:r=!0,imageGenerationMode:i=!1,videoGenerationMode:a=!1,toolsEnabled:o=!1,images:s,files:c,setImages:l,setFiles:u,enableTextareaResize:d=!1,enableCompositionHandling:f=!1,enableCharacterCount:p=!1})=>{let[m,h]=(0,Q.useState)(``),g=(0,Q.useRef)(null),_=J(e=>e.settings.sendWithEnter),v=J(e=>e.settings.mobileInputMethodEnterAsNewline),y=me(),b=y.palette.mode===`dark`,x=w(y.breakpoints.down(`sm`)),S=w(y.breakpoints.between(`sm`,`md`)),[C,T]=(0,Q.useState)(d?x?32:S?36:34:40),[E,O]=(0,Q.useState)(!1),[k,A]=(0,Q.useState)(!1),[j,M]=(0,Q.useState)(!1),[N,P]=(0,Q.useState)(!1),F=(0,Q.useCallback)(()=>(m.trim()||s.length>0||c.length>0)&&(r||!n),[m,s.length,c.length,r,n]),I=(0,Q.useRef)(null),L=(0,Q.useCallback)(e=>{d&&(I.current&&clearTimeout(I.current),I.current=setTimeout(()=>{requestAnimationFrame(()=>{if(!e)return;let t=e.scrollHeight,n=Math.max(x?32:S?36:34,Math.min(t,120));e.style.height=`auto`,e.style.height=`${n}px`,T(e=>e===n?e:n)})},16))},[d,x,S]),R=(0,Q.useCallback)(async()=>{if(!m.trim()&&s.length===0&&c.length===0||n&&!r)return;let f=m.trim();if(i&&t){if(t(f),h(``),d){let e=x?24:28;T(e),g.current&&(g.current.style.height=`${e}px`)}return}if(a&&t){if(t(f),h(``),d){let e=x?24:28;T(e),g.current&&(g.current.style.height=`${e}px`)}return}let p=[...s,...c.filter(e=>e.mimeType.startsWith(`image/`)).map(e=>({base64Data:e.base64Data,url:e.url||``,width:e.width,height:e.height}))],_=await Promise.all(p.map(async e=>{let t=e.base64Data||e.url;if(e.url&&e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/)){let n=e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/);if(n&&n[1])try{let e=n[1],r=await D.getImageBlob(e);r&&(t=await new Promise(e=>{let t=new FileReader;t.onload=()=>e(t.result),t.readAsDataURL(r)}))}catch(e){console.error(`åŠ è½½å›¾ç‰‡å¼•ç”¨å¤±è´¥:`,e)}}return{type:`image_url`,image_url:{url:t}}})),v=c.filter(e=>!e.mimeType.startsWith(`image/`));if(e(f,_.length>0?_:void 0,o,v),(0,Q.startTransition)(()=>{h(``),l([]),u([]),M(!1),P(!1),A(!1)}),d){let e=x?24:28;T(e),g.current&&(g.current.style.height=`${e}px`)}},[m,s,c,n,r,i,a,t,d,x,e,o,h,l,u,T]),z=(0,Q.useCallback)(e=>{if(f&&(e.ctrlKey||e.metaKey))switch(e.key){case`a`:case`z`:case`y`:break}if(e.key===`Enter`&&!e.shiftKey&&(!f||!E)){if(x&&v)return;_&&(e.preventDefault(),R())}},[f,E,R,_,x,v]),ee=(0,Q.useCallback)(()=>{f&&O(!0)},[f]),B=(0,Q.useCallback)(e=>{f&&(O(!1),L(e.target))},[f,L]),te=(0,Q.useCallback)(e=>{let t=e.target.value,n=t.length;h(t),n>1e3&&window.requestIdleCallback?window.requestIdleCallback(()=>{(0,Q.startTransition)(()=>{M(n>5e3),P(n>1e4),p&&A(n>500)})},{timeout:100}):(0,Q.startTransition)(()=>{M(n>5e3),P(n>1e4),p&&A(n>500)}),d&&requestAnimationFrame(()=>{L(e.target)})},[p,d,L]);return(0,Q.useEffect)(()=>{p&&m.length<=500&&(0,Q.startTransition)(()=>{A(!1)})},[m,p]),(0,Q.useEffect)(()=>()=>{I.current&&clearTimeout(I.current)},[]),{message:m,setMessage:h,textareaRef:g,canSendMessage:F,handleSubmit:R,handleKeyDown:z,handleChange:te,textareaHeight:C,isComposing:E,showCharCount:k,adjustTextareaHeight:L,handleCompositionStart:ee,handleCompositionEnd:B,isLargeText:j,performanceWarning:N,isDarkMode:b,isMobile:x,isTablet:S}},Yt=()=>{let e=(0,Q.useCallback)(()=>{try{let e=window.sessionStorage.getItem(`selectedKnowledgeBase`);return e?JSON.parse(e):null}catch(e){return console.error(`è·å–çŸ¥è¯†åº“ä¸Šä¸‹æ–‡å¤±è´¥:`,e),null}},[]);return{getStoredKnowledgeContext:e,clearStoredKnowledgeContext:(0,Q.useCallback)(()=>{try{window.sessionStorage.removeItem(`selectedKnowledgeBase`)}catch(e){console.error(`æ¸…é™¤çŸ¥è¯†åº“ä¸Šä¸‹æ–‡å¤±è´¥:`,e)}},[]),applyKnowledgeContext:(0,Q.useCallback)(async(t,n=!0)=>{let r=e();if(!r||!r.isSelected||!r.searchOnSend)return t;try{console.log(`[useKnowledgeContext] å¼€å§‹æœç´¢çŸ¥è¯†åº“å†…å®¹...`);let{MobileKnowledgeService:e}=await Je(async()=>{let{MobileKnowledgeService:e}=await import(`./MobileKnowledgeService-SzgWqQxm.js`);return{MobileKnowledgeService:e}},__vite__mapDeps([0,1,2])),i=await e.getInstance().search({knowledgeBaseId:r.knowledgeBase.id,query:t.trim(),threshold:.6,limit:r.knowledgeBase.documentCount||5});if(console.log(`[useKnowledgeContext] æœç´¢åˆ° ${i.length} ä¸ªç›¸å…³å†…å®¹`),i.length===0)return console.log(`[useKnowledgeContext] æœªæ‰¾åˆ°ç›¸å…³å†…å®¹`),t;let a=i.map((e,t)=>({id:t+1,content:e.content,type:`file`,similarity:e.similarity,knowledgeBaseId:r.knowledgeBase.id,knowledgeBaseName:r.knowledgeBase.name,sourceUrl:`knowledge://${r.knowledgeBase.id}/${e.documentId||t}`}));if(n){let e=`\`\`\`json\n${JSON.stringify(a,null,2)}\n\`\`\``,n=fe.replace(`{question}`,t).replace(`{references}`,e);return console.log(`[useKnowledgeContext] åº”ç”¨REFERENCE_PROMPTæ ¼å¼`),n}else{let e=`

--- çŸ¥è¯†åº“å‚è€ƒå†…å®¹ ---
`;return e+=`\n[${r.knowledgeBase.name}]:\n`,a.forEach((t,n)=>{let r=t.similarity?` (ç›¸ä¼¼åº¦: ${(t.similarity*100).toFixed(1)}%)`:``;e+=`${n+1}. ${t.content}${r}\n`}),e+=`
--- è¯·åŸºäºä»¥ä¸ŠçŸ¥è¯†åº“å†…å®¹å›ç­”é—®é¢˜ ---
`,console.log(`[useKnowledgeContext] åº”ç”¨ç®€å•æ–‡æœ¬æ ¼å¼`),t+e}}catch(e){return console.error(`æœç´¢çŸ¥è¯†åº“å¤±è´¥:`,e),t}},[e]),hasKnowledgeContext:(0,Q.useCallback)(()=>{let t=e();return!!(t&&t.isSelected&&t.searchOnSend)},[e]),getKnowledgeContextSummary:(0,Q.useCallback)(()=>{let t=e();return!t||!t.isSelected?null:`${t.knowledgeBase?.name||`æœªçŸ¥çŸ¥è¯†åº“`} (å°†åœ¨å‘é€æ—¶æœç´¢)`},[e])}},Xt=()=>{let e=me().palette.mode===`dark`,t=J(e=>e.settings.inputBoxStyle||`default`);return{styles:(0,Q.useMemo)(()=>{let n={inputBg:`transparent`,iconBg:e?`rgba(40, 40, 40, 0.8)`:`rgba(248, 250, 252, 0.8)`,border:e?`1px solid rgba(60, 60, 60, 0.8)`:`1px solid rgba(230, 230, 230, 0.8)`,borderRadius:`8px`,boxShadow:e?`0 2px 8px rgba(0,0,0,0.3)`:`0 2px 8px rgba(0,0,0,0.1)`};switch(t){case`modern`:return{...n,inputBg:`transparent`,borderRadius:`12px`,boxShadow:e?`0 4px 16px rgba(0,0,0,0.4)`:`0 4px 16px rgba(0,0,0,0.15)`};case`minimal`:return{...n,inputBg:`transparent`,border:e?`1px solid rgba(255, 255, 255, 0.1)`:`1px solid rgba(0, 0, 0, 0.1)`,borderRadius:`6px`,boxShadow:`none`};default:return n}},[e,t]),isDarkMode:e,inputBoxStyle:t}};var Zt=({open:e,onClose:t,availableModels:n,onSelectionChange:r,selectedModels:i,maxSelection:a=5})=>{let o=me(),s=w(o.breakpoints.down(`sm`)),c=o.palette.mode,[l,u]=(0,Q.useState)(null);(0,Q.useEffect)(()=>{Je(()=>import(`./MultiModelSelector.solid-Cj_lkK-t.js`),__vite__mapDeps([3,1,2,4,5,6])).then(e=>{u(()=>e.MultiModelSelector)})},[]);let d=J(Tt),f=(0,Q.useMemo)(()=>({open:e,onClose:t,availableModels:n,onSelectionChange:r,selectedModels:i,maxSelection:a,providers:d,themeMode:c,fullScreen:s}),[e,t,n,r,i,a,d,c,s]);return!e||!l?null:(0,$.jsx)(wt,{component:l,props:f,debugName:`MultiModelSelector`})},Qt=({anchorEl:r,open:i,onClose:o,onImageUpload:c,onFileUpload:l,onMultiModelSend:u,showMultiModel:d=!1,onAIDebate:f,showAIDebate:p=!1,isDebating:m=!1,onQuickPhrase:h,showQuickPhrase:g=!1,onNoteSelect:_,showNote:v=!1})=>(L(`upload-menu-${(0,Q.useId)()}`,i,o),(0,$.jsxs)(ee,{anchorEl:r,open:i,onClose:o,disableAutoFocus:!0,disableRestoreFocus:!0,disableEnforceFocus:!0,anchorOrigin:{vertical:`top`,horizontal:`center`},transformOrigin:{vertical:`bottom`,horizontal:`center`},slotProps:{paper:{sx:{minWidth:`200px`,borderRadius:`12px`,boxShadow:`0 4px 20px rgba(0,0,0,0.15)`}},root:{slotProps:{backdrop:{invisible:!1,sx:{backgroundColor:`transparent`}}}}},sx:{"& .MuiList-root":{"&:focus":{outline:`none`}}},children:[(0,$.jsxs)(F,{onClick:()=>{c(`photos`),o()},sx:{py:1.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(s,{size:20,color:`#1976d2`})}),(0,$.jsx)(yt,{primary:`ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡`})]}),(0,$.jsxs)(F,{onClick:()=>{c(`camera`),o()},sx:{py:1.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(n,{size:20,color:`#9c27b0`})}),(0,$.jsx)(yt,{primary:`æ‹æ‘„ç…§ç‰‡`})]}),(0,$.jsxs)(F,{onClick:()=>{l(),o()},sx:{py:1.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(a,{size:20,color:`#4caf50`})}),(0,$.jsx)(yt,{primary:`ä¸Šä¼ æ–‡ä»¶`})]}),v&&_&&[(0,$.jsx)(ct,{sx:{my:.5}},`note-divider`),(0,$.jsxs)(F,{onClick:()=>{_(),o()},sx:{py:1.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(t,{size:20,color:`#ff9800`})}),(0,$.jsx)(yt,{primary:`æ·»åŠ ç¬”è®°`,secondary:`ä»ç¬”è®°ä¸­é€‰æ‹©å†…å®¹å‘é€`,sx:{"& .MuiListItemText-secondary":{fontSize:`0.75rem`,color:`text.secondary`}}})]},`note-item`)],p&&f&&[(0,$.jsx)(ct,{sx:{my:.5}},`ai-debate-divider`),(0,$.jsxs)(F,{onClick:()=>{f(),o()},sx:{py:1.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(St,{name:`aiDebate`,size:20,color:`currentColor`})}),(0,$.jsx)(yt,{primary:m?`åœæ­¢AIè¾©è®º`:`å¼€å§‹AIè¾©è®º`,secondary:m?`ç»“æŸå½“å‰è¾©è®º`:`å¤šAIè§’è‰²è¾©è®ºåŠŸèƒ½`,sx:{"& .MuiListItemText-secondary":{fontSize:`0.75rem`,color:`text.secondary`}}})]},`ai-debate-item`)],g&&h&&[(0,$.jsx)(ct,{sx:{my:.5}},`quick-phrase-divider`),(0,$.jsxs)(F,{onClick:()=>{h(),o()},sx:{py:1.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(St,{name:`quickPhrase`,size:20,color:`currentColor`})}),(0,$.jsx)(yt,{primary:`å¿«æ·çŸ­è¯­`,secondary:`æ’å…¥é¢„è®¾çš„æ–‡æœ¬çŸ­è¯­`,sx:{"& .MuiListItemText-secondary":{fontSize:`0.75rem`,color:`text.secondary`}}})]},`quick-phrase-item`)],d&&u&&[(0,$.jsx)(ct,{sx:{my:.5}},`multi-model-divider`),(0,$.jsxs)(F,{onClick:()=>{u(),o()},sx:{py:1.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(e,{size:20})}),(0,$.jsx)(yt,{primary:`å‘é€åˆ°å¤šä¸ªæ¨¡å‹`,secondary:`åŒæ—¶å‘å¤šä¸ªAIæ¨¡å‹å‘é€æ¶ˆæ¯`,sx:{"& .MuiListItemText-secondary":{fontSize:`0.75rem`,color:`text.secondary`}}})]},`multi-model-item`)]]})),$t=50*1024*1024;const en={async selectFiles(){try{if(ne.isNativePlatform()){let e=await xt.pickFiles({readData:!0});if(!e||!e.files||e.files.length===0)return[];let t=[];for(let n of e.files){if(n.size>$t){await bt.show({text:`æ–‡ä»¶ ${n.name} å¤ªå¤§ï¼Œæœ€å¤§å…è®¸50MB`,duration:`long`});continue}try{let e=await mt.uploadFile({name:n.name,mimeType:n.mimeType,size:n.size,base64Data:n.data?`data:${n.mimeType};base64,${n.data}`:``}),r={name:n.name,mimeType:n.mimeType,extension:n.name.split(`.`).pop()||``,size:n.size,base64Data:e.base64Data?`data:${n.mimeType};base64,${e.base64Data}`:void 0,url:``,fileId:e.id,fileRecord:e};if(n.mimeType.startsWith(`image/`)&&e.base64Data)try{let t=await this.getImageDimensions(`data:${n.mimeType};base64,${e.base64Data}`);r.width=t.width,r.height=t.height}catch(e){console.warn(`è·å–å›¾ç‰‡å°ºå¯¸å¤±è´¥:`,e)}t.push(r)}catch(e){console.error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥:`,e),await bt.show({text:`æ–‡ä»¶ ${n.name} ä¸Šä¼ å¤±è´¥: ${e instanceof Error?e.message:`æœªçŸ¥é”™è¯¯`}`,duration:`long`})}}return t}else return new Promise((e,t)=>{let n=document.createElement(`input`);n.type=`file`,n.multiple=!0;let r=!1;n.onchange=async n=>{if(r)return;r=!0;let i=n.target.files;if(!i||i.length===0){e([]);return}try{let t=Array.from(i).filter(e=>e.size>$t?(alert(`æ–‡ä»¶ ${e.name} å¤ªå¤§ï¼Œæœ€å¤§å…è®¸50MB`),!1):!0);if(t.length===0){e([]);return}let n=[];for(let e of t)try{let t=await mt.uploadFile({name:e.name,mimeType:e.type,size:e.size,base64Data:await this.readFileAsBase64(e)}),r={name:e.name,mimeType:e.type,extension:e.name.split(`.`).pop()||``,size:e.size,base64Data:t.base64Data?`data:${e.type};base64,${t.base64Data}`:void 0,url:``,fileId:t.id,fileRecord:t};if(e.type.startsWith(`image/`)&&t.base64Data)try{let n=await this.getImageDimensions(`data:${e.type};base64,${t.base64Data}`);r.width=n.width,r.height=n.height}catch(e){console.warn(`è·å–å›¾ç‰‡å°ºå¯¸å¤±è´¥:`,e)}n.push(r)}catch(t){console.error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥:`,t),alert(`æ–‡ä»¶ ${e.name} ä¸Šä¼ å¤±è´¥: ${t instanceof Error?t.message:`æœªçŸ¥é”™è¯¯`}`)}e(n)}catch(e){t(e)}},n.oncancel=()=>{r||(r=!0,e([]))};let i=()=>{setTimeout(()=>{!r&&(!n.files||n.files.length===0)&&(r=!0,e([])),window.removeEventListener(`focus`,i)},300)};window.addEventListener(`focus`,i),n.click()})}catch(e){throw console.error(`é€‰æ‹©æ–‡ä»¶å¤±è´¥:`,e),await bt.show({text:`é€‰æ‹©æ–‡ä»¶å¤±è´¥: `+(e instanceof Error?e.message:String(e)),duration:`long`}),e}},getFileIconByMimeType(e){return e.startsWith(`image/`)?`image`:e.startsWith(`video/`)?`video`:e.startsWith(`audio/`)?`audio`:e.includes(`pdf`)?`picture_as_pdf`:e.includes(`word`)||e.includes(`document`)?`description`:e.includes(`spreadsheet`)||e.includes(`excel`)?`table_chart`:e.includes(`presentation`)||e.includes(`powerpoint`)?`slideshow`:e.includes(`text/`)?`text_snippet`:`insert_drive_file`},async readFileAsBase64(e){return new Promise((t,n)=>{let r=new FileReader;r.onload=e=>{if(!e.target||!e.target.result){n(Error(`è¯»å–æ–‡ä»¶å¤±è´¥`));return}t(e.target.result)},r.onerror=()=>{n(Error(`è¯»å–æ–‡ä»¶å¤±è´¥`))},r.readAsDataURL(e)})},async getImageDimensions(e){return new Promise((t,n)=>{let r=new Image;r.onload=()=>{t({width:r.width,height:r.height})},r.onerror=()=>{n(Error(`å›¾ç‰‡åŠ è½½å¤±è´¥`))},r.src=e})},formatFileSize(e){if(e===0)return`0 B`;let t=[`B`,`KB`,`MB`,`GB`,`TB`],n=Math.floor(Math.log(e)/Math.log(1024));return(e/1024**n).toFixed(2)+` `+t[n]}},tn=({currentTopicState:e,setUploadingMedia:t})=>({handleImageUpload:async(n=`photos`)=>{try{t(!0);let r;try{r=await i.selectImages(n)}catch(e){let n=e?.message||String(e);return n.includes(`cancel`)||n.includes(`å–æ¶ˆ`)||n.includes(`User cancelled`)?(t(!1),[]):(console.error(`é€‰æ‹©å›¾ç‰‡æ—¶å‡ºé”™:`,e),t(!1),[])}if(r.length===0)return t(!1),[];let a=r.length,o=0,s=(e=1)=>{o+=e,console.log(`å¤„ç†å›¾ç‰‡è¿›åº¦: ${o}/${a}`)},c=(await Promise.all(r.map(async(t,n)=>{try{let n=await i.compressImage(t,1024);if(s(.5),e&&e.id)try{let t=await D.saveBase64Image(n.base64Data||``,{mimeType:n.mimeType,width:n.width,height:n.height,size:n.size,topicId:e.id});return s(.5),{url:`[å›¾ç‰‡:${t}]`,mimeType:n.mimeType,width:n.width,height:n.height}}catch(e){return console.warn(`[useFileUpload] æ•°æ®åº“å­˜å‚¨å›¾ç‰‡å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜ä¸­çš„å›¾ç‰‡:`,e),s(.5),n}else{console.log(`[useFileUpload] å½“å‰æ²¡æœ‰è¯é¢˜æˆ–è¯é¢˜IDï¼Œç›´æ¥ä½¿ç”¨å‹ç¼©åçš„å›¾ç‰‡`);let e=i.ensureCorrectFormat(n);return s(.5),e}}catch(e){return console.error(`[useFileUpload] å¤„ç†ç¬¬ ${n+1} å¼ å›¾ç‰‡æ—¶å‡ºé”™:`,e),s(1),null}}))).filter(e=>e!==null);return t(!1),c}catch(e){let n=e?.message||String(e);return console.error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥:`,e),t(!1),n.includes(`cancel`)||n.includes(`å–æ¶ˆ`)||n.includes(`User cancelled`),[]}},handleFileUpload:async()=>{try{t(!0);let e=await en.selectFiles();return e.length===0?(t(!1),[]):(t(!1),e)}catch(e){throw console.error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥:`,e),t(!1),e}}});var nn={TEXT:`text`};const rn=class e{static instance;runtime;constructor(){this.runtime=C(),console.log(`[LongTextPasteService] åˆå§‹åŒ–ï¼Œè¿è¡Œæ—¶:`,this.runtime)}static getInstance(){return e.instance||=new e,e.instance}async handleTextPaste(e,t){if(!t.enabled||e.length<=t.threshold)return{success:!0,convertedToFile:!1,text:e};try{return{success:!0,convertedToFile:!0,file:await this.convertTextToFile(e)}}catch(e){return console.error(`[LongTextPasteService] è½¬æ¢æ–‡æœ¬ä¸ºæ–‡ä»¶å¤±è´¥:`,e),{success:!1,convertedToFile:!1,error:e instanceof Error?e.message:`è½¬æ¢å¤±è´¥`}}}async convertTextToFile(e){let t=`ç²˜è´´çš„æ–‡æœ¬_${new Date().toISOString().slice(0,19).replace(/[:-]/g,``)}.txt`,n=et(),r=new TextEncoder().encode(e),i=`data:text/plain;base64,${this.arrayBufferToBase64(r)}`,a=new Blob([e],{type:`text/plain`}).size,o=await this.saveFile({id:n,name:t,mimeType:`text/plain`,size:a,base64Data:i,text:e});return{name:t,mimeType:`text/plain`,extension:`.txt`,size:a,base64Data:i,url:o.path||``,fileId:o.id,fileRecord:o}}async saveFile(e){let t={id:e.id,name:e.id+`.txt`,origin_name:e.name,path:``,size:e.size,ext:`.txt`,type:nn.TEXT,mimeType:e.mimeType,base64Data:e.base64Data,created_at:new Date().toISOString(),count:1,textContent:e.text},n=t.textContent;switch(this.runtime){case de.TAURI:await this.saveFileForTauri(t,n||``);break;case de.CAPACITOR:await this.saveFileForCapacitor(t,n||``);break;default:await this.saveFileForWeb(t)}return t}async saveFileForTauri(e,t){try{let n=globalThis;if(n.__TAURI__?.fs||n.__TAURI_INTERNALS__)try{let{writeTextFile:n,BaseDirectory:r}=await Je(async()=>{let{writeTextFile:e,BaseDirectory:t}=await import(`./dist-js-DUJMg-md.js`);return{writeTextFile:e,BaseDirectory:t}},__vite__mapDeps([7,8])),i=`AetherLink/files/${e.name}`;await n(i,t,{baseDir:r.AppData}),e.path=i,console.log(`[LongTextPasteService] Tauri æ–‡ä»¶ä¿å­˜æˆåŠŸ:`,i)}catch{console.warn(`[LongTextPasteService] Tauri v2 API ä¸å¯ç”¨ï¼Œä½¿ç”¨ Dexie å­˜å‚¨`),await this.saveFileForWeb(e)}else await this.saveFileForWeb(e)}catch(t){console.error(`[LongTextPasteService] Tauri ä¿å­˜å¤±è´¥ï¼Œé™çº§åˆ° Dexie:`,t),await this.saveFileForWeb(e)}}async saveFileForCapacitor(e,t){try{let{Capacitor:n}=await Je(async()=>{let{Capacitor:e}=await import(`./dist-B5qeFBon.js`);return{Capacitor:e}},__vite__mapDeps([9,1,2]));if(n.isNativePlatform()){let{Directory:n,Encoding:r,Filesystem:i}=await Je(async()=>{let{Directory:e,Encoding:t,Filesystem:n}=await import(`./esm-DYZd5LID.js`);return{Directory:e,Encoding:t,Filesystem:n}},__vite__mapDeps([10,1,2])),a=`AetherLink/files/${e.name}`;try{await i.mkdir({path:`AetherLink/files`,directory:n.Data,recursive:!0})}catch{}await i.writeFile({path:a,data:t,directory:n.Data,encoding:r.UTF8}),e.path=a,console.log(`[LongTextPasteService] Capacitor æ–‡ä»¶ä¿å­˜æˆåŠŸ:`,a)}else await this.saveFileForWeb(e)}catch(t){console.error(`[LongTextPasteService] Capacitor ä¿å­˜å¤±è´¥ï¼Œé™çº§åˆ° Dexie:`,t),await this.saveFileForWeb(e)}try{await D.files.put(e)}catch(e){console.warn(`[LongTextPasteService] Dexie å¤‡ä»½ä¿å­˜å¤±è´¥:`,e)}}async saveFileForWeb(e){try{await D.files.put(e),console.log(`[LongTextPasteService] Web/Dexie æ–‡ä»¶ä¿å­˜æˆåŠŸ:`,e.id)}catch(e){throw console.error(`[LongTextPasteService] Dexie ä¿å­˜å¤±è´¥:`,e),e}}arrayBufferToBase64(e){let t=``,n=new Uint8Array(e),r=n.byteLength;for(let e=0;e<r;e++)t+=String.fromCharCode(n[e]);return btoa(t)}shouldConvertToFile(e,t){return t.enabled&&e.length>t.threshold}getRuntime(){return this.runtime}}.getInstance();function an(e={}){let{onFileAdd:t,onError:n,onSuccess:r}=e,i=J(e=>e.settings.pasteLongTextAsFile??!1),a=J(e=>e.settings.pasteLongTextThreshold??1500),o=(0,Q.useCallback)(e=>rn.shouldConvertToFile(e,{enabled:i,threshold:a}),[i,a]);return{handlePaste:(0,Q.useCallback)(async e=>{let s=e.clipboardData;if(!s)return!1;let c=s.getData(`text`);if(!c||!o(c))return!1;try{let e=await rn.handleTextPaste(c,{enabled:i,threshold:a});if(e.success&&e.convertedToFile&&e.file){t?.(e.file);let n=e.file.name;return r?.(`é•¿æ–‡æœ¬å·²è½¬æ¢ä¸ºæ–‡ä»¶: ${n}`),!0}else if(!e.success&&e.error)return n?.(e.error),!1;return!1}catch(e){return console.error(`[useLongTextPaste] å¤„ç†å¤±è´¥:`,e),n?.(e instanceof Error?e.message:`é•¿æ–‡æœ¬è½¬æ–‡ä»¶å¤±è´¥`),!1}},[i,a,o,t,n,r]),shouldConvertToFile:o,isEnabled:i,threshold:a}}var on=({file:e,onRemove:t,status:n=`success`,progress:r=0,error:i,compact:c=!1,draggable:l=!1,onDragStart:u,onDragEnd:d})=>{let f=me(),[p,m]=(0,Q.useState)(!1),h=je(e.name),_=()=>{let t=e.mimeType.toLowerCase(),n=c?16:24;return t.startsWith(`image/`)?(0,$.jsx)(s,{size:n,color:`#2196f3`}):t.startsWith(`video/`)?(0,$.jsx)(g,{size:n,color:`#f44336`}):t.startsWith(`audio/`)?(0,$.jsx)(Wt,{size:n,color:`#4caf50`}):t.includes(`pdf`)?(0,$.jsx)(a,{size:n,color:`#e53935`}):t.includes(`word`)||t.includes(`document`)?(0,$.jsx)(a,{size:n,color:`#1565c0`}):h===`code`?(0,$.jsx)(Ne,{size:n,color:`#ff9800`}):t.includes(`text/`)?(0,$.jsx)(a,{size:n,color:`#757575`}):(0,$.jsx)(o,{size:n,color:`#9e9e9e`})},v=()=>{switch(n){case`success`:return(0,$.jsx)(Ve,{size:16,color:`#4caf50`});case`error`:return(0,$.jsx)(nt,{size:16,color:`#f44336`});case`uploading`:case`validating`:return null;default:return null}},y=()=>{switch(h){case`image`:return`#2196f3`;case`video`:return`#f44336`;case`audio`:return`#4caf50`;case`code`:return`#ff9800`;case`text`:return`#757575`;case`document`:return`#9c27b0`;default:return`#607d8b`}},b=e=>{m(!0),u?.(e)},x=e=>{m(!1),d?.(e)};return c?(0,$.jsx)(X,{title:i||`${e.name} (${en.formatFileSize(e.size)})`,children:(0,$.jsxs)(Y,{draggable:l,onDragStart:b,onDragEnd:x,sx:{display:`inline-flex`,alignItems:`center`,padding:`4px 8px`,margin:`2px`,borderRadius:`16px`,backgroundColor:n===`error`?`rgba(244, 67, 54, 0.1)`:`rgba(0, 0, 0, 0.08)`,border:n===`error`?`1px solid rgba(244, 67, 54, 0.3)`:`none`,position:`relative`,cursor:l?`grab`:`default`,opacity:p?.5:1,transition:`all 0.2s ease`,maxWidth:`200px`,"&:hover":{backgroundColor:n===`error`?`rgba(244, 67, 54, 0.15)`:`rgba(0, 0, 0, 0.12)`}},children:[l&&(0,$.jsx)(we,{size:12,color:`rgba(0, 0, 0, 0.4)`,style:{marginRight:`4px`}}),(0,$.jsx)(Y,{sx:{marginRight:`6px`,display:`flex`,alignItems:`center`},children:_()}),(0,$.jsx)(Z,{variant:`caption`,sx:{fontWeight:500,textOverflow:`ellipsis`,overflow:`hidden`,whiteSpace:`nowrap`,maxWidth:`100px`,marginRight:`6px`},children:e.name}),v(),(0,$.jsx)(S,{size:`small`,onClick:t,sx:{marginLeft:`4px`,padding:`2px`,width:`16px`,height:`16px`,color:`rgba(0, 0, 0, 0.6)`,"&:hover":{color:`#f44336`,backgroundColor:`rgba(244, 67, 54, 0.1)`}},children:(0,$.jsx)(ft,{size:12})}),(n===`uploading`||n===`validating`)&&(0,$.jsx)(at,{variant:r>0?`determinate`:`indeterminate`,value:r,sx:{position:`absolute`,bottom:0,left:0,right:0,height:`2px`,borderRadius:`0 0 16px 16px`}})]})}):(0,$.jsxs)(Y,{draggable:l,onDragStart:b,onDragEnd:x,sx:{display:`flex`,alignItems:`center`,padding:`12px`,borderRadius:`12px`,backgroundColor:n===`error`?`rgba(244, 67, 54, 0.05)`:f.palette.mode===`dark`?`rgba(255, 255, 255, 0.05)`:`rgba(0, 0, 0, 0.03)`,border:n===`error`?`1px solid rgba(244, 67, 54, 0.3)`:`1px solid rgba(0, 0, 0, 0.08)`,position:`relative`,margin:`8px 0`,maxWidth:`100%`,cursor:l?`grab`:`default`,opacity:p?.5:1,transition:`all 0.2s ease`,"&:hover":{backgroundColor:n===`error`?`rgba(244, 67, 54, 0.08)`:f.palette.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.06)`}},children:[l&&(0,$.jsx)(Y,{sx:{marginRight:`8px`,display:`flex`,alignItems:`center`},children:(0,$.jsx)(we,{size:20,color:`rgba(0, 0, 0, 0.4)`})}),(0,$.jsx)(Y,{sx:{marginRight:`12px`,display:`flex`,alignItems:`center`},children:_()}),(0,$.jsxs)(Y,{sx:{flexGrow:1,overflow:`hidden`,marginRight:`12px`},children:[(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,marginBottom:`4px`},children:[(0,$.jsx)(Z,{variant:`body2`,sx:{fontWeight:500,textOverflow:`ellipsis`,overflow:`hidden`,whiteSpace:`nowrap`,maxWidth:`250px`,marginRight:`8px`},children:e.name}),(0,$.jsx)(lt,{label:h.toUpperCase(),size:`small`,sx:{height:`20px`,fontSize:`10px`,fontWeight:`bold`,backgroundColor:y(),color:`white`,"& .MuiChip-label":{padding:`0 6px`}}})]}),(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:`8px`},children:[(0,$.jsx)(Z,{variant:`caption`,color:`textSecondary`,children:en.formatFileSize(e.size)}),n===`uploading`&&(0,$.jsxs)(Z,{variant:`caption`,color:`primary`,children:[`ä¸Šä¼ ä¸­... `,r>0&&`${Math.round(r)}%`]}),n===`validating`&&(0,$.jsx)(Z,{variant:`caption`,color:`warning.main`,children:`éªŒè¯ä¸­...`}),n===`error`&&i&&(0,$.jsx)(Z,{variant:`caption`,color:`error`,children:i}),n===`success`&&(0,$.jsx)(Z,{variant:`caption`,color:`success.main`,children:`å°±ç»ª`})]})]}),(0,$.jsx)(Y,{sx:{marginRight:`8px`},children:v()}),(0,$.jsx)(S,{size:`small`,onClick:t,sx:{color:`rgba(0, 0, 0, 0.6)`,"&:hover":{color:`#f44336`,backgroundColor:`rgba(244, 67, 54, 0.1)`}},children:(0,$.jsx)(ft,{size:20})}),(n===`uploading`||n===`validating`)&&(0,$.jsx)(at,{variant:r>0?`determinate`:`indeterminate`,value:r,sx:{position:`absolute`,bottom:0,left:0,right:0,height:`3px`,borderRadius:`0 0 12px 12px`}})]})},sn=({files:e,images:t,onRemoveFile:n,onRemoveImage:r,fileStatuses:i={},compact:a=!0,maxVisibleItems:o=3})=>{let s=me(),[c,l]=(0,Q.useState)(!1),[u,d]=(0,Q.useState)({});(0,Q.useEffect)(()=>{d(e=>{let n={};return t.forEach((t,r)=>{let i=r.toString();e[i]&&(n[i]=e[i])}),n})},[t.length]);let f=(0,Q.useCallback)(async(e,t)=>{try{let n=`img_cache_${e}`,r=sessionStorage.getItem(n);if(r){d(e=>({...e,[t]:r}));return}let i=await D.getImageBlob(e);if(!i){console.warn(`å›¾ç‰‡ä¸å­˜åœ¨:`,e);return}let a=URL.createObjectURL(i);sessionStorage.setItem(n,a),d(e=>({...e,[t]:a}))}catch(e){console.error(`åŠ è½½å›¾ç‰‡å¼•ç”¨å¤±è´¥:`,e)}},[]),p=(0,Q.useCallback)((e,t)=>{if(e.base64Data)return e.base64Data;if(e.url){let n=e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/);if(n&&n[1]){let e=n[1];return u[t]?u[t]:(f(e,t),``)}return e.url}return``},[u,f]),m=e.length+t.length,h=m>0,g=m>o,_=c?e:e.slice(0,Math.max(0,o-t.length)),v=c?t:t.slice(0,o);return h?(0,$.jsxs)(Y,{sx:{width:`100%`,marginBottom:`8px`,borderRadius:`12px`,backgroundColor:s.palette.background.paper,border:`1px solid ${s.palette.divider}`,overflow:`hidden`,transition:`all 0.3s ease`},children:[(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,justifyContent:`space-between`,padding:`8px 12px`,backgroundColor:s.palette.action.hover,borderBottom:`1px solid ${s.palette.divider}`},children:[(0,$.jsxs)(Z,{variant:`caption`,color:`textSecondary`,sx:{fontWeight:500},children:[m,` ä¸ªæ–‡ä»¶å·²é€‰æ‹©`]}),g&&(0,$.jsx)(S,{size:`small`,onClick:()=>l(!c),sx:{padding:`2px`,color:s.palette.text.secondary,"&:hover":{backgroundColor:s.palette.action.hover}},children:c?(0,$.jsx)(Ze,{fontSize:`small`}):(0,$.jsx)(De,{fontSize:`small`})})]}),(0,$.jsxs)(Y,{sx:{padding:`8px`},children:[v.length>0&&(0,$.jsx)(Y,{sx:{display:`flex`,flexWrap:`wrap`,gap:`6px`,marginBottom:_.length>0?`8px`:0},children:v.map((e,t)=>{let n=e.id||`image-${t}-${e.name||`unnamed`}-${e.size||Date.now()}`,i=p(e,t);return(0,$.jsxs)(Y,{sx:{position:`relative`,width:`48px`,height:`48px`,borderRadius:`8px`,overflow:`hidden`,border:`1px solid rgba(0, 0, 0, 0.1)`,backgroundColor:i?`transparent`:`rgba(0, 0, 0, 0.05)`},children:[i?(0,$.jsx)(`img`,{src:i,alt:`é¢„è§ˆ ${t+1}`,style:{width:`100%`,height:`100%`,objectFit:`cover`},onError:t=>{console.warn(`å›¾ç‰‡åŠ è½½å¤±è´¥:`,e),t.currentTarget.style.display=`none`}}):(0,$.jsx)(Y,{sx:{width:`100%`,height:`100%`,display:`flex`,alignItems:`center`,justifyContent:`center`,fontSize:`12px`,color:`rgba(0, 0, 0, 0.5)`},children:`åŠ è½½ä¸­...`}),(0,$.jsx)(S,{size:`small`,onClick:()=>r(t),sx:{position:`absolute`,top:-6,right:-6,backgroundColor:`rgba(0, 0, 0, 0.7)`,color:`white`,padding:`2px`,width:`16px`,height:`16px`,"&:hover":{backgroundColor:`rgba(244, 67, 54, 0.8)`}},children:(0,$.jsx)(De,{size:10,style:{transform:`rotate(45deg)`}})})]},n)})}),_.length>0&&(0,$.jsx)(Y,{sx:{display:`flex`,flexWrap:`wrap`,gap:`4px`},children:_.map((e,t)=>{let r=i[`${e.name}-${e.size}`],o=e.id||`file-${t}-${e.name}-${e.size||Date.now()}`;return(0,$.jsx)(on,{file:e,onRemove:()=>n(t),compact:a,status:r?.status,progress:r?.progress,error:r?.error,draggable:!1},o)})}),(0,$.jsx)(qe,{in:c,children:(0,$.jsxs)(Y,{sx:{marginTop:`8px`},children:[t.length>o&&(0,$.jsx)(Y,{sx:{display:`flex`,flexWrap:`wrap`,gap:`6px`,marginBottom:`8px`},children:t.slice(o).map((e,t)=>{let n=o+t,i=e.id?`extra-${e.id}`:`extra-image-${n}-${e.name||`unnamed`}-${e.size||Date.now()}`,a=p(e,n);return(0,$.jsxs)(Y,{sx:{position:`relative`,width:`48px`,height:`48px`,borderRadius:`8px`,overflow:`hidden`,border:`1px solid rgba(0, 0, 0, 0.1)`,backgroundColor:a?`transparent`:`rgba(0, 0, 0, 0.05)`},children:[a?(0,$.jsx)(`img`,{src:a,alt:`é¢„è§ˆ ${n+1}`,style:{width:`100%`,height:`100%`,objectFit:`cover`},onError:t=>{console.warn(`å›¾ç‰‡åŠ è½½å¤±è´¥:`,e),t.currentTarget.style.display=`none`}}):(0,$.jsx)(Y,{sx:{width:`100%`,height:`100%`,display:`flex`,alignItems:`center`,justifyContent:`center`,fontSize:`12px`,color:`rgba(0, 0, 0, 0.5)`},children:`åŠ è½½ä¸­...`}),(0,$.jsx)(S,{size:`small`,onClick:()=>r(n),sx:{position:`absolute`,top:-6,right:-6,backgroundColor:`rgba(0, 0, 0, 0.7)`,color:`white`,padding:`2px`,width:`16px`,height:`16px`,"&:hover":{backgroundColor:`rgba(244, 67, 54, 0.8)`}},children:(0,$.jsx)(De,{size:10,style:{transform:`rotate(45deg)`}})})]},i)})}),e.length>Math.max(0,o-t.length)&&(0,$.jsx)(Y,{sx:{display:`flex`,flexWrap:`wrap`,gap:`4px`},children:e.slice(Math.max(0,o-t.length)).map((e,r)=>{let s=i[`${e.name}-${e.size}`],c=Math.max(0,o-t.length)+r,l=e.id?`extra-${e.id}`:`extra-file-${c}-${e.name}-${e.size||Date.now()}`;return(0,$.jsx)(on,{file:e,onRemove:()=>n(c),compact:a,status:s?.status,progress:s?.progress,error:s?.error,draggable:!1},l)})})]})})]})]}):null},cn=(0,Q.forwardRef)(({images:e,files:t,setImages:n,setFiles:r,setUploadingMedia:i,fileStatuses:a,setFileStatuses:o,isDarkMode:s,isMobile:c,borderRadius:l},u)=>{let[d,f]=(0,Q.useState)(!1),[p,m]=(0,Q.useState)(0),h=J(e=>e.messages.currentTopicId),[g,_]=(0,Q.useState)(null),{handleImageUpload:v,handleFileUpload:y}=tn({currentTopicState:g,setUploadingMedia:i});(0,Q.useEffect)(()=>{(async()=>{if(h)try{let e=await dt.getTopic(h);e?_(e):console.warn(`[FileUploadManager] ç¼“å­˜æˆ–æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è¯é¢˜:`,h)}catch(e){console.error(`[FileUploadManager] åŠ è½½è¯é¢˜ä¿¡æ¯å¤±è´¥:`,e)}})()},[h]);let b=async(e=`photos`)=>{try{let t=await v(e);t&&t.length>0&&n(e=>[...e,...t])}catch(e){console.error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥:`,e),i(!1)}},x=async()=>{try{let e=await y();e&&e.length>0&&r(t=>[...t,...e])}catch(e){console.error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥:`,e),i(!1)}};(0,Q.useImperativeHandle)(u,()=>({handleImageUpload:b,handleFileUpload:x,handlePaste:A}),[]);let S=e=>{n(t=>t.filter((t,n)=>n!==e))},C=e=>{let n=t[e];if(n){let e=`${n.name}-${n.size}`;o(t=>{let n={...t};return delete n[e],n})}r(t=>t.filter((t,n)=>n!==e))},w=e=>{e.preventDefault(),e.stopPropagation(),m(e=>e+1),e.dataTransfer.items&&e.dataTransfer.items.length>0&&f(!0)},T=e=>{e.preventDefault(),e.stopPropagation(),m(e=>e-1),p<=1&&f(!1)},E=e=>{e.preventDefault(),e.stopPropagation()},D=async e=>{e.preventDefault(),e.stopPropagation(),f(!1),m(0);let t=Array.from(e.dataTransfer.files);if(t.length!==0)try{i(!0);for(let e of t)if(e.type.startsWith(`image/`)){let t=new FileReader;t.onload=t=>{let r=t.target?.result,i={id:`img-${Date.now()}-${Math.random().toString(36).substring(2,11)}-${e.name.replace(/[^a-zA-Z0-9]/g,``)}`,url:r,base64Data:r,mimeType:e.type,name:e.name,size:e.size};n(e=>[...e,i])},t.readAsDataURL(e)}else{let t=new FileReader;t.onload=t=>{let n=t.target?.result,i={id:`file-${Date.now()}-${Math.random().toString(36).substring(2,11)}-${e.name.replace(/[^a-zA-Z0-9]/g,``)}`,name:e.name,mimeType:e.type,extension:e.name&&typeof e.name==`string`&&e.name.split(`.`).pop()||``,size:e.size,base64Data:n,url:``};r(e=>[...e,i])},t.readAsDataURL(e)}$e.show({message:`æˆåŠŸæ·»åŠ  ${t.length} ä¸ªæ–‡ä»¶`,type:`success`,duration:3e3})}catch(e){console.error(`æ‹–æ‹½æ–‡ä»¶å¤„ç†å¤±è´¥:`,e),$e.show({message:`æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•`,type:`error`,duration:3e3})}finally{i(!1)}},{handlePaste:O,shouldConvertToFile:k}=an({onFileAdd:e=>{r(t=>[...t,e])},onSuccess:e=>{$e.show({message:e,type:`success`,duration:3e3})},onError:e=>{console.error(`é•¿æ–‡æœ¬è½¬æ–‡ä»¶å¤±è´¥:`,e),$e.show({message:`é•¿æ–‡æœ¬è½¬æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•`,type:`error`,duration:3e3})}}),A=async e=>{let t=e.clipboardData;if(!t)return;let r=t.getData(`text`);if(r&&k(r)){e.preventDefault(),i(!0);try{await O(e)}finally{i(!1)}return}let a=Array.from(t.items).filter(e=>e.type.startsWith(`image/`));if(a.length!==0){e.preventDefault();try{i(!0);for(let e of a){let t=e.getAsFile();if(t){let e=new FileReader;e.onload=e=>{let r=e.target?.result,i=Date.now(),a={id:`paste-img-${i}-${Math.random().toString(36).substring(2,11)}`,url:r,base64Data:r,mimeType:t.type,name:`ç²˜è´´çš„å›¾ç‰‡_${i}.${t.type&&typeof t.type==`string`&&t.type.includes(`/`)&&t.type.split(`/`)[1]||`png`}`,size:t.size};n(e=>[...e,a])},e.readAsDataURL(t)}}$e.show({message:`æˆåŠŸç²˜è´´ ${a.length} å¼ å›¾ç‰‡`,type:`success`,duration:3e3})}catch(e){console.error(`ç²˜è´´å›¾ç‰‡å¤„ç†å¤±è´¥:`,e),$e.show({message:`ç²˜è´´å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•`,type:`error`,duration:3e3})}finally{i(!1)}}};return(0,$.jsxs)(`div`,{style:{position:`relative`,width:`100%`},onDragEnter:w,onDragLeave:T,onDragOver:E,onDrop:D,children:[(0,$.jsx)(sn,{files:t,images:e,onRemoveFile:C,onRemoveImage:S,fileStatuses:a,compact:!0,maxVisibleItems:c?2:3}),d&&(0,$.jsx)(`div`,{style:{position:`absolute`,top:0,left:0,right:0,bottom:0,backgroundColor:s?`rgba(33, 150, 243, 0.1)`:`rgba(33, 150, 243, 0.05)`,border:`2px dashed ${s?`#2196F3`:`#1976D2`}`,borderRadius:l,display:`flex`,alignItems:`center`,justifyContent:`center`,zIndex:1002,pointerEvents:`none`},children:(0,$.jsx)(`div`,{style:{color:s?`#2196F3`:`#1976D2`,fontSize:`16px`,fontWeight:500,textAlign:`center`,padding:`20px`},children:`ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ `})})]})});cn.displayName=`FileUploadManager`;var ln=cn,un=e=>{let t=`custom-thin-scrollbar-styles`;if(document.getElementById(t))return;let n=document.createElement(`style`);n.id=t,n.textContent=`
    .custom-thin-scrollbar::-webkit-scrollbar {
      width: 1px;
    }

    .custom-thin-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-thin-scrollbar::-webkit-scrollbar-thumb {
      background: ${e?`#555`:`#ccc`};
      border-radius: 0px;
    }

    .custom-thin-scrollbar::-webkit-scrollbar-thumb:hover {
      background: ${e?`#666`:`#999`};
    }
  `,document.head.appendChild(n)},dn=({message:e,textareaRef:t,textareaHeight:n,showCharCount:r,handleChange:i,handleKeyDown:a,handleCompositionStart:o,handleCompositionEnd:s,onPaste:c,isLoading:l,allowConsecutiveMessages:u,imageGenerationMode:d,videoGenerationMode:f,webSearchActive:p,isMobile:m,isTablet:h,isDarkMode:g,shouldHideVoiceButton:_,expanded:v,onExpandToggle:y})=>{(0,Q.useEffect)(()=>{un(g)},[g]);let b=(0,Q.useRef)(v);(0,Q.useEffect)(()=>{b.current&&!v&&t.current&&requestAnimationFrame(()=>{t.current&&(t.current.style.height=`auto`)}),b.current=v},[v,t]);let x=(0,Q.useCallback)(e=>{a(e),e.key===`Enter`&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),y())},[a,y]);(0,Q.useEffect)(()=>{let e=t.current;if(!e||e.dataset.initialized===`true`)return;let n=setTimeout(()=>{if(e&&e.dataset.initialized!==`true`){let t=m?32:h?36:34;e.style.height=`${t}px`,e.dataset.initialized=`true`}},100),r=()=>{},i=()=>{};return e&&(e.addEventListener(`focus`,r),e.addEventListener(`blur`,i)),()=>{clearTimeout(n),e&&(e.removeEventListener(`focus`,r),e.removeEventListener(`blur`,i))}},[]);let S=(0,Q.useMemo)(()=>({flexGrow:1,margin:_?h?`0 12px 0 4px`:`0 8px 0 2px`:h?`0 12px`:`0 8px`,position:`relative`}),[_,h]),C=(0,Q.useMemo)(()=>d?`è¾“å…¥å›¾åƒç”Ÿæˆæç¤ºè¯... (Ctrl+Enter å±•å¼€)`:f?`è¾“å…¥è§†é¢‘ç”Ÿæˆæç¤ºè¯... (Ctrl+Enter å±•å¼€)`:p?`è¾“å…¥ç½‘ç»œæœç´¢å†…å®¹... (Ctrl+Enter å±•å¼€)`:`å’ŒaiåŠ©æ‰‹è¯´ç‚¹ä»€ä¹ˆ... (Ctrl+Enter å±•å¼€)`,[d,f,p]);return(0,$.jsxs)(`div`,{style:S,children:[(0,$.jsx)(`textarea`,{ref:t,className:`custom-thin-scrollbar`,style:{fontSize:h?`17px`:`16px`,padding:h?`10px 0`:`8px 0`,border:`none`,outline:`none`,width:`100%`,backgroundColor:`transparent`,lineHeight:`1.4`,fontFamily:`inherit`,resize:`none`,overflow:e.trim().length>0?`auto`:`hidden`,minHeight:v?`70vh`:`${m?32:h?36:34}px`,height:v?`70vh`:`${n}px`,maxHeight:v?`70vh`:`${m?200:250}px`,color:`var(--theme-text-primary)`,transition:`height 0.3s ease-out, min-height 0.3s ease-out, max-height 0.3s ease`,scrollbarWidth:`thin`,scrollbarColor:`${g?`#555`:`#ccc`} transparent`},placeholder:C,value:e,onChange:i,onKeyDown:x,onCompositionStart:o,onCompositionEnd:s,onPaste:c,disabled:l&&!u,rows:1}),r&&(0,$.jsxs)(`div`,{style:{position:`absolute`,bottom:`-20px`,right:`0`,fontSize:`12px`,color:e.length>1e3?`#f44336`:g?`#888`:`#666`,opacity:.8,transition:`all 0.2s ease`},children:[e.length,e.length>1e3?` (è¿‡é•¿)`:``]})]})},fn=e=>{let{uploadingMedia:t,isLoading:n,allowConsecutiveMessages:r,isStreaming:i,imageGenerationMode:a,webSearchActive:o,images:c,files:l,isDarkMode:u,isTablet:d,disabledColor:f,handleOpenUploadMenu:g,handleSubmit:_,onStopResponse:v,canSendMessage:y}=e,b=n&&!r;return(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(X,{title:`æ·»åŠ å›¾ç‰‡æˆ–æ–‡ä»¶`,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{size:d?`large`:`medium`,onClick:g,disabled:t||n&&!r,style:{color:t?f:u?`#ffffff`:`#000000`,padding:d?`10px`:`8px`,position:`relative`,marginRight:d?`4px`:`0`},children:t?(0,$.jsx)(ut,{size:d?28:24}):(0,$.jsx)(Vt,{badgeContent:c.length+l.length,color:`primary`,max:9,invisible:c.length+l.length===0,children:(0,$.jsx)(p,{size:d?28:24})})})})}),(0,$.jsx)(X,{title:i?`åœæ­¢ç”Ÿæˆ`:a?`ç”Ÿæˆå›¾åƒ`:o?`æœç´¢ç½‘ç»œ`:`å‘é€æ¶ˆæ¯`,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{onClick:i&&v?v:_,disabled:!i&&(!y()||n&&!r),size:d?`large`:`medium`,style:{color:i?`#ff4d4f`:!y()||n&&!r?f:a?`#9C27B0`:o?`#3b82f6`:u?`#4CAF50`:`#09bb07`,padding:d?`10px`:`8px`},children:i?(0,$.jsx)(re,{size:d?20:18}):b?(0,$.jsx)(ut,{size:d?28:24,color:`inherit`}):a?(0,$.jsx)(s,{size:d?20:18}):o?(0,$.jsx)(m,{size:d?20:18}):(0,$.jsx)(h,{size:d?20:18})})})})]})},pn={MAX_ROUNDS:5,MODERATOR_ENABLED:!0,SUMMARY_ENABLED:!0},mn=({onStartDebate:e,onStopDebate:t,isDebating:n=!1,disabled:r=!1,question:i=``})=>{let a=tt(),{t:o}=Me(),[s,c]=(0,Q.useState)(!1),[l,u]=(0,Q.useState)(null),[d,p]=(0,Q.useState)(``),[m,h]=(0,Q.useState)({maxRounds:pn.MAX_ROUNDS,enableModerator:pn.MODERATOR_ENABLED,enableSummary:pn.SUMMARY_ENABLED}),[g,_]=(0,Q.useState)([]),[v,y]=(0,Q.useState)(``),[b,x]=(0,Q.useState)(!1),C=[{category:o(`aiDebate.topicCategories.tech`),topics:[o(`aiDebate.topics.tech.ai`),o(`aiDebate.topics.tech.social`),o(`aiDebate.topics.tech.auto`),o(`aiDebate.topics.tech.remote`),o(`aiDebate.topics.tech.vr`)]},{category:o(`aiDebate.topicCategories.education`),topics:[o(`aiDebate.topics.education.online`),o(`aiDebate.topics.education.coding`),o(`aiDebate.topics.education.exam`),o(`aiDebate.topics.education.screen`),o(`aiDebate.topics.education.university`)]},{category:o(`aiDebate.topicCategories.environment`),topics:[o(`aiDebate.topics.environment.individual`),o(`aiDebate.topics.environment.nuclear`),o(`aiDebate.topics.environment.ev`),o(`aiDebate.topics.environment.plastic`),o(`aiDebate.topics.environment.urban`)]},{category:o(`aiDebate.topicCategories.economy`),topics:[o(`aiDebate.topics.economy.ubi`),o(`aiDebate.topics.economy.crypto`),o(`aiDebate.topics.economy.sharing`),o(`aiDebate.topics.economy.csr`),o(`aiDebate.topics.economy.globalization`)]},{category:o(`aiDebate.topicCategories.health`),topics:[o(`aiDebate.topics.health.vegan`),o(`aiDebate.topics.health.exercise`),o(`aiDebate.topics.health.mental`),o(`aiDebate.topics.health.gene`),o(`aiDebate.topics.health.traditional`)]},{category:o(`aiDebate.topicCategories.society`),topics:[o(`aiDebate.topics.society.equality`),o(`aiDebate.topics.society.tradition`),o(`aiDebate.topics.society.privacy`),o(`aiDebate.topics.society.speech`),o(`aiDebate.topics.society.diversity`)]}];(0,Q.useEffect)(()=>{(()=>{try{let e=localStorage.getItem(`aiDebateConfig`);if(e){let t=JSON.parse(e);u(t),h({maxRounds:t.maxRounds||pn.MAX_ROUNDS,enableModerator:t.moderatorEnabled??pn.MODERATOR_ENABLED,enableSummary:t.summaryEnabled??pn.SUMMARY_ENABLED})}let t=localStorage.getItem(`aiDebateConfigGroups`);t&&_(JSON.parse(t))}catch(e){console.error(o(`errors.aiDebate.loadConfigFailed`),e)}})()},[o]),(0,Q.useEffect)(()=>{i&&p(i)},[i]);let w=()=>{n?t?.():(c(!0),i&&p(i))},T=()=>{if(!l||!d.trim())return;let t={...l,maxRounds:m.maxRounds,moderatorEnabled:m.enableModerator,summaryEnabled:m.enableSummary};e?.(d.trim(),t),c(!1)},E=()=>{c(!1),a(`/settings/ai-debate`)},D=e=>{if(y(e),e){let t=g.find(t=>t.id===e);t&&(u(t.config),h({maxRounds:t.config.maxRounds||pn.MAX_ROUNDS,enableModerator:t.config.moderatorEnabled??pn.MODERATOR_ENABLED,enableSummary:t.config.summaryEnabled??pn.SUMMARY_ENABLED}))}else{let e=localStorage.getItem(`aiDebateConfig`);if(e){let t=JSON.parse(e);u(t),h({maxRounds:t.maxRounds||pn.MAX_ROUNDS,enableModerator:t.moderatorEnabled??pn.MODERATOR_ENABLED,enableSummary:t.summaryEnabled??pn.SUMMARY_ENABLED})}}},k=l&&l.enabled&&l.roles.length>=2,A=(()=>n?{color:`error`,icon:(0,$.jsx)(re,{size:20}),tooltip:o(`aiDebate.button.stop`)}:{color:k?`primary`:`default`,icon:(0,$.jsx)(St,{name:`aiDebate`,size:20,color:`currentColor`}),tooltip:o(k?`aiDebate.button.start`:`aiDebate.button.notConfigured`)})();return(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(X,{title:A.tooltip,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{onClick:w,disabled:r,color:A.color,size:`small`,children:A.icon})})}),(0,$.jsxs)(j,{open:s,onClose:()=>c(!1),maxWidth:`sm`,fullWidth:!0,children:[(0,$.jsxs)(Qe,{sx:{display:`flex`,alignItems:`center`},children:[(0,$.jsx)(Y,{sx:{mr:1,display:`flex`,alignItems:`center`},children:(0,$.jsx)(St,{name:`aiDebate`,size:20,color:`currentColor`})}),o(`aiDebate.dialog.title`)]}),(0,$.jsxs)(Ke,{children:[k?(0,$.jsx)(ue,{severity:`info`,sx:{mb:2},children:o(`aiDebate.dialog.configuredInfo`,{count:l?.roles.length})}):(0,$.jsx)(ue,{severity:`warning`,sx:{mb:2},action:(0,$.jsx)(Pe,{color:`inherit`,size:`small`,onClick:E,sx:{fontWeight:600},children:o(`aiDebate.dialog.goToSettings`)}),children:(0,$.jsxs)(Y,{children:[(0,$.jsx)(Z,{variant:`body2`,sx:{fontWeight:600,mb:.5},children:o(`aiDebate.dialog.notConfiguredTitle`)}),(0,$.jsx)(Z,{variant:`body2`,children:o(`aiDebate.dialog.notConfiguredWarning`)})]})}),(0,$.jsxs)(Y,{sx:{mb:2},children:[(0,$.jsx)(Z,{variant:`subtitle2`,sx:{mb:1},children:o(`aiDebate.dialog.topic`)}),(0,$.jsx)(O,{value:d,onChange:e=>p(e.target.value),multiline:!0,rows:3,fullWidth:!0,placeholder:o(`aiDebate.dialog.topicPlaceholder`),disabled:!k}),(0,$.jsxs)(Y,{sx:{mt:2},children:[(0,$.jsx)(Pe,{onClick:()=>x(!b),startIcon:b?(0,$.jsx)(Ze,{size:16}):(0,$.jsx)(De,{size:16}),sx:{textTransform:`none`,color:`text.secondary`,fontSize:`0.875rem`,p:.5,minWidth:`auto`,"&:hover":{bgcolor:`action.hover`}},children:o(`aiDebate.dialog.quickTopics`)}),(0,$.jsx)(qe,{in:b,children:(0,$.jsx)(Y,{sx:{mt:1,maxHeight:200,overflow:`auto`,border:1,borderColor:`divider`,borderRadius:1,p:1},children:C.map((e,t)=>(0,$.jsxs)(Y,{sx:{mb:1},children:[(0,$.jsx)(Z,{variant:`caption`,sx:{fontWeight:600,color:`primary.main`,display:`block`,mb:.5},children:e.category}),(0,$.jsx)(Y,{sx:{display:`flex`,flexWrap:`wrap`,gap:.5},children:e.topics.map((e,t)=>(0,$.jsx)(lt,{label:e,size:`small`,variant:`outlined`,onClick:()=>p(e),sx:{fontSize:`0.7rem`,height:24,cursor:`pointer`,"&:hover":{bgcolor:`primary.main`,color:`white`}},disabled:!k},t))})]},t))})})]})]}),g.length>0&&(0,$.jsx)(Y,{sx:{mb:2},children:(0,$.jsxs)(ce,{fullWidth:!0,size:`small`,children:[(0,$.jsx)(I,{children:o(`aiDebate.dialog.selectGroup`)}),(0,$.jsxs)(ie,{value:v,onChange:e=>D(e.target.value),label:o(`aiDebate.dialog.selectGroup`),children:[(0,$.jsx)(F,{value:``,children:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`},children:[(0,$.jsx)(ze,{size:16,style:{marginRight:8}}),o(`aiDebate.dialog.currentConfig`)]})}),g.map(e=>(0,$.jsx)(F,{value:e.id,children:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`},children:[(0,$.jsx)(ze,{size:16,style:{marginRight:8}}),e.name,(0,$.jsxs)(Z,{variant:`caption`,color:`text.secondary`,sx:{ml:1},children:[`(`,o(`aiDebate.roles.roleCount`,{count:e.config.roles.length}),`)`]})]})},e.id))]})]})}),k&&(0,$.jsxs)(Y,{sx:{mb:2},children:[(0,$.jsx)(Z,{variant:`subtitle2`,sx:{mb:1},children:o(`aiDebate.dialog.rolesLabel`)}),(0,$.jsx)(Y,{sx:{display:`flex`,gap:1,flexWrap:`wrap`},children:l?.roles.map(e=>(0,$.jsx)(lt,{label:e.name,size:`small`,sx:{bgcolor:e.color,color:`white`,"& .MuiChip-label":{fontWeight:500}}},e.id))})]}),(0,$.jsx)(ct,{sx:{my:2}}),(0,$.jsx)(Z,{variant:`subtitle2`,sx:{mb:1},children:o(`aiDebate.dialog.settingsLabel`)}),(0,$.jsxs)(Y,{sx:{display:`grid`,gap:2},children:[(0,$.jsx)(O,{label:o(`aiDebate.basicSettings.maxRounds`),value:m.maxRounds,onChange:e=>{let t=e.target.value;if(t===``)h({...m,maxRounds:0});else{let e=parseInt(t);isNaN(e)||h({...m,maxRounds:e})}},size:`small`,disabled:!k,helperText:o(`aiDebate.basicSettings.maxRoundsHelper`)}),(0,$.jsx)(Ee,{control:(0,$.jsx)(st,{checked:m.enableModerator,onChange:e=>h({...m,enableModerator:e.target.checked}),disabled:!k}),label:o(`aiDebate.basicSettings.enableModerator`)}),(0,$.jsx)(Ee,{control:(0,$.jsx)(st,{checked:m.enableSummary,onChange:e=>h({...m,enableSummary:e.target.checked}),disabled:!k}),label:o(`aiDebate.basicSettings.enableSummary`)})]})]}),(0,$.jsxs)(ke,{children:[(0,$.jsx)(Pe,{onClick:E,startIcon:(0,$.jsx)(le,{size:16}),children:o(`aiDebate.dialog.configureRoles`)}),(0,$.jsx)(Pe,{onClick:()=>c(!1),children:o(`common.cancel`)}),(0,$.jsx)(Pe,{onClick:T,variant:`contained`,startIcon:(0,$.jsx)(f,{size:16}),disabled:!k||!d.trim(),children:o(`aiDebate.dialog.startDebate`)})]})]})]})},hn=q.div`
  padding: 5px 0;
  background-color: ${e=>e.theme?.palette?.background?.paper};
`,gn=q.div`
  max-height: 300px;
  overflow-y: auto;
  
  &::-webkit-scrollbar {
    width: 6px;
  }
  
  &::-webkit-scrollbar-track {
    background: transparent;
  }
  
  &::-webkit-scrollbar-thumb {
    background: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.2)`:`rgba(0, 0, 0, 0.2)`};
    border-radius: 3px;
  }
`,_n=q.div`
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 0 5px 1px 5px;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.1s ease;

  &:hover {
    background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.04)`};
  }

  &.focused {
    background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.12)`:`rgba(0, 0, 0, 0.08)`};
  }
`,vn=q.div`
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0;
`,yn=q.span`
  display: flex;
  align-items: center;
  justify-content: center;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
  flex-shrink: 0;
`,bn=q.span`
  font-size: 14px;
  line-height: 20px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex-shrink: 0;
`,xn=q.div`
  display: flex;
  align-items: center;
  gap: 8px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
  flex-shrink: 1;
  min-width: 0;
`,Sn=q.span`
  font-size: 12px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`,Cn=q.div`
  height: 1px;
  background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.08)`};
  margin: 4px 8px;
`,wn=q.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px 6px;
  border-top: 1px solid ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.08)`};
`,Tn=q.div`
  font-size: 12px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
`,En=q.div`
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 11px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
`,Dn=({onInsertPhrase:e,assistant:t,disabled:n=!1,size:r=`medium`})=>{let i=me(),[a,o]=(0,Q.useState)(!1),[s,c]=(0,Q.useState)([]),[l,u]=(0,Q.useState)([]),[d,f]=(0,Q.useState)(!1),[m,h]=(0,Q.useState)(-1),g=(0,Q.useRef)(null),[_,v]=(0,Q.useState)({title:``,content:``,location:`global`}),y=(0,Q.useCallback)(async()=>{try{c(await Ct.getAll()),t&&u(Ct.getAssistantPhrases(t))}catch(e){console.error(`åŠ è½½å¿«æ·çŸ­è¯­å¤±è´¥:`,e)}},[t]);(0,Q.useEffect)(()=>{y()},[y]);let b=()=>{console.log(`QuickPhrase button clicked, opening panel`),o(!0),h(-1)},x=()=>{o(!1),h(-1)},C=t=>{e(t.content),x()},w=()=>{f(!0),o(!1)},T=()=>{f(!1),v({title:``,content:``,location:`global`})},E=async()=>{if(!(!_.title.trim()||!_.content.trim()))try{_.location===`global`?await Ct.add({title:_.title,content:_.content}):_.location===`assistant`&&t&&await Ct.addAssistantPhrase(t,{title:_.title,content:_.content},async e=>{await D.saveAssistant(e),window.dispatchEvent(new CustomEvent(`assistantUpdated`,{detail:{assistant:e}}))}),T(),await y()}catch(e){console.error(`ä¿å­˜å¿«æ·çŸ­è¯­å¤±è´¥:`,e)}},A=(0,Q.useMemo)(()=>[...l,...s],[l,s]),M=r===`large`?28:r===`small`?20:24;return(0,Q.useEffect)(()=>{if(!a)return;let e=e=>{e.key===`Escape`?(e.preventDefault(),x()):e.key===`ArrowDown`?(e.preventDefault(),h(e=>e<A.length?e+1:0)):e.key===`ArrowUp`?(e.preventDefault(),h(e=>e>0?e-1:A.length)):e.key===`Enter`&&m>=0&&(e.preventDefault(),m===A.length?w():C(A[m]))};return window.addEventListener(`keydown`,e),()=>{window.removeEventListener(`keydown`,e)}},[a,m,A]),(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(X,{title:`å¿«æ·çŸ­è¯­`,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{onClick:b,disabled:n,size:r,style:{color:i.palette.mode===`dark`?`#fff`:`#666`,padding:r===`large`?`10px`:r===`small`?`6px`:`8px`},children:(0,$.jsx)(St,{name:`quickPhrase`,size:M,color:`currentColor`})})})}),(0,$.jsx)(Kt,{anchor:`bottom`,open:a,onClose:x,PaperProps:{sx:{borderTopLeftRadius:16,borderTopRightRadius:16,maxHeight:`60vh`,bgcolor:`background.paper`,pb:`var(--safe-area-bottom-computed, 0px)`}},children:(0,$.jsxs)(Y,{sx:{maxHeight:`60vh`,display:`flex`,flexDirection:`column`},children:[(0,$.jsx)(Y,{sx:{pt:1,pb:1.5,display:`flex`,justifyContent:`center`},children:(0,$.jsx)(Y,{sx:{width:40,height:4,bgcolor:e=>rt(e.palette.text.primary,.2),borderRadius:999}})}),(0,$.jsxs)(hn,{ref:g,theme:i,children:[(0,$.jsxs)(gn,{theme:i,children:[A.length>0&&(0,$.jsxs)($.Fragment,{children:[l.map((e,t)=>(0,$.jsxs)(_n,{theme:i,className:m===t?`focused`:``,onClick:()=>C(e),onMouseEnter:()=>h(t),children:[(0,$.jsxs)(vn,{children:[(0,$.jsx)(yn,{theme:i,children:(0,$.jsx)(Ut,{size:18})}),(0,$.jsx)(bn,{children:e.title})]}),(0,$.jsx)(xn,{theme:i,children:(0,$.jsx)(Sn,{children:e.content.length>50?e.content.substring(0,50)+`...`:e.content})})]},e.id)),s.map((e,t)=>{let n=l.length+t;return(0,$.jsxs)(_n,{theme:i,className:m===n?`focused`:``,onClick:()=>C(e),onMouseEnter:()=>h(n),children:[(0,$.jsxs)(vn,{children:[(0,$.jsx)(yn,{theme:i,children:(0,$.jsx)(St,{name:`quickPhrase`,size:18,color:`currentColor`})}),(0,$.jsx)(bn,{children:e.title})]}),(0,$.jsx)(xn,{theme:i,children:(0,$.jsx)(Sn,{children:e.content.length>50?e.content.substring(0,50)+`...`:e.content})})]},e.id)}),(0,$.jsx)(Cn,{theme:i})]}),(0,$.jsx)(_n,{theme:i,className:m===A.length?`focused`:``,onClick:w,onMouseEnter:()=>h(A.length),children:(0,$.jsxs)(vn,{children:[(0,$.jsx)(yn,{theme:i,children:(0,$.jsx)(p,{size:18})}),(0,$.jsx)(bn,{children:`æ·»åŠ å¿«æ·çŸ­è¯­...`})]})})]}),(0,$.jsxs)(wn,{theme:i,children:[(0,$.jsx)(Tn,{theme:i,children:`å¿«æ·çŸ­è¯­`}),(0,$.jsxs)(En,{theme:i,children:[(0,$.jsx)(`span`,{children:`ESC å…³é—­`}),(0,$.jsx)(`span`,{children:`â–²â–¼ é€‰æ‹©`}),(0,$.jsx)(`span`,{children:`â†©ï¸ ç¡®è®¤`})]})]})]})]})}),(0,$.jsxs)(j,{open:d,onClose:T,maxWidth:`sm`,fullWidth:!0,children:[(0,$.jsx)(Qe,{children:`æ·»åŠ å¿«æ·çŸ­è¯­`}),(0,$.jsx)(Ke,{children:(0,$.jsxs)(Y,{sx:{display:`flex`,flexDirection:`column`,gap:2,pt:1},children:[(0,$.jsx)(O,{label:`æ ‡é¢˜`,value:_.title,onChange:e=>v({..._,title:e.target.value}),fullWidth:!0,size:`small`}),(0,$.jsx)(O,{label:`å†…å®¹`,value:_.content,onChange:e=>v({..._,content:e.target.value}),multiline:!0,rows:4,fullWidth:!0,size:`small`}),(0,$.jsxs)(ce,{component:`fieldset`,children:[(0,$.jsx)(Ce,{component:`legend`,children:`æ·»åŠ ä½ç½®`}),(0,$.jsxs)(oe,{value:_.location,onChange:e=>v({..._,location:e.target.value}),row:!0,children:[(0,$.jsx)(Ee,{value:`global`,control:(0,$.jsx)(k,{size:`small`}),label:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:.5},children:[(0,$.jsx)(St,{name:`quickPhrase`,size:16,color:`currentColor`}),(0,$.jsx)(Z,{variant:`body2`,children:`å…¨å±€å¿«æ·çŸ­è¯­`})]})}),t&&(0,$.jsx)(Ee,{value:`assistant`,control:(0,$.jsx)(k,{size:`small`}),label:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:.5},children:[(0,$.jsx)(Ut,{size:16}),(0,$.jsx)(Z,{variant:`body2`,children:`åŠ©æ‰‹æç¤ºè¯`})]})})]})]})]})}),(0,$.jsxs)(ke,{children:[(0,$.jsx)(Pe,{onClick:T,children:`å–æ¶ˆ`}),(0,$.jsx)(Pe,{onClick:E,variant:`contained`,disabled:!_.title.trim()||!_.content.trim(),children:`ä¿å­˜`})]})]})]})},On=({onSendMessage:e,onSendMultiModelMessage:t,onStartDebate:n,onStopDebate:r,isLoading:i=!1,allowConsecutiveMessages:a=!0,imageGenerationMode:o=!1,videoGenerationMode:s=!1,onSendImagePrompt:l,webSearchActive:f=!1,onStopResponse:p,isStreaming:m=!1,isDebating:h=!1,toolsEnabled:g=!1,availableModels:_=[]})=>{let[v,y]=(0,Q.useState)(null),[b,x]=(0,Q.useState)(!1);(0,Q.useEffect)(()=>()=>{y(null)},[]);let C=(0,Q.useMemo)(()=>E(),[]),[w,T]=(0,Q.useState)(`normal`),[O,k]=(0,Q.useState)(!1),[A,j]=(0,Q.useState)(!1),[M,N]=(0,Q.useState)(!1),[P,F]=(0,Q.useState)([]),[I,L]=(0,Q.useState)([]),[R,z]=(0,Q.useState)(!1),[ee,B]=(0,Q.useState)({}),[te,ne]=(0,Q.useState)([]),V=(0,Q.useRef)(null),[re,ie]=(0,Q.useState)(0),ae=J(e=>e.assistants.currentAssistant),{styles:oe,isDarkMode:se,inputBoxStyle:H}=Xt(),{hasKnowledgeContext:ce,getStoredKnowledgeContext:le,clearStoredKnowledgeContext:ue}=Yt(),de=J(e=>e.settings.showAIDebateButton??!0),fe=J(e=>e.settings.showQuickPhraseButton??!0),{message:U,setMessage:W,textareaRef:pe,canSendMessage:me,handleSubmit:he,handleKeyDown:ge,handleChange:_e,textareaHeight:ve,showCharCount:be,handleCompositionStart:xe,handleCompositionEnd:Se,adjustTextareaHeight:G,isMobile:Ce,isTablet:K}=Jt({onSendMessage:e,onSendMultiModelMessage:t,onSendImagePrompt:l,isLoading:i,allowConsecutiveMessages:a,imageGenerationMode:o,videoGenerationMode:s,toolsEnabled:g,images:P,files:I,setImages:F,setFiles:L,enableTextareaResize:!0,enableCompositionHandling:!0,enableCharacterCount:!0,availableModels:_}),{isListening:we,startRecognition:Te,stopRecognition:Ee}=Dt(),{isKeyboardVisible:ke,hideKeyboard:q}=ye(),Ae=(0,Q.useCallback)(()=>{q(),he()},[q,he]);(0,Q.useEffect)(()=>{ke&&A&&j(!1)},[ke,A]),(0,Q.useEffect)(()=>$e.subscribe(ne),[]),(0,Q.useEffect)(()=>{let e=()=>{ie(e=>e+1)};return window.addEventListener(`knowledgeBaseSelected`,e),()=>{window.removeEventListener(`knowledgeBaseSelected`,e)}},[]);let{border:je,borderRadius:Me,boxShadow:Ne}=oe,Pe=se?`#ffffff`:`#000000`,Fe=se?`#555`:`#ccc`,Ie=async e=>{if(!U.trim()&&P.length===0&&I.length===0||!t)return;let n=U.trim(),r=[...P,...I.filter(e=>e.mimeType.startsWith(`image/`)).map(e=>({base64Data:e.base64Data,url:e.url||``,width:e.width,height:e.height}))],i=await Promise.all(r.map(async e=>{let t=e.base64Data||e.url;if(e.url&&e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/)){let n=e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/);if(n&&n[1])try{let e=n[1],r=await D.getImageBlob(e);r&&(t=await new Promise(e=>{let t=new FileReader;t.onload=()=>e(t.result),t.readAsDataURL(r)}))}catch(e){console.error(`åŠ è½½å›¾ç‰‡å¼•ç”¨å¤±è´¥:`,e)}}return{type:`image_url`,image_url:{url:t}}})),a=I.filter(e=>!e.mimeType.startsWith(`image/`));console.log(`å‘é€å¤šæ¨¡å‹æ¶ˆæ¯:`,{message:n,models:e.map(e=>`${e.provider||e.providerType}:${e.id}`),images:i.length,files:I.length,toolsEnabled:g}),t(n,e,i.length>0?i:void 0,g,a),W(``),F([]),L([]),z(!1)},Le=Q.useMemo(()=>{let e=U.length,t=0;if(e<1e3)t=U.split(`
`).length-1;else for(let n=0;n<Math.min(e,1e4);n++)U[n]===`
`&&t++;let n=Ce?280:K?400:500,r=Math.floor(n/(K?17:16)),i=Math.ceil(e/r)+t;return{shouldHideVoiceButton:i>3,showExpandButton:A?!0:i>4}},[U,Ce,K,A]),Re=(0,Q.useRef)(null);(0,Q.useEffect)(()=>(Re.current&&clearTimeout(Re.current),Re.current=setTimeout(()=>{requestAnimationFrame(()=>{k(Le.shouldHideVoiceButton),N(Le.showExpandButton)})},100),()=>{Re.current&&clearTimeout(Re.current)}),[Le]);let ze=(0,Q.useCallback)(e=>{_e(e)},[_e]),Be=(0,Q.useRef)(A);(0,Q.useEffect)(()=>{Be.current&&!A&&pe.current&&requestAnimationFrame(()=>{pe.current&&G(pe.current)}),Be.current=A},[A,pe,G]);let Ve=(0,Q.useCallback)(()=>{j(!A)},[A]),He=e=>{y(e.currentTarget)},Ue=()=>{y(null)},We=async(e=`photos`)=>{V.current&&await V.current.handleImageUpload(e)},Ge=async()=>{V.current&&await V.current.handleFileUpload()},Ke=(0,Q.useCallback)(e=>{if(!pe.current)return;let t=pe.current,n=t.selectionStart,r=t.selectionEnd,i=U;W(i.slice(0,n)+e+i.slice(r)),setTimeout(()=>{if(t){let r=n+e.length;t.focus(),t.setSelectionRange(r,r)}},10)},[U,W]),qe=(0,Q.useRef)(null),Je=(0,Q.useRef)(null),Ye=(0,Q.useCallback)(()=>{if(h)r?.();else if(qe.current){let e=qe.current.querySelector(`button`);e&&e.click()}},[h,r]),Xe=(0,Q.useCallback)(()=>{if(Je.current){let e=Je.current.querySelector(`button`);e&&e.click()}},[]),Qe=()=>{w===`normal`?T(`recording`):w===`recording`&&(we&&Ee().catch(e=>console.error(`åœæ­¢è¯­éŸ³è¯†åˆ«å‡ºé”™:`,e)),T(`normal`))},et=async t=>{if(t&&t.trim()){let n=[...P,...I.filter(e=>e.mimeType.startsWith(`image/`)).map(e=>({base64Data:e.base64Data,url:e.url||``,width:e.width,height:e.height}))],r=await Promise.all(n.map(async e=>{let t=e.base64Data||e.url;if(e.url&&e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/)){let n=e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/);if(n&&n[1])try{let e=n[1],r=await D.getImageBlob(e);r&&(t=await new Promise(e=>{let t=new FileReader;t.onload=()=>e(t.result),t.readAsDataURL(r)}))}catch(e){console.error(`åŠ è½½å›¾ç‰‡å¼•ç”¨å¤±è´¥:`,e)}}return{type:`image_url`,image_url:{url:t}}})),i=I.filter(e=>!e.mimeType.startsWith(`image/`));if(e(t.trim(),r.length>0?r:void 0,g,i),F([]),L([]),z(!1),T(`normal`),`navigator`in window&&`vibrate`in navigator)try{navigator.vibrate(50)}catch{}}};return(0,$.jsxs)(`div`,{className:`chat-input-container`,style:{backgroundColor:`transparent`,...(()=>Ce?{paddingTop:`0px`,paddingBottom:C?`34px`:`4px`,maxWidth:`100%`,marginTop:`0`,marginLeft:`0`,marginRight:`0`,paddingLeft:`8px`,paddingRight:`8px`}:K?{paddingTop:`0px`,paddingBottom:C?`34px`:`4px`,maxWidth:`calc(100% - 40px)`,marginTop:`0`,marginLeft:`auto`,marginRight:`auto`}:{paddingTop:`0px`,paddingBottom:C?`34px`:`6px`,maxWidth:`calc(100% - 32px)`,marginTop:`0`,marginLeft:`auto`,marginRight:`auto`})(),width:`100%`,display:`flex`,flexDirection:`column`,alignItems:`center`,justifyContent:`center`,zIndex:1e3,boxShadow:`none`,transition:`all 0.3s ease`,marginBottom:`0`,paddingBottom:C?`34px`:`0`,border:`none`,position:`relative`},children:[ce()&&(()=>(0,$.jsx)(Y,{sx:{px:1,mb:1},children:(0,$.jsx)(qt,{knowledgeBaseName:le()?.knowledgeBase?.name||`æœªçŸ¥çŸ¥è¯†åº“`,onRemove:()=>{ue(),ie(e=>e+1)}})},`knowledge-${re}`))(),(0,$.jsx)(ln,{ref:V,images:P,files:I,setImages:F,setFiles:L,setUploadingMedia:z,fileStatuses:ee,setFileStatuses:B,isDarkMode:se,isMobile:Ce,borderRadius:Me}),(0,$.jsxs)(`div`,{style:{display:`flex`,alignItems:`center`,padding:K?`6px 12px`:`5px 8px`,borderRadius:Me,background:`var(--theme-bg-paper)`,border:je,minHeight:K?`56px`:Ce?`48px`:`50px`,boxShadow:Ne,width:`100%`,maxWidth:`100%`,backdropFilter:H===`modern`?`blur(10px)`:`none`,WebkitBackdropFilter:H===`modern`?`blur(10px)`:`none`,transition:`all 0.3s ease`,position:`relative`,userSelect:`none`,WebkitUserSelect:`none`,MozUserSelect:`none`,msUserSelect:`none`,WebkitTouchCallout:`none`,WebkitTapHighlightColor:`transparent`},children:[M&&(0,$.jsx)(`div`,{style:{position:`absolute`,top:`4px`,right:`4px`,zIndex:10},children:(0,$.jsx)(X,{title:A?`æ”¶èµ·è¾“å…¥æ¡†`:`å±•å¼€è¾“å…¥æ¡†`,children:(0,$.jsx)(S,{onClick:Ve,size:`small`,style:{color:A?`#2196F3`:Pe,padding:`2px`,width:`20px`,height:`20px`,minWidth:`20px`,backgroundColor:se?`rgba(42, 42, 42, 0.9)`:`rgba(255, 255, 255, 0.9)`,backdropFilter:`blur(4px)`,borderRadius:`6px`,boxShadow:`0 2px 4px rgba(0,0,0,0.1)`,transition:`all 0.2s ease`},children:A?(0,$.jsx)(De,{size:14}):(0,$.jsx)(Ze,{size:14})})})}),!O&&(0,$.jsx)(X,{title:w===`normal`?`åˆ‡æ¢åˆ°è¯­éŸ³è¾“å…¥æ¨¡å¼`:`é€€å‡ºè¯­éŸ³è¾“å…¥æ¨¡å¼`,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{onClick:Qe,disabled:R||i&&!a,size:K?`large`:`medium`,style:{color:w===`normal`?se?`#ffffff`:`#000000`:`#f44336`,padding:K?`10px`:`8px`,backgroundColor:w===`normal`?`transparent`:`rgba(211, 47, 47, 0.15)`,transition:`all 0.25s ease-in-out`},children:w===`normal`?(0,$.jsx)(d,{size:K?28:24}):(0,$.jsx)(c,{size:K?28:24})})})}),w===`recording`?(0,$.jsx)(`div`,{style:{flexGrow:1,margin:K?`0 12px`:`0 8px`,position:`relative`},children:(0,$.jsx)(u,{isDarkMode:se,onClose:()=>T(`normal`),onSendMessage:et,onInsertText:e=>{W(e)},startRecognition:Te,currentMessage:U})}):(0,$.jsx)(dn,{message:U,textareaRef:pe,textareaHeight:ve,showCharCount:be,handleChange:ze,handleKeyDown:ge,handleCompositionStart:xe,handleCompositionEnd:Se,onPaste:e=>{V.current&&V.current.handlePaste(e)},isLoading:i,allowConsecutiveMessages:a,imageGenerationMode:o,videoGenerationMode:s,webSearchActive:f,isMobile:Ce,isTablet:K,isDarkMode:se,shouldHideVoiceButton:O,expanded:A,onExpandToggle:Ve}),w!==`recording`&&(0,$.jsx)(fn,{uploadingMedia:R,isLoading:i,allowConsecutiveMessages:a,isStreaming:m,imageGenerationMode:o,webSearchActive:f,images:P,files:I,isDarkMode:se,isTablet:K,disabledColor:Fe,handleOpenUploadMenu:He,handleSubmit:Ae,onStopResponse:p,canSendMessage:me})]}),(0,$.jsx)(Qt,{anchorEl:v,open:!!v,onClose:Ue,onImageUpload:We,onFileUpload:Ge,onMultiModelSend:()=>x(!0),showMultiModel:!!(t&&_.length>1&&!m&&me()),onAIDebate:Ye,showAIDebate:de,isDebating:h,onQuickPhrase:Xe,showQuickPhrase:fe}),(0,$.jsx)(Zt,{open:b,onClose:()=>x(!1),availableModels:_,onSelectionChange:Ie,maxSelection:5}),(0,$.jsx)(Oe,{messages:te,onClose:e=>$e.remove(e),maxVisible:3}),(0,$.jsx)(`div`,{style:{position:`absolute`,left:`-9999px`,top:`-9999px`},ref:qe,children:(0,$.jsx)(mn,{onStartDebate:n,onStopDebate:r,isDebating:h,disabled:!1,question:U})}),(0,$.jsx)(`div`,{ref:Je,style:{position:`fixed`,top:`50%`,left:`50%`,transform:`translate(-50%, -50%)`,zIndex:-1,opacity:0,pointerEvents:`none`},children:(0,$.jsx)(Dn,{onInsertPhrase:Ke,assistant:ae,disabled:!1,size:`medium`})})]})};const kn=()=>{let e=gt(),t=(0,Q.useRef)(!1);return{handleCreateTopic:async()=>{if(t.current)return console.log(`[useTopicManagement] æ­£åœ¨åˆ›å»ºè¯é¢˜ï¼Œè·³è¿‡é‡å¤è¯·æ±‚`),null;t.current=!0;try{console.log(`[useTopicManagement] å¼€å§‹åˆ›å»ºè¯é¢˜ - Cherry Studioæ¨¡å¼`),xe.emit(G.ADD_NEW_TOPIC);let t=await Ye.getCurrentAssistant();if(!t)return null;let n=Be(t.id);return console.log(`[useTopicManagement] ç«‹å³æ›´æ–°Reduxå’Œé€‰æ‹©æ–°è¯é¢˜:`,n.id),Te.dispatch(T({assistantId:t.id,topic:n})),e(He.setCurrentTopicId(n.id)),xe.emit(G.SHOW_TOPIC_SIDEBAR),xe.emit(G.TOPIC_CREATED,{topic:n,assistantId:t.id,type:`create`}),Promise.resolve().then(async()=>{try{await Fe.saveTopic(n),await Ye.addAssistantMessagesToTopic({assistant:t,topic:n}),console.log(`[useTopicManagement] å¼‚æ­¥ä¿å­˜å®Œæˆ`)}catch(e){console.error(`[useTopicManagement] å¼‚æ­¥ä¿å­˜è¯é¢˜å¤±è´¥:`,e)}}),console.log(`[useTopicManagement] è¯é¢˜åˆ›å»ºå®Œæˆï¼ŒUIå·²ç«‹å³æ›´æ–°`),n}catch(e){return console.error(`[useTopicManagement] åˆ›å»ºè¯é¢˜å¤±è´¥:`,e),null}finally{setTimeout(()=>{t.current=!1},500)}}}},An=e=>({container:{background:`transparent`,border:`none`,borderRadius:`24px`,padding:`0 8px`,position:`relative`},button:{position:`relative`,background:e?`rgba(255, 255, 255, 0.02)`:`rgba(255, 255, 255, 0.06)`,border:e?`1px solid rgba(255, 255, 255, 0.04)`:`1px solid rgba(255, 255, 255, 0.08)`,borderRadius:`16px`,padding:`8px 14px`,backdropFilter:`blur(40px) saturate(200%) brightness(105%)`,WebkitBackdropFilter:`blur(40px) saturate(200%) brightness(105%)`,boxShadow:e?`0 4px 20px rgba(0, 0, 0, 0.06),
           0 1px 4px rgba(0, 0, 0, 0.04),
           inset 0 1px 0 rgba(255, 255, 255, 0.03),
           inset 0 -1px 0 rgba(255, 255, 255, 0.01)`:`0 4px 20px rgba(0, 0, 0, 0.03),
           0 1px 4px rgba(0, 0, 0, 0.02),
           inset 0 1px 0 rgba(255, 255, 255, 0.12),
           inset 0 -1px 0 rgba(255, 255, 255, 0.06)`,transition:`all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)`,cursor:`pointer`,display:`flex`,alignItems:`center`,gap:`8px`,minHeight:`36px`,userSelect:`none`,WebkitUserSelect:`none`,willChange:`transform, background, box-shadow, backdrop-filter`,transform:`translateZ(0)`,"&::before":{content:`""`,position:`absolute`,top:`1px`,left:`1px`,right:`1px`,height:`40%`,background:e?`linear-gradient(180deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.005) 100%)`:`linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.01) 100%)`,borderRadius:`15px 15px 0 0`,pointerEvents:`none`}},buttonHover:{background:e?`rgba(255, 255, 255, 0.04)`:`rgba(255, 255, 255, 0.1)`,border:e?`1px solid rgba(255, 255, 255, 0.06)`:`1px solid rgba(255, 255, 255, 0.12)`,backdropFilter:`blur(50px) saturate(220%) brightness(108%)`,WebkitBackdropFilter:`blur(50px) saturate(220%) brightness(108%)`,boxShadow:e?`0 8px 30px rgba(0, 0, 0, 0.08),
           0 2px 8px rgba(0, 0, 0, 0.06),
           inset 0 1px 0 rgba(255, 255, 255, 0.05),
           inset 0 -1px 0 rgba(255, 255, 255, 0.02)`:`0 8px 30px rgba(0, 0, 0, 0.04),
           0 2px 8px rgba(0, 0, 0, 0.03),
           inset 0 1px 0 rgba(255, 255, 255, 0.18),
           inset 0 -1px 0 rgba(255, 255, 255, 0.08)`,transform:`translateY(-1px) scale(1.01) translateZ(0)`},buttonActive:{background:e?`rgba(255, 255, 255, 0.06)`:`rgba(255, 255, 255, 0.14)`,border:e?`1px solid rgba(255, 255, 255, 0.08)`:`1px solid rgba(255, 255, 255, 0.16)`,backdropFilter:`blur(35px) saturate(240%) brightness(112%)`,WebkitBackdropFilter:`blur(35px) saturate(240%) brightness(112%)`,boxShadow:e?`0 2px 12px rgba(0, 0, 0, 0.1),
           inset 0 1px 4px rgba(0, 0, 0, 0.04),
           inset 0 1px 0 rgba(255, 255, 255, 0.06)`:`0 2px 12px rgba(0, 0, 0, 0.05),
           inset 0 1px 4px rgba(0, 0, 0, 0.02),
           inset 0 1px 0 rgba(255, 255, 255, 0.22)`,transform:`translateY(0px) scale(0.98) translateZ(0)`},text:{fontSize:`13px`,fontWeight:600,color:e?`rgba(255, 255, 255, 0.92)`:`rgba(0, 0, 0, 0.85)`,textShadow:e?`0 1px 3px rgba(0, 0, 0, 0.4)`:`0 1px 3px rgba(255, 255, 255, 0.9)`,letterSpacing:`0.02em`}}),jn=e=>({container:{background:`transparent`,border:`none`,borderRadius:`24px`,padding:`0 8px`},button:{background:`transparent`,border:`none`,borderRadius:`20px`,padding:`6px 12px`,transition:`all 0.15s ease`,cursor:`pointer`,display:`flex`,alignItems:`center`,gap:`6px`,minHeight:`32px`},buttonHover:{background:e?`rgba(255, 255, 255, 0.06)`:`rgba(0, 0, 0, 0.04)`},buttonActive:{background:e?`rgba(255, 255, 255, 0.1)`:`rgba(0, 0, 0, 0.06)`,transform:`scale(0.96)`},text:{fontSize:`13px`,fontWeight:500,color:e?`rgba(255, 255, 255, 0.85)`:`rgba(0, 0, 0, 0.75)`}});var Mn=({onClearTopic:e,imageGenerationMode:t=!1,toggleImageGenerationMode:n,videoGenerationMode:r=!1,toggleVideoGenerationMode:i,webSearchActive:a=!1,toggleWebSearch:o,toolsEnabled:s=!0,onToolsEnabledChange:c})=>{let l=(0,Q.useRef)(null),u=(0,Q.useRef)(null),[d,f]=(0,Q.useState)(!1),[m,h]=(0,Q.useState)(0),[_,v]=(0,Q.useState)(0),[b,x]=(0,Q.useState)(!1),C=me().palette.mode===`dark`,w=gt(),{handleCreateTopic:T}=kn(),E=J(e=>e.webSearch)?.enabled||!1,D=J(e=>e.settings.toolbarDisplayStyle||`both`),O=J(e=>e.settings.toolbarCollapsed||!1),[k,A]=(0,Q.useState)(O),j=J(e=>e.settings.toolbarStyle||`glassmorphism`),M=J(e=>e.settings.toolbarButtons||{order:[`mcp-tools`,`new-topic`,`clear-topic`,`generate-image`,`generate-video`,`knowledge`,`web-search`],visibility:{"mcp-tools":!0,"new-topic":!0,"clear-topic":!0,"generate-image":!0,"generate-video":!0,knowledge:!0,"web-search":!0}}),N=j===`glassmorphism`?An(C):jn(C),P=e=>({...N.button,...e&&j===`glassmorphism`&&{background:C?`rgba(255, 255, 255, 0.15)`:`rgba(255, 255, 255, 0.28)`,border:C?`1px solid rgba(255, 255, 255, 0.18)`:`1px solid rgba(255, 255, 255, 0.35)`,backdropFilter:`blur(26px) saturate(220%) brightness(118%)`,WebkitBackdropFilter:`blur(26px) saturate(220%) brightness(118%)`,boxShadow:C?`0 6px 24px rgba(0, 0, 0, 0.18),
             0 2px 8px rgba(0, 0, 0, 0.12),
             inset 0 1px 0 rgba(255, 255, 255, 0.18),
             inset 0 -1px 0 rgba(255, 255, 255, 0.08)`:`0 6px 24px rgba(0, 0, 0, 0.09),
             0 2px 8px rgba(0, 0, 0, 0.06),
             inset 0 1px 0 rgba(255, 255, 255, 0.5),
             inset 0 -1px 0 rgba(255, 255, 255, 0.25)`,"&::after":{content:`""`,position:`absolute`,top:`2px`,left:`2px`,right:`2px`,height:`40%`,background:C?`linear-gradient(180deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.02) 100%)`:`linear-gradient(180deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.05) 100%)`,borderRadius:`18px 18px 0 0`,pointerEvents:`none`}},...e&&j===`transparent`&&{background:C?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.05)`}});(0,Q.useEffect)(()=>{if(b){let e=setTimeout(()=>{x(!1)},3e3);return()=>clearTimeout(e)}},[b]),(0,Q.useEffect)(()=>{A(O)},[O]),(0,Q.useEffect)(()=>()=>{u.current&&clearTimeout(u.current)},[]);let F=()=>{let e=!k;A(e),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{w(Se({toolbarCollapsed:e}))},500)},I=()=>{b?(e?.(),x(!1)):x(!0)},L=e=>{f(!0),h(e.pageX-l.current.offsetLeft),v(l.current.scrollLeft),l.current&&(l.current.style.cursor=`grabbing`)},R=()=>{f(!1),l.current&&(l.current.style.cursor=`grab`)},z=()=>{f(!1),l.current&&(l.current.style.cursor=`grab`)},ee=e=>{if(!d)return;e.preventDefault();let t=_-(e.pageX-l.current.offsetLeft-m)*1.5;if(l.current){let e=l.current.scrollWidth-l.current.clientWidth;t<0?l.current.scrollLeft=t*.3:t>e?l.current.scrollLeft=e+(t-e)*.3:l.current.scrollLeft=t}},B=e=>{f(!0),h(e.touches[0].pageX-l.current.offsetLeft),v(l.current.scrollLeft)},te=()=>{f(!1)},ne=e=>{if(!d)return;let t=_-(e.touches[0].pageX-l.current.offsetLeft-m)*1.5;if(l.current){let e=l.current.scrollWidth-l.current.clientWidth;t<0?l.current.scrollLeft=t*.3:t>e?l.current.scrollLeft=e+(t-e)*.3:l.current.scrollLeft=t}},V={"mcp-tools":c?{id:`mcp-tools`,component:`MCPToolsButton`,isActive:s}:null,"new-topic":{id:`new-topic`,icon:(0,$.jsx)(p,{size:16,color:C?`rgba(76, 175, 80, 0.8)`:`rgba(76, 175, 80, 0.7)`}),label:`æ–°å»ºè¯é¢˜`,onClick:T,isActive:!1},"clear-topic":{id:`clear-topic`,icon:b?(0,$.jsx)(ae,{size:16,color:C?`rgba(244, 67, 54, 0.8)`:`rgba(244, 67, 54, 0.7)`}):(0,$.jsx)(y,{size:16,color:C?`rgba(33, 150, 243, 0.8)`:`rgba(33, 150, 243, 0.7)`}),label:b?`ç¡®è®¤æ¸…ç©º`:`æ¸…ç©ºå†…å®¹`,onClick:I,isActive:b},"generate-image":{id:`generate-image`,icon:(0,$.jsx)(St,{name:`imageGenerate`,size:16,color:t?C?`rgba(156, 39, 176, 0.9)`:`rgba(156, 39, 176, 0.8)`:C?`rgba(156, 39, 176, 0.6)`:`rgba(156, 39, 176, 0.5)`}),label:t?`å–æ¶ˆç”Ÿæˆ`:`ç”Ÿæˆå›¾ç‰‡`,onClick:n,isActive:t},"generate-video":{id:`generate-video`,icon:(0,$.jsx)(g,{size:16,color:r?C?`rgba(233, 30, 99, 0.9)`:`rgba(233, 30, 99, 0.8)`:C?`rgba(233, 30, 99, 0.6)`:`rgba(233, 30, 99, 0.5)`}),label:r?`å–æ¶ˆç”Ÿæˆ`:`ç”Ÿæˆè§†é¢‘`,onClick:i,isActive:r},knowledge:{id:`knowledge`,component:`KnowledgeButton`,isActive:!1},"web-search":E&&o?{id:`web-search`,component:`WebSearchButton`,isActive:a}:null},re=M.order.filter(e=>M.visibility[e]&&V[e]).map(e=>V[e]).filter(e=>e!==null);return(0,$.jsx)(Y,{sx:{padding:`4px 0 0 0`,backgroundColor:`transparent`,width:`100%`,position:`relative`,overflow:`visible`,zIndex:1,display:`flex`,justifyContent:`center`,alignItems:`center`},children:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,width:`100%`,maxWidth:`800px`,position:`relative`,...N.container},children:[(0,$.jsx)(S,{onClick:F,size:`small`,sx:{...j===`glassmorphism`?{background:C?`rgba(255, 255, 255, 0.02)`:`rgba(255, 255, 255, 0.05)`,border:C?`1px solid rgba(255, 255, 255, 0.03)`:`1px solid rgba(255, 255, 255, 0.08)`,borderRadius:`14px`,width:32,height:32,backdropFilter:`blur(18px) saturate(180%) brightness(110%)`,WebkitBackdropFilter:`blur(18px) saturate(180%) brightness(110%)`,boxShadow:C?`0 6px 20px rgba(0, 0, 0, 0.1),
                   0 1px 4px rgba(0, 0, 0, 0.06),
                   inset 0 1px 0 rgba(255, 255, 255, 0.06)`:`0 6px 20px rgba(0, 0, 0, 0.05),
                   0 1px 4px rgba(0, 0, 0, 0.03),
                   inset 0 1px 0 rgba(255, 255, 255, 0.25)`,transition:`all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)`,marginRight:1,"&:hover":{background:C?`rgba(255, 255, 255, 0.07)`:`rgba(255, 255, 255, 0.15)`,border:C?`1px solid rgba(255, 255, 255, 0.1)`:`1px solid rgba(255, 255, 255, 0.22)`,backdropFilter:`blur(22px) saturate(200%) brightness(115%)`,WebkitBackdropFilter:`blur(22px) saturate(200%) brightness(115%)`,boxShadow:C?`0 8px 28px rgba(0, 0, 0, 0.12),
                     0 2px 8px rgba(0, 0, 0, 0.08),
                     inset 0 1px 0 rgba(255, 255, 255, 0.1)`:`0 8px 28px rgba(0, 0, 0, 0.06),
                     0 2px 8px rgba(0, 0, 0, 0.04),
                     inset 0 1px 0 rgba(255, 255, 255, 0.35)`,transform:`translateY(-1px) scale(1.05)`},"&:active":{transform:`translateY(0px) scale(0.95)`,boxShadow:C?`0 2px 8px rgba(0, 0, 0, 0.15),
                     inset 0 2px 6px rgba(0, 0, 0, 0.08)`:`0 2px 8px rgba(0, 0, 0, 0.08),
                     inset 0 2px 6px rgba(0, 0, 0, 0.04)`}}:{background:`transparent`,borderRadius:`16px`,width:28,height:28,transition:`all 0.15s ease`,marginRight:.5,"&:hover":{background:C?`rgba(255, 255, 255, 0.06)`:`rgba(0, 0, 0, 0.04)`}},color:C?`rgba(255, 255, 255, 0.8)`:`rgba(0, 0, 0, 0.8)`,flexShrink:0},children:(0,$.jsx)(Ue,{size:16,style:{transition:`transform 0.2s ease`,transform:k?`rotate(180deg)`:`rotate(0deg)`}})}),(0,$.jsx)(Y,{sx:{display:k?`none`:`flex`,alignItems:`center`,flex:1,overflow:`hidden`},children:(0,$.jsx)(Y,{ref:l,sx:{display:`flex`,overflowX:`auto`,padding:`0 8px`,scrollbarWidth:`none`,"&::-webkit-scrollbar":{display:`none`},whiteSpace:`nowrap`,minHeight:`38px`,alignItems:`center`,justifyContent:{xs:`flex-start`,md:`center`},cursor:`grab`,willChange:`transform`,transform:`translateZ(0)`,width:`100%`,"&:active":{cursor:`grabbing`}},onMouseDown:L,onMouseUp:R,onMouseLeave:z,onMouseMove:ee,onTouchStart:B,onTouchEnd:te,onTouchMove:ne,children:re.map(e=>{if(`component`in e&&e.component===`MCPToolsButton`)return(0,$.jsx)(Y,{sx:{mr:1},children:(0,$.jsx)(Rn,{toolsEnabled:s,onToolsEnabledChange:c,variant:`toolbar`})},e.id);if(`component`in e&&e.component===`WebSearchButton`)return(0,$.jsx)(Y,{sx:{mr:1},children:(0,$.jsx)(Vn,{webSearchActive:a,toggleWebSearch:o,variant:`toolbar`})},e.id);if(`component`in e&&e.component===`KnowledgeButton`)return(0,$.jsx)(Y,{sx:{mr:1},children:(0,$.jsx)(tr,{variant:`toolbar`})},e.id);if(!(`onClick`in e)||!(`icon`in e)||!(`label`in e))return null;let t=P(e.isActive);return(0,$.jsxs)(Y,{onClick:e.onClick,sx:{...t,margin:j===`glassmorphism`?`0 4px`:`0 2px`,"&:hover":{...N.buttonHover},"&:active":{...N.buttonActive}},children:[D!==`text`&&e.icon,D!==`icon`&&(0,$.jsx)(Z,{variant:`body2`,sx:{...N.text,ml:D===`both`?.5:0},children:e.label})]},e.id)})})})]})})};const Nn=()=>{let e=(0,Q.useCallback)(async(e,t,n)=>{try{e?Re.hasSavedActiveServers()&&(await Re.restoreSavedActiveServers(),t?.(),console.log(`[MCP] æ€»å¼€å…³å¼€å¯ï¼Œå·²æ¢å¤ä¹‹å‰çš„æ´»è·ƒæœåŠ¡å™¨çŠ¶æ€`)):(await Re.stopAllActiveServers(),t?.(),console.log(`[MCP] æ€»å¼€å…³å…³é—­ï¼Œå·²åœæ­¢æ‰€æœ‰æ´»è·ƒæœåŠ¡å™¨`)),n?.(e)}catch(t){let r=e?`æ¢å¤æœåŠ¡å™¨çŠ¶æ€`:`åœæ­¢æœåŠ¡å™¨`;console.error(`[MCP] ${r}å¤±è´¥:`,t),n?.(e)}},[]);return{handleMCPToggle:e,createMCPToggleHandler:(0,Q.useCallback)((t,n)=>r=>e(r,t,n),[e])}};var Pn={httpStream:{icon:H,color:`#9c27b0`,label:`HTTP Stream`},sse:{icon:H,color:`#2196f3`,label:`SSE`},streamableHttp:{icon:H,color:`#00bcd4`,label:`Streamable HTTP`},stdio:{icon:te,color:`#ff9800`,label:`stdio`},inMemory:{icon:Ae,color:`#4CAF50`,label:`In Memory`},default:{icon:le,color:`#9e9e9e`,label:`Default`}},Fn=Q.memo(({open:e,onClose:t,toolsEnabled:n=!1,onToolsEnabledChange:r})=>{let i=tt(),[a,o]=(0,Q.useState)([]),[s,c]=(0,Q.useState)({}),[l,u]=(0,Q.useState)(null),[d,f]=(0,Q.useState)(!0),{createMCPToggleHandler:m}=Nn(),h=(0,Q.useMemo)(()=>a.filter(e=>e.isActive),[a]),g=h.length>0,_=(0,Q.useCallback)(()=>{try{o(Re.getServers()),u(null)}catch(e){console.error(`åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:`,e),u(`åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥`)}finally{f(!1)}},[]);(0,Q.useEffect)(()=>{e&&_()},[e,_]);let v=(0,Q.useCallback)(async(e,t)=>{c(t=>({...t,[e]:!0})),u(null);try{if(await Re.toggleServer(e,t),_(),r){let e=Re.getActiveServers();t&&!n?(console.log(`[MCP] å¼€å¯æœåŠ¡å™¨ï¼Œè‡ªåŠ¨å¯ç”¨MCPå·¥å…·æ€»å¼€å…³`),r(!0)):!t&&e.length===0&&n&&(console.log(`[MCP] æ‰€æœ‰æœåŠ¡å™¨å·²å…³é—­ï¼Œè‡ªåŠ¨ç¦ç”¨MCPå·¥å…·æ€»å¼€å…³`),r(!1))}}catch(e){console.error(`åˆ‡æ¢æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:`,e),u(`åˆ‡æ¢æœåŠ¡å™¨çŠ¶æ€å¤±è´¥: ${e instanceof Error?e.message:`æœªçŸ¥é”™è¯¯`}`)}finally{c(t=>{let{[e]:n,...r}=t;return r})}},[_,r,n]),y=(0,Q.useCallback)(()=>{t(),i(`/settings/mcp-server`)},[i,t]),b=(0,Q.useCallback)(e=>m(_,r)(e),[m,_,r]),S=(0,Q.useCallback)(e=>{let t=(Pn[e]||Pn.default).icon;return(0,$.jsx)(t,{size:16})},[]),C=(0,Q.useCallback)(e=>(Pn[e]||Pn.default).color,[]);return(0,$.jsxs)(j,{open:e,onClose:t,maxWidth:`sm`,fullWidth:!0,transitionDuration:0,slotProps:{paper:{sx:{borderRadius:2,maxHeight:`80vh`}}},children:[(0,$.jsx)(Qe,{sx:{pb:1},children:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,justifyContent:`space-between`},children:[(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[(0,$.jsx)(pe,{size:20,color:`#10b981`}),(0,$.jsx)(Z,{variant:`h6`,fontWeight:600,children:`MCP å·¥å…·æœåŠ¡å™¨`}),g&&(0,$.jsx)(lt,{label:`${h.length} ä¸ªè¿è¡Œä¸­`,size:`small`,color:`success`,variant:`outlined`})]}),r&&(0,$.jsx)(st,{checked:n,onChange:e=>b(e.target.checked)})]})}),(0,$.jsxs)(Ke,{sx:{p:0},children:[l&&(0,$.jsx)(Y,{sx:{p:2},children:(0,$.jsx)(ue,{severity:`error`,onClose:()=>u(null),children:l})}),d?(0,$.jsx)(be,{sx:{py:0},children:[1,2,3].map(e=>(0,$.jsxs)(ve,{sx:{py:2},children:[(0,$.jsx)(x,{children:(0,$.jsx)(V,{variant:`circular`,width:32,height:32})}),(0,$.jsx)(yt,{primary:(0,$.jsx)(V,{variant:`text`,width:`60%`,height:24}),secondary:(0,$.jsxs)(Y,{sx:{display:`flex`,gap:1,mt:.5},children:[(0,$.jsx)(V,{variant:`rectangular`,width:60,height:20,sx:{borderRadius:`10px`}}),(0,$.jsx)(V,{variant:`rectangular`,width:50,height:20,sx:{borderRadius:`10px`}})]}),secondaryTypographyProps:{component:`div`}}),(0,$.jsx)(Y,{sx:{ml:`auto`},children:(0,$.jsx)(V,{variant:`rectangular`,width:40,height:24,sx:{borderRadius:`12px`}})})]},e))}):a.length===0?(0,$.jsxs)(Y,{sx:{p:3,textAlign:`center`},children:[(0,$.jsx)(pe,{size:48,color:`rgba(0,0,0,0.4)`,style:{marginBottom:16}}),(0,$.jsx)(Z,{variant:`h6`,gutterBottom:!0,children:`è¿˜æ²¡æœ‰é…ç½® MCP æœåŠ¡å™¨`}),(0,$.jsx)(Z,{variant:`body2`,color:`text.secondary`,sx:{mb:3},children:`MCP æœåŠ¡å™¨å¯ä»¥ä¸º AI æä¾›é¢å¤–çš„å·¥å…·å’ŒåŠŸèƒ½`}),(0,$.jsx)(Pe,{variant:`contained`,startIcon:(0,$.jsx)(p,{size:16}),onClick:y,sx:{bgcolor:`#10b981`,"&:hover":{bgcolor:`#059669`}},children:`æ·»åŠ æœåŠ¡å™¨`})]}):(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(be,{sx:{py:0},children:a.map((e,t)=>(0,$.jsxs)(Q.Fragment,{children:[(0,$.jsxs)(ve,{sx:{py:2},secondaryAction:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[s[e.id]&&(0,$.jsx)(ut,{size:16}),(0,$.jsx)(st,{checked:e.isActive,onChange:t=>v(e.id,t.target.checked),disabled:s[e.id]||!1})]}),children:[(0,$.jsx)(x,{children:(0,$.jsx)(Xe,{sx:{bgcolor:rt(C(e.type),.1),color:C(e.type),width:32,height:32},children:S(e.type)})}),(0,$.jsx)(yt,{primary:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[(0,$.jsx)(Z,{variant:`subtitle2`,fontWeight:600,children:e.name}),e.isActive&&(0,$.jsx)(lt,{label:`è¿è¡Œä¸­`,size:`small`,color:`success`,variant:`outlined`})]}),secondary:(0,$.jsxs)(Y,{component:`div`,children:[e.description&&(0,$.jsx)(Z,{variant:`body2`,color:`text.secondary`,component:`span`,sx:{display:`block`},children:e.description}),e.baseUrl&&(0,$.jsx)(Z,{variant:`caption`,color:`text.secondary`,component:`span`,sx:{display:`block`},children:e.baseUrl})]}),slotProps:{secondary:{component:`div`}}})]}),t<a.length-1&&(0,$.jsx)(ct,{})]},e.id))}),(0,$.jsx)(Y,{sx:{p:2,borderTop:`1px solid`,borderColor:`divider`},children:(0,$.jsx)(Pe,{fullWidth:!0,variant:`outlined`,startIcon:(0,$.jsx)(le,{size:16}),onClick:y,size:`small`,children:`ç®¡ç† MCP æœåŠ¡å™¨`})})]})]}),(0,$.jsx)(ke,{children:(0,$.jsx)(Pe,{onClick:t,children:`å…³é—­`})})]})}),In=e=>e.settings?.toolbarDisplayStyle||`both`,Ln=e=>e.settings?.toolbarStyle||`glassmorphism`,Rn=Q.memo(({toolsEnabled:e=!1,onToolsEnabledChange:t,variant:n=`toolbar`})=>{let r=me().palette.mode===`dark`,[i,a]=(0,Q.useState)(!1),[o,s]=(0,Q.useState)([]),c=J(In),l=J(Ln),u=(0,Q.useMemo)(()=>o.filter(e=>e.isActive),[o]),d=(0,Q.useMemo)(()=>l===`glassmorphism`?An(r):jn(r),[l,r]),f=(0,Q.useCallback)(()=>{try{s(Re.getServers())}catch(e){console.error(`åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:`,e)}},[]);(0,Q.useEffect)(()=>{f()},[f]);let p=(0,Q.useCallback)(()=>{a(!0)},[]),m=(0,Q.useCallback)(()=>{a(!1),f()},[f]),h=(0,Q.useCallback)(e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),p())},[p]),g=u.length>0;return(0,$.jsxs)($.Fragment,{children:[(()=>{if(n===`icon-button-compact`){let e=g?`#4CAF50`:r?`#B0B0B0`:`#555`;return(0,$.jsx)(X,{title:`MCPå·¥å…·`,children:(0,$.jsx)(S,{size:`small`,onClick:p,sx:{color:e,backgroundColor:g?`${e}15`:`transparent`,border:g?`1px solid ${e}30`:`1px solid transparent`,width:34,height:34,borderRadius:`8px`,transition:`all 0.2s ease`,"&:hover":{backgroundColor:`${e}20`,borderColor:`${e}50`,color:e,transform:`translateY(-1px)`,boxShadow:`0 2px 8px ${e}20`}},children:(0,$.jsx)(pe,{size:20})})})}return n===`icon-button-integrated`?(0,$.jsx)(X,{title:`MCPå·¥å…·`,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{size:`medium`,onClick:p,disabled:!1,style:{color:g?`#4CAF50`:r?`#ffffff`:`#000000`,padding:`6px`,backgroundColor:g?`rgba(59, 130, 246, 0.1)`:`transparent`,transition:`all 0.2s ease-in-out`},children:(0,$.jsx)(pe,{size:20})})})}):(0,$.jsxs)(Y,{role:`button`,tabIndex:0,"aria-label":`æ‰“å¼€ MCP å·¥å…·ç®¡ç†`,onClick:p,onKeyDown:h,sx:{...d.button,...g&&l===`glassmorphism`&&{background:r?`rgba(16, 185, 129, 0.15)`:`rgba(16, 185, 129, 0.2)`,border:r?`1px solid rgba(16, 185, 129, 0.25)`:`1px solid rgba(16, 185, 129, 0.35)`,boxShadow:r?`0 4px 16px rgba(16, 185, 129, 0.1), 0 1px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(16, 185, 129, 0.2)`:`0 4px 16px rgba(16, 185, 129, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(16, 185, 129, 0.3)`},...g&&l===`transparent`&&{background:r?`rgba(16, 185, 129, 0.08)`:`rgba(16, 185, 129, 0.05)`},margin:l===`glassmorphism`?`0 4px`:`0 2px`,"&:hover":{...d.buttonHover,...g&&l===`glassmorphism`&&{background:r?`rgba(16, 185, 129, 0.2)`:`rgba(16, 185, 129, 0.25)`,border:r?`1px solid rgba(16, 185, 129, 0.3)`:`1px solid rgba(16, 185, 129, 0.4)`,boxShadow:r?`0 6px 24px rgba(16, 185, 129, 0.15), 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(16, 185, 129, 0.25)`:`0 6px 24px rgba(16, 185, 129, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(16, 185, 129, 0.4)`},...g&&l===`transparent`&&{background:r?`rgba(16, 185, 129, 0.12)`:`rgba(16, 185, 129, 0.08)`}},"&:active":{...d.buttonActive},"&:focus":{outline:`2px solid ${r?`rgba(16, 185, 129, 0.8)`:`rgba(16, 185, 129, 0.6)`}`,outlineOffset:`2px`}},title:`MCP å·¥å…·`,children:[c!==`text`&&(0,$.jsx)(pe,{size:16,color:g?r?`rgba(16, 185, 129, 0.9)`:`rgba(16, 185, 129, 0.8)`:r?`rgba(255, 255, 255, 0.85)`:`rgba(0, 0, 0, 0.75)`}),c!==`icon`&&(0,$.jsx)(Z,{variant:`body2`,sx:{fontWeight:600,fontSize:`13px`,color:g?r?`rgba(16, 185, 129, 0.95)`:`rgba(16, 185, 129, 0.9)`:r?`rgba(255, 255, 255, 0.9)`:`rgba(0, 0, 0, 0.8)`,textShadow:r?`0 1px 2px rgba(0, 0, 0, 0.3)`:`0 1px 2px rgba(255, 255, 255, 0.8)`,letterSpacing:`0.01em`,ml:c===`both`?.5:0},children:`å·¥å…·`})]})})(),(0,$.jsx)(Fn,{open:i,onClose:m,toolsEnabled:e,onToolsEnabledChange:t})]})}),zn=[],Bn=({open:e,onClose:t,onProviderSelect:n})=>{let i=gt(),a=tt(),o=J(e=>e.webSearch),s=o?.providers||zn,c=o?.provider||`bing-free`,l=o?.enabled||!1;if(!s||s.length===0)return(0,$.jsxs)(j,{open:e,onClose:t,maxWidth:`sm`,fullWidth:!0,children:[(0,$.jsx)(Qe,{children:`åŠ è½½ä¸­...`}),(0,$.jsx)(Ke,{children:(0,$.jsx)(Z,{children:`æ­£åœ¨åŠ è½½æœç´¢æä¾›å•†...`})})]});let u=e=>{i(R(e)),i(z(e)),n?.(e),t()},d=()=>{i(R(`custom`)),i(z(void 0)),n?.(``),t()},f=()=>{t(),a(`/settings/web-search`)},p=()=>{i(P())},m=e=>{switch(e){case`bing-free`:return`ğŸ†“`;case`tavily`:return`ğŸ”`;case`bing`:return`ğŸ”`;case`searxng`:return`ğŸŒ`;case`exa`:return`ğŸ¯`;case`bocha`:return`ğŸ¤–`;case`firecrawl`:return``;default:return`ğŸ”`}},h=e=>e.id===`bing-free`||e.id===`bing`?{available:!0,label:`å…è´¹å¯ç”¨`}:e.apiKey&&e.apiKey.trim()?{available:!0,label:`APIå¯†é’¥`}:e.apiHost&&e.apiHost.trim()?{available:!0,label:`è‡ªæ‰˜ç®¡`}:`basicAuthUsername`in e&&`basicAuthPassword`in e&&e.basicAuthUsername&&e.basicAuthPassword?{available:!0,label:`åŸºç¡€è®¤è¯`}:{available:!1,label:`éœ€è¦é…ç½®`},g=s;return(0,$.jsxs)(j,{open:e,onClose:t,maxWidth:`sm`,fullWidth:!0,PaperProps:{sx:{borderRadius:3,maxHeight:`80vh`}},children:[(0,$.jsxs)(Qe,{sx:{display:`flex`,alignItems:`center`,gap:1,pb:1},children:[(0,$.jsx)(H,{color:`#1976d2`}),(0,$.jsx)(Z,{variant:`h6`,component:`span`,children:`é€‰æ‹©æœç´¢æä¾›å•†`}),(0,$.jsx)(Y,{sx:{flexGrow:1}}),(0,$.jsx)(S,{onClick:p,size:`small`,title:`åˆ·æ–°æä¾›å•†åˆ—è¡¨`,children:(0,$.jsx)(_e,{})}),(0,$.jsx)(S,{onClick:t,size:`small`,children:(0,$.jsx)(ft,{})})]}),(0,$.jsxs)(Ke,{sx:{px:0,pb:2},children:[(0,$.jsx)(be,{dense:!0,children:(0,$.jsx)(ve,{disablePadding:!0,children:(0,$.jsxs)(he,{onClick:d,selected:!l||!c,sx:{mx:2,borderRadius:2,mb:1},children:[(0,$.jsx)(x,{children:(0,$.jsx)(Y,{sx:{width:32,height:32,borderRadius:1,display:`flex`,alignItems:`center`,justifyContent:`center`,bgcolor:rt(`#666`,.1),fontSize:`16px`},children:`ğŸš«`})}),(0,$.jsx)(yt,{primary:`ä¸ä½¿ç”¨ç½‘ç»œæœç´¢`,secondary:`ç¦ç”¨ç½‘ç»œæœç´¢åŠŸèƒ½`}),(!l||!c)&&(0,$.jsx)(N,{children:(0,$.jsx)(r,{color:`#1976d2`})})]})})}),(0,$.jsx)(ct,{sx:{my:1}}),g.length>0&&(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(Z,{variant:`subtitle2`,color:`text.secondary`,sx:{px:2,py:1},children:`æœç´¢æä¾›å•†`}),(0,$.jsx)(be,{dense:!0,children:g.map(e=>{let t=h(e),n=l&&c===e.id;return(0,$.jsx)(ve,{disablePadding:!0,children:(0,$.jsxs)(he,{onClick:()=>u(e.id),selected:n,sx:{mx:2,borderRadius:2,mb:.5},children:[(0,$.jsx)(x,{children:(0,$.jsx)(Y,{sx:{width:32,height:32,borderRadius:1,display:`flex`,alignItems:`center`,justifyContent:`center`,bgcolor:t.available?rt(`#3b82f6`,.1):rt(`#666`,.1),fontSize:`16px`,opacity:t.available?1:.6},children:m(e.id)})}),(0,$.jsx)(yt,{primary:e.name,secondary:t.available?`âœ“ ${t.label}`:`âš ï¸ ${t.label}`}),n&&(0,$.jsx)(N,{children:(0,$.jsx)(r,{color:`#1976d2`})})]})},e.id)})})]}),(0,$.jsx)(ct,{sx:{my:1}}),(0,$.jsx)(be,{dense:!0,children:(0,$.jsx)(ve,{disablePadding:!0,children:(0,$.jsxs)(he,{onClick:f,sx:{mx:2,borderRadius:2},children:[(0,$.jsx)(x,{children:(0,$.jsx)(le,{color:`#757575`})}),(0,$.jsx)(yt,{primary:`æœç´¢è®¾ç½®`,secondary:`é…ç½®æœç´¢æä¾›å•†å’Œé€‰é¡¹`})]})})})]})]})},Vn=({webSearchActive:e=!1,toggleWebSearch:t,variant:n=`toolbar`})=>{let r=me().palette.mode===`dark`,[i,a]=(0,Q.useState)(!1),o=J(e=>e.webSearch),s=o?.enabled||!1,c=o?.provider,l=J(e=>e.settings?.toolbarDisplayStyle||`both`),u=J(e=>e.settings?.toolbarStyle||`glassmorphism`),d=u===`glassmorphism`?An(r):jn(r),f=(0,Q.useCallback)(()=>{e?t?.():a(!0)},[e,t]),p=(0,Q.useCallback)(e=>{e&&t&&t()},[t]);return!s||!t?null:(0,$.jsxs)($.Fragment,{children:[(()=>{if(n===`icon-button-compact`){let t=e?`#3b82f6`:r?`#B0B0B0`:`#555`;return(0,$.jsx)(X,{title:e?`å…³é—­æœç´¢`:`ç½‘ç»œæœç´¢`,children:(0,$.jsx)(S,{size:`small`,onClick:f,sx:{color:t,backgroundColor:e?`${t}15`:`transparent`,border:e?`1px solid ${t}30`:`1px solid transparent`,width:34,height:34,borderRadius:`8px`,transition:`all 0.2s ease`,"&:hover":{backgroundColor:`${t}20`,borderColor:`${t}50`,color:t,transform:`translateY(-1px)`,boxShadow:`0 2px 8px ${t}20`}},children:(0,$.jsx)(m,{size:20})})})}if(n===`icon-button-integrated`)return(0,$.jsx)(X,{title:e?`é€€å‡ºç½‘ç»œæœç´¢æ¨¡å¼`:`ç½‘ç»œæœç´¢`,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{size:`medium`,onClick:f,disabled:!1,style:{color:e?`#3b82f6`:r?`#ffffff`:`#000000`,padding:`6px`,backgroundColor:e?`rgba(59, 130, 246, 0.1)`:`transparent`,transition:`all 0.2s ease-in-out`},children:(0,$.jsx)(St,{name:`search`,size:20})})})});let t=e?r?`rgba(59, 130, 246, 0.9)`:`rgba(59, 130, 246, 0.8)`:r?`rgba(59, 130, 246, 0.6)`:`rgba(59, 130, 246, 0.5)`;return(0,$.jsxs)(Y,{role:`button`,tabIndex:0,"aria-label":`ç½‘ç»œæœç´¢`,onClick:f,sx:{...d.button,...e&&u===`glassmorphism`&&{background:r?`rgba(59, 130, 246, 0.15)`:`rgba(59, 130, 246, 0.2)`,border:r?`1px solid rgba(59, 130, 246, 0.25)`:`1px solid rgba(59, 130, 246, 0.35)`,boxShadow:r?`0 4px 16px rgba(59, 130, 246, 0.1), 0 1px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(59, 130, 246, 0.2)`:`0 4px 16px rgba(59, 130, 246, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(59, 130, 246, 0.3)`},...e&&u===`transparent`&&{background:r?`rgba(59, 130, 246, 0.08)`:`rgba(59, 130, 246, 0.05)`},margin:u===`glassmorphism`?`0 4px`:`0 2px`,"&:hover":{...d.buttonHover,...e&&u===`glassmorphism`&&{background:r?`rgba(59, 130, 246, 0.2)`:`rgba(59, 130, 246, 0.25)`,border:r?`1px solid rgba(59, 130, 246, 0.3)`:`1px solid rgba(59, 130, 246, 0.4)`,boxShadow:r?`0 6px 24px rgba(59, 130, 246, 0.15), 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(59, 130, 246, 0.25)`:`0 6px 24px rgba(59, 130, 246, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(59, 130, 246, 0.4)`},...e&&u===`transparent`&&{background:r?`rgba(59, 130, 246, 0.12)`:`rgba(59, 130, 246, 0.08)`}},"&:active":{...d.buttonActive},"&:focus":{outline:`2px solid ${r?`rgba(59, 130, 246, 0.8)`:`rgba(59, 130, 246, 0.6)`}`,outlineOffset:`2px`}},title:e?`å…³é—­æœç´¢`:o?.providers?.find(e=>e.id===c)?.name||`æœç´¢`,children:[l!==`text`&&(0,$.jsx)(St,{name:`search`,size:16,color:t}),l!==`icon`&&(0,$.jsx)(Z,{variant:`body2`,sx:{fontWeight:600,fontSize:`13px`,color:e?r?`rgba(59, 130, 246, 0.95)`:`rgba(59, 130, 246, 0.9)`:r?`rgba(255, 255, 255, 0.9)`:`rgba(0, 0, 0, 0.8)`,textShadow:r?`0 1px 2px rgba(0, 0, 0, 0.3)`:`0 1px 2px rgba(255, 255, 255, 0.8)`,letterSpacing:`0.01em`,ml:l===`both`?.5:0},children:e?`å…³é—­æœç´¢`:o?.providers?.find(e=>e.id===c)?.name||`æœç´¢`})]})})(),(0,$.jsx)(Bn,{open:i,onClose:()=>a(!1),onProviderSelect:p})]})},Hn=q.div`
  padding: 5px 0;
  background-color: ${e=>e.theme?.palette?.background?.paper};
`,Un=q.div`
  max-height: 300px;
  overflow-y: auto;
  
  &::-webkit-scrollbar {
    width: 6px;
  }
  
  &::-webkit-scrollbar-track {
    background: transparent;
  }
  
  &::-webkit-scrollbar-thumb {
    background: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.2)`:`rgba(0, 0, 0, 0.2)`};
    border-radius: 3px;
  }
`,Wn=q.div`
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 0 5px 1px 5px;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.1s ease;
  background-color: ${e=>e.selected?e.theme?.palette?.mode===`dark`?`rgba(5, 150, 105, 0.25)`:`rgba(5, 150, 105, 0.15)`:`transparent`};

  &:hover {
    background-color: ${e=>e.selected?e.theme?.palette?.mode===`dark`?`rgba(5, 150, 105, 0.35)`:`rgba(5, 150, 105, 0.25)`:e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.04)`};
  }
`,Gn=q.div`
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
`,Kn=q.span`
  display: flex;
  align-items: center;
  justify-content: center;
  color: ${e=>e.selected?e.theme?.palette?.mode===`dark`?`rgba(5, 150, 105, 0.95)`:`rgba(5, 150, 105, 0.85)`:e.theme?.palette?.text?.secondary||`#666`};
  flex-shrink: 0;
`,qn=q.div`
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 0;
  gap: 2px;
`,Jn=q.span`
  font-size: 14px;
  line-height: 20px;
  font-weight: ${e=>e.selected?600:400};
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`,Yn=q.span`
  font-size: 12px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`,Xn=q.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px 6px;
  border-top: 1px solid ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.08)`};
`,Zn=q.div`
  font-size: 12px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
`,Qn=q.div`
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 11px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
`,$n=q.div`
  height: 1px;
  background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.08)`};
  margin: 4px 8px;
`,er=({open:e,onClose:n,onSelect:r})=>{let i=me(),a=tt(),[o,s]=(0,Q.useState)([]),[c,l]=(0,Q.useState)(!1),[u,d]=(0,Q.useState)(``),[f,m]=(0,Q.useState)(``),h=(0,Q.useRef)(!0);(0,Q.useEffect)(()=>()=>{h.current=!1},[]);let g=(0,Q.useCallback)(async()=>{try{l(!0),m(``);let e=await D.knowledge_bases.toArray(),t=await Promise.all(e.map(async e=>{let t=await D.knowledge_documents.where(`knowledgeBaseId`).equals(e.id).toArray();return{id:e.id,name:e.name,description:e.description,documentCount:t.length,createdAt:e.created_at}}));h.current&&s(t)}catch(e){console.error(`åŠ è½½çŸ¥è¯†åº“å¤±è´¥:`,e),h.current&&m(`åŠ è½½çŸ¥è¯†åº“å¤±è´¥ï¼Œè¯·é‡è¯•`)}finally{h.current&&l(!1)}},[]),_=(0,Q.useCallback)(()=>{d(``),m(``),n()},[n]),v=(0,Q.useCallback)(()=>{window.sessionStorage.removeItem(`selectedKnowledgeBase`),window.dispatchEvent(new CustomEvent(`knowledgeBaseSelected`,{detail:{knowledgeBase:null}})),_()},[_]),b=(0,Q.useCallback)(()=>{_(),a(`/knowledge`)},[_,a]),x=(0,Q.useCallback)(e=>{u===e.id?(r(e,[]),_()):d(e.id)},[u,r,_]),S=(0,Q.useCallback)(()=>{let e=o.find(e=>e.id===u);e&&(r(e,[]),_())},[u,o,r,_]);(0,Q.useEffect)(()=>{e&&(h.current=!0,g())},[e,g]);let C=(0,Q.useMemo)(()=>c?`loading`:f?`error`:o.length===0?`empty`:`loaded`,[c,f,o.length]);return(0,Q.useEffect)(()=>{if(!e)return;let t=e=>{e.key===`Escape`?(e.preventDefault(),_()):e.key===`Enter`&&u&&(e.preventDefault(),S())};return window.addEventListener(`keydown`,t),()=>{window.removeEventListener(`keydown`,t)}},[e,u,_,S]),(0,$.jsx)(Kt,{anchor:`bottom`,open:e,onClose:_,PaperProps:{sx:{borderTopLeftRadius:16,borderTopRightRadius:16,maxHeight:`60vh`,bgcolor:`background.paper`,pb:`var(--safe-area-bottom-computed, 0px)`}},children:(0,$.jsxs)(Y,{sx:{maxHeight:`60vh`,display:`flex`,flexDirection:`column`},children:[(0,$.jsx)(Y,{sx:{pt:1,pb:1.5,display:`flex`,justifyContent:`center`},children:(0,$.jsx)(Y,{sx:{width:40,height:4,bgcolor:e=>rt(e.palette.text.primary,.2),borderRadius:999}})}),(0,$.jsxs)(Hn,{theme:i,children:[f&&(0,$.jsx)(ue,{severity:`error`,sx:{mx:1,mb:1},children:f}),(0,$.jsxs)(Un,{theme:i,children:[(0,$.jsxs)(Wn,{theme:i,onClick:v,children:[(0,$.jsxs)(Gn,{children:[(0,$.jsx)(Kn,{theme:i,children:(0,$.jsx)(y,{size:18})}),(0,$.jsx)(Jn,{children:`æ¸…é™¤`})]}),(0,$.jsx)(Yn,{theme:i,children:`æ¸…é™¤å½“å‰å·²é€‰ä¸­çš„çŸ¥è¯†åº“`})]}),(0,$.jsx)($n,{theme:i}),C===`loading`?(0,$.jsx)(Y,{display:`flex`,justifyContent:`center`,py:3,children:(0,$.jsx)(ut,{size:24})}):C===`empty`?(0,$.jsx)(ue,{severity:`info`,sx:{mx:1},children:`æš‚æ— çŸ¥è¯†åº“ï¼Œè¯·å…ˆåˆ›å»ºçŸ¥è¯†åº“`}):(0,$.jsxs)($.Fragment,{children:[o.length>0&&o.map(e=>(0,$.jsx)(Wn,{theme:i,selected:u===e.id,onClick:()=>x(e),children:(0,$.jsxs)(Gn,{children:[(0,$.jsx)(Kn,{theme:i,selected:u===e.id,children:(0,$.jsx)(t,{size:20})}),(0,$.jsxs)(qn,{children:[(0,$.jsx)(Jn,{selected:u===e.id,children:e.name}),(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:.5},children:[e.description&&(0,$.jsx)(Yn,{theme:i,children:e.description.length>30?`${e.description.substring(0,30)}...`:e.description}),(0,$.jsx)(lt,{size:`small`,label:`${e.documentCount}ä¸ªæ–‡æ¡£`,sx:{height:18,fontSize:`11px`,"& .MuiChip-label":{px:.5}}})]})]})]})},e.id)),(0,$.jsx)($n,{theme:i}),(0,$.jsx)(Wn,{theme:i,onClick:b,children:(0,$.jsxs)(Gn,{children:[(0,$.jsx)(Kn,{theme:i,children:(0,$.jsx)(p,{size:18})}),(0,$.jsx)(Jn,{children:`æ·»åŠ çŸ¥è¯†åº“...`})]})})]})]}),(0,$.jsxs)(Xn,{theme:i,children:[(0,$.jsxs)(Zn,{theme:i,children:[`çŸ¥è¯†åº“ (`,o.length,`)`]}),(0,$.jsxs)(Qn,{theme:i,children:[(0,$.jsx)(`span`,{children:`ESC å…³é—­`}),(0,$.jsx)(`span`,{children:`å•å‡»é€‰æ‹©`}),(0,$.jsx)(`span`,{children:`â†©ï¸ ç¡®è®¤`})]})]})]})]})})},tr=({variant:e=`toolbar`,searchQuery:n})=>{let r=me().palette.mode===`dark`,[i,a]=(0,Q.useState)(!1),o=J(e=>e.settings?.toolbarDisplayStyle||`both`),s=J(e=>e.settings?.toolbarStyle||`glassmorphism`),c=s===`glassmorphism`?An(r):jn(r),l=(0,Q.useCallback)(()=>{a(!0)},[]),u=(0,Q.useCallback)((e,t)=>{console.log(`é€‰æ‹©äº†çŸ¥è¯†åº“:`,e,`æœç´¢ç»“æœ:`,t);let n={knowledgeBase:{id:e.id,name:e.name},isSelected:!0,searchOnSend:!0};console.log(`[çŸ¥è¯†åº“é€‰æ‹©] å‡†å¤‡ä¿å­˜åˆ°sessionStorage:`,n),window.sessionStorage.setItem(`selectedKnowledgeBase`,JSON.stringify(n));let r=window.sessionStorage.getItem(`selectedKnowledgeBase`);console.log(`[çŸ¥è¯†åº“é€‰æ‹©] sessionStorageä¿å­˜éªŒè¯:`,r),console.log(`[çŸ¥è¯†åº“é€‰æ‹©] å·²é€‰æ‹©çŸ¥è¯†åº“: ${e.name}ï¼Œå°†åœ¨å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨æœç´¢ç›¸å…³å†…å®¹`),window.dispatchEvent(new CustomEvent(`knowledgeBaseSelected`,{detail:{knowledgeBase:e}})),a(!1)},[]);return(0,$.jsxs)($.Fragment,{children:[(()=>{let n=r?`rgba(5, 150, 105, 0.8)`:`rgba(5, 150, 105, 0.7)`;return e===`icon-button-compact`?(0,$.jsx)(X,{title:`çŸ¥è¯†åº“`,children:(0,$.jsx)(S,{size:`small`,onClick:l,sx:{color:r?`#B0B0B0`:`#555`,backgroundColor:`transparent`,border:`1px solid transparent`,width:34,height:34,borderRadius:`8px`,transition:`all 0.2s ease`,"&:hover":{backgroundColor:`${n}20`,borderColor:`${n}50`,color:n,transform:`translateY(-1px)`,boxShadow:`0 2px 8px ${n}20`}},children:(0,$.jsx)(t,{size:20})})}):e===`icon-button-integrated`?(0,$.jsx)(X,{title:`çŸ¥è¯†åº“`,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{size:`medium`,onClick:l,disabled:!1,style:{color:r?`#ffffff`:`#000000`,padding:`6px`,backgroundColor:`transparent`,transition:`all 0.2s ease-in-out`},children:(0,$.jsx)(t,{size:20})})})}):(0,$.jsxs)(Y,{role:`button`,tabIndex:0,"aria-label":`çŸ¥è¯†åº“`,onClick:l,sx:{...c.button,margin:s===`glassmorphism`?`0 4px`:`0 2px`,"&:hover":{...c.buttonHover},"&:active":{...c.buttonActive},"&:focus":{outline:`2px solid ${r?`rgba(5, 150, 105, 0.8)`:`rgba(5, 150, 105, 0.6)`}`,outlineOffset:`2px`}},title:`çŸ¥è¯†åº“`,children:[o!==`text`&&(0,$.jsx)(t,{size:16,color:n}),o!==`icon`&&(0,$.jsx)(Z,{variant:`body2`,sx:{fontWeight:600,fontSize:`13px`,color:r?`rgba(255, 255, 255, 0.9)`:`rgba(0, 0, 0, 0.8)`,textShadow:r?`0 1px 2px rgba(0, 0, 0, 0.3)`:`0 1px 2px rgba(255, 255, 255, 0.8)`,letterSpacing:`0.01em`,ml:o===`both`?.5:0},children:`çŸ¥è¯†åº“`})]})})(),(0,$.jsx)(er,{open:i,onClose:()=>a(!1),onSelect:u,searchQuery:n})]})};const nr=({toolsEnabled:e,webSearchActive:t,imageGenerationMode:n,onNewTopic:r,onClearTopic:i,handleWebSearchClick:a,toggleImageGenerationMode:o})=>[{icon:(0,$.jsx)(pe,{size:20}),label:`å·¥å…·`,onClick:()=>{},color:e?`#4CAF50`:`#9E9E9E`,active:e},{icon:(0,$.jsx)(m,{size:20}),label:`ç½‘ç»œæœç´¢`,onClick:a,color:t?`#3b82f6`:`#607D8B`,active:t},{icon:(0,$.jsx)(s,{size:20}),label:`ç”Ÿæˆå›¾ç‰‡`,onClick:o||(()=>{}),color:n?`#9C27B0`:`#FF9800`,active:n},{icon:(0,$.jsx)(p,{size:20}),label:`æ–°å»ºè¯é¢˜`,onClick:r||(()=>{}),color:`#2196F3`},{icon:(0,$.jsx)(y,{size:20}),label:`æ¸…ç©ºå†…å®¹`,onClick:i||(()=>{}),color:`#f44336`}],rr=({toolsEnabled:e,uploadingMedia:r,toggleToolsEnabled:i,handleImageUpload:a,handleFileUpload:o,handleKnowledgeClick:c})=>[{icon:(0,$.jsx)(n,{size:20}),label:`æ‹ç…§ä¸Šä¼ `,onClick:()=>a(`camera`),color:`#FF9800`,disabled:r},{icon:(0,$.jsx)(s,{size:20}),label:`å›¾ç‰‡ä¸Šä¼ `,onClick:()=>a(`photos`),color:`#2196F3`,disabled:r},{icon:(0,$.jsx)(Gt,{size:20}),label:`æ–‡ä»¶ä¸Šä¼ `,onClick:o,color:`#9C27B0`,disabled:r},{icon:(0,$.jsx)(t,{size:20}),label:`çŸ¥è¯†åº“`,onClick:c||(()=>{}),color:`#059669`},{icon:(0,$.jsx)(pe,{size:20}),label:`é«˜çº§å·¥å…·`,onClick:i||(()=>{}),color:e?`#4CAF50`:`#9E9E9E`,active:e}];var ir=({onSendMessage:e,onSendMultiModelMessage:t,onStartDebate:n,onStopDebate:r,isLoading:i=!1,allowConsecutiveMessages:a=!0,imageGenerationMode:o=!1,onSendImagePrompt:s,webSearchActive:c=!1,onStopResponse:d,isStreaming:f=!1,isDebating:m=!1,toolsEnabled:g=!1,availableModels:_=[],onClearTopic:v,onNewTopic:y,toggleImageGenerationMode:b,toggleWebSearch:x,toggleToolsEnabled:C})=>{let[w,T]=(0,Q.useState)(!1),[D,O]=(0,Q.useState)(!1),[k,A]=(0,Q.useState)(!1),[j,M]=(0,Q.useState)(40),[N,P]=(0,Q.useState)(!1),[F,I]=(0,Q.useState)(!1),[L,R]=(0,Q.useState)(!1),z=(0,Q.useMemo)(()=>E(),[]),[ee,B]=(0,Q.useState)(!1),[te,ne]=(0,Q.useState)([]),[V,ie]=(0,Q.useState)([]),[ae,oe]=(0,Q.useState)([]),[se,H]=(0,Q.useState)(!1),[ce,le]=(0,Q.useState)(0),ue=J(e=>e.messages.currentTopicId),[de,fe]=(0,Q.useState)(null),{styles:U,isDarkMode:W,inputBoxStyle:pe}=Xt(),{hasKnowledgeContext:me,getStoredKnowledgeContext:he,clearStoredKnowledgeContext:ge}=Yt(),_e=J(e=>e.settings.showAIDebateButton??!0),ve=J(e=>e.settings.showQuickPhraseButton??!0),be=J(e=>e.assistants.currentAssistant),{handleImageUpload:xe,handleFileUpload:Se}=tn({currentTopicState:de,setUploadingMedia:H}),{message:G,setMessage:Ce,textareaRef:K,canSendMessage:we,handleSubmit:Te,handleKeyDown:Ee,handleChange:ke,showCharCount:q,handleCompositionStart:Ae,handleCompositionEnd:je}=Jt({onSendMessage:e,onSendMultiModelMessage:t,onSendImagePrompt:s,isLoading:i,allowConsecutiveMessages:a,imageGenerationMode:o,toolsEnabled:g,images:V,files:ae,setImages:ie,setFiles:oe,enableTextareaResize:!0,enableCompositionHandling:!0,enableCharacterCount:!0,availableModels:_}),{isListening:Me,error:Ne,startRecognition:Pe,stopRecognition:Fe}=Dt(),{isKeyboardVisible:Ie,hideKeyboard:Le}=ye(),Re=(0,Q.useCallback)(()=>{Le(),Te()},[Le,Te]);(0,Q.useEffect)(()=>{Ie&&k&&A(!1)},[Ie,k]),(0,Q.useEffect)(()=>{},[Ne]),(0,Q.useEffect)(()=>$e.subscribe(ne),[]),(0,Q.useEffect)(()=>{(async()=>{if(ue)try{let e=await dt.getTopic(ue);e&&fe(e)}catch(e){console.error(`åŠ è½½è¯é¢˜ä¿¡æ¯å¤±è´¥:`,e)}})()},[ue]),(0,Q.useEffect)(()=>{let e=()=>{le(e=>e+1)};return window.addEventListener(`knowledgeBaseSelected`,e),()=>{window.removeEventListener(`knowledgeBaseSelected`,e)}},[]);let ze=(0,Q.useRef)(k);(0,Q.useEffect)(()=>{ze.current&&!k&&K.current&&requestAnimationFrame(()=>{K.current&&(K.current.style.height=`auto`)}),ze.current=k},[k,K]),(0,Q.useEffect)(()=>{if(K.current){if(!F&&!G.trim()){K.current.style.height=`40px`,M(56);return}K.current.style.height=`auto`;let e=K.current.scrollHeight,t=k?window.innerHeight*.7:N?200:120,n=Math.max(24,Math.min(e,t));e>t&&(n=t),k||(K.current.style.height=`${n}px`),M(k?window.innerHeight*.7+16:n+16)}},[G,N,F,k]);let Be=()=>{console.log(`[CompactChatInput] è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹`),I(!0)},Ve=()=>{!G.trim()&&!i&&!f&&I(!1)},He=()=>{I(!0)},Ue=(0,Q.useMemo)(()=>{if(k)return{showExpandButton:!0};{let e=G.length,t=0;if(e<1e3)t=G.split(`
`).length-1;else for(let n=0;n<Math.min(e,1e4);n++)G[n]===`
`&&t++;return{showExpandButton:Math.ceil(e/20)+t>4}}},[k,G]),We=(0,Q.useRef)(null);(0,Q.useEffect)(()=>(We.current&&clearTimeout(We.current),We.current=setTimeout(()=>{requestAnimationFrame(()=>{O(Ue.showExpandButton)})},100),()=>{We.current&&clearTimeout(We.current)}),[Ue]);let Ge=(0,Q.useCallback)(e=>{ke(e),e.target.value.trim()&&I(!0)},[ke]),Ke=e=>{Ee(e),e.key===`Enter`&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),P(!N))},Je=async(e=`photos`)=>{try{let t=await xe(e);ie(e=>[...e,...t])}catch(e){console.error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥:`,e),alert(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•`)}},X=async()=>{try{let e=await Se();oe(t=>[...t,...e])}catch(e){console.error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥:`,e),alert(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•`)}},Ye=e=>{ie(t=>t.filter((t,n)=>n!==e))},Xe=e=>{oe(t=>t.filter((t,n)=>n!==e))},Qe=()=>{R(!L),L&&Me&&Fe()},et=t=>{if(t.trim()){let n=[...V,...ae.filter(e=>e.mimeType.startsWith(`image/`))].map(e=>({type:`image_url`,image_url:{url:e.base64Data||e.url}}));e(t.trim(),n.length>0?n:void 0,g,ae),ie([]),oe([]),H(!1),R(!1)}},tt=e=>{if(t&&G.trim()){let n=[...V,...ae.filter(e=>e.mimeType.startsWith(`image/`))].map(e=>({type:`image_url`,image_url:{url:e.base64Data||e.url}}));t(G.trim(),e,n.length>0?n:void 0,g,ae),Ce(``),ie([]),oe([]),H(!1),B(!1)}},nt=e=>{Ce(t=>t+e),I(!0)},{handlePaste:rt,shouldConvertToFile:it}=an({onFileAdd:e=>{oe(t=>[...t,e])},onSuccess:e=>{$e.show({message:e,type:`success`,duration:3e3})},onError:e=>{console.error(`é•¿æ–‡æœ¬è½¬æ–‡ä»¶å¤±è´¥:`,e),$e.show({message:`é•¿æ–‡æœ¬è½¬æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•`,type:`error`,duration:3e3})}}),at=async e=>{let t=e.clipboardData;if(!t)return;let n=t.getData(`text`);if(n&&it(n)){e.preventDefault(),H(!0);try{await rt(e)}finally{H(!1)}return}let r=Array.from(t.items).filter(e=>e.type.startsWith(`image/`));if(r.length!==0){e.preventDefault();try{H(!0);for(let e of r){let t=e.getAsFile();if(t){let e=new FileReader;e.onload=e=>{let n=e.target?.result,r=Date.now(),i={id:`paste-img-${r}-${Math.random().toString(36).substring(2,11)}`,url:n,base64Data:n,mimeType:t.type,name:`ç²˜è´´çš„å›¾ç‰‡_${r}.${t.type&&typeof t.type==`string`&&t.type.includes(`/`)?t.type.split(`/`)[1]:`png`}`,size:t.size};ie(e=>[...e,i])},e.readAsDataURL(t)}}$e.show({message:`æˆåŠŸç²˜è´´ ${r.length} å¼ å›¾ç‰‡`,type:`success`,duration:3e3})}catch(e){console.error(`ç²˜è´´å›¾ç‰‡å¤„ç†å¤±è´¥:`,e),$e.show({message:`ç²˜è´´å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•`,type:`error`,duration:3e3})}finally{H(!1)}}},ot=nr({toolsEnabled:g,webSearchActive:c,imageGenerationMode:o,onNewTopic:y,onClearTopic:v,handleWebSearchClick:()=>{},toggleImageGenerationMode:b}),st=rr({toolsEnabled:g,uploadingMedia:se,toggleToolsEnabled:C,handleImageUpload:Je,handleFileUpload:X,handleKnowledgeClick:()=>{}});return(0,$.jsxs)(Y,{className:`chat-input-container`,sx:{width:`100%`,maxWidth:{xs:`100%`,sm:`800px`},margin:{xs:`0`,sm:`0 auto`},paddingLeft:{xs:`8px`,sm:`0`},paddingRight:{xs:`8px`,sm:`0`},"& textarea::-webkit-scrollbar":{width:`6px`},"& textarea::-webkit-scrollbar-track":{background:`transparent`},"& textarea::-webkit-scrollbar-thumb":{background:W?`#555`:`#ccc`,borderRadius:`3px`},"& textarea::-webkit-scrollbar-thumb:hover":{background:W?`#666`:`#999`},...z?{position:`relative`,zIndex:1e3,marginBottom:`34px`,paddingBottom:`10px`}:{}},children:[me()&&(()=>(0,$.jsx)(Y,{sx:{px:1},children:(0,$.jsx)(qt,{knowledgeBaseName:he()?.knowledgeBase?.name||`æœªçŸ¥çŸ¥è¯†åº“`,onRemove:()=>{ge(),le(e=>e+1)}})},`knowledge-${ce}`))(),L?(0,$.jsx)(u,{isDarkMode:W,onClose:()=>R(!1),onSendMessage:et,onInsertText:e=>{Ce(t=>t+e),R(!1)},startRecognition:Pe,currentMessage:G}):(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`flex-end`,background:W?`#2A2A2A`:`#FFFFFF`,border:U.border,borderRadius:F||w||G.trim().length>0?`${U.borderRadius} ${U.borderRadius} 0 0`:U.borderRadius,boxShadow:U.boxShadow,padding:`8px 12px`,marginBottom:`0`,borderBottom:F||w||G.trim().length>0?`none`:U.border,minHeight:`40px`,height:`${j}px`,transition:`all 0.2s ease`,cursor:!F&&!G.trim()?`pointer`:`text`,position:`relative`,"&:hover":!F&&!G.trim()?{borderColor:W?`#555`:`#ddd`,boxShadow:`0 2px 8px ${W?`rgba(255,255,255,0.1)`:`rgba(0,0,0,0.1)`}`}:{}},onClick:F?void 0:He,children:[D&&(0,$.jsx)(Y,{sx:{position:`absolute`,top:`4px`,right:`4px`,zIndex:10},children:(0,$.jsx)(S,{onClick:()=>A(!k),size:`small`,sx:{color:k?`#2196F3`:W?`#B0B0B0`:`#555`,padding:`2px`,width:`20px`,height:`20px`,minWidth:`20px`,backgroundColor:W?`rgba(42, 42, 42, 0.9)`:`rgba(255, 255, 255, 0.9)`,backdropFilter:`blur(4px)`,borderRadius:`6px`,boxShadow:`0 2px 4px rgba(0,0,0,0.1)`,transition:`all 0.2s ease`},children:k?(0,$.jsx)(De,{size:14}):(0,$.jsx)(Ze,{size:14})})}),(0,$.jsxs)(Y,{sx:{flex:1,marginRight:`8px`,"& textarea::placeholder":{userSelect:`none`,WebkitUserSelect:`none`,MozUserSelect:`none`,msUserSelect:`none`,pointerEvents:`none`}},children:[(0,$.jsx)(`textarea`,{ref:K,className:`hide-scrollbar`,style:{width:`100%`,border:`none`,outline:`none`,backgroundColor:`transparent`,resize:`none`,fontSize:`14px`,lineHeight:`1.4`,fontFamily:`inherit`,color:W?`#ffffff`:`#000000`,minHeight:k?`70vh`:F?`24px`:`40px`,height:k?`70vh`:`auto`,maxHeight:k?`70vh`:F?`120px`:`40px`,overflow:k||F?`auto`:`hidden`,padding:`0`,transition:`all 0.3s ease`},placeholder:F?o?`è¾“å…¥å›¾åƒç”Ÿæˆæç¤ºè¯... (Ctrl+Enter å…¨å±•å¼€)`:c?`è¾“å…¥ç½‘ç»œæœç´¢å†…å®¹... (Ctrl+Enter å…¨å±•å¼€)`:`å’ŒaiåŠ©æ‰‹è¯´ç‚¹ä»€ä¹ˆ... (Ctrl+Enter å…¨å±•å¼€)`:`å’ŒaiåŠ©æ‰‹è¯´ç‚¹ä»€ä¹ˆ...`,value:G,onChange:Ge,onKeyDown:Ke,onCompositionStart:Ae,onCompositionEnd:je,onFocus:Be,onBlur:Ve,onClick:He,onPaste:at,disabled:i&&!a}),q&&(0,$.jsxs)(`div`,{style:{position:`absolute`,bottom:`-20px`,right:`0`,fontSize:`12px`,color:G.length>1e3?`#f44336`:W?`#888`:`#666`,opacity:.8,transition:`all 0.2s ease`},children:[G.length,G.length>1e3?` (è¿‡é•¿)`:``]})]}),(0,$.jsxs)(Y,{sx:{display:`flex`,gap:1,alignItems:`flex-end`,paddingBottom:`4px`},children:[(0,$.jsx)(l,{isVoiceMode:L,isDisabled:se||i&&!a,onToggleVoiceMode:Qe,size:`small`,color:`default`,tooltip:L?`é€€å‡ºè¯­éŸ³è¾“å…¥æ¨¡å¼`:`åˆ‡æ¢åˆ°è¯­éŸ³è¾“å…¥æ¨¡å¼`}),(0,$.jsx)(S,{onClick:f&&d?d:Re,disabled:!f&&(!we()||i&&!a),sx:{backgroundColor:f?`#ff4d4f`:!we()||i&&!a?`rgba(0,0,0,0.1)`:o?`#9C27B0`:c?`#3b82f6`:`#4CAF50`,color:`white`,width:32,height:32,"&:hover":{backgroundColor:f?`#ff7875`:!we()||i&&!a?`rgba(0,0,0,0.1)`:o?`#AB47BC`:c?`#1976d2`:`#66BB6A`},"&:disabled":{backgroundColor:`rgba(0,0,0,0.1)`,color:`rgba(0,0,0,0.3)`}},children:f?(0,$.jsx)(re,{size:18}):(0,$.jsx)(h,{size:18})})]})]}),(V.length>0||ae.length>0)&&(0,$.jsxs)(Y,{sx:{padding:`8px 12px`,background:W?`#2A2A2A`:`#FFFFFF`,border:U.border,borderTop:`none`,borderBottom:`none`,maxHeight:`120px`,overflowY:`auto`},children:[V.length>0&&(0,$.jsxs)(Y,{sx:{mb:1},children:[(0,$.jsxs)(Z,{variant:`caption`,sx:{color:`text.secondary`,mb:1,display:`block`},children:[`å·²é€‰æ‹© `,V.length,` å¼ å›¾ç‰‡`]}),(0,$.jsx)(Y,{sx:{display:`flex`,gap:1,flexWrap:`wrap`},children:V.map((e,t)=>{let n=`image-${t}-${e.name||`unnamed`}-${e.size||Date.now()}`;return(0,$.jsxs)(Y,{sx:{position:`relative`,width:60,height:60,borderRadius:1,overflow:`hidden`,border:`1px solid`,borderColor:`divider`},children:[(0,$.jsx)(`img`,{src:e.base64Data||(e.url?`${e.url}?t=${Date.now()}`:``),alt:`é¢„è§ˆ ${t+1}`,style:{width:`100%`,height:`100%`,objectFit:`cover`},onError:t=>{console.warn(`å›¾ç‰‡åŠ è½½å¤±è´¥:`,e),t.currentTarget.style.display=`none`}}),(0,$.jsx)(S,{size:`small`,onClick:()=>Ye(t),sx:{position:`absolute`,top:-8,right:-8,backgroundColor:`error.main`,color:`white`,width:20,height:20,"&:hover":{backgroundColor:`error.dark`}},children:(0,$.jsx)(ft,{size:12})})]},n)})})]}),ae.length>0&&(0,$.jsxs)(Y,{sx:{mb:1},children:[(0,$.jsxs)(Z,{variant:`caption`,sx:{color:`text.secondary`,mb:1,display:`block`},children:[`å·²é€‰æ‹© `,ae.length,` ä¸ªæ–‡ä»¶`]}),(0,$.jsx)(Y,{sx:{display:`flex`,gap:1,flexWrap:`wrap`},children:ae.map((e,t)=>{let n=`file-${t}-${e.name}-${e.size||Date.now()}`;return(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:1,p:1,bgcolor:`action.hover`,borderRadius:1,border:`1px solid`,borderColor:`divider`},children:[(0,$.jsx)(Gt,{size:16,style:{color:`text.secondary`}}),(0,$.jsx)(Z,{variant:`caption`,sx:{maxWidth:100,overflow:`hidden`,textOverflow:`ellipsis`},children:e.name}),(0,$.jsx)(S,{size:`small`,onClick:()=>Xe(t),sx:{p:.5},children:(0,$.jsx)(ft,{size:12})})]},n)})})]})]}),(0,$.jsx)(qe,{in:F||w||G.trim().length>0,children:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,justifyContent:`space-between`,padding:`8px 12px`,background:W?`#2A2A2A`:`#FFFFFF`,border:U.border,borderTop:`none`,borderRadius:w?`none`:`0 0 ${U.borderRadius} ${U.borderRadius}`,boxShadow:U.boxShadow,minHeight:`40px`,transition:`all 0.2s ease`},children:[ot.map((e,t)=>e.label===`å·¥å…·`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`},children:(0,$.jsx)(Rn,{toolsEnabled:g,onToolsEnabledChange:C?()=>C():void 0,variant:`icon-button-compact`})},t):e.label===`ç½‘ç»œæœç´¢`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`},children:(0,$.jsx)(Vn,{webSearchActive:c,toggleWebSearch:x,variant:`icon-button-compact`})},t):(0,$.jsx)(S,{onClick:e.onClick,size:`small`,sx:{color:e.active?e.color:W?`#B0B0B0`:`#555`,backgroundColor:e.active?`${e.color}15`:`transparent`,border:e.active?`1px solid ${e.color}30`:`1px solid transparent`,width:34,height:34,borderRadius:`8px`,transition:`all 0.2s ease`,"&:hover":{backgroundColor:`${e.color}20`,borderColor:`${e.color}50`,color:e.color,transform:`translateY(-1px)`,boxShadow:`0 2px 8px ${e.color}20`}},children:e.icon},t)),_e&&(0,$.jsx)(mn,{onStartDebate:n,onStopDebate:r,isDebating:m,disabled:se||i&&!a,question:G}),ve&&(0,$.jsx)(Dn,{onInsertPhrase:nt,assistant:be,disabled:se||i&&!a,size:`small`}),(0,$.jsx)(S,{onClick:()=>T(!w),size:`small`,sx:{color:w?`#2196F3`:W?`#B0B0B0`:`#555`,backgroundColor:w?`#2196F315`:`transparent`,border:w?`1px solid #2196F330`:`1px solid transparent`,width:30,height:30,borderRadius:`8px`,transition:`all 0.2s ease`,"&:hover":{backgroundColor:`#2196F320`,borderColor:`#2196F350`,color:`#2196F3`,transform:`translateY(-1px)`,boxShadow:`0 2px 8px #2196F320`}},children:w?(0,$.jsx)(ft,{size:20}):(0,$.jsx)(p,{size:20})})]})}),(0,$.jsx)(qe,{in:w,children:(0,$.jsx)(Y,{sx:{marginTop:`0`,padding:`8px 12px`,background:W?`#2A2A2A`:`#FFFFFF`,border:U.border,borderTop:`none`,borderRadius:`0 0 ${U.borderRadius} ${U.borderRadius}`,boxShadow:U.boxShadow,backdropFilter:pe===`modern`?`blur(10px)`:`none`,WebkitBackdropFilter:pe===`modern`?`blur(10px)`:`none`},children:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,justifyContent:`flex-start`,gap:2,flexWrap:`wrap`},children:[st.map((e,t)=>e.label===`çŸ¥è¯†åº“`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`},children:(0,$.jsx)(tr,{variant:`icon-button-compact`})},t):(0,$.jsxs)(Y,{onClick:e.disabled?void 0:e.onClick,sx:{display:`flex`,alignItems:`center`,gap:1,padding:`6px 12px`,borderRadius:`12px`,cursor:e.disabled?`not-allowed`:`pointer`,opacity:e.disabled?.5:1,backgroundColor:e.active?`${e.color}15`:W?`rgba(255,255,255,0.05)`:`rgba(0,0,0,0.03)`,border:e.active?`1px solid ${e.color}40`:`1px solid ${W?`rgba(255,255,255,0.1)`:`rgba(0,0,0,0.1)`}`,transition:`all 0.2s ease`,minWidth:`fit-content`,"&:hover":e.disabled?{}:{backgroundColor:`${e.color}20`,borderColor:`${e.color}60`,transform:`translateY(-1px)`,boxShadow:`0 2px 8px ${e.color}20`}},children:[(0,$.jsx)(Y,{sx:{width:20,height:20,display:`flex`,alignItems:`center`,justifyContent:`center`,color:e.active?e.color:W?`#B0B0B0`:`#666`,"& svg":{fontSize:`18px`}},children:e.icon}),(0,$.jsx)(Z,{variant:`body2`,sx:{color:e.active?e.color:W?`#B0B0B0`:`#666`,fontSize:`12px`,fontWeight:e.active?500:400,whiteSpace:`nowrap`},children:e.label})]},t)),t&&_.length>1&&(0,$.jsxs)(Y,{onClick:()=>B(!0),sx:{display:`flex`,alignItems:`center`,gap:1,padding:`6px 12px`,borderRadius:`12px`,cursor:`pointer`,backgroundColor:W?`rgba(255,255,255,0.05)`:`rgba(0,0,0,0.03)`,border:`1px solid ${W?`rgba(255,255,255,0.1)`:`rgba(0,0,0,0.1)`}`,transition:`all 0.2s ease`,minWidth:`fit-content`,"&:hover":{backgroundColor:`#FF980020`,borderColor:`#FF980060`,transform:`translateY(-1px)`,boxShadow:`0 2px 8px #FF980020`}},children:[(0,$.jsx)(Y,{sx:{width:20,height:20,display:`flex`,alignItems:`center`,justifyContent:`center`,color:W?`#B0B0B0`:`#666`,"& svg":{fontSize:`18px`}},children:(0,$.jsx)(h,{size:18})}),(0,$.jsx)(Z,{variant:`body2`,sx:{color:W?`#B0B0B0`:`#666`,fontSize:`12px`,fontWeight:400,whiteSpace:`nowrap`},children:`å¤šæ¨¡å‹`})]}),(0,$.jsx)(Z,{variant:`caption`,sx:{color:W?`#666`:`#999`,fontSize:`11px`,fontStyle:`italic`,marginLeft:`auto`},children:`æ›´å¤šåŠŸèƒ½å³å°†æ¨å‡º...`})]})})}),(0,$.jsx)(Zt,{open:ee,onClose:()=>B(!1),availableModels:_,onSelectionChange:tt,maxSelection:5}),(0,$.jsx)(Oe,{messages:te,onClose:e=>$e.remove(e),maxVisible:3})]})},ar=({message:e,setMessage:t,isDarkMode:n,isLoading:r,allowConsecutiveMessages:i,uploadingMedia:a,files:o,setImages:s,setFiles:l,setUploadingMedia:f,processImages:p,onSendMessage:m,toolsEnabled:h,iconColor:g})=>{let[_,v]=(0,Q.useState)(`normal`),{isListening:y,startRecognition:b,stopRecognition:x}=Dt(),S=(0,Q.useCallback)(()=>{_===`normal`?v(`recording`):_===`recording`&&(y&&x().catch(e=>console.error(`åœæ­¢è¯­éŸ³è¯†åˆ«å‡ºé”™:`,e)),v(`normal`))},[_,y,x]),C=(0,Q.useCallback)(async e=>{if(e&&e.trim()){let t=await p(),n=o.filter(e=>!e.mimeType.startsWith(`image/`));if(m(e.trim(),t.length>0?t:void 0,h,n),s([]),l([]),f(!1),v(`normal`),`navigator`in window&&`vibrate`in navigator)try{navigator.vibrate(50)}catch{}}},[p,o,m,h,s,l,f]);return{voiceState:_,getVoiceButtonConfig:(0,Q.useCallback)(()=>({id:`voice`,icon:_===`normal`?(0,$.jsx)(d,{size:20}):(0,$.jsx)(c,{size:20}),tooltip:_===`normal`?`åˆ‡æ¢åˆ°è¯­éŸ³è¾“å…¥æ¨¡å¼`:`é€€å‡ºè¯­éŸ³è¾“å…¥æ¨¡å¼`,onClick:S,color:_===`normal`?g:`#f44336`,disabled:a||r&&!i,isActive:_!==`normal`}),[_,S,g,a,r,i]),renderVoiceInput:(0,Q.useCallback)(()=>_===`recording`?(0,$.jsx)(`div`,{style:{flexGrow:1,position:`relative`},children:(0,$.jsx)(u,{isDarkMode:n,onClose:()=>v(`normal`),onSendMessage:C,onInsertText:e=>{t(e)},startRecognition:b,currentMessage:e})}):null,[_,n,C,t,b,e]),isVoiceRecording:_===`recording`}},or=e=>{let t=e.provider||e.providerId||`unknown`;return Le({id:e.id,provider:t})},sr=({selectedModels:e,onRemoveModel:t,onClearAll:n})=>{let r=J(Tt),i=e=>r.find(t=>t.id===e)?.name||e;return e.length===0?null:(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:1,px:2,py:1,borderBottom:`1px solid`,borderColor:`divider`,backgroundColor:`background.paper`,overflowX:`auto`,"&::-webkit-scrollbar":{height:4},"&::-webkit-scrollbar-thumb":{backgroundColor:`action.hover`,borderRadius:2}},children:[(0,$.jsx)(X,{title:`å¤šæ¨¡å‹å¯¹æ¯”`,children:(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,color:`primary.main`},children:(0,$.jsx)(Ht,{size:16})})}),(0,$.jsx)(Y,{sx:{display:`flex`,gap:.5,flexWrap:`nowrap`},children:e.map(e=>{let n=i(e.provider||e.providerType||`unknown`);return(0,$.jsx)(lt,{label:`${e.name||e.id} (${n})`,size:`small`,color:`primary`,variant:`outlined`,onDelete:()=>t(e),deleteIcon:(0,$.jsx)(ft,{size:14}),sx:{height:24,"& .MuiChip-label":{px:1,fontSize:`0.75rem`},"& .MuiChip-deleteIcon":{fontSize:14,marginRight:`4px`}}},or(e))})}),n&&e.length>1&&(0,$.jsx)(X,{title:`æ¸…ç©ºæ‰€æœ‰`,children:(0,$.jsx)(S,{size:`small`,onClick:n,sx:{ml:`auto`,flexShrink:0},children:(0,$.jsx)(ft,{size:16})})}),(0,$.jsxs)(Z,{variant:`caption`,color:`text.secondary`,sx:{ml:`auto`,flexShrink:0,whiteSpace:`nowrap`},children:[e.length,` ä¸ªæ¨¡å‹`]})]})},cr=({anchorEl:e,open:n,onClose:r,onClearTopic:i,imageGenerationMode:a=!1,toggleImageGenerationMode:o,videoGenerationMode:s=!1,toggleVideoGenerationMode:c,webSearchActive:l=!1,toggleWebSearch:u,toolsEnabled:d=!0,onToolsEnabledChange:f})=>{L(`tools-menu-${(0,Q.useId)()}`,n,r);let[m,h]=(0,Q.useState)(!1),[_,v]=(0,Q.useState)(!1),[b,x]=(0,Q.useState)(!1),[S,C]=(0,Q.useState)(!1),w=me();Xt();let{handleCreateTopic:T}=kn(),E=J(e=>e.webSearch),D=E?.enabled||!1,O=E?.provider,k=J(e=>e.settings.toolbarButtons||{order:[`mcp-tools`,`new-topic`,`clear-topic`,`generate-image`,`generate-video`,`knowledge`,`web-search`],visibility:{"mcp-tools":!0,"new-topic":!0,"clear-topic":!0,"generate-image":!0,"generate-video":!0,knowledge:!0,"web-search":!0}}),A=(0,Q.useRef)(void 0);(0,Q.useEffect)(()=>()=>{A.current&&clearTimeout(A.current)},[]);let j=async()=>{await T(),r()},M=()=>{_?(i?.(),v(!1),r()):(v(!0),A.current&&clearTimeout(A.current),A.current=window.setTimeout(()=>v(!1),3e3))},N=()=>{x(!0)},P=(e,t)=>{console.log(`é€‰æ‹©äº†çŸ¥è¯†åº“:`,e,`æœç´¢ç»“æœ:`,t);let n={knowledgeBase:{id:e.id,name:e.name},isSelected:!0,searchOnSend:!0};console.log(`[ToolsMenu] ä¿å­˜çŸ¥è¯†åº“é€‰æ‹©åˆ°sessionStorage:`,n),window.sessionStorage.setItem(`selectedKnowledgeBase`,JSON.stringify(n));let r=window.sessionStorage.getItem(`selectedKnowledgeBase`);console.log(`[ToolsMenu] sessionStorageä¿å­˜éªŒè¯:`,r),x(!1)},I=()=>{h(!0)},R=e=>{e&&u&&u(),r()},z=()=>{C(!0)},B=()=>{C(!1)},te={"mcp-tools":{id:`mcp-tools`,icon:(0,$.jsx)(pe,{size:16,color:d?w.palette.success.main:w.palette.text.disabled}),label:`å·¥å…·`,onClick:z,isActive:d},"new-topic":{id:`new-topic`,icon:(0,$.jsx)(p,{size:16,color:w.palette.success.main}),label:`æ–°å»ºè¯é¢˜`,onClick:j,isActive:!1},"clear-topic":{id:`clear-topic`,icon:_?(0,$.jsx)(ae,{size:16,color:w.palette.error.main}):(0,$.jsx)(y,{size:16,color:w.palette.primary.main}),label:_?`ç¡®è®¤æ¸…ç©º`:`æ¸…ç©ºå†…å®¹`,onClick:M,isActive:_},"generate-image":{id:`generate-image`,icon:(0,$.jsx)(St,{name:`imageGenerate`,size:16,color:a?w.palette.secondary.main:rt(w.palette.secondary.main,.6)}),label:a?`å–æ¶ˆç”Ÿæˆ`:`ç”Ÿæˆå›¾ç‰‡`,onClick:()=>{o?.(),r()},isActive:a},"generate-video":{id:`generate-video`,icon:(0,$.jsx)(g,{size:16,color:s?w.palette.error.main:rt(w.palette.error.main,.6)}),label:s?`å–æ¶ˆç”Ÿæˆ`:`ç”Ÿæˆè§†é¢‘`,onClick:()=>{c?.(),r()},isActive:s},knowledge:{id:`knowledge`,icon:(0,$.jsx)(t,{size:16,color:w.palette.info.main}),label:`çŸ¥è¯†åº“`,onClick:N,isActive:!1},"web-search":D&&u?{id:`web-search`,icon:(0,$.jsx)(St,{name:`search`,size:16,color:l?w.palette.primary.main:rt(w.palette.primary.main,.6)}),label:E?.providers?.find(e=>e.id===O)?.name||`ç½‘ç»œæœç´¢`,onClick:I,isActive:l}:null},ne=k.order.filter(e=>{let t=te[e];return k.visibility[e]&&t&&typeof t==`object`&&`id`in t}).map(e=>te[e]).filter(e=>e!==null);return(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(ee,{anchorEl:e,open:n,onClose:r,disableAutoFocus:!0,disableRestoreFocus:!0,disableEnforceFocus:!0,anchorOrigin:{vertical:`top`,horizontal:`left`},transformOrigin:{vertical:`bottom`,horizontal:`left`},slotProps:{paper:{sx:{borderRadius:3,minWidth:{xs:`90vw`,sm:280},maxWidth:{xs:`95vw`,sm:320},width:{xs:`90vw`,sm:`auto`},maxHeight:{xs:`70vh`,sm:`80vh`},overflow:`auto`,boxShadow:w.shadows[8],backgroundColor:w.palette.background.paper}},root:{slotProps:{backdrop:{invisible:!1,sx:{backgroundColor:`transparent`}}}}},sx:{"& .MuiList-root":{"&:focus":{outline:`none`}}},children:ne.map(e=>!(`onClick`in e)||!(`icon`in e)||!(`label`in e)?null:(0,$.jsxs)(F,{onClick:()=>{if(e.id===`clear-topic`&&!_){e.onClick();return}e.onClick(),r()},sx:{padding:{xs:1.5,sm:2},minHeight:{xs:52,sm:60},display:`flex`,alignItems:`center`,"&:hover":{backgroundColor:w.palette.action.hover}},children:[(0,$.jsx)(Y,{sx:{width:{xs:28,sm:32},height:{xs:28,sm:32},borderRadius:2,backgroundColor:e.isActive?e.id===`mcp-tools`?rt(w.palette.success.main,.15):rt(w.palette.primary.main,.15):rt(w.palette.text.primary,.08),display:`flex`,alignItems:`center`,justifyContent:`center`,marginRight:{xs:1.5,sm:2},flexShrink:0},children:(0,$.jsx)(Y,{sx:{"& svg":{width:{xs:`14px`,sm:`16px`},height:{xs:`14px`,sm:`16px`}}},children:e.icon})}),(0,$.jsx)(Z,{variant:`body2`,sx:{color:w.palette.text.primary,fontSize:{xs:`14px`,sm:`15px`},fontWeight:500,flex:1},children:e.label})]},e.id))}),(0,$.jsx)(Bn,{open:m,onClose:()=>h(!1),onProviderSelect:R}),(0,$.jsx)(er,{open:b,onClose:()=>x(!1),onSelect:P}),(0,$.jsx)(Fn,{open:S,onClose:B,toolsEnabled:d,onToolsEnabledChange:f})]})},lr=q.div`
  padding: 5px 0;
  background-color: ${e=>e.theme?.palette?.background?.paper};
`,ur=q.div`
  max-height: 400px;
  overflow-y: auto;
  
  &::-webkit-scrollbar {
    width: 6px;
  }
  
  &::-webkit-scrollbar-track {
    background: transparent;
  }
  
  &::-webkit-scrollbar-thumb {
    background: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.2)`:`rgba(0, 0, 0, 0.2)`};
    border-radius: 3px;
  }
  
  // ç§»åŠ¨ç«¯ä¼˜åŒ–
  @media (max-width: 768px) {
    max-height: calc(100vh - 240px);
    -webkit-overflow-scrolling: touch;
  }
  
  @media (max-width: 480px) {
    max-height: calc(100vh - 220px);
  }
`,dr=q.div`
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 0 5px 1px 5px;
  padding: 10px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.1s ease;

  &:hover {
    background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.04)`};
  }

  &.focused {
    background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.12)`:`rgba(0, 0, 0, 0.08)`};
  }
  
  // ç§»åŠ¨ç«¯ä¼˜åŒ–
  @media (max-width: 768px) {
    min-height: 48px;
    padding: 12px 16px;
    margin: 0 8px 2px 8px;
  }
  
  @media (max-width: 480px) {
    min-height: 52px;
    padding: 14px 16px;
    margin: 0 12px 3px 12px;
  }
  
  // ç§»åŠ¨ç«¯è§¦æ‘¸åé¦ˆ
  @media (hover: none) {
  &:active {
    background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.16)`:`rgba(0, 0, 0, 0.12)`};
  }
}
`,fr=q.div`
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
`,pr=q.span`
  display: flex;
  align-items: center;
  justify-content: center;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
  flex-shrink: 0;
`,mr=q.span`
  font-size: 14px;
  line-height: 20px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
`,hr=q.div`
  display: flex;
  align-items: center;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
  flex-shrink: 0;
`,gr=q.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px 6px;
  border-top: 1px solid ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.08)`};
`,_r=q.div`
  font-size: 12px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
`,vr=q.div`
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 11px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
`,yr=q.div`
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
  font-size: 13px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
  border-bottom: 1px solid ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.08)`};
  
  // ç§»åŠ¨ç«¯ä¼˜åŒ–
  @media (max-width: 768px) {
    padding: 10px 16px;
    font-size: 14px;
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    
    &::-webkit-scrollbar {
      display: none;
    }
  }
  
  @media (max-width: 480px) {
    padding: 12px 16px;
    font-size: 15px;
  }
`,br=q.span`
  cursor: ${e=>e.clickable?`pointer`:`default`};
  color: ${e=>e.clickable?e.theme?.palette?.primary?.main:`inherit`};
  white-space: nowrap;
  
  &:hover {
    text-decoration: ${e=>e.clickable?`underline`:`none`};
  }
  
  // ç§»åŠ¨ç«¯ä¼˜åŒ–
  @media (max-width: 768px) {
    font-size: 14px;
    padding: 2px 0;
  }
  
  @media (max-width: 480px) {
    font-size: 15px;
    padding: 3px 0;
  }
`,xr=q.div`
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  margin: 0 8px 8px 8px;
  border-radius: 8px;
  background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 255, 255, 0.05)`:`rgba(0, 0, 0, 0.04)`};
  
  @media (max-width: 768px) {
    margin: 0 12px 8px 12px;
    padding: 10px 14px;
  }
`,Sr=q.div`
  font-size: 12px;
  color: ${e=>e.theme?.palette?.text?.secondary||`#666`};
  margin-top: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  
  mark {
    background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(255, 213, 79, 0.3)`:`rgba(255, 213, 79, 0.5)`};
    color: inherit;
    padding: 0 2px;
    border-radius: 2px;
  }
`,Cr=q.span`
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  background-color: ${e=>e.theme?.palette?.mode===`dark`?`rgba(66, 165, 245, 0.2)`:`rgba(66, 165, 245, 0.15)`};
  color: ${e=>e.theme?.palette?.primary?.main||`#42A5F5`};
  margin-left: 8px;
  flex-shrink: 0;
`,wr=({open:e,onClose:t,onSelectNote:n})=>{let r=me(),[i,o]=(0,Q.useState)([]),[s,c]=(0,Q.useState)(!1),[l,u]=(0,Q.useState)(``),[d,f]=(0,Q.useState)(-1),[p,h]=(0,Q.useState)(!1),g=(0,Q.useRef)(null),_=(0,Q.useRef)(null),{search:y,reset:b,keyword:x,isSearching:C,results:T,stats:E}=Ot({debounceMs:300}),D=w(`(max-width:768px)`),O=w(`(max-width:480px)`),k=(0,Q.useRef)(0),A=(0,Q.useRef)(null),j=(0,Q.useRef)(0),M=e=>{k.current=e.touches[0].clientY},N=e=>{A.current&&e.touches[0].clientY-k.current>100&&l===``&&t()},P=(0,Q.useCallback)(async(e=``)=>{c(!0);try{o(await Et.listNotes(e))}catch(e){console.error(`åŠ è½½ç¬”è®°åˆ—è¡¨å¤±è´¥:`,e),o([])}finally{c(!1)}},[]);(0,Q.useEffect)(()=>{e?(P(l),f(-1)):(h(!1),b())},[e,l,P,b]),(0,Q.useEffect)(()=>{p&&_.current&&_.current.focus()},[p]);let F=(0,Q.useMemo)(()=>p&&x?T:i,[p,x,T,i]),I=async e=>{if(D){let e=Date.now();if(j.current&&e-j.current<300)return;j.current=e}if(e.isDirectory)u(e.path),f(-1),p&&(h(!1),b());else try{let r=await Et.readNote(e.path);n(e.path,r,e.name),t()}catch(e){console.error(`è¯»å–ç¬”è®°å¤±è´¥:`,e)}},L=(0,Q.useCallback)(()=>{h(e=>(e&&b(),!e)),f(-1)},[b]),R=(0,Q.useCallback)(()=>{if(p){h(!1),b();return}if(!l)return;let e=l.split(`/`);e.length===1?u(``):(e.pop(),u(e.join(`/`)))},[l,p,b]),z=(0,Q.useMemo)(()=>l?[`æ ¹ç›®å½•`,...l.split(`/`)]:[`æ ¹ç›®å½•`],[l]);(0,Q.useEffect)(()=>{if(!e)return;let n=e=>{e.key===`Escape`?(e.preventDefault(),p?(h(!1),b()):l?R():t()):e.key===`ArrowDown`?(e.preventDefault(),f(e=>e<F.length-1?e+1:0)):e.key===`ArrowUp`?(e.preventDefault(),f(e=>e>0?e-1:F.length-1)):e.key===`Enter`&&d>=0&&(e.preventDefault(),I(F[d]))};return window.addEventListener(`keydown`,n),()=>{window.removeEventListener(`keydown`,n)}},[e,d,F,l,p,R,b]);let ee=e=>{if(!e.matches||e.matches.length===0)return null;let{context:t,matchStart:n,matchEnd:i}=e.matches[0];return(0,$.jsxs)(Sr,{theme:r,children:[t.substring(0,n),(0,$.jsx)(`mark`,{children:t.substring(n,i)}),t.substring(i)]})};return(0,$.jsx)(Ie,{anchor:`bottom`,open:e,onClose:t,ref:A,PaperProps:{sx:{borderTopLeftRadius:O?0:16,borderTopRightRadius:O?0:16,maxHeight:O?`100vh`:D?`85vh`:`70vh`,height:O?`100vh`:`auto`,bgcolor:`background.paper`,pb:`var(--safe-area-bottom-computed, 0px)`}},onTouchStart:M,onTouchMove:N,children:(0,$.jsxs)(Y,{sx:{maxHeight:O?`100vh`:D?`85vh`:`70vh`,display:`flex`,flexDirection:`column`},children:[D&&(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,justifyContent:`space-between`,p:2,borderBottom:`1px solid ${r.palette.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.08)`}`},children:[(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:2},children:[(l||p)&&(0,$.jsx)(X,{title:`è¿”å›`,children:(0,$.jsx)(S,{onClick:R,size:O?`medium`:`small`,sx:{color:r.palette.text.secondary,padding:O?2:1,"&:hover":{backgroundColor:r.palette.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.04)`}},children:(0,$.jsx)(ht,{size:O?24:20})})}),(0,$.jsx)(Z,{variant:`h6`,sx:{fontSize:O?`1.1rem`:`1.25rem`},children:p?`æœç´¢ç¬”è®°`:`é€‰æ‹©ç¬”è®°`})]}),(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[!p&&(0,$.jsx)(X,{title:`æœç´¢`,children:(0,$.jsx)(S,{onClick:L,size:O?`medium`:`small`,sx:{color:r.palette.text.secondary,padding:O?2:1,"&:hover":{backgroundColor:r.palette.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.04)`}},children:(0,$.jsx)(m,{size:O?22:18})})}),(0,$.jsx)(S,{onClick:t,size:O?`medium`:`small`,sx:{color:r.palette.text.secondary,padding:O?2:1,"&:hover":{backgroundColor:r.palette.mode===`dark`?`rgba(255, 255, 255, 0.08)`:`rgba(0, 0, 0, 0.04)`}},children:(0,$.jsx)(ft,{size:O?24:20})})]})]}),!D&&(0,$.jsx)(Y,{sx:{pt:1,pb:1.5,display:`flex`,justifyContent:`center`},children:(0,$.jsx)(Y,{sx:{width:40,height:4,bgcolor:e=>rt(e.palette.text.primary,.2),borderRadius:999}})}),!D&&!p&&(0,$.jsx)(yr,{theme:r,children:z.map((e,t)=>(0,$.jsxs)(Q.Fragment,{children:[t>0&&(0,$.jsx)(Ge,{size:14}),(0,$.jsx)(br,{clickable:t>0&&t<z.length-1,theme:r,onClick:()=>{t===0?u(``):t<z.length-1&&u(z.slice(1,t+1).join(`/`))},children:e})]},t))}),p&&(0,$.jsxs)(xr,{theme:r,children:[(0,$.jsx)(m,{size:18,color:r.palette.text.secondary}),(0,$.jsx)(We,{inputRef:_,placeholder:`æœç´¢ç¬”è®°åç§°æˆ–å†…å®¹...`,value:x,onChange:e=>y(e.target.value),fullWidth:!0,sx:{fontSize:D?16:14}}),C&&(0,$.jsx)(ut,{size:16})]}),(0,$.jsxs)(lr,{ref:g,theme:r,children:[s||p&&C&&!x?(0,$.jsx)(Y,{sx:{display:`flex`,justifyContent:`center`,p:D?6:4},children:(0,$.jsx)(ut,{size:D?32:24})}):F.length===0?(0,$.jsxs)(Y,{sx:{p:D?6:4,textAlign:`center`},children:[(0,$.jsx)(Z,{color:`text.secondary`,variant:D?`h6`:`body2`,sx:{fontSize:D?`1.1rem`:`inherit`},children:p?x?`æœªæ‰¾åˆ°åŒ¹é…çš„ç¬”è®°`:`è¾“å…¥å…³é”®è¯æœç´¢ç¬”è®°`:`æ­¤æ–‡ä»¶å¤¹ä¸ºç©º`}),p&&x&&E.total===0&&(0,$.jsx)(Z,{color:`text.secondary`,variant:`body2`,sx:{mt:1,fontSize:`0.85rem`},children:`å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯`})]}):(0,$.jsxs)($.Fragment,{children:[p&&x&&E.total>0&&(0,$.jsxs)(Y,{sx:{px:2,py:1,fontSize:12,color:`text.secondary`},children:[`æ‰¾åˆ° `,E.total,` ä¸ªç»“æœ`,E.bothMatches>0&&` (${E.bothMatches} ä¸ªåŒæ—¶åŒ¹é…åç§°å’Œå†…å®¹)`]}),(0,$.jsx)(ur,{theme:r,children:F.map((e,t)=>{let n=`matchType`in e?e:null;return(0,$.jsxs)(dr,{theme:r,className:d===t?`focused`:``,onClick:()=>I(e),onMouseEnter:()=>!D&&f(t),onTouchStart:()=>D&&f(t),children:[(0,$.jsxs)(fr,{children:[(0,$.jsx)(pr,{theme:r,children:e.isDirectory?(0,$.jsx)(v,{size:D?22:18,color:`#FBC02D`}):(0,$.jsx)(a,{size:D?22:18,color:`#42A5F5`})}),(0,$.jsxs)(Y,{sx:{flex:1,minWidth:0},children:[(0,$.jsxs)(Y,{sx:{display:`flex`,alignItems:`center`},children:[(0,$.jsx)(mr,{children:e.name}),n&&n.matchType===`both`&&(0,$.jsx)(Cr,{theme:r,children:`å…¨åŒ¹é…`})]}),p&&e.path&&e.path.includes(`/`)&&(0,$.jsx)(Z,{variant:`caption`,color:`text.secondary`,sx:{display:`block`,fontSize:11,opacity:.7},children:e.path}),n&&ee(n)]})]}),e.isDirectory&&(0,$.jsx)(hr,{theme:r,children:(0,$.jsx)(Ge,{size:D?20:16})})]},e.id)})})]}),!D&&(0,$.jsxs)(gr,{theme:r,children:[(0,$.jsx)(_r,{theme:r,children:p?`æœç´¢ç¬”è®°${E.total>0?` (${E.total})`:``}`:`é€‰æ‹©ç¬”è®°`}),(0,$.jsxs)(vr,{theme:r,children:[(0,$.jsxs)(`span`,{children:[`ESC `,p?`é€€å‡ºæœç´¢`:l?`è¿”å›`:`å…³é—­`]}),(0,$.jsx)(`span`,{children:`â–²â–¼ é€‰æ‹©`}),(0,$.jsx)(`span`,{children:`â†©ï¸ ç¡®è®¤`})]})]})]})]})})},Tr=({message:e,isStreaming:t,isDebating:n,canSendMessage:r,imageGenerationMode:i,videoGenerationMode:a,webSearchActive:o,toolsEnabled:s,availableModels:c,onSendMultiModelMessage:l,handleImageUploadLocal:u,handleFileUploadLocal:d,onStartDebate:f,onStopDebate:p,handleInsertPhrase:m,currentAssistant:h,onClearTopic:g,toggleImageGenerationMode:_,toggleVideoGenerationMode:v,toggleWebSearch:y,onToolsEnabledChange:b,showAIDebateButton:x,showQuickPhraseButton:S,processImages:C,files:w,setImages:T,setFiles:E,setUploadingMedia:O,setMessage:k})=>{let[A,j]=(0,Q.useState)(null),[M,N]=(0,Q.useState)(!1),[P,F]=(0,Q.useState)(!1),[I,L]=(0,Q.useState)(null),[R,z]=(0,Q.useState)(!1),[ee,B]=(0,Q.useState)([]),te=(0,Q.useCallback)(e=>{let t=e.provider||e.providerId||`unknown`;return Le({id:e.id,provider:t})},[]),ne=(0,Q.useCallback)(e=>{let t=te(e);B(e=>e.filter(e=>te(e)!==t))},[te]),V=(0,Q.useCallback)(()=>{B([])},[]),re=(0,Q.useRef)(null),ie=(0,Q.useRef)(null),ae=(0,Q.useCallback)(e=>{j(e.currentTarget)},[]),oe=(0,Q.useCallback)(()=>{j(null)},[]),se=(0,Q.useCallback)(e=>{L(e.currentTarget),F(!0)},[]),H=(0,Q.useCallback)(()=>{L(null),F(!1)},[]),ce=(0,Q.useCallback)(async t=>{if(!e.trim()&&w.length===0){console.log(`æ²¡æœ‰å†…å®¹å¯å‘é€`);return}if(!t||t.length===0){console.log(`æ²¡æœ‰é€‰æ‹©æ¨¡å‹`);return}let n=e.trim(),r=await C(),i=w.filter(e=>!e.mimeType.startsWith(`image/`));console.log(`å‘é€å¤šæ¨¡å‹æ¶ˆæ¯:`,{message:n,models:t.map(e=>`${e.provider||e.providerType}:${e.id}`),images:r.length,files:w.length,toolsEnabled:s}),l&&l(n,t,r.length>0?r:void 0,s,i),k(``),T([]),E([]),O(!1),N(!1)},[e,w,C,s,l,k,T,E,O]),le=(0,Q.useCallback)(()=>{if(n)p?.();else if(re.current){let e=re.current.querySelector(`button`);e&&e.click()}},[n,p]),ue=(0,Q.useCallback)(e=>{if(ie.current){let t=e.currentTarget.getBoundingClientRect(),n=ie.current;n.style.position=`fixed`,n.style.left=`${t.left}px`,n.style.top=`${t.top}px`,n.style.zIndex=`-1`,n.style.opacity=`0`,n.style.pointerEvents=`none`;let r=n.querySelector(`button`);r&&r.click()}},[]),de=(0,Q.useCallback)(()=>{if(ie.current){let e=ie.current;e.style.position=`fixed`,e.style.left=`50%`,e.style.top=`50%`,e.style.transform=`translate(-50%, -50%)`,e.style.zIndex=`-1`,e.style.opacity=`0`,e.style.pointerEvents=`none`;let t=e.querySelector(`button`);t&&t.click()}},[]),fe=(0,Q.useCallback)(()=>{z(!0)},[]),U=(0,Q.useCallback)(async(e,t,n)=>{let r=`note-${Date.now()}`,i=btoa(unescape(encodeURIComponent(t))),a={id:r,name:n,origin_name:n,path:``,size:new Blob([t]).size,ext:`md`,type:`text`,created_at:new Date().toISOString(),count:1,base64Data:i,mimeType:`text/markdown`};try{await D.files.put(a)}catch(e){console.error(`ä¿å­˜ç¬”è®°æ–‡ä»¶åˆ°æ•°æ®åº“å¤±è´¥:`,e)}let o={id:r,name:n,mimeType:`text/markdown`,extension:`md`,size:new Blob([t]).size,url:`note://${e}`,base64Data:i,fileRecord:a};E([...w,o]),z(!1)},[w,E]);return{uploadMenuAnchorEl:A,multiModelSelectorOpen:M,toolsMenuOpen:P,toolsMenuAnchorEl:I,mentionedModels:ee,handleOpenUploadMenu:ae,handleCloseUploadMenu:oe,handleOpenToolsMenu:se,handleCloseToolsMenu:H,handleMultiModelSend:ce,handleAIDebateClick:le,handleQuickPhraseClick:ue,handleQuickPhraseClickForUploadMenu:de,setMultiModelSelectorOpen:N,setMentionedModels:B,handleRemoveMentionedModel:ne,handleClearMentionedModels:V,renderMenus:(0,Q.useCallback)(()=>(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(Qt,{anchorEl:A,open:!!A,onClose:oe,onImageUpload:u,onFileUpload:d,onMultiModelSend:()=>N(!0),showMultiModel:!!(l&&c.length>1&&!t&&r()),onAIDebate:le,showAIDebate:x,isDebating:n,onQuickPhrase:de,showQuickPhrase:S,onNoteSelect:fe,showNote:!0}),(0,$.jsx)(wr,{open:R,onClose:()=>z(!1),onSelectNote:U}),(0,$.jsx)(Zt,{open:M,onClose:()=>N(!1),availableModels:c,selectedModels:ee,onSelectionChange:B,maxSelection:5}),(0,$.jsx)(cr,{anchorEl:I,open:P,onClose:H,onClearTopic:g,imageGenerationMode:i,toggleImageGenerationMode:_,videoGenerationMode:a,toggleVideoGenerationMode:v,webSearchActive:o,toggleWebSearch:y,toolsEnabled:s,onToolsEnabledChange:b}),(0,$.jsx)(`div`,{style:{position:`absolute`,left:`-9999px`,top:`-9999px`},ref:re,children:(0,$.jsx)(mn,{onStartDebate:f,onStopDebate:p,isDebating:n,disabled:!1,question:e})}),(0,$.jsx)(`div`,{ref:ie,style:{position:`fixed`,left:`-9999px`,top:`-9999px`,zIndex:-1,opacity:0,pointerEvents:`none`},children:(0,$.jsx)(Dn,{onInsertPhrase:m,assistant:h,disabled:!1,size:`medium`})})]}),[A,oe,u,d,l,c,t,r,le,x,n,de,S,M,ce,I,P,H,g,i,_,a,v,o,y,s,b,f,p,e,m,h,ee,R,U]),renderMentionedModels:(0,Q.useCallback)(()=>ee.length===0?null:(0,$.jsx)(sr,{selectedModels:ee,onRemoveModel:ne,onClearAll:V}),[ee,ne,V])}},Er=({isLoading:t,allowConsecutiveMessages:r,isStreaming:i,uploadingMedia:o,imageGenerationMode:c,videoGenerationMode:l,webSearchActive:u,toolsEnabled:d,images:f,files:m,handleSubmit:_,onStopResponse:v,handleImageUploadLocal:b,handleFileUploadLocal:x,onClearTopic:C,onToolsEnabledChange:w,handleQuickWebSearchToggle:T,toggleImageGenerationMode:E,toggleVideoGenerationMode:D,menuManager:O,voiceInputManager:k,canSendMessage:A,isDarkMode:j,iconColor:M,disabledColor:N,showLoadingIndicator:P,isDebating:F})=>{let[I,L]=(0,Q.useState)(!1),R=J(e=>e.settings.integratedInputLeftButtons||[`tools`,`clear`,`search`]),z=J(e=>e.settings.integratedInputRightButtons||[`upload`,`voice`,`send`]),ee=(0,Q.useCallback)(()=>{I?(C?.(),L(!1)):(L(!0),setTimeout(()=>L(!1),3e3))},[I,C]),B={tools:{id:`tools`,icon:(0,$.jsx)(St,{name:`settingsPanel`,size:20}),tooltip:`æ‰©å±•`,onClick:O.handleOpenToolsMenu,color:M,disabled:!1,isActive:!1},"mcp-tools":{id:`mcp-tools`,component:`MCPToolsButton`,tooltip:`MCPå·¥å…·`,onClick:()=>{},color:d?`#4CAF50`:M,disabled:!1,isActive:d},clear:{id:`clear`,icon:I?(0,$.jsx)(ae,{size:20}):(0,$.jsx)(y,{size:20}),tooltip:I?`ç¡®è®¤æ¸…ç©º`:`æ¸…ç©ºå†…å®¹`,onClick:ee,color:I?`#f44336`:M,disabled:!1,isActive:I},image:{id:`image`,icon:(0,$.jsx)(s,{size:20}),tooltip:c?`é€€å‡ºå›¾åƒç”Ÿæˆæ¨¡å¼`:`å›¾åƒç”Ÿæˆ`,onClick:E||(()=>{}),color:c?`#9C27B0`:M,disabled:!1,isActive:c},video:{id:`video`,icon:(0,$.jsx)(g,{size:20}),tooltip:l?`é€€å‡ºè§†é¢‘ç”Ÿæˆæ¨¡å¼`:`è§†é¢‘ç”Ÿæˆ`,onClick:D||(()=>{}),color:l?`#FF5722`:M,disabled:!1,isActive:l},knowledge:{id:`knowledge`,component:`KnowledgeButton`,tooltip:`çŸ¥è¯†åº“`,onClick:()=>{},color:M,disabled:!1,isActive:!1},search:{id:`search`,component:`WebSearchButton`,tooltip:u?`é€€å‡ºç½‘ç»œæœç´¢æ¨¡å¼`:`ç½‘ç»œæœç´¢`,onClick:()=>{},color:u?`#3b82f6`:M,disabled:!1,isActive:u},upload:{id:`upload`,icon:o?(0,$.jsx)(ut,{size:20}):(0,$.jsx)(Vt,{badgeContent:f.length+m.length,color:`primary`,max:9,invisible:f.length+m.length===0,children:(0,$.jsx)(p,{size:20})}),tooltip:`æ·»åŠ å†…å®¹`,onClick:O.handleOpenUploadMenu,color:o?N:M,disabled:o||t&&!r,isActive:!1},camera:{id:`camera`,icon:(0,$.jsx)(n,{size:20}),tooltip:`æ‹æ‘„ç…§ç‰‡`,onClick:()=>b(`camera`),color:`#9C27B0`,disabled:o||t&&!r,isActive:!1},"photo-select":{id:`photo-select`,icon:(0,$.jsx)(s,{size:20}),tooltip:`é€‰æ‹©å›¾ç‰‡`,onClick:()=>b(`photos`),color:`#1976D2`,disabled:o||t&&!r,isActive:!1},"file-upload":{id:`file-upload`,icon:(0,$.jsx)(a,{size:20}),tooltip:`ä¸Šä¼ æ–‡ä»¶`,onClick:x,color:`#4CAF50`,disabled:o||t&&!r,isActive:!1},"ai-debate":{id:`ai-debate`,icon:(0,$.jsx)(St,{name:`aiDebate`,size:20,color:F?`#f44336`:M}),tooltip:F?`åœæ­¢AIè¾©è®º`:`å¼€å§‹AIè¾©è®º`,onClick:O.handleAIDebateClick,color:F?`#f44336`:M,disabled:!1,isActive:F},"quick-phrase":{id:`quick-phrase`,icon:(0,$.jsx)(St,{name:`quickPhrase`,size:20,color:M}),tooltip:`å¿«æ·çŸ­è¯­`,onClick:O.handleQuickPhraseClick,color:M,disabled:!1,isActive:!1},"multi-model":{id:`multi-model`,icon:(0,$.jsx)(e,{size:20}),tooltip:`å¤šæ¨¡å‹å‘é€`,onClick:()=>O.setMultiModelSelectorOpen(!0),color:M,disabled:!1,isActive:!1},send:{id:`send`,icon:i?(0,$.jsx)(re,{size:18}):P?(0,$.jsx)(ut,{size:20,color:`inherit`}):c?(0,$.jsx)(s,{size:18}):(0,$.jsx)(h,{size:18}),tooltip:i?`åœæ­¢ç”Ÿæˆ`:c?`ç”Ÿæˆå›¾åƒ`:`å‘é€æ¶ˆæ¯`,onClick:i&&v?v:_,color:i?`#ff4d4f`:!A()||t&&!r?N:c?`#9C27B0`:j?`#4CAF50`:`#09bb07`,disabled:!i&&(!A()||t&&!r),isActive:!1},voice:k.getVoiceButtonConfig()};return{renderButtonToolbar:(0,Q.useCallback)(()=>(0,$.jsxs)(`div`,{style:{display:`flex`,alignItems:`center`,justifyContent:`space-between`,paddingTop:`0px`,minHeight:`36px`,height:`36px`,flex:`0 0 auto`},children:[(0,$.jsx)(`div`,{style:{display:`flex`,alignItems:`center`,gap:`4px`},children:R.map(e=>{let n=B[e];return n?`component`in n&&n.component===`KnowledgeButton`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,mr:.5},children:(0,$.jsx)(tr,{variant:`icon-button-integrated`})},e):`component`in n&&n.component===`WebSearchButton`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,mr:.5},children:(0,$.jsx)(Vn,{webSearchActive:u,toggleWebSearch:T,variant:`icon-button-integrated`})},e):`component`in n&&n.component===`MCPToolsButton`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,mr:.5},children:(0,$.jsx)(Rn,{toolsEnabled:d,onToolsEnabledChange:w,variant:`icon-button-integrated`})},e):(0,$.jsx)(X,{title:n.tooltip,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{size:`medium`,onClick:n.onClick,disabled:n.disabled||t&&!r,style:{color:n.color,padding:`6px`,backgroundColor:n.isActive?`rgba(59, 130, 246, 0.1)`:`transparent`,transition:`all 0.2s ease-in-out`},children:n.icon})})},e):null})}),(0,$.jsx)(`div`,{style:{display:`flex`,alignItems:`center`,gap:`4px`},children:z.map(e=>{let n=B[e];return n?`component`in n&&n.component===`KnowledgeButton`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,mr:.5},children:(0,$.jsx)(tr,{variant:`icon-button-integrated`})},e):`component`in n&&n.component===`WebSearchButton`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,mr:.5},children:(0,$.jsx)(Vn,{webSearchActive:u,toggleWebSearch:T,variant:`icon-button-integrated`})},e):`component`in n&&n.component===`MCPToolsButton`?(0,$.jsx)(Y,{sx:{display:`flex`,alignItems:`center`,mr:.5},children:(0,$.jsx)(Rn,{toolsEnabled:d,onToolsEnabledChange:w,variant:`icon-button-integrated`})},e):(0,$.jsx)(X,{title:n.tooltip,children:(0,$.jsx)(`span`,{children:(0,$.jsx)(S,{size:`medium`,onClick:n.onClick,disabled:n.disabled||t&&!r,style:{color:n.color,padding:`6px`,backgroundColor:n.isActive?`rgba(59, 130, 246, 0.1)`:`transparent`,transition:`all 0.2s ease-in-out`},children:n.icon})})},e):null})})]}),[R,z,B,t,r,d,w])}},Dr=({message:e,isMobile:t,isTablet:n,isIOS:r,isDarkMode:i,iconColor:a,inputBoxStyle:o,border:s,borderRadius:c,boxShadow:l,handleChange:u})=>{let[d,f]=(0,Q.useState)(!1),[p,m]=(0,Q.useState)(!1),{isKeyboardVisible:h}=ye();(0,Q.useEffect)(()=>{h&&d&&f(!1)},[h,d]);let g=(0,Q.useMemo)(()=>{let r=e.length,i=t?280:n?400:500,a=Math.floor(i/(n?17:16)),o=0;if(r<1e3)o=e.split(`
`).length-1;else for(let t=0;t<Math.min(r,1e4);t++)e[t]===`
`&&o++;let s=Math.ceil(r/a)+o;return{showExpandButton:d?!0:s>4}},[e,t,n,d]),_=(0,Q.useRef)(null);(0,Q.useEffect)(()=>(_.current&&clearTimeout(_.current),_.current=setTimeout(()=>{requestAnimationFrame(()=>{m(g.showExpandButton)})},100),()=>{_.current&&clearTimeout(_.current)}),[g]);let v=(0,Q.useCallback)(e=>{u(e)},[u]),y=(0,Q.useCallback)(()=>{f(!d)},[d]),b=()=>t?{paddingTop:`0px`,paddingBottom:r?`34px`:`4px`,maxWidth:`100%`,marginTop:`0`,marginLeft:`0`,marginRight:`0`,paddingLeft:`8px`,paddingRight:`8px`}:n?{paddingTop:`0px`,paddingBottom:r?`34px`:`4px`,maxWidth:`calc(100% - 40px)`,marginTop:`0`,marginLeft:`auto`,marginRight:`auto`}:{paddingTop:`0px`,paddingBottom:r?`34px`:`6px`,maxWidth:`calc(100% - 32px)`,marginTop:`0`,marginLeft:`auto`,marginRight:`auto`},x=(0,Q.useCallback)(()=>p?(0,$.jsx)(`div`,{style:{position:`absolute`,top:`4px`,right:`4px`,zIndex:10},children:(0,$.jsx)(X,{title:d?`æ”¶èµ·è¾“å…¥æ¡†`:`å±•å¼€è¾“å…¥æ¡†`,children:(0,$.jsx)(S,{onClick:y,size:`small`,style:{color:d?`#2196F3`:a,padding:`2px`,width:`20px`,height:`20px`,minWidth:`20px`,backgroundColor:i?`rgba(42, 42, 42, 0.9)`:`rgba(255, 255, 255, 0.9)`,backdropFilter:`blur(4px)`,borderRadius:`6px`,boxShadow:`0 2px 4px rgba(0,0,0,0.1)`,transition:`all 0.2s ease`},children:d?(0,$.jsx)(De,{size:14}):(0,$.jsx)(Ze,{size:14})})})}):null,[p,d,y,a,i]);return{expanded:d,showExpandButton:p,enhancedHandleChange:v,handleExpandToggle:y,renderContainer:(0,Q.useCallback)(e=>(0,$.jsx)(`div`,{className:`chat-input-container`,style:{backgroundColor:`transparent`,...b(),width:`100%`,display:`flex`,flexDirection:`column`,alignItems:`center`,justifyContent:`center`,boxShadow:`none`,transition:`all 0.3s ease`,marginBottom:`0`,paddingBottom:r?h?`0`:`34px`:`0`,border:`none`},children:(0,$.jsxs)(`div`,{style:{display:`flex`,flexDirection:`column`,padding:n?`8px 12px`:t?`6px 8px`:`7px 10px`,borderRadius:c,background:`var(--theme-bg-paper)`,border:s,minHeight:n?`72px`:t?`64px`:`68px`,boxShadow:l,width:`100%`,maxWidth:`100%`,backdropFilter:o===`modern`?`blur(10px)`:`none`,WebkitBackdropFilter:o===`modern`?`blur(10px)`:`none`,transition:`all 0.3s ease`,position:`relative`,userSelect:`none`,WebkitUserSelect:`none`,MozUserSelect:`none`,msUserSelect:`none`,WebkitTouchCallout:`none`,WebkitTapHighlightColor:`transparent`},children:[x(),e]})}),[b,t,n,r,s,l,o,c,x])}},Or=({onSendMessage:e,onSendMultiModelMessage:t,onStartDebate:n,onStopDebate:r,isLoading:i=!1,allowConsecutiveMessages:a=!0,imageGenerationMode:o=!1,videoGenerationMode:s=!1,onSendImagePrompt:c,webSearchActive:l=!1,onStopResponse:u,isStreaming:d=!1,isDebating:f=!1,toolsEnabled:p=!1,availableModels:m=[],onClearTopic:h,toggleImageGenerationMode:g,toggleVideoGenerationMode:_,toggleWebSearch:v,onToolsEnabledChange:y})=>{let b=(0,Q.useMemo)(()=>E(),[]),[x,S]=(0,Q.useState)(0),[C,w]=(0,Q.useState)([]),[T,O]=(0,Q.useState)([]),[k,A]=(0,Q.useState)(!1),[j,M]=(0,Q.useState)({}),[N,P]=(0,Q.useState)([]),F=(0,Q.useRef)(null),[I,L]=(0,Q.useState)(!1),z=J(e=>e.assistants.currentAssistant),ee=gt(),B=J(e=>e.webSearch),{styles:te,isDarkMode:ne,inputBoxStyle:V}=Xt(),{hasKnowledgeContext:re,getStoredKnowledgeContext:ie,clearStoredKnowledgeContext:ae}=Yt(),oe=J(e=>e.settings.showAIDebateButton??!0),se=J(e=>e.settings.showQuickPhraseButton??!0);(0,Q.useEffect)(()=>{I&&B?.enabled&&B?.provider&&B.provider!==`custom`&&(v?.(),L(!1))},[B?.enabled,B?.provider,I,v]);let{message:H,setMessage:ce,textareaRef:le,canSendMessage:ue,handleSubmit:de,handleKeyDown:fe,handleChange:U,textareaHeight:W,showCharCount:pe,handleCompositionStart:me,handleCompositionEnd:he,isMobile:ge,isTablet:_e}=Jt({onSendMessage:e,onSendMultiModelMessage:t,onSendImagePrompt:c,isLoading:i,allowConsecutiveMessages:a,imageGenerationMode:o,videoGenerationMode:s,toolsEnabled:p,images:C,files:T,setImages:w,setFiles:O,enableTextareaResize:!0,enableCompositionHandling:!0,enableCharacterCount:!0,availableModels:m}),{hideKeyboard:ve}=ye();(0,Q.useEffect)(()=>$e.subscribe(P),[]),(0,Q.useEffect)(()=>{let e=()=>{S(e=>e+1)};return window.addEventListener(`knowledgeBaseSelected`,e),()=>{window.removeEventListener(`knowledgeBaseSelected`,e)}},[]);let{border:be,borderRadius:xe,boxShadow:Se}=te,G=ne?`#ffffff`:`#000000`,Ce=ne?`#555`:`#ccc`,K=async()=>{let e=[...C,...T.filter(e=>e.mimeType.startsWith(`image/`)).map(e=>({base64Data:e.base64Data,url:e.url||``,width:e.width,height:e.height}))];return await Promise.all(e.map(async e=>{let t=e.base64Data||e.url;if(e.url&&e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/)){let n=e.url.match(/\[å›¾ç‰‡:([a-zA-Z0-9_-]+)\]/);if(n&&n[1])try{let e=n[1],r=await D.getImageBlob(e);r&&(t=await new Promise(e=>{let t=new FileReader;t.onload=()=>e(t.result),t.readAsDataURL(r)}))}catch(e){console.error(`åŠ è½½å›¾ç‰‡å¼•ç”¨å¤±è´¥:`,e)}}return{type:`image_url`,image_url:{url:t}}}))},we=ar({message:H,setMessage:ce,isDarkMode:ne,isLoading:i,allowConsecutiveMessages:a,uploadingMedia:k,files:T,setImages:w,setFiles:O,setUploadingMedia:A,processImages:K,onSendMessage:e,toolsEnabled:p,iconColor:G}),Te=async(e=`photos`)=>{F.current&&await F.current.handleImageUpload(e)},Ee=async()=>{F.current&&await F.current.handleFileUpload()},De=(0,Q.useCallback)(()=>{if(l)v?.();else{let e=B?.enabled||!1,t=B?.provider;if(e&&t&&t!==`custom`)v?.();else{let n=[];e||n.push(ot()),(!t||t===`custom`)&&n.push(R(`bing-free`)),n.forEach(e=>ee(e)),L(!0)}}},[l,B,v,ee,L]),ke=Tr({message:H,isStreaming:d,isDebating:f,canSendMessage:ue,imageGenerationMode:o,videoGenerationMode:s,webSearchActive:l,toolsEnabled:p,availableModels:m,onSendMultiModelMessage:t,handleImageUploadLocal:Te,handleFileUploadLocal:Ee,onStartDebate:n,onStopDebate:r,handleInsertPhrase:(0,Q.useCallback)(e=>{if(!le.current)return;let t=le.current,n=t.selectionStart,r=t.selectionEnd,i=H;ce(i.slice(0,n)+e+i.slice(r)),setTimeout(()=>{if(t){let r=n+e.length;t.focus(),t.setSelectionRange(r,r)}},10)},[H,ce]),currentAssistant:z,onClearTopic:h,toggleImageGenerationMode:g,toggleVideoGenerationMode:_,toggleWebSearch:v,onToolsEnabledChange:y,showAIDebateButton:oe,showQuickPhraseButton:se,processImages:K,files:T,setImages:w,setFiles:O,setUploadingMedia:A,setMessage:ce}),q=i&&!a,Ae=(0,Q.useCallback)(async()=>{if(ve(),ke.mentionedModels.length>0&&t){let e=await K(),n=T.filter(e=>!e.mimeType.startsWith(`image/`));console.log(`æ™ºèƒ½å‘é€ï¼šä½¿ç”¨å¤šæ¨¡å‹æ¨¡å¼`,{models:ke.mentionedModels.map(e=>e.id),message:H.trim()}),t(H.trim(),ke.mentionedModels,e.length>0?e:void 0,p,n.length>0?n:void 0),ce(``),w([]),O([]),A(!1),ke.setMentionedModels([])}else de()},[ve,ke.mentionedModels,t,K,T,H,p,ce,w,O,A,de]),je=Dr({message:H,isMobile:ge,isTablet:_e,isIOS:b,isDarkMode:ne,iconColor:G,inputBoxStyle:V,border:be,borderRadius:xe,boxShadow:Se,handleChange:U}),Me=Er({isLoading:i,allowConsecutiveMessages:a,isStreaming:d,uploadingMedia:k,imageGenerationMode:o,videoGenerationMode:s,webSearchActive:l,toolsEnabled:p,images:C,files:T,handleSubmit:Ae,onStopResponse:u,handleImageUploadLocal:Te,handleFileUploadLocal:Ee,onClearTopic:h,onToolsEnabledChange:y,handleQuickWebSearchToggle:De,toggleImageGenerationMode:g,toggleVideoGenerationMode:_,menuManager:ke,voiceInputManager:we,canSendMessage:ue,isDarkMode:ne,iconColor:G,disabledColor:Ce,showLoadingIndicator:q,isDebating:f});return je.renderContainer((0,$.jsxs)($.Fragment,{children:[re()&&(()=>(0,$.jsx)(Y,{sx:{px:1,mb:1},children:(0,$.jsx)(qt,{knowledgeBaseName:ie()?.knowledgeBase?.name||`æœªçŸ¥çŸ¥è¯†åº“`,onRemove:()=>{ae(),S(e=>e+1)}})},`knowledge-${x}`))(),ke.renderMentionedModels(),(0,$.jsx)(ln,{ref:F,images:C,files:T,setImages:w,setFiles:O,setUploadingMedia:A,fileStatuses:j,setFileStatuses:M,isDarkMode:ne,isMobile:ge,borderRadius:xe}),(0,$.jsx)(`div`,{style:{display:`flex`,alignItems:`center`,marginBottom:`0px`,minHeight:`36px`,height:`36px`,flex:`1`},children:we.isVoiceRecording?we.renderVoiceInput():(0,$.jsx)(dn,{message:H,textareaRef:le,textareaHeight:W,showCharCount:pe,handleChange:je.enhancedHandleChange,handleKeyDown:fe,handleCompositionStart:me,handleCompositionEnd:he,onPaste:e=>{F.current&&F.current.handlePaste(e)},isLoading:i,allowConsecutiveMessages:a,imageGenerationMode:o,videoGenerationMode:s,webSearchActive:l,isMobile:ge,isTablet:_e,isDarkMode:ne,shouldHideVoiceButton:!1,expanded:je.expanded,onExpandToggle:je.handleExpandToggle})}),!we.isVoiceRecording&&Me.renderButtonToolbar(),ke.renderMenus(),(0,$.jsx)(Oe,{messages:N,onClose:e=>$e.remove(e),maxVisible:3})]}))};export{kn as a,Wt as c,Mn as i,ir as n,On as o,Nn as r,Kt as s,Or as t};