const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["static/js/web-lO1g68A0.js","static/js/index-hvLbsAjx.js","static/css/index-iKlUzaLt.css"])))=>i.map(i=>d[i]);
import{Lp as e,ip as t,jp as n,np as r,qp as i,zp as a}from"./index-hvLbsAjx.js";var o=e(`SpeechRecognition`,{web:()=>n(()=>import(`./web-lO1g68A0.js`),__vite__mapDeps([0,1,2])).then(e=>new e.SpeechRecognitionWeb)});const s=class e{static instance;apiKey=``;model=`whisper-1`;language;temperature=0;responseFormat=`json`;constructor(){}static getInstance(){return e.instance||=new e,e.instance}setApiKey(e){this.apiKey=e}setModel(e){this.model=e}setLanguage(e){this.language=e}setTemperature(e){this.temperature=e}setResponseFormat(e){this.responseFormat=e}async transcribeAudio(e){if(!this.apiKey)throw Error(`API密钥未设置，请先设置API密钥`);let t=new FormData;t.append(`file`,e,`recording.webm`),t.append(`model`,this.model),this.language&&t.append(`language`,this.language),t.append(`temperature`,this.temperature.toString()),t.append(`response_format`,this.responseFormat);let n=await fetch(`https://api.openai.com/v1/audio/transcriptions`,{method:`POST`,headers:{Authorization:`Bearer ${this.apiKey}`},body:t});if(!n.ok){let e=await n.json();throw Error(`OpenAI API错误: ${e.error?.message||n.statusText}`)}return await n.json()}async recordAndTranscribe(e=5e3){try{let t=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(t),r=[];return n.addEventListener(`dataavailable`,e=>{r.push(e.data)}),n.start(),console.log(`开始录制音频...`),await new Promise(t=>setTimeout(t,e)),new Promise((e,i)=>{n.addEventListener(`stop`,async()=>{try{t.getTracks().forEach(e=>e.stop());let n=new Blob(r,{type:`audio/webm`});e(await this.transcribeAudio(n))}catch(e){i(e)}}),n.stop()})}catch(e){throw console.error(`录制或转录失败:`,e),e}}getAvailableModels(){return[`whisper-1`]}}.getInstance(),c=class e{static instance;isListening=!1;partialResultsCallback=null;errorCallback=null;listeningStateCallback=null;provider=`capacitor`;recordingDuration=5e3;recordingTimeoutId=null;recordingStream=null;mediaRecorder=null;audioChunks=[];isWebEnvironment=!1;webSpeechRecognition=null;constructor(){this.isWebEnvironment=typeof window<`u`&&typeof navigator<`u`&&!!navigator.userAgent,this.isWebEnvironment&&(window.SpeechRecognition||window.webkitSpeechRecognition)&&(this.webSpeechRecognition=new(window.SpeechRecognition||window.webkitSpeechRecognition),this.webSpeechRecognition&&(this.webSpeechRecognition.continuous=!0,this.webSpeechRecognition.interimResults=!0,this.webSpeechRecognition.onresult=e=>{if(this.provider!==`capacitor`)return;let t=e.results[e.results.length-1];(t.isFinal&&this.partialResultsCallback||this.partialResultsCallback)&&this.partialResultsCallback(t[0].transcript)},this.webSpeechRecognition.onend=()=>{this.provider===`capacitor`&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`))},this.webSpeechRecognition.onerror=e=>{this.provider===`capacitor`&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`),this.errorCallback&&this.errorCallback(Error(`语音识别错误: ${e.error}`)))})),this.loadProvider(),this.isWebEnvironment||o.addListener(`partialResults`,e=>{this.provider===`capacitor`&&e.matches&&e.matches.length>0&&this.partialResultsCallback&&this.partialResultsCallback(e.matches[0])})}async loadProvider(){try{let e=await r(`speech_recognition_provider`);(e===`openai`||e===`capacitor`)&&(this.provider=e)}catch{}}static getInstance(){return e.instance||=new e,e.instance}async setProvider(e){this.isListening&&await this.stopRecognition(),this.provider=e,await t(`speech_recognition_provider`,e)}getProvider(){return this.provider}async checkPermissions(){if(this.provider===`capacitor`)if(this.isWebEnvironment)try{if(`permissions`in navigator)try{let e=await navigator.permissions.query({name:`microphone`});return e.state===`granted`?{speechRecognition:`granted`}:e.state===`denied`?{speechRecognition:`denied`}:{speechRecognition:`prompt`}}catch{return{speechRecognition:`unknown`}}else return{speechRecognition:`unknown`}}catch{return{speechRecognition:`unknown`}}else try{return await o.checkPermissions()}catch{return{speechRecognition:`unknown`}}else try{if(`permissions`in navigator){let e=await navigator.permissions.query({name:`microphone`});return e.state===`granted`?{speechRecognition:`granted`}:e.state===`denied`?{speechRecognition:`denied`}:{speechRecognition:`prompt`}}else return{speechRecognition:`unknown`}}catch{return{speechRecognition:`unknown`}}}async requestPermissions(){if(this.provider===`capacitor`)if(this.isWebEnvironment)try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),{speechRecognition:`granted`}}catch(e){return e instanceof DOMException&&e.name,{speechRecognition:`denied`}}else try{return await o.requestPermissions()}catch{return{speechRecognition:`denied`}}else try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),{speechRecognition:`granted`}}catch(e){return e instanceof DOMException&&e.name,{speechRecognition:`denied`}}}isVoiceRecognitionAvailable(){if(this.provider===`capacitor`)if(this.isWebEnvironment){let e=!!(window.SpeechRecognition||window.webkitSpeechRecognition),t=window.isSecureContext||window.location.protocol===`https:`||window.location.hostname===`localhost`||window.location.hostname===`127.0.0.1`;return e&&t&&!!this.webSpeechRecognition}else return!0;else return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}async startRecognition(e){if(this.isListening)try{await this.stopRecognition(),await new Promise(e=>setTimeout(e,300))}catch{}if(!this.isVoiceRecognitionAvailable()){let e=Error(`语音识别在当前环境下不可用`);throw this.errorCallback&&this.errorCallback(e),e}try{if(this.isListening=!0,this.listeningStateCallback&&this.listeningStateCallback(`started`),this.provider===`capacitor`)if(this.isWebEnvironment&&this.webSpeechRecognition){this.webSpeechRecognition.onend=()=>{this.isListening&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`))},this.webSpeechRecognition.onerror=e=>{this.isListening&&(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`)),this.errorCallback&&this.errorCallback(Error(`语音识别错误: ${e.error}`))},this.webSpeechRecognition.lang=e?.language||`zh-CN`;try{this.webSpeechRecognition.start()}catch(e){throw this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`),e}}else await o.start({language:e?.language||`zh-CN`,maxResults:e?.maxResults||5,partialResults:e?.partialResults!==!1,popup:e?.popup||!1});else await this.startWhisperRecognition()}catch(e){throw this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`),this.errorCallback&&this.errorCallback(e),e}}async startWhisperRecognition(){try{this.recordingStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.mediaRecorder=new MediaRecorder(this.recordingStream),this.audioChunks=[],this.mediaRecorder.addEventListener(`dataavailable`,e=>{this.audioChunks.push(e.data)}),this.mediaRecorder.addEventListener(`stop`,async()=>{try{let e=new Blob(this.audioChunks,{type:`audio/webm`});this.recordingStream&&=(this.recordingStream.getTracks().forEach(e=>e.stop()),null),await this.loadWhisperSettings();let t=await s.transcribeAudio(e);this.partialResultsCallback&&t.text&&this.partialResultsCallback(t.text)}catch(e){this.errorCallback&&this.errorCallback(e)}finally{this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`),this.mediaRecorder=null}}),this.mediaRecorder.start(),this.recordingTimeoutId=window.setTimeout(()=>{this.stopWhisperRecording()},this.recordingDuration)}catch(e){throw this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`),this.errorCallback&&this.errorCallback(e),e}}stopWhisperRecording(){this.recordingTimeoutId&&=(clearTimeout(this.recordingTimeoutId),null),this.mediaRecorder&&this.mediaRecorder.state!==`inactive`&&this.mediaRecorder.stop()}async loadWhisperSettings(){try{let e=await r(`whisper_api_key`)||``,t=await r(`whisper_model`)||`whisper-1`,n=await r(`whisper_language`),i=Number(await r(`whisper_temperature`)||`0`),a=await r(`whisper_response_format`)||`json`;s.setApiKey(e),s.setModel(t),n&&s.setLanguage(n),s.setTemperature(i),s.setResponseFormat(a)}catch{}}async stopRecognition(){if(this.isListening)try{if(this.isListening=!1,this.listeningStateCallback&&this.listeningStateCallback(`stopped`),this.provider===`capacitor`)if(this.isWebEnvironment&&this.webSpeechRecognition)try{this.webSpeechRecognition.stop()}catch{}else await o.stop().catch(()=>{});else this.stopWhisperRecording()}catch(e){this.errorCallback&&this.errorCallback(e)}}setPartialResultsCallback(e){this.partialResultsCallback=e}setListeningStateCallback(e){this.listeningStateCallback=e}setErrorCallback(e){this.errorCallback=e}getIsListening(){return this.isListening}async getSupportedLanguages(){if(this.provider===`capacitor`){if(this.isWebEnvironment)return[`zh-CN`,`en-US`,`fr-FR`,`de-DE`,`ja-JP`,`ko-KR`,`es-ES`,`it-IT`,`pt-BR`,`ru-RU`];try{return(await o.getSupportedLanguages()).languages||[]}catch{return[]}}else return`zh.en.ja.ko.fr.de.es.ru.pt.it.nl.tr.pl.ar.hi.id.fi.vi.he.uk.el.ms.cs.ro.da.hu.ta.no.th.ur.hr.bg.lt.la.mi.ml.cy.sk.te.fa.lv.bn.sr.az.sl.kn.et.mk.br.eu.is.hy.ne.mn.bs.kk.sq.sw.gl.mr.pa.si.km.sn.yo.so.af.oc.ka.be.tg.sd.gu.am.yi.lo.uz.fo.ht.ps.tk.nn.mt.sa.lb.my.bo.tl.mg.as.tt.haw.ln.ha.ba.jw.su`.split(`.`)}setRecordingDuration(e){this.recordingDuration=e}}.getInstance();var l=i(a(),1);const u=()=>{let[e,t]=(0,l.useState)(c.getIsListening()),[n,r]=(0,l.useState)(``),[i,a]=(0,l.useState)(`unknown`),[o,s]=(0,l.useState)(null);(0,l.useEffect)(()=>{let e=c;return e.setPartialResultsCallback(e=>{r(e)}),e.setListeningStateCallback(e=>{t(e===`started`),e===`stopped`&&r(``)}),e.setErrorCallback(e=>{s(e),t(!1)}),e.checkPermissions().then(e=>{a(e.speechRecognition)}),()=>{}},[]);let u=(0,l.useCallback)(async()=>{let e=await c.checkPermissions();if(a(e.speechRecognition),e.speechRecognition!==`granted`){let e=await c.requestPermissions();return a(e.speechRecognition),e.speechRecognition===`granted`}return e.speechRecognition===`granted`},[]);return{isListening:e,recognitionText:n,permissionStatus:i,error:o,startRecognition:(0,l.useCallback)(async e=>{if(s(null),!await u()){s(Error(`Speech recognition permission not granted.`));return}try{await c.startRecognition(e)}catch(e){s(e)}},[u]),stopRecognition:(0,l.useCallback)(async()=>{try{await c.stopRecognition()}catch(e){s(e)}},[]),checkAndRequestPermissions:u,getSupportedLanguages:(0,l.useCallback)(async()=>await c.getSupportedLanguages(),[])}};export{s as n,u as t};