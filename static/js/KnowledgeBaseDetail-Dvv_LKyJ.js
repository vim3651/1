const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["static/js/pdf-CrkkV70G.js","static/js/index-hvLbsAjx.js","static/css/index-iKlUzaLt.css","static/js/lib-BkIu6xxR.js","static/js/jszip.min-cQRNosLs.js","static/js/jszip.min-D09e27JL.js","static/js/esm-vRu9w9or.js","static/js/esm-C7HltxvG.js","static/js/dist-js-dsO4Yr2H.js","static/js/core-Drq98oSU.js","static/js/dist-js-DUJMg-md.js"])))=>i.map(i=>d[i]);
import{t as e}from"./Card-CgnXHdbl.js";import{t}from"./CardContent-f2tPkMYB.js";import{t as n}from"./InputAdornment-DO0tC8Wv.js";import{t as r}from"./clock-Dks_woIj.js";import{t as i}from"./file-text-BSjgZddV.js";import{t as a}from"./file-GY4o0CHl.js";import{t as o}from"./search-DqeTnaF8.js";import{t as s}from"./zap-Dl5cJHmZ.js";import{Ad as c,Al as l,Bu as u,C as d,Cd as f,Dl as p,Du as m,Eu as ee,Fl as h,Gi as g,Hd as _,Kp as v,Lt as y,Ou as b,Rt as x,Sd as S,Vl as C,Vu as w,Wu as T,Zu as E,_u as te,ad as D,bd as O,bp as ne,dd as k,eo as re,fd as A,fu as j,id as M,jd as N,jp as P,ku as F,mp as I,mu as ie,nd as ae,op as oe,ou as se,pp as ce,pu as le,qd as L,qp as R,qu as ue,rd as de,s as fe,td as pe,vd as z,wd as B,wl as V,wp as H,xd as U,xp as me,xu as he,zp as W,zu as ge}from"./index-hvLbsAjx.js";var G=R(W(),1),K={mobile:{maxPdfSize:10*1024*1024,maxExcelSize:5*1024*1024,maxDocxSize:20*1024*1024,pdfSupported:!1},desktop:{maxPdfSize:100*1024*1024,maxExcelSize:50*1024*1024,maxDocxSize:100*1024*1024,pdfSupported:!0},web:{maxPdfSize:50*1024*1024,maxExcelSize:20*1024*1024,maxDocxSize:50*1024*1024,pdfSupported:!0}};const q={text:[`.txt`,`.md`,`.markdown`,`.csv`,`.json`,`.xml`,`.yaml`,`.yml`,`.ini`,`.conf`,`.log`],code:[`.js`,`.ts`,`.jsx`,`.tsx`,`.py`,`.java`,`.c`,`.cpp`,`.h`,`.hpp`,`.cs`,`.go`,`.rs`,`.rb`,`.php`,`.swift`,`.kt`,`.scala`,`.vue`,`.svelte`],document:[`.html`,`.htm`,`.pdf`,`.docx`,`.doc`,`.rtf`,`.odt`],spreadsheet:[`.xlsx`,`.xls`,`.ods`],presentation:[`.pptx`,`.ppt`,`.odp`],ebook:[`.epub`]},_e=[...q.text,...q.code,...q.document,...q.spreadsheet,...q.presentation,...q.ebook];var ve={maxSize:50*1024*1024,extractImages:!1,preserveFormatting:!1,language:`zh-CN`};const ye=class e{static instance;platformInfo=H();limits;constructor(){this.platformInfo.isCapacitor&&this.platformInfo.isMobile?this.limits=K.mobile:this.platformInfo.isTauri?this.limits=K.desktop:this.limits=K.web}static getInstance(){return e.instance||=new e,e.instance}async parseFile(e,t,n={}){let r={...ve,...n},i=this.getExtension(t).toLowerCase(),a=e instanceof File?e.size:e.byteLength;if(r.maxSize&&a>r.maxSize)throw Error(`文件大小超过限制: ${this.formatSize(a)} > ${this.formatSize(r.maxSize)}`);if(!this.isSupported(t))throw Error(`不支持的文件格式: ${i}`);let o,s=`native`;try{this.isTextFile(i)||this.isCodeFile(i)?o=await this.parseTextFile(e):i===`.html`||i===`.htm`?o=await this.parseHtmlFile(e):i===`.pdf`?(o=await this.parsePdfFile(e,r),s=`library`):i===`.docx`?(o=await this.parseDocxFile(e),s=`library`):i===`.xlsx`||i===`.xls`?(o=await this.parseSpreadsheetFile(e,i),s=`library`):i===`.pptx`?(o=await this.parsePptxFile(e),s=`library`):i===`.epub`?(o=await this.parseEpubFile(e),s=`library`):o=await this.parseTextFile(e)}catch(e){throw console.error(`解析文件失败: ${t}`,e),Error(`解析文件失败: ${e instanceof Error?e.message:`未知错误`}`)}let c=this.countWords(o);return{content:o,metadata:{fileName:t,fileSize:a,fileType:i,parseMethod:s,wordCount:c,parsedAt:Date.now()}}}async parseTextFile(e){return e instanceof File?await e.text():new TextDecoder(`utf-8`).decode(e)}async parseHtmlFile(e){let t=await this.parseTextFile(e);return this.stripHtml(t)}async parsePdfFile(e,t){let n=e instanceof File?e.size:e.byteLength;if(!this.limits.pdfSupported)return this.getMobilePdfMessage();if(n>this.limits.maxPdfSize)throw Error(`PDF 文件过大: ${this.formatSize(n)} > ${this.formatSize(this.limits.maxPdfSize)}`);try{let t=await this.loadPdfJs();if(!t)return this.getPdfFallbackMessage();let n=e instanceof File?await e.arrayBuffer():e,r=await t.getDocument({data:n}).promise,i=[],a=r.numPages;for(let e=1;e<=a;e++){let t=(await(await r.getPage(e)).getTextContent()).items.map(e=>e.str).join(` `);i.push(`--- 第 ${e} 页 ---\n${t}`)}return i.join(`

`)}catch(e){return console.warn(`PDF 解析失败，使用降级方案:`,e),this.getPdfFallbackMessage()}}async loadPdfJs(){try{let e=await P(()=>import(`./pdf-CrkkV70G.js`),__vite__mapDeps([0,1,2]));return e.GlobalWorkerOptions&&(e.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${e.version}/pdf.worker.min.js`),e}catch{return null}}getPdfFallbackMessage(){return`[PDF 文件]

此 PDF 文件需要安装 pdfjs-dist 库才能解析内容。

请运行: npm install pdfjs-dist

或者您可以：
1. 将 PDF 转换为文本格式后上传
2. 复制 PDF 中的文本内容直接粘贴`}getMobilePdfMessage(){return`[PDF 文件]

移动端暂不支持直接解析 PDF 文件（性能和内存限制）。

建议：
1. 在电脑上将 PDF 转换为 TXT/MD 格式
2. 或者复制 PDF 中的文本内容直接粘贴
3. 使用桌面端上传 PDF 文件`}async parseDocxFile(e){try{let t=await this.loadMammoth();if(!t)return this.getDocxFallbackParse(e);let n=e instanceof File?await e.arrayBuffer():e;return(await t.extractRawText({arrayBuffer:n})).value||``}catch(t){return console.warn(`DOCX mammoth 解析失败，尝试简单解析:`,t),this.getDocxFallbackParse(e)}}async loadMammoth(){try{return await P(()=>import(`./lib-BkIu6xxR.js`).then(v(1)),__vite__mapDeps([3,1,2,4]))}catch{return null}}async getDocxFallbackParse(e){try{let t=(await P(async()=>{let{default:e}=await import(`./jszip.min-D09e27JL.js`).then(v(1));return{default:e}},__vite__mapDeps([5,4,1,2]))).default,n=e instanceof File?await e.arrayBuffer():e,r=await(await t.loadAsync(n)).file(`word/document.xml`)?.async(`text`);if(!r)throw Error(`无法读取 DOCX 内容`);return this.stripXml(r)}catch{return`[DOCX 文件]

需要安装 mammoth 或 jszip 库才能解析 DOCX 文件。

请运行: npm install mammoth`}}async parseSpreadsheetFile(e,t){let n=e instanceof File?e.size:e.byteLength;if(n>this.limits.maxExcelSize)throw Error(`Excel 文件过大: ${this.formatSize(n)} > ${this.formatSize(this.limits.maxExcelSize)}，请拆分后上传`);try{let t=await P(()=>import(`./xlsx-BM8wxq-S.js`),[]),n=e instanceof File?await e.arrayBuffer():e,r=t.read(n,{type:`array`}),i=[];for(let e of r.SheetNames){let n=r.Sheets[e],a=t.utils.sheet_to_csv(n);i.push(`=== 工作表: ${e} ===\n${a}`)}return i.join(`

`)}catch{return`[Excel 文件]

需要安装 xlsx 库才能解析电子表格。

请运行: npm install xlsx`}}async parsePptxFile(e){try{let t=(await P(async()=>{let{default:e}=await import(`./jszip.min-D09e27JL.js`).then(v(1));return{default:e}},__vite__mapDeps([5,4,1,2]))).default,n=e instanceof File?await e.arrayBuffer():e,r=await t.loadAsync(n),i=[],a=1;for(;;){let e=r.file(`ppt/slides/slide${a}.xml`);if(!e)break;let t=await e.async(`text`),n=this.stripXml(t);n.trim()&&i.push(`--- 幻灯片 ${a} ---\n${n}`),a++}return i.join(`

`)||`[空白演示文稿]`}catch{return`[PPTX 文件]

需要安装 jszip 库才能解析演示文稿。

请运行: npm install jszip`}}async parseEpubFile(e){try{let t=(await P(async()=>{let{default:e}=await import(`./jszip.min-D09e27JL.js`).then(v(1));return{default:e}},__vite__mapDeps([5,4,1,2]))).default,n=e instanceof File?await e.arrayBuffer():e,r=await t.loadAsync(n),i=[],a=Object.keys(r.files).filter(e=>e.endsWith(`.html`)||e.endsWith(`.xhtml`)).sort();for(let e of a){let t=await r.file(e)?.async(`text`);if(t){let e=this.stripHtml(t);e.trim()&&i.push(e)}}return i.join(`

---

`)||`[空白电子书]`}catch{return`[EPUB 文件]

需要安装 jszip 库才能解析电子书。

请运行: npm install jszip`}}stripHtml(e){let t=e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,``);return t=t.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,``),t=t.replace(/<\/?(p|div|br|h[1-6]|li|tr)[^>]*>/gi,`
`),t=t.replace(/<[^>]+>/g,``),t=this.decodeHtmlEntities(t),t=t.replace(/\n\s*\n/g,`

`).trim(),t}stripXml(e){return(e.match(/>([^<]+)</g)||[]).map(e=>e.slice(1,-1).trim()).filter(e=>e.length>0).join(` `)}decodeHtmlEntities(e){let t={"&nbsp;":` `,"&amp;":`&`,"&lt;":`<`,"&gt;":`>`,"&quot;":`"`,"&#39;":`'`,"&apos;":`'`,"&mdash;":`—`,"&ndash;":`–`,"&hellip;":`...`},n=e;for(let[e,r]of Object.entries(t))n=n.replace(new RegExp(e,`g`),r);return n=n.replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(parseInt(t,10))),n}getExtension(e){let t=e.lastIndexOf(`.`);return t>=0?e.slice(t):``}isSupported(e){let t=this.getExtension(e).toLowerCase();return _e.includes(t)}isTextFile(e){return q.text.includes(e)}isCodeFile(e){return q.code.includes(e)}formatSize(e){let t=[`B`,`KB`,`MB`,`GB`];if(e===0)return`0 B`;let n=Math.floor(Math.log(e)/Math.log(1024));return`${(e/1024**n).toFixed(1)} ${t[n]}`}countWords(e){return(e.match(/[\u4e00-\u9fa5]/g)||[]).length+e.replace(/[\u4e00-\u9fa5]/g,` `).split(/\s+/).filter(e=>e.length>0).length}getSupportedFormatsDescription(){return`支持格式：
• 文本: TXT, MD, CSV, JSON, XML, YAML
• 代码: JS, TS, Python, Java, C/C++, Go, Rust 等
• 文档: HTML, PDF*, DOCX*, RTF
• 表格: XLSX*, XLS*
• 演示: PPTX*
• 电子书: EPUB*

* 需要安装额外依赖`}}.getInstance();var J=R(me(),1),be=async()=>{try{let{FilePicker:e}=await P(async()=>{let{FilePicker:e}=await import(`./esm-vRu9w9or.js`);return{FilePicker:e}},__vite__mapDeps([6,7,1,2]));return e}catch{return null}},xe=async()=>{try{let{open:e}=await P(async()=>{let{open:e}=await import(`./dist-js-dsO4Yr2H.js`);return{open:e}},__vite__mapDeps([8,9]));return e}catch{return null}},Se=async()=>{try{return await P(()=>import(`./dist-js-DUJMg-md.js`),__vite__mapDeps([10,9]))}catch{return null}},Ce=_(A,{shouldForwardProp:e=>e!==`isDragActive`&&e!==`disabled`})(({theme:e,isDragActive:t,disabled:n})=>({border:`2px dashed ${t?e.palette.primary.main:e.palette.divider}`,borderRadius:Number(e.shape.borderRadius)*2,padding:e.spacing(3),textAlign:`center`,cursor:n?`not-allowed`:`pointer`,transition:`all 0.2s ease-in-out`,backgroundColor:t?L(e.palette.primary.main,.08):n?L(e.palette.action.disabled,.04):`transparent`,opacity:n?.6:1,"&:hover":{borderColor:n?e.palette.divider:e.palette.primary.main,backgroundColor:L(n?e.palette.action.disabled:e.palette.primary.main,.04)}})),we=_(`input`)({display:`none`}),Y=_e.join(`,`),Te=({onFilesSelected:e,accept:t=Y,multiple:n=!0,disabled:r=!1,maxSize:i=50*1024*1024,children:o})=>{let[s,c]=(0,G.useState)(!1),l=(0,G.useRef)(null),u=H(),d=e=>new Promise((t,n)=>{let r=new FileReader;r.onload=e=>t(e.target?.result),r.onerror=()=>n(Error(`读取文件失败`)),r.readAsText(e)}),f=async e=>{let t=Array.from(e),n=[];for(let e of t){if(i&&e.size>i){console.warn(`文件 ${e.name} 超过大小限制`);continue}try{let t,r;ee(e.name)?(r=await g(e),t=await h(e)):t=await d(e),n.push({name:e.name,size:e.size,type:e.type||m(e.name),content:t,arrayBuffer:r})}catch(t){console.error(`读取文件 ${e.name} 失败:`,t)}}return n},m=e=>({txt:`text/plain`,md:`text/markdown`,csv:`text/csv`,json:`application/json`,html:`text/html`,xml:`application/xml`,yaml:`text/yaml`,yml:`text/yaml`,js:`text/javascript`,ts:`text/typescript`,jsx:`text/javascript`,tsx:`text/typescript`,py:`text/x-python`,java:`text/x-java`,pdf:`application/pdf`,docx:`application/vnd.openxmlformats-officedocument.wordprocessingml.document`,doc:`application/msword`,rtf:`application/rtf`,xlsx:`application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`,xls:`application/vnd.ms-excel`,pptx:`application/vnd.openxmlformats-officedocument.presentationml.presentation`,ppt:`application/vnd.ms-powerpoint`,epub:`application/epub+zip`})[e.split(`.`).pop()?.toLowerCase()||``]||`application/octet-stream`,ee=e=>{let t=`.`+(e.split(`.`).pop()?.toLowerCase()||``);return[...q.document.filter(e=>e!==`.html`&&e!==`.htm`),...q.spreadsheet,...q.presentation,...q.ebook].includes(t)},h=e=>new Promise((t,n)=>{let r=new FileReader;r.onload=e=>{let n=e.target?.result;t(n.split(`,`)[1]||n)},r.onerror=()=>n(Error(`读取文件失败`)),r.readAsDataURL(e)}),g=e=>new Promise((t,n)=>{let r=new FileReader;r.onload=e=>t(e.target?.result),r.onerror=()=>n(Error(`读取文件失败`)),r.readAsArrayBuffer(e)}),_=async()=>{let r=await be();if(r)try{e((await r.pickFiles({types:t.split(`,`).map(e=>e.trim().replace(`.`,``)),readData:!0,limit:n?0:1})).files.map(e=>({name:e.name,size:e.size,type:e.mimeType||m(e.name),content:e.data?atob(e.data):void 0,path:e.path})))}catch(e){console.error(`Capacitor 文件选择失败:`,e)}},v=async()=>{let r=await xe(),i=await Se();if(!(!r||!i))try{let a=await r({multiple:n,filters:[{name:`文本文件`,extensions:t.split(`,`).map(e=>e.trim().replace(`.`,``))}]});if(!a)return;let o=Array.isArray(a)?a:[a],s=[];for(let e of o)try{let t=await i.readTextFile(e),n=e.split(/[/\\]/).pop()||e,r=await i.stat(e);s.push({name:n,size:r.size,type:m(n),content:t,path:e})}catch(t){console.error(`读取文件失败: ${e}`,t)}e(s)}catch(e){console.error(`Tauri 文件选择失败:`,e)}},y=(0,G.useCallback)(()=>{r||(u.isCapacitor&&u.isMobile?_():u.isTauri?v():l.current?.click())},[r,u]),b=(0,G.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),r||c(!0)},[r]),x=(0,G.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),c(!1)},[]),S=(0,G.useCallback)(e=>{e.preventDefault(),e.stopPropagation()},[]),C=(0,G.useCallback)(async t=>{if(t.preventDefault(),t.stopPropagation(),c(!1),r)return;let n=t.dataTransfer.files;if(n.length>0){let t=await f(n);t.length>0&&e(t)}},[r,e,i]),w=(0,G.useCallback)(async t=>{let n=t.target.files;if(n&&n.length>0){let t=await f(n);t.length>0&&e(t)}t.target.value=``},[e,i]),T=u.isCapacitor&&u.isMobile;return(0,J.jsxs)(Ce,{isDragActive:s,disabled:r,onClick:y,onDragEnter:T?void 0:b,onDragLeave:T?void 0:x,onDragOver:T?void 0:S,onDrop:T?void 0:C,children:[(0,J.jsx)(we,{ref:l,type:`file`,accept:t,multiple:n,onChange:w}),o||(0,J.jsxs)(A,{sx:{py:2},children:[(0,J.jsx)(A,{sx:{mb:2,color:s?`primary.main`:`text.secondary`},children:s?(0,J.jsx)(a,{size:48}):(0,J.jsx)(p,{size:48})}),(0,J.jsx)(U,{variant:`body1`,color:s?`primary`:`textSecondary`,gutterBottom:!0,children:s?`松开以上传文件`:T?`点击选择文件`:`拖拽文件到此处，或点击选择`}),(0,J.jsx)(U,{variant:`caption`,color:`textSecondary`,children:`支持 TXT, MD, CSV, JSON, HTML, XML 格式`}),!T&&(0,J.jsx)(A,{sx:{mt:2},children:(0,J.jsx)(k,{variant:`outlined`,size:`small`,startIcon:(0,J.jsx)(p,{size:16}),onClick:e=>{e.stopPropagation(),y()},disabled:r,children:`选择文件`})})]})]})},Ee=({status:e,progress:t,error:n,onRetry:i,size:a=20})=>(0,J.jsx)(A,{sx:{display:`inline-flex`,alignItems:`center`},children:(()=>{switch(e){case`pending`:return(0,J.jsx)(F,{title:`等待处理`,children:(0,J.jsx)(A,{sx:{display:`flex`,alignItems:`center`,color:`warning.main`},children:(0,J.jsx)(r,{size:a})})});case`processing`:return(0,J.jsx)(F,{title:t===void 0?`处理中...`:`处理中 ${t}%`,children:(0,J.jsxs)(A,{sx:{display:`flex`,alignItems:`center`,position:`relative`},children:[(0,J.jsx)(B,{size:a,variant:t===void 0?`indeterminate`:`determinate`,value:t,sx:{color:`primary.main`}}),t!==void 0&&(0,J.jsx)(A,{sx:{position:`absolute`,top:`50%`,left:`50%`,transform:`translate(-50%, -50%)`,fontSize:a*.4,fontWeight:`bold`,color:`primary.main`},children:Math.round(t)})]})});case`completed`:return(0,J.jsx)(F,{title:`处理完成`,children:(0,J.jsx)(A,{sx:{display:`flex`,alignItems:`center`,color:`success.main`},children:(0,J.jsx)(j,{size:a})})});case`failed`:return(0,J.jsxs)(A,{sx:{display:`flex`,alignItems:`center`,gap:.5},children:[(0,J.jsx)(F,{title:n||`处理失败`,children:(0,J.jsx)(A,{sx:{display:`flex`,alignItems:`center`,color:`error.main`},children:(0,J.jsx)(le,{size:a})})}),i&&(0,J.jsx)(F,{title:`重试`,children:(0,J.jsx)(f,{size:`small`,onClick:e=>{e.stopPropagation(),i()},sx:{p:.5,color:`primary.main`,"&:hover":{backgroundColor:`action.hover`}},children:(0,J.jsx)(C,{size:a-4})})})]});default:return null}})()}),De=3,X=({knowledgeBaseId:e,onDocumentsAdded:t})=>{let[r,i]=(0,G.useState)([]),[s,d]=(0,G.useState)([]),[p,m]=(0,G.useState)(!0),[h,_]=(0,G.useState)(!1),[v,y]=(0,G.useState)(``),[E,O]=(0,G.useState)({active:!1,current:0,total:0}),[ne,j]=(0,G.useState)(!1),[P,F]=(0,G.useState)(null),[I,se]=(0,G.useState)(!0),ce=(0,G.useRef)(null),le=(0,G.useRef)(null),L=x.getInstance(),R=(0,G.useCallback)(e=>{if(e===0)return`0 B`;let t=1024,n=[`B`,`KB`,`MB`,`GB`],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/t**+r).toFixed(1))+` `+n[r]},[]),fe=(0,G.useCallback)(e=>e.split(`.`).pop()?.toUpperCase()||`TXT`,[]),H=(0,G.useCallback)(e=>{let t=new Date(e),n=new Date().getTime()-t.getTime(),r=Math.floor(n/(1e3*60*60*24));return r===0?t.toLocaleTimeString(`zh-CN`,{hour:`2-digit`,minute:`2-digit`}):r===1?`昨天`:r<7?`${r}天前`:t.toLocaleDateString(`zh-CN`,{month:`short`,day:`numeric`})},[]),me=(0,G.useCallback)(e=>{switch(e){case`reading`:return`读取文件...`;case`parsing`:return`解析内容...`;case`chunking`:return`分块处理...`;case`embedding`:return`向量化...`;case`saving`:return`保存中...`;default:return`处理中...`}},[]),he=(0,G.useCallback)(e=>{let t=`.`+(e.split(`.`).pop()?.toLowerCase()||``);return[`.pdf`,`.docx`,`.doc`,`.xlsx`,`.xls`,`.pptx`,`.ppt`,`.epub`,`.rtf`,`.odt`].includes(t)},[]),W=(0,G.useCallback)(async()=>{try{m(!0),i(await L.getDocumentsByKnowledgeBaseId(e))}catch(e){console.error(`加载文档失败:`,e),F(`无法加载文档列表，请稍后再试`)}finally{m(!1)}},[e,L]);(0,G.useEffect)(()=>(e&&W(),()=>{ce.current&&ce.current.abort()}),[e,W]);let K=(0,G.useCallback)((e,t)=>{d(n=>n.map(n=>n.id===e?{...n,...t}:n))},[]),q=(0,G.useCallback)(async t=>{K(t.id,{status:`processing`,progress:0});try{let n=t.fileContent;if(O(e=>({...e,currentFileProgress:5,currentStage:`reading`})),K(t.id,{progress:5}),await new Promise(e=>setTimeout(e,50)),K(t.id,{progress:10}),O(e=>({...e,currentFileProgress:10})),he(t.fileName)){O(e=>({...e,currentFileProgress:15,currentStage:`parsing`})),K(t.id,{progress:15});try{let e=t.arrayBuffer||(t.fileContent?Uint8Array.from(atob(t.fileContent),e=>e.charCodeAt(0)).buffer:null);e&&(n=(await ye.parseFile(e,t.fileName)).content)}catch(e){console.warn(`文件解析失败，使用原始内容:`,e),n=`[${t.fileName}]\n\n此文件格式需要额外依赖才能解析。\n\n${e instanceof Error?e.message:`解析失败`}`}K(t.id,{progress:30}),O(e=>({...e,currentFileProgress:30}))}else K(t.id,{progress:30}),O(e=>({...e,currentFileProgress:30}));return O(e=>({...e,currentFileProgress:40,currentStage:`chunking`})),K(t.id,{progress:40}),await new Promise(e=>setTimeout(e,50)),K(t.id,{progress:50}),O(e=>({...e,currentFileProgress:50})),O(e=>({...e,currentFileProgress:60,currentStage:`embedding`})),K(t.id,{progress:60}),await L.addDocument({knowledgeBaseId:e,content:n,metadata:{source:t.fileName,fileName:t.fileName}}),K(t.id,{progress:85}),O(e=>({...e,currentFileProgress:85})),O(e=>({...e,currentFileProgress:95,currentStage:`saving`})),K(t.id,{progress:95}),await new Promise(e=>setTimeout(e,50)),K(t.id,{status:`completed`,progress:100}),O(e=>({...e,currentFileProgress:100})),!0}catch(e){let n=e instanceof Error?e.message:`处理失败`;return K(t.id,{status:`failed`,error:n,retryCount:t.retryCount+1}),!1}},[e,L,K]),_e=(0,G.useCallback)(async e=>{if(e.length===0)return;_(!0),F(null),O({active:!0,current:0,total:e.length});let n=e.map(e=>({id:oe(),fileName:e.name,fileSize:e.size,fileContent:e.content||``,status:`pending`,progress:0,retryCount:0,chunkIds:[],created_at:Date.now()}));d(e=>[...e,...n]);let r=0;for(let e=0;e<n.length;e++){let t=n[e];O(n=>({...n,current:e,currentFileName:t.fileName})),await q(t)&&r++,O(t=>({...t,current:e+1}))}await W(),t&&r>0&&t(),_(!1),O({active:!1,current:0,total:0}),d(e=>e.filter(e=>e.status!==`completed`))},[q,W,t]),ve=(0,G.useCallback)(async e=>{let t=s.find(t=>t.id===e);if(!t||t.retryCount>=De){F(`文档 ${t?.fileName||``} 已达到最大重试次数`);return}await q(t),await W()},[s,q,W]),be=(0,G.useCallback)(async e=>{try{await L.deleteDocument(e),await W()}catch(e){console.error(`删除文档失败:`,e),F(`删除文档失败，请稍后再试`)}},[L,W]),xe=(0,G.useCallback)(e=>{d(t=>t.filter(t=>t.id!==e))},[]),Se=(0,G.useCallback)(async()=>{try{m(!0),await Promise.all(r.map(e=>L.deleteDocument(e.id))),await W(),d([])}catch(e){console.error(`清理文档失败:`,e),F(`清理文档失败，请稍后再试`)}finally{j(!1),m(!1)}},[r,L,W]),Ce=(0,G.useCallback)(async e=>{try{await L.deleteDocument(e.id);let t={id:oe(),fileName:e.metadata.fileName||e.metadata.source,fileSize:e.content.length,fileContent:e.content,status:`pending`,progress:0,retryCount:0,chunkIds:[],created_at:Date.now()};d(e=>[...e,t]),await q(t),await W(),d(e=>e.filter(e=>e.status!==`completed`))}catch(e){console.error(`刷新文档失败:`,e),F(`刷新文档失败，请稍后再试`)}},[L,q,W]),we=(0,G.useCallback)(e=>{y(e.target.value)},[]),Y=(0,G.useMemo)(()=>r.filter(e=>{if(!v)return!0;let t=v.toLowerCase();return e.content.toLowerCase().includes(t)||e.metadata.fileName?.toLowerCase().includes(t)||e.metadata.source.toLowerCase().includes(t)}),[r,v]),X=(0,G.useMemo)(()=>{let e=new Map;return Y.forEach(t=>{let n=t.metadata.fileName||t.metadata.source,r=e.get(n)||[];e.set(n,[...r,t])}),Array.from(e.entries()).map(([e,t])=>({fileName:e,docs:t.sort((e,t)=>(e.metadata.chunkIndex||0)-(t.metadata.chunkIndex||0)),totalSize:t.reduce((e,t)=>e+t.content.length,0),timestamp:Math.max(...t.map(e=>e.metadata.timestamp))}))},[Y]),Z=re({count:X.length,getScrollElement:()=>le.current,estimateSize:()=>72,overscan:5}),Q=s.filter(e=>e.status===`processing`||e.status===`pending`),$=s.filter(e=>e.status===`failed`);return(0,J.jsxs)(A,{sx:{width:`100%`,overflow:`auto`,maxHeight:`calc(100vh - 300px)`},children:[(0,J.jsxs)(A,{sx:{mb:2},children:[(0,J.jsxs)(A,{sx:{display:`flex`,alignItems:`center`,justifyContent:`space-between`,mb:1},children:[(0,J.jsx)(U,{variant:`subtitle2`,color:`textSecondary`,children:`文件上传`}),(0,J.jsx)(f,{size:`small`,onClick:()=>se(!I),children:I?(0,J.jsx)(ie,{size:16}):(0,J.jsx)(te,{size:16})})]}),(0,J.jsx)(N,{in:I,children:(0,J.jsx)(Te,{onFilesSelected:_e,disabled:h,accept:`.txt,.md,.csv,.json,.html,.xml`,multiple:!0})})]}),E.active&&(0,J.jsxs)(c,{variant:`outlined`,sx:{mb:2,p:2},children:[(0,J.jsxs)(A,{sx:{display:`flex`,justifyContent:`space-between`,mb:1},children:[(0,J.jsxs)(U,{variant:`body2`,fontWeight:`medium`,children:[`处理文件 (`,E.current,`/`,E.total,`)`]}),(0,J.jsxs)(U,{variant:`body2`,color:`text.secondary`,children:[Math.round(E.current/E.total*100),`%`]})]}),(0,J.jsx)(ue,{variant:`determinate`,value:E.current/E.total*100,sx:{mb:1.5,height:6,borderRadius:3}}),E.currentFileName&&(0,J.jsxs)(A,{sx:{mt:1.5,p:1.5,bgcolor:`action.hover`,borderRadius:1},children:[(0,J.jsxs)(A,{sx:{display:`flex`,justifyContent:`space-between`,alignItems:`center`,mb:.5},children:[(0,J.jsx)(U,{variant:`caption`,noWrap:!0,sx:{maxWidth:`60%`},children:E.currentFileName}),(0,J.jsx)(z,{label:me(E.currentStage),size:`small`,color:`primary`,variant:`outlined`,sx:{height:20,fontSize:`0.7rem`}})]}),(0,J.jsx)(ue,{variant:`determinate`,value:E.currentFileProgress||0,sx:{height:4,borderRadius:2},color:`secondary`})]})]}),Q.length>0&&(0,J.jsxs)(c,{variant:`outlined`,sx:{mb:2,p:1},children:[(0,J.jsxs)(U,{variant:`subtitle2`,sx:{mb:1},children:[`处理中 (`,Q.length,`)`]}),(0,J.jsx)(T,{dense:!0,children:Q.map(e=>(0,J.jsxs)(w,{children:[(0,J.jsx)(u,{sx:{minWidth:40},children:(0,J.jsx)(Ee,{status:e.status,progress:e.progress,size:20})}),(0,J.jsx)(ge,{primary:e.fileName,secondary:`${(e.fileSize/1024).toFixed(1)} KB`})]},e.id))})]}),$.length>0&&(0,J.jsxs)(S,{severity:`error`,sx:{mb:2},action:(0,J.jsx)(k,{size:`small`,onClick:()=>d(e=>e.filter(e=>e.status!==`failed`)),children:`清除全部`}),children:[(0,J.jsxs)(U,{variant:`subtitle2`,sx:{mb:1},children:[`处理失败 (`,$.length,`)`]}),$.map(e=>(0,J.jsxs)(A,{sx:{display:`flex`,alignItems:`center`,gap:1,mt:.5},children:[(0,J.jsx)(U,{variant:`body2`,children:e.fileName}),(0,J.jsx)(Ee,{status:`failed`,error:e.error,onRetry:e.retryCount<De?()=>ve(e.id):void 0,size:16}),(0,J.jsx)(f,{size:`small`,onClick:()=>xe(e.id),children:(0,J.jsx)(V,{size:14})})]},e.id))]}),P&&(0,J.jsx)(S,{severity:`error`,sx:{mb:2},onClose:()=>F(null),children:P}),(0,J.jsxs)(b,{direction:{xs:`column`,sm:`row`},spacing:2,mb:2,alignItems:`center`,children:[(0,J.jsx)(ee,{placeholder:`搜索文档...`,variant:`outlined`,size:`small`,fullWidth:!0,value:v,onChange:we,disabled:p,slotProps:{input:{startAdornment:(0,J.jsx)(n,{position:`start`,children:(0,J.jsx)(o,{size:20})}),endAdornment:v?(0,J.jsx)(n,{position:`end`,children:(0,J.jsx)(f,{onClick:()=>y(``),size:`small`,children:(0,J.jsx)(V,{size:20})})}):null}}}),r.length>0&&(0,J.jsx)(k,{variant:`outlined`,color:`error`,startIcon:(0,J.jsx)(l,{size:16}),onClick:()=>j(!0),disabled:h||p,sx:{whiteSpace:`nowrap`},children:`清理全部`})]}),X.length>0&&(0,J.jsxs)(A,{sx:{display:`flex`,gap:2,mb:1.5,flexWrap:`wrap`},children:[(0,J.jsxs)(U,{variant:`caption`,color:`text.secondary`,children:[`共 `,X.length,` 个文件，`,Y.length,` 个块`]}),(0,J.jsxs)(U,{variant:`caption`,color:`text.secondary`,children:[`总大小: `,R(Y.reduce((e,t)=>e+t.content.length,0))]})]}),(0,J.jsx)(c,{variant:`outlined`,children:p?(0,J.jsxs)(A,{display:`flex`,justifyContent:`center`,alignItems:`center`,p:4,children:[(0,J.jsx)(B,{size:32}),(0,J.jsx)(U,{ml:2,variant:`body1`,children:`加载文档中...`})]}):X.length>0?(0,J.jsx)(A,{ref:le,sx:{height:400,overflow:`auto`,"&::-webkit-scrollbar":{width:6},"&::-webkit-scrollbar-thumb":{backgroundColor:`action.disabled`,borderRadius:3}},children:(0,J.jsx)(A,{sx:{height:`${Z.getTotalSize()}px`,width:`100%`,position:`relative`},children:Z.getVirtualItems().map(e=>{let t=X[e.index],n=t.docs[0],r=fe(t.fileName);return(0,J.jsxs)(A,{"data-index":e.index,ref:Z.measureElement,sx:{position:`absolute`,top:0,left:0,width:`100%`,transform:`translateY(${e.start}px)`},children:[e.index>0&&(0,J.jsx)(pe,{}),(0,J.jsxs)(w,{sx:{py:1.5},secondaryAction:(0,J.jsxs)(b,{direction:`row`,spacing:.5,children:[(0,J.jsx)(f,{onClick:()=>Ce(n),size:`small`,title:`重新处理`,children:(0,J.jsx)(C,{size:18})}),(0,J.jsx)(f,{onClick:()=>{t.docs.forEach(e=>be(e.id))},size:`small`,title:`删除`,children:(0,J.jsx)(l,{size:18})})]}),children:[(0,J.jsx)(u,{children:(0,J.jsx)(A,{sx:{width:40,height:40,borderRadius:1,bgcolor:`action.hover`,display:`flex`,alignItems:`center`,justifyContent:`center`},children:(0,J.jsx)(a,{size:20})})}),(0,J.jsx)(ge,{primary:(0,J.jsxs)(A,{sx:{display:`flex`,alignItems:`center`,gap:1},children:[(0,J.jsx)(U,{variant:`body2`,fontWeight:`medium`,noWrap:!0,sx:{maxWidth:200},children:t.fileName}),(0,J.jsx)(z,{label:r,size:`small`,sx:{height:18,fontSize:`0.65rem`,bgcolor:`primary.main`,color:`primary.contrastText`}})]}),secondary:(0,J.jsxs)(A,{sx:{display:`flex`,gap:1.5,mt:.5,flexWrap:`wrap`},children:[(0,J.jsx)(U,{variant:`caption`,color:`text.secondary`,children:R(t.totalSize)}),(0,J.jsxs)(U,{variant:`caption`,color:`text.secondary`,children:[t.docs.length,` 块`]}),(0,J.jsx)(U,{variant:`caption`,color:`text.secondary`,children:H(t.timestamp)})]}),secondaryTypographyProps:{component:`div`}})]})]},e.key)})})}):(0,J.jsx)(A,{p:4,textAlign:`center`,children:(0,J.jsx)(U,{color:`textSecondary`,children:v?`没有找到匹配的文档`:`暂无文档，请拖拽文件上传`})})}),(0,J.jsxs)(g,{open:ne,onClose:()=>j(!1),children:[(0,J.jsx)(ae,{children:`确认清理所有文档`}),(0,J.jsx)(M,{children:(0,J.jsxs)(de,{children:[`确定要删除知识库中的所有 `,r.length,` 个文档吗？此操作不可撤销。`]})}),(0,J.jsxs)(D,{children:[(0,J.jsx)(k,{onClick:()=>j(!1),children:`取消`}),(0,J.jsx)(k,{onClick:Se,color:`error`,children:`清理全部`})]})]})]})};const Z=({knowledgeBaseId:r,onInsertReference:i})=>{let[a,l]=(0,G.useState)(``),[u,p]=(0,G.useState)([]),[m,g]=(0,G.useState)(!1),[_,v]=(0,G.useState)(null),[y,C]=(0,G.useState)(.7),[w,te]=(0,G.useState)(5),[D,O]=(0,G.useState)(!0),[re,j]=(0,G.useState)(null),M=ne(e=>e.messages.currentTopicId);(0,G.useEffect)(()=>{(async()=>{try{let e=await x.getInstance().getKnowledgeBase(r);e&&(C(e.threshold||.7),te(e.documentCount||5))}catch(e){console.error(`Error fetching knowledge base details:`,e)}})()},[r]);let N=async()=>{if(!a.trim()){v(`请输入搜索内容`);return}g(!0),v(null),j(null);let e=Date.now();try{let t=await x.getInstance().search({knowledgeBaseId:r,query:a.trim(),threshold:y,limit:w,useEnhancedRAG:D});j(Date.now()-e),p(t),t.length===0&&v(`没有找到匹配的内容`)}catch(e){console.error(`Search error:`,e),v(`搜索过程中发生错误`)}finally{g(!1)}},P=()=>{l(``),p([]),v(null)},I=e=>{e.key===`Enter`&&N()},ie=async e=>{try{if(!M){v(`未选择会话`);return}await d.createKnowledgeReferenceBlockFromSearchResult(M,e,r,a),i&&i(e.documentId,e.content)}catch(e){console.error(`Error inserting reference:`,e),v(`插入引用失败`)}};return(0,J.jsxs)(A,{sx:{width:`100%`,overflow:`auto`,maxHeight:`calc(100vh - 300px)`},children:[(0,J.jsxs)(c,{elevation:0,sx:{p:2,mb:2},children:[(0,J.jsxs)(A,{display:`flex`,justifyContent:`space-between`,alignItems:`center`,mb:2,children:[(0,J.jsx)(U,{variant:`subtitle1`,children:`知识库搜索`}),(0,J.jsx)(F,{title:D?`增强RAG搜索：使用查询扩展、混合搜索和重排序`:`简单搜索：仅使用向量相似度`,children:(0,J.jsx)(E,{control:(0,J.jsx)(fe,{checked:D,onChange:e=>O(e.target.checked)}),label:(0,J.jsxs)(A,{display:`flex`,alignItems:`center`,gap:.5,children:[D?(0,J.jsx)(h,{size:16}):(0,J.jsx)(s,{size:16}),(0,J.jsx)(U,{variant:`caption`,children:D?`增强RAG`:`简单搜索`})]})})})]}),(0,J.jsx)(ee,{fullWidth:!0,variant:`outlined`,size:`small`,placeholder:`输入搜索内容...`,value:a,onChange:e=>l(e.target.value),onKeyDown:I,slotProps:{input:{startAdornment:(0,J.jsx)(n,{position:`start`,children:(0,J.jsx)(o,{size:20})}),endAdornment:a&&(0,J.jsx)(n,{position:`end`,children:(0,J.jsx)(f,{size:`small`,onClick:P,children:(0,J.jsx)(V,{size:16})})})}},sx:{mb:1}}),(0,J.jsx)(k,{variant:`contained`,color:`primary`,onClick:N,disabled:m||!a.trim(),fullWidth:!0,children:m?(0,J.jsx)(B,{size:24,color:`inherit`}):`搜索`})]}),_&&(0,J.jsx)(S,{severity:`info`,sx:{mb:2},children:_}),u.length>0&&(0,J.jsxs)(A,{children:[(0,J.jsxs)(A,{display:`flex`,justifyContent:`space-between`,alignItems:`center`,mb:1,children:[(0,J.jsxs)(U,{variant:`subtitle2`,children:[`搜索结果 (`,u.length,`)`]}),(0,J.jsxs)(A,{display:`flex`,gap:1,children:[re&&(0,J.jsx)(z,{label:`${re}ms`,size:`small`,variant:`outlined`,color:`primary`}),(0,J.jsx)(z,{label:D?`增强RAG`:`简单搜索`,size:`small`,color:D?`success`:`default`,icon:D?(0,J.jsx)(h,{size:16}):(0,J.jsx)(s,{size:16})})]})]}),(0,J.jsx)(T,{disablePadding:!0,children:u.map(n=>(0,J.jsx)(e,{variant:`outlined`,sx:{mb:1},children:(0,J.jsx)(t,{sx:{p:2,"&:last-child":{pb:2}},children:(0,J.jsxs)(b,{spacing:1,children:[(0,J.jsx)(U,{variant:`body2`,component:`div`,sx:{fontSize:`0.875rem`,mb:1,maxHeight:100,overflow:`auto`},children:n.content}),(0,J.jsxs)(A,{display:`flex`,justifyContent:`space-between`,alignItems:`center`,children:[(0,J.jsxs)(U,{variant:`caption`,color:`text.secondary`,children:[`相似度: `,(n.similarity*100).toFixed(1),`%`]}),(0,J.jsx)(k,{size:`small`,variant:`outlined`,startIcon:(0,J.jsx)(se,{size:16}),onClick:()=>ie(n),children:`插入引用`})]})]})})},n.documentId))})]})]})};var Q=({active:e,icon:t,label:n,onClick:r})=>(0,J.jsxs)(A,{onClick:r,sx:{flex:1,display:`flex`,alignItems:`center`,justifyContent:`center`,gap:1,py:1.5,cursor:`pointer`,borderBottom:2,borderColor:e?`text.primary`:`transparent`,color:e?`text.primary`:`text.secondary`,transition:`all 0.2s`,"&:hover":{color:`text.primary`,bgcolor:e=>L(e.palette.text.primary,.05)}},children:[(0,J.jsx)(t,{size:18}),(0,J.jsx)(U,{variant:`body2`,fontWeight:e?600:400,children:n})]}),$=()=>{let{id:e}=I(),t=ce(),[n,r]=(0,G.useState)(0),{selectKnowledgeBase:a,selectedKnowledgeBase:s}=y();return(0,G.useEffect)(()=>{e&&a(e)},[e,a]),e?(0,J.jsxs)(A,{sx:{display:`flex`,flexDirection:`column`,height:`100vh`,bgcolor:e=>e.palette.mode===`light`?L(e.palette.primary.main,.02):L(e.palette.background.default,.9)},children:[(0,J.jsx)(O,{position:`fixed`,elevation:0,sx:{zIndex:e=>e.zIndex.drawer+1,bgcolor:`background.paper`,color:`text.primary`,borderBottom:1,borderColor:`divider`},children:(0,J.jsxs)(m,{children:[(0,J.jsx)(f,{edge:`start`,onClick:()=>{t(`/settings/knowledge`)},"aria-label":`back`,sx:{color:e=>e.palette.primary.main},children:(0,J.jsx)(he,{size:20})}),(0,J.jsx)(U,{variant:`h6`,component:`div`,sx:{flexGrow:1,fontWeight:600,ml:1},children:s?.name||`知识库详情`})]})}),(0,J.jsx)(A,{sx:{flexGrow:1,overflow:`auto`,mt:8,px:{xs:1,sm:2},py:2},children:s?(0,J.jsxs)(J.Fragment,{children:[(0,J.jsxs)(A,{sx:{mb:2,p:2,borderRadius:2,border:`1px solid`,borderColor:`divider`,bgcolor:`background.paper`},children:[(0,J.jsx)(U,{variant:`body2`,color:`text.secondary`,sx:{mb:2},children:s.description||`暂无描述`}),(0,J.jsx)(pe,{sx:{my:1.5}}),(0,J.jsxs)(A,{sx:{display:`grid`,gridTemplateColumns:`repeat(auto-fit, minmax(150px, 1fr))`,gap:1},children:[(0,J.jsxs)(A,{children:[(0,J.jsx)(U,{variant:`caption`,color:`text.secondary`,children:`模型`}),(0,J.jsx)(U,{variant:`body2`,fontWeight:500,children:s.model})]}),(0,J.jsxs)(A,{children:[(0,J.jsx)(U,{variant:`caption`,color:`text.secondary`,children:`维度`}),(0,J.jsx)(U,{variant:`body2`,fontWeight:500,children:s.dimensions})]}),(0,J.jsxs)(A,{children:[(0,J.jsx)(U,{variant:`caption`,color:`text.secondary`,children:`块大小`}),(0,J.jsx)(U,{variant:`body2`,fontWeight:500,children:s.chunkSize})]}),(0,J.jsxs)(A,{children:[(0,J.jsx)(U,{variant:`caption`,color:`text.secondary`,children:`重叠`}),(0,J.jsx)(U,{variant:`body2`,fontWeight:500,children:s.chunkOverlap})]}),(0,J.jsxs)(A,{children:[(0,J.jsx)(U,{variant:`caption`,color:`text.secondary`,children:`阈值`}),(0,J.jsx)(U,{variant:`body2`,fontWeight:500,children:s.threshold})]})]})]}),(0,J.jsxs)(A,{sx:{display:`flex`,borderBottom:1,borderColor:`divider`,bgcolor:`background.paper`,borderRadius:`8px 8px 0 0`},children:[(0,J.jsx)(Q,{active:n===0,icon:i,label:`文档管理`,onClick:()=>r(0)}),(0,J.jsx)(Q,{active:n===1,icon:o,label:`知识搜索`,onClick:()=>r(1)})]}),(0,J.jsxs)(A,{sx:{bgcolor:`background.paper`,borderRadius:`0 0 8px 8px`,border:`1px solid`,borderColor:`divider`,borderTop:`none`,p:2},children:[n===0&&(0,J.jsx)(X,{knowledgeBaseId:e}),n===1&&(0,J.jsx)(Z,{knowledgeBaseId:e})]})]}):(0,J.jsx)(A,{display:`flex`,justifyContent:`center`,alignItems:`center`,height:`50vh`,children:(0,J.jsx)(B,{})})})]}):(t(`/settings/knowledge`),null)};export{$ as default};